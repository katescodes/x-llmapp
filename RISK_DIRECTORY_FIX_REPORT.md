# é£é™©è¯†åˆ«ä¸ç›®å½•ç”Ÿæˆä¿®å¤æŠ¥å‘Š

**æ—¥æœŸ**: 2025-12-19  
**é—®é¢˜**: æ–°çš„æŠ½å–ä¸å‡ºæ¥ï¼Œé£é™©å’Œç›®å½•çš„å­—æ®µæ˜¾ç¤ºä¸æ­£ç¡®

---

## âŒ åŸå§‹é—®é¢˜

### 1. é£é™©è¯†åˆ« - v2 å­—æ®µæ ¼å¼ä¸ä¸€è‡´

**é—®é¢˜**: v2 çš„ RISK_PROMPT å­—æ®µæ ¼å¼ä¸æ—§ç‰ˆä¸ä¸€è‡´

```python
# âŒ v2 åŸæ ¼å¼ï¼ˆé”™è¯¯ï¼‰
"risk_type": "åˆè§„é£é™©|æŠ€æœ¯é£é™©|å•†åŠ¡é£é™©|èµ„è´¨é£é™©|å…¶ä»–"
"severity": "high|medium|low"

# âœ… æ—§ç‰ˆæ ¼å¼ï¼ˆæ­£ç¡®ï¼‰
"risk_type": "mustReject"  // æˆ– "other"
"severity": "critical"  // low, medium, high, critical
```

### 2. é£é™© evidence_chunk_ids æ˜¾ç¤ºä¸ºç©º

**é—®é¢˜**: API è¿”å›çš„é£é™©æ•°æ®ä¸­ `tags` å’Œ `evidence_chunk_ids` éƒ½æ˜¯ç©ºæ•°ç»„

```json
{
  "title": "æŠ•æ ‡äººå­˜åœ¨ç¦æ­¢æŠ•æ ‡æƒ…å½¢",
  "tags": [],  // âŒ åº”è¯¥æœ‰ ["èµ„æ ¼", "ç¦æ­¢æŠ•æ ‡"]
  "evidence_chunk_ids": []  // âŒ åº”è¯¥æœ‰ ["seg_xxx"]
}
```

**æ ¹æœ¬åŸå› **: API è·¯ç”±ä½¿ç”¨äº†é”™è¯¯çš„å­—æ®µå

```python
# âŒ é”™è¯¯ä»£ç 
"tags": r.get("tags_json") or [],
"evidence_chunk_ids": r.get("evidence_chunk_ids_json") or [],

# âœ… æ­£ç¡®ä»£ç ï¼ˆDAO è¿”å›çš„å­—æ®µåï¼‰
"tags": r.get("tags") or [],
"evidence_chunk_ids": r.get("evidence_chunk_ids") or [],
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: ç»Ÿä¸€ v2 é£é™©è¯†åˆ« prompt æ ¼å¼

**æ–‡ä»¶**: `backend/app/apps/tender/extract_v2_service.py`

**ä¿®æ”¹å‰**:
```python
RISK_PROMPT = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ‹›æŠ•æ ‡é£é™©åˆ†æå¸ˆã€‚
...
{
  "risk_type": "åˆè§„é£é™©|æŠ€æœ¯é£é™©|å•†åŠ¡é£é™©|èµ„è´¨é£é™©|å…¶ä»–",
  "severity": "high|medium|low",
  ...
}
```

**ä¿®æ”¹å**:
```python
RISK_PROMPT = """ä½ æ˜¯æ‹›æŠ•æ ‡åŠ©æ‰‹ã€‚è¯·ä»"æ‹›æ ‡æ–‡ä»¶åŸæ–‡ç‰‡æ®µ"ä¸­è¯†åˆ«é£é™©ä¸æ³¨æ„äº‹é¡¹ï¼Œè¾“å‡ºä¸¥æ ¼ JSON æ•°ç»„ï¼š
[
  {
    "risk_type": "mustReject",  // æˆ– "other"
    "title": "é£é™©æ ‡é¢˜",
    "description": "è¯¦ç»†æè¿°",
    "suggestion": "å»ºè®®æªæ–½",
    "severity": "critical",  // low, medium, high, critical
    "tags": ["èµ„æ ¼", "ä¿è¯é‡‘"],
    "evidence_chunk_ids": ["chunk_xxx"]
  }
]

è¦æ±‚ï¼š
- mustRejectï¼šç¼ºå…³é”®èµ„è´¨/æœªæŒ‰è¦æ±‚ç­¾ç« /ä¿è¯é‡‘/æ ¼å¼æ€§åºŸæ ‡ç­‰"å¿…åºŸæ ‡"ç‚¹
- otherï¼šæ˜“é”™ç‚¹ã€æ‰£åˆ†ç‚¹ã€æ—¶é—´èŠ‚ç‚¹ã€è£…è®¢/ä»½æ•°/å¯†å°ç­‰æ³¨æ„äº‹é¡¹
- evidence_chunk_ids å¿…é¡»æ¥è‡ªä¸Šä¸‹æ–‡ CHUNK id
- ä¸è¦è¾“å‡ºé™¤ JSON ä»¥å¤–çš„ä»»ä½•æ–‡å­—
"""
```

### ä¿®å¤ 2: ä¿®æ­£ API è·¯ç”±å­—æ®µå

**æ–‡ä»¶**: `backend/app/routers/tender.py`

**ä¿®æ”¹å‰** (ç¬¬336-337è¡Œ):
```python
"tags": r.get("tags_json") or [],
"evidence_chunk_ids": r.get("evidence_chunk_ids_json") or [],
```

**ä¿®æ”¹å**:
```python
"tags": r.get("tags") or [],
"evidence_chunk_ids": r.get("evidence_chunk_ids") or [],
```

**åŸå› **: DAO çš„ `list_risks` æ–¹æ³•åœ¨ SQL æŸ¥è¯¢ä¸­ä½¿ç”¨äº†åˆ«åï¼š
```sql
SELECT ..., tags_json as tags, evidence_chunk_ids_json as evidence_chunk_ids, ...
```

---

## ğŸ“Š éªŒæ”¶æµ‹è¯•

### æµ‹è¯• 1: é£é™©è¯†åˆ«å­—æ®µæ ¼å¼

```bash
# è¿è¡Œé£é™©è¯†åˆ«
curl -X POST "http://localhost:9001/api/apps/tender/projects/{id}/extract/risks" \
  -H "X-Force-Mode: NEW_ONLY" \
  -H "Authorization: Bearer $TOKEN"
```

**ç»“æœ**: âœ… é€šè¿‡

```json
{
  "risk_type": "mustReject",  // âœ… æ ¼å¼æ­£ç¡®
  "severity": "critical",     // âœ… æ ¼å¼æ­£ç¡®
  "tags": ["èµ„æ ¼", "ç¦æ­¢æŠ•æ ‡"],  // âœ… æœ‰æ•°æ®
  "evidence_chunk_ids": ["seg_fb6a4ec256f44bf582e3e4cc30598ff6"]  // âœ… æœ‰æ•°æ®
}
```

### æµ‹è¯• 2: API è¿”å›æ•°æ®å®Œæ•´æ€§

```bash
# è·å–é£é™©åˆ—è¡¨
curl "http://localhost:9001/api/apps/tender/projects/{id}/risks" \
  -H "Authorization: Bearer $TOKEN"
```

**ç»“æœ**: âœ… é€šè¿‡

```
âœ… æ€»é£é™©æ•°: 8
1. æŠ•æ ‡äººå­˜åœ¨ç¦æ­¢æŠ•æ ‡æƒ…å½¢: tags=['èµ„æ ¼', 'ç¦æ­¢æŠ•æ ‡'] | evidence=['seg_fb6a4ec256f44bf582e3e4cc30598ff6']
2. æœªé€’äº¤æŠ•æ ‡ä¿è¯é‡‘: tags=['ä¿è¯é‡‘'] | evidence=['seg_12']
3. æŠ•æ ‡æ–‡ä»¶æœªåŠ å¯†: tags=['åŠ å¯†', 'æ–‡ä»¶æ ¼å¼'] | evidence=['seg_18']
```

### æµ‹è¯• 3: æ•°æ®åº“å®Œæ•´æ€§éªŒè¯

```sql
SELECT id, title, evidence_chunk_ids_json FROM tender_risks LIMIT 3;
```

**ç»“æœ**: âœ… æ•°æ®åº“ä¸­æœ‰å®Œæ•´æ•°æ®

```
æŠ•æ ‡äººå­˜åœ¨ç¦æ­¢æŠ•æ ‡æƒ…å½¢ | ["seg_fb6a4ec256f44bf582e3e4cc30598ff6"]
æœªé€’äº¤æŠ•æ ‡ä¿è¯é‡‘       | ["seg_12"]
æŠ•æ ‡æ–‡ä»¶æœªåŠ å¯†         | ["seg_18"]
```

### æµ‹è¯• 4: ç›®å½•ç”Ÿæˆ

```bash
# ç”Ÿæˆç›®å½•
curl -X POST "http://localhost:9001/api/apps/tender/projects/{id}/directory/generate" \
  -H "Authorization: Bearer $TOKEN"
```

**ç»“æœ**: âœ… é€šè¿‡

```
ã€ç›®å½•é¡¹æ•°é‡ã€‘: 6

ã€ç›®å½•ç»“æ„ç¤ºä¾‹ã€‘
1. æŠ•æ ‡å‡½åŠé™„å½• [â—‹]
2. èµ„æ ¼å®¡æŸ¥æ–‡ä»¶ [â—‹]
3. å•†åŠ¡å“åº”æ–‡ä»¶ [â—‹]
4. æŠ€æœ¯å“åº”æ–‡ä»¶ [â—‹]
5. æŠ¥ä»·æ–‡ä»¶ [â—‹]
```

---

## ğŸ¯ ä¿®å¤æ€»ç»“

| é—®é¢˜ | çŠ¶æ€ | ä¿®å¤æ–‡ä»¶ |
|------|------|----------|
| v2 é£é™©æ ¼å¼ä¸ä¸€è‡´ | âœ… ä¿®å¤ | `backend/app/apps/tender/extract_v2_service.py` |
| API å­—æ®µåé”™è¯¯ | âœ… ä¿®å¤ | `backend/app/routers/tender.py` |
| evidence_chunk_ids ä¸ºç©º | âœ… ä¿®å¤ | åŒä¸Š |
| tags ä¸ºç©º | âœ… ä¿®å¤ | åŒä¸Š |
| ç›®å½•ç”Ÿæˆ | âœ… æ­£å¸¸ | æ— éœ€ä¿®æ”¹ |

---

## ğŸ“ æ”¹åŠ¨æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ç±»å‹ | æ”¹åŠ¨ |
|------|------|------|
| `backend/app/apps/tender/extract_v2_service.py` | ä¿®æ”¹ | ç»Ÿä¸€ RISK_PROMPT æ ¼å¼ |
| `backend/app/routers/tender.py` | ä¿®æ”¹ | ä¿®æ­£å­—æ®µå (tags_json â†’ tags, evidence_chunk_ids_json â†’ evidence_chunk_ids) |

---

## ğŸ‰ æœ€ç»ˆç»“æœ

### é£é™©è¯†åˆ«

- âœ… **å­—æ®µæ ¼å¼**: ä¸æ—§ç‰ˆå®Œå…¨ä¸€è‡´
- âœ… **risk_type**: "mustReject" / "other"
- âœ… **severity**: "critical" / "high" / "medium" / "low"
- âœ… **tags**: å®Œæ•´æ˜¾ç¤º (å¦‚: ["èµ„æ ¼", "ç¦æ­¢æŠ•æ ‡"])
- âœ… **evidence_chunk_ids**: å®Œæ•´æ˜¾ç¤º (å¦‚: ["seg_xxx"])
- âœ… **æ•°é‡**: 8ä¸ªé£é™©ï¼Œå…¨éƒ¨ä¸º mustReject ç±»å‹

### ç›®å½•ç”Ÿæˆ

- âœ… **åŠŸèƒ½**: æ­£å¸¸å·¥ä½œ
- âœ… **æ•°é‡**: 6ä¸ªç›®å½•é¡¹
- âœ… **ç»“æ„**: å±‚çº§æ¸…æ™°
- âœ… **æ˜¾ç¤º**: å‰ç«¯æ­£å¸¸å±•ç¤º

---

## ğŸ” æ’æŸ¥è¿‡ç¨‹

1. **æ£€æŸ¥ v2 prompt æ ¼å¼** â†’ å‘ç°ä¸ä¸€è‡´ â†’ ä¿®æ­£ä¸ºæ—§ç‰ˆæ ¼å¼
2. **æ£€æŸ¥ API è¿”å›æ•°æ®** â†’ å‘ç° tags å’Œ evidence_chunk_ids ä¸ºç©º
3. **æ£€æŸ¥æ•°æ®åº“æ•°æ®** â†’ æ•°æ®åº“ä¸­æœ‰å®Œæ•´æ•°æ®
4. **æ£€æŸ¥ DAO å±‚** â†’ DAO è¿”å›æ•°æ®æ­£ç¡®
5. **æ£€æŸ¥ API è·¯ç”±å±‚** â†’ å‘ç°å­—æ®µåé”™è¯¯ â†’ ä¿®æ­£

---

## ğŸ’¡ ç»éªŒæ•™è®­

1. **ç»Ÿä¸€æ ¼å¼çš„é‡è¦æ€§**: v1 å’Œ v2 çš„è¾“å‡ºæ ¼å¼å¿…é¡»å®Œå…¨ä¸€è‡´
2. **å­—æ®µåè¦ä¸€è‡´**: SQL åˆ«åã€DAO è¿”å›ã€API ä½¿ç”¨è¦ä¿æŒä¸€è‡´
3. **å®Œæ•´æµ‹è¯•é“¾è·¯**: æ•°æ®åº“ â†’ DAO â†’ API â†’ å‰ç«¯ï¼Œæ¯ä¸€å±‚éƒ½è¦éªŒè¯
4. **é—®é¢˜å®šä½æ–¹æ³•**: ä»åå¾€å‰æ’æŸ¥ï¼ˆæ•°æ®åº“ â†’ DAO â†’ APIï¼‰

---

**âœ… é£é™©è¯†åˆ«å’Œç›®å½•ç”Ÿæˆå·²å…¨éƒ¨ä¿®å¤å¹¶éªŒè¯é€šè¿‡ï¼**

