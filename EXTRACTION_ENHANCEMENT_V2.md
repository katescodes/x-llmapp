# 信息提取增强 v2.0 - 开标时间 + 技术参数

## 用户反馈问题

1. **开标时间**（`bidOpeningTime`）字段为空
2. **技术参数**提取不全（只有4条，应该有很多）

## 问题调查

### 1. 开标时间问题

**文档内容**：
```
投标文件递交的截止时间（投标截止时间，下同）为2024年12月12日10时30分
招标人或其委托代理机构，以及已在投标截止时间前按规定上传投标文件的投标人，
均应在开标当日投标截止时间前登录不见面开标系统
```

**发现**：
- 文档中没有单独明确的"开标时间：xxx"
- 而是写的"**在开标当日投标截止时间前**"
- 说明：**开标时间 = 投标截止时间**

**原因**：
- LLM没有理解"开标当日投标截止时间"就是开标时间
- 缺乏明确的提示告诉LLM这两个时间可能是一样的

### 2. 技术参数问题

**已提取的技术参数**：只有4条
1. PLC设备、超融合一体机
2. 中央操作计算机（CPU i7-12700, 内存32GB等）
3. 供货期90天
4. 投标保证金50万元

**文档中的技术参数**（"技术标准和要求.pdf"，305个分片）：
```
- 电机功率≥55kW应配置软启动器
- 电压降应在10%以内
- 漆膜厚度：湿膜每层60um，干膜每层35um
- 防护等级IP要求
- 加热器表面温度不得超过200℃
- 执行器分体最大距离可达到50米
- 短路检测机构：ASTA、KEMA
- 噪音和振动要求
- 材质要求（不锈钢、镀铬等）
- 润滑油规格
- 焊接标准BS5135
... 还有大量其他技术参数
```

**原因**：
1. **检索关键词不够丰富**：原来只有"技术要求 技术规范 技术参数 设备参数 性能指标 功能要求 规格 型号 参数表"
2. **检索数量不够**：topk_per_query=30, topk_total=120，对于包含305个分片的技术文档来说太少
3. **缺乏具体参数关键词**：没有"功率"、"电压"、"尺寸"、"防护等级"等具体术语
4. **Prompt缺乏引导**：没有明确告诉LLM要提取各种类型的技术参数

## 解决方案

### 修复1：扩展base查询（开标时间）

**文件**：`backend/app/works/tender/extraction_specs/project_info_v2.py`

**修改前**：
```python
"base": "... 投标截止 开标时间 开标地点 ..."
```

**修改后**：
```python
"base": "... 投标截止时间 投标文件递交截止时间 开标时间 开标当日 开标地点 ..."
```

**新增关键词**：
- `投标截止时间`（完整表述）
- `投标文件递交截止时间`（文档中的实际用词）
- `开标当日`（用于匹配"开标当日投标截止时间"）

### 修复2：大幅扩展technical查询

**修改前（9个关键词）**：
```python
"technical": "技术要求 技术规范 技术参数 设备参数 性能指标 功能要求 规格 型号 参数表"
```

**修改后（60+个关键词）**：
```python
"technical": "技术要求 技术规范 技术标准 技术参数 技术指标 设备参数 性能指标 性能要求 功能要求 功能参数 规格 型号 参数表 技术清单 不低于 大于等于 小于等于 额定 标称 CPU 内存 硬盘 显卡 处理器 操作系统 功率 电压 电流 频率 转速 流量 压力 温度 湿度 尺寸 重量 厚度 直径 长度 宽度 高度 容量 精度 防护等级 IP等级 材质 品牌"
```

**新增类别**：
- **比较词**：不低于、大于等于、小于等于、额定、标称
- **电气参数**：功率、电压、电流、频率
- **物理参数**：尺寸、重量、厚度、直径、长度、宽度、高度、容量
- **性能参数**：转速、流量、压力、温度、湿度、精度
- **质量参数**：防护等级、IP等级、材质、品牌
- **IT参数**：CPU、内存、硬盘、显卡、处理器、操作系统

### 修复3：增加检索数量

**修改前**：
```python
top_k_per_query = 30   # 每个查询返回30个
top_k_total = 120      # 总共最多120个
```

**修改后**：
```python
top_k_per_query = 50   # 增加到50个
top_k_total = 200      # 增加到200个
```

**理由**：
- 技术标准文档有305个分片
- 原来的120个总数可能覆盖不全
- 增加到200个，确保技术文档被充分检索

### 修复4：优化prompt（开标时间）

**文件**：`backend/app/works/tender/prompts/project_info_v2.md`

**修改前**：
```json
"bidOpeningTime": "开标时间"
```

**修改后**：
```json
"bidOpeningTime": "开标时间（注意：如果文档中只写'在开标当日投标截止时间前'，说明开标时间=投标截止时间，此时bidOpeningTime应填写与bidDeadline相同的时间）"
```

**效果**：明确告诉LLM，开标时间可能等于投标截止时间。

### 修复5：增加技术参数提取指南

在prompt中新增一节：

```markdown
## 技术参数提取重点说明

提取`technical_parameters`时，请特别注意：
1. **尽可能多地提取**各类设备、系统的技术规格和参数
2. 技术参数包括但不限于：
   - 电气参数（电压、电流、功率、频率等）
   - 物理参数（尺寸、重量、容量、厚度、直径等）
   - 性能参数（转速、流量、压力、精度、效率等）
   - 环境参数（温度、湿度、防护等级IP等）
   - 配置参数（CPU、内存、硬盘、操作系统等）
   - 质量参数（材质、品牌、标准等）
3. 对于带"不低于"、"≥"、"≤"等限制条件的参数，应完整提取
4. 优先提取有明确数值的参数（如"电压380V"、"功率≥55kW"等）
5. 如果有独立的"技术标准和要求"文档，应重点从中提取详细参数
```

**效果**：
- 明确告诉LLM要提取哪些类型的参数
- 强调"尽可能多地提取"
- 给出具体的参数分类和示例

## 预期效果

### 开标时间

**修改前**：
```json
{
  "bidDeadline": "2024年12月12日10时30分",
  "bidOpeningTime": ""
}
```

**修改后**：
```json
{
  "bidDeadline": "2024年12月12日10时30分",
  "bidOpeningTime": "2024年12月12日10时30分"
}
```

### 技术参数

**修改前**：4条参数

**修改后**：预计提取**50+条**技术参数，包括：
- 主要设备规格（PLC、超融合一体机）
- 计算机配置（CPU、内存、硬盘、显卡、操作系统）
- 电气要求（电机功率≥55kW、电压降≤10%）
- 材质要求（不锈钢、镀铬、涂层厚度）
- 防护等级（IP等级、防潮、防腐）
- 环境参数（温度、加热器表面温度≤200℃）
- 执行器参数（分体距离≤50米、控制信号4~20mA）
- 标准要求（焊接标准BS5135、检测机构ASTA/KEMA）
- ... 更多参数

## 测试验证

### 步骤

1. 登录系统：`admin/admin123`
2. 进入"测试"项目
3. **重新点击"提取基本信息"**按钮
4. 等待提取完成

### 验证点

**1. 开标时间**
```sql
SELECT 
    data_json->'base'->>'bidOpeningTime' as opening_time,
    data_json->'base'->>'bidDeadline' as deadline
FROM tender_project_info
WHERE project_id = 'tp_9160ce348db444e9b5a3fa4b66e8680a';
```

**预期**：两个时间应该一样（都是2024年12月12日10时30分）

**2. 技术参数数量**
```sql
SELECT 
    jsonb_array_length(data_json->'technical_parameters') as param_count
FROM tender_project_info
WHERE project_id = 'tp_9160ce348db444e9b5a3fa4b66e8680a';
```

**预期**：param_count应该 > 20（之前只有4）

**3. 技术参数详情**
```sql
SELECT 
    jsonb_pretty(data_json->'technical_parameters')
FROM tender_project_info
WHERE project_id = 'tp_9160ce348db444e9b5a3fa4b66e8680a';
```

**预期**：应该能看到各种类型的参数（电气、物理、性能、质量等）

## 总结

### 改进亮点

1. **开标时间**：增加了语义理解，让LLM能识别"开标当日投标截止时间"就是开标时间
2. **技术参数**：
   - 关键词从9个扩展到60+个 ✅
   - 检索数量从120增加到200 ✅
   - 增加了详细的提取指南 ✅
3. **召回率提升**：通过增加topk和关键词，预计能召回更多相关文档块

### 技术要点

**核心原则**：
1. **检索阶段**：使用尽可能丰富的关键词和同义词
2. **召回阶段**：增加topk值，确保重要文档不被遗漏
3. **提取阶段**：提供明确的提取指南和示例

**招投标领域特点**：
- 术语多样性高（招标控制价=最高限价）
- 文档结构复杂（基本信息+技术标准+商务条款+评分标准）
- 技术参数分散在多个文档中

---

**版本**：v2.0  
**更新日期**：2025-12-25  
**状态**：已部署，等待测试验证

