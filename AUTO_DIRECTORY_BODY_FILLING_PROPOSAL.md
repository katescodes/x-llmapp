# è‡ªåŠ¨æŠ½å–ç›®å½•å¹¶å¡«å……æ ¼å¼æ–‡æ¡£ - å®Œæ•´æ–¹æ¡ˆ

**æå‡ºæ—¶é—´**: 2025-12-25  
**éœ€æ±‚**: è‡ªåŠ¨æŠ½å–æŠ•æ ‡æ–‡ä»¶ç›®å½•ï¼Œå¹¶å°†æ‹›æ ‡ä¹¦ä¸­çš„æ ¼å¼æ–‡æ¡£è‡ªåŠ¨è¯†åˆ«å¹¶å¡«å…¥ç›®å½•æ­£æ–‡

---

## ğŸ“‹ éœ€æ±‚åˆ†æ

### ä¸šåŠ¡åœºæ™¯

```
æ‹›æ ‡ä¹¦åŒ…å«:
â”œâ”€ æŠ•æ ‡æ–‡ä»¶ç»„æˆè¦æ±‚ï¼ˆç›®å½•ç»“æ„ï¼‰
â”‚   â”œâ”€ ç¬¬ä¸€å· å•†åŠ¡æ–‡ä»¶
â”‚   â”‚   â”œâ”€ 1. æŠ•æ ‡å‡½
â”‚   â”‚   â”œâ”€ 2. æ³•äººæˆæƒå§”æ‰˜ä¹¦
â”‚   â”‚   â””â”€ 3. æŠ•æ ‡ä¿è¯é‡‘å‡­è¯
â”‚   â””â”€ ç¬¬äºŒå· æŠ€æœ¯æ–‡ä»¶
â”‚       â”œâ”€ 1. æŠ€æœ¯æ–¹æ¡ˆ
â”‚       â””â”€ 2. æ–½å·¥ç»„ç»‡è®¾è®¡
â””â”€ æŠ•æ ‡æ–‡ä»¶æ ¼å¼ï¼ˆæ ¼å¼æ–‡æ¡£/æ ·è¡¨ï¼‰
    â”œâ”€ é™„ä»¶1ï¼šæŠ•æ ‡å‡½ï¼ˆæ ¼å¼ï¼‰
    â”œâ”€ é™„ä»¶2ï¼šæ³•äººæˆæƒå§”æ‰˜ä¹¦ï¼ˆæ ¼å¼ï¼‰
    â””â”€ é™„ä»¶3ï¼šå…¶ä»–æ ¼å¼

å½“å‰é—®é¢˜:
1. ç›®å½•ç”Ÿæˆï¼šâœ… å·²æ”¯æŒï¼ˆdirectory generationï¼‰
2. æ ¼å¼æ–‡æ¡£æå–ï¼šâœ… å·²æ”¯æŒï¼ˆsnippet extractionï¼‰
3. è‡ªåŠ¨å…³è”ï¼šâŒ æœªæ”¯æŒï¼ˆéœ€è¦äººå·¥åŒ¹é…ï¼‰

æœŸæœ›ç»“æœ:
è‡ªåŠ¨å°†æ ¼å¼æ–‡æ¡£å¡«å…¥å¯¹åº”çš„ç›®å½•èŠ‚ç‚¹æ­£æ–‡ä¸­
```

### ç”¨æˆ·ä»·å€¼

1. **æ•ˆç‡æå‡**
   - å½“å‰ï¼šäººå·¥æŸ¥æ‰¾æ ¼å¼æ–‡æ¡£ â†’ å¤åˆ¶ â†’ ç²˜è´´åˆ°ç›®å½•èŠ‚ç‚¹
   - ä¼˜åŒ–åï¼šä¸€é”®è‡ªåŠ¨å¡«å……ï¼ŒèŠ‚çœ90%æ—¶é—´

2. **å‡†ç¡®æ€§æå‡**
   - è‡ªåŠ¨åŒ¹é…ï¼Œå‡å°‘äººä¸ºé”™è¯¯
   - åŸºäºè¯­ä¹‰ç†è§£ï¼Œè€Œéç®€å•å­—ç¬¦ä¸²åŒ¹é…

3. **ç”¨æˆ·ä½“éªŒ**
   - ç”¨æˆ·åªéœ€ç‚¹å‡»"ç”Ÿæˆç›®å½•"
   - ç³»ç»Ÿè‡ªåŠ¨å®Œæˆç›®å½•ç»“æ„ + æ ¼å¼æ–‡æ¡£å¡«å……

---

## ğŸ¯ æ–¹æ¡ˆè®¾è®¡

### æ ¸å¿ƒæ€è·¯

```
Phase 1: ç›®å½•ç”Ÿæˆï¼ˆå·²æœ‰ï¼‰
  â†“
Phase 2: æ ¼å¼æ–‡æ¡£æå–ï¼ˆå·²æœ‰ï¼‰
  â†“
Phase 3: æ™ºèƒ½åŒ¹é…ï¼ˆæ–°å¢ï¼‰âœ¨
  â”œâ”€ åŸºäºæ ‡é¢˜ç›¸ä¼¼åº¦
  â”œâ”€ åŸºäºå…³é”®è¯åŒ¹é…
  â”œâ”€ åŸºäºLLMè¯­ä¹‰ç†è§£
  â””â”€ åŸºäºè¯æ®chunké‡å åº¦
  â†“
Phase 4: è‡ªåŠ¨å¡«å……ï¼ˆæ–°å¢ï¼‰âœ¨
  â””â”€ å°†åŒ¹é…çš„æ ¼å¼æ–‡æ¡£å†…å®¹å¡«å…¥ç›®å½•èŠ‚ç‚¹çš„bodyå­—æ®µ
```

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯ï¼ˆç”¨æˆ·æ“ä½œï¼‰                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. ç”¨æˆ·ç‚¹å‡»ã€Œç”Ÿæˆç›®å½•ã€                                    â”‚
â”‚  2. åç«¯è¿”å›ç›®å½•ç»“æ„ + æ ¼å¼æ–‡æ¡£è‡ªåŠ¨å¡«å……                     â”‚
â”‚  3. å‰ç«¯å±•ç¤ºç›®å½•æ ‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹æ˜¾ç¤º:                           â”‚
â”‚     - èŠ‚ç‚¹æ ‡é¢˜                                              â”‚
â”‚     - æ˜¯å¦å·²å¡«å……æ­£æ–‡ï¼ˆâœ… å›¾æ ‡ï¼‰                            â”‚
â”‚     - æ­£æ–‡é¢„è§ˆï¼ˆå‰100å­—ï¼‰                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åç«¯ï¼ˆæ™ºèƒ½å¤„ç†æµç¨‹ï¼‰                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Step 1: ç”Ÿæˆç›®å½•ç»“æ„ï¼ˆdirectory generationï¼‰              â”‚
â”‚    - è°ƒç”¨ LLM æå–æŠ•æ ‡æ–‡ä»¶ç›®å½•è¦æ±‚                          â”‚
â”‚    - è¾“å‡º: nodes = [                                        â”‚
â”‚        {title: "æŠ•æ ‡å‡½", level: 2, ...},                    â”‚
â”‚        {title: "æ³•äººæˆæƒå§”æ‰˜ä¹¦", level: 2, ...},            â”‚
â”‚        ...                                                  â”‚
â”‚      ]                                                      â”‚
â”‚                                                             â”‚
â”‚  Step 2: æå–æ ¼å¼æ–‡æ¡£ï¼ˆsnippet extractionï¼‰                â”‚
â”‚    - è°ƒç”¨ LLM è¯†åˆ«æ‹›æ ‡ä¹¦ä¸­çš„æ ¼å¼æ–‡æ¡£                        â”‚
â”‚    - è¾“å‡º: snippets = [                                     â”‚
â”‚        {title: "æŠ•æ ‡å‡½", content: "...", type: "BID_LETTER"},â”‚
â”‚        {title: "æ³•äººæˆæƒå§”æ‰˜ä¹¦", content: "...", ...},      â”‚
â”‚        ...                                                  â”‚
â”‚      ]                                                      â”‚
â”‚                                                             â”‚
â”‚  Step 3: æ™ºèƒ½åŒ¹é… âœ¨ æ–°å¢                                   â”‚
â”‚    - å¯¹æ¯ä¸ªç›®å½•èŠ‚ç‚¹:                                        â”‚
â”‚      for node in nodes:                                     â”‚
â”‚        matched_snippet = match_snippet(node, snippets)      â”‚
â”‚        if matched_snippet:                                  â”‚
â”‚          node.body = matched_snippet.content               â”‚
â”‚          node.auto_filled = True                           â”‚
â”‚          node.matched_snippet_id = matched_snippet.id      â”‚
â”‚                                                             â”‚
â”‚  Step 4: ä¿å­˜åˆ°æ•°æ®åº“                                       â”‚
â”‚    - ä¿å­˜ç›®å½•èŠ‚ç‚¹ï¼ˆåŒ…å«bodyï¼‰                               â”‚
â”‚    - è®°å½•åŒ¹é…å…³ç³»                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æŠ€æœ¯æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šåŸºäºè§„åˆ™çš„åŒ¹é…ï¼ˆç®€å•ï¼Œå¿«é€Ÿå®æ–½ï¼‰â­â­â­

**æ ¸å¿ƒæ€æƒ³**: ä½¿ç”¨æ ‡é¢˜ç›¸ä¼¼åº¦ + å…³é”®è¯åŒ¹é…

**åŒ¹é…ç®—æ³•**:

```python
def match_snippet_by_rules(
    node: DirectoryNode,
    snippets: List[Snippet]
) -> Optional[Snippet]:
    """
    åŸºäºè§„åˆ™åŒ¹é…æ ¼å¼æ–‡æ¡£
    
    åŒ¹é…ç­–ç•¥ï¼ˆä¼˜å…ˆçº§é€’å‡ï¼‰:
    1. æ ‡é¢˜å®Œå…¨åŒ¹é…ï¼ˆå»é™¤ç©ºæ ¼ã€æ ‡ç‚¹ï¼‰
    2. æ ‡é¢˜åŒ…å«åŒ¹é…ï¼ˆsnippetæ ‡é¢˜åŒ…å«nodeæ ‡é¢˜ï¼Œæˆ–åä¹‹ï¼‰
    3. å…³é”®è¯åŒ¹é…ï¼ˆé¢„å®šä¹‰çš„åŒä¹‰è¯è¡¨ï¼‰
    4. æ¨¡ç³ŠåŒ¹é…ï¼ˆç¼–è¾‘è·ç¦»ã€ä½™å¼¦ç›¸ä¼¼åº¦ï¼‰
    """
    
    # 1. æ ‡é¢˜å®Œå…¨åŒ¹é…
    node_title_clean = clean_title(node.title)  # "æŠ•æ ‡å‡½" -> "æŠ•æ ‡å‡½"
    for snippet in snippets:
        snippet_title_clean = clean_title(snippet.title)
        if node_title_clean == snippet_title_clean:
            return snippet  # å®Œå…¨åŒ¹é…ï¼Œç½®ä¿¡åº¦100%
    
    # 2. æ ‡é¢˜åŒ…å«åŒ¹é…
    for snippet in snippets:
        if node_title_clean in snippet.title or snippet.title in node_title_clean:
            return snippet  # åŒ…å«åŒ¹é…ï¼Œç½®ä¿¡åº¦90%
    
    # 3. å…³é”®è¯åŒä¹‰è¯åŒ¹é…
    synonyms = {
        "æŠ•æ ‡å‡½": ["æŠ•æ ‡ä¹¦", "æŠ•æ ‡æ–‡ä»¶", "æŠ•æ ‡ç”³è¯·", "æŠ•æ ‡æŠ¥ä»·å‡½"],
        "æˆæƒå§”æ‰˜ä¹¦": ["æ³•äººæˆæƒä¹¦", "æˆæƒä¹¦", "å§”æ‰˜ä¹¦", "æ³•å®šä»£è¡¨äººæˆæƒ"],
        "ä¿è¯é‡‘": ["æŠ•æ ‡ä¿è¯é‡‘", "ä¿è¯é‡‘å‡­è¯", "ä¿å‡½"],
        "æŠ¥ä»·è¡¨": ["æŠ•æ ‡æŠ¥ä»·è¡¨", "æŠ¥ä»·æ¸…å•", "ä»·æ ¼è¡¨", "è´¹ç”¨æ¸…å•"],
        "åç¦»è¡¨": ["æŠ€æœ¯åç¦»è¡¨", "å•†åŠ¡åç¦»è¡¨", "å“åº”åç¦»è¡¨"],
        # ... æ›´å¤šåŒä¹‰è¯
    }
    
    for key, synonyms_list in synonyms.items():
        if key in node_title_clean:
            for snippet in snippets:
                for syn in synonyms_list:
                    if syn in snippet.title:
                        return snippet  # åŒä¹‰è¯åŒ¹é…ï¼Œç½®ä¿¡åº¦80%
    
    # 4. æ¨¡ç³ŠåŒ¹é…ï¼ˆä½¿ç”¨fuzzywuzzyæˆ–difflibï¼‰
    from fuzzywuzzy import fuzz
    best_match = None
    best_score = 0
    
    for snippet in snippets:
        score = fuzz.token_sort_ratio(node_title_clean, snippet.title)
        if score > best_score and score >= 70:  # ç›¸ä¼¼åº¦é˜ˆå€¼70%
            best_score = score
            best_match = snippet
    
    if best_match:
        return best_match  # æ¨¡ç³ŠåŒ¹é…ï¼Œç½®ä¿¡åº¦60-80%
    
    return None  # æœªåŒ¹é…
```

**ä¼˜ç‚¹**:
- âœ… å®ç°ç®€å•ï¼Œå¼€å‘æ—¶é—´çŸ­ï¼ˆ4-6å°æ—¶ï¼‰
- âœ… é€Ÿåº¦å¿«ï¼Œæ— éœ€è°ƒç”¨LLM
- âœ… å¯è§£é‡Šæ€§å¼ºï¼Œç”¨æˆ·èƒ½ç†è§£åŒ¹é…é€»è¾‘
- âœ… å‡†ç¡®ç‡ä¸­ç­‰ï¼ˆé¢„è®¡70-85%ï¼‰

**ç¼ºç‚¹**:
- âŒ éœ€è¦ç»´æŠ¤åŒä¹‰è¯è¡¨
- âŒ å¯¹å¤æ‚ã€éæ ‡å‡†æ ‡é¢˜åŒ¹é…æ•ˆæœå·®
- âŒ æ— æ³•ç†è§£è¯­ä¹‰ï¼ˆå¦‚"æŠ•æ ‡æ‰¿è¯ºå‡½"å’Œ"æ‰¿è¯ºä¹¦"ï¼‰

**é€‚ç”¨åœºæ™¯**: å¿«é€Ÿä¸Šçº¿ï¼Œ80%çš„æ ‡å‡†åŒ–æ‹›æ ‡é¡¹ç›®

---

### æ–¹æ¡ˆBï¼šåŸºäºLLMçš„è¯­ä¹‰åŒ¹é…ï¼ˆæ™ºèƒ½ï¼Œæ¨èï¼‰â­â­â­â­â­

**æ ¸å¿ƒæ€æƒ³**: ä½¿ç”¨å°æ¨¡å‹è¿›è¡Œè¯­ä¹‰ç›¸ä¼¼åº¦åˆ¤æ–­

**åŒ¹é…ç®—æ³•**:

```python
async def match_snippet_by_llm(
    node: DirectoryNode,
    snippets: List[Snippet],
    llm: LLMClient
) -> Optional[Snippet]:
    """
    ä½¿ç”¨LLMè¿›è¡Œè¯­ä¹‰åŒ¹é…
    
    ç­–ç•¥:
    1. æ‰¹é‡è°ƒç”¨LLMï¼Œåˆ¤æ–­æ¯ä¸ªsnippetä¸nodeçš„åŒ¹é…åº¦
    2. è¿”å›åŒ¹é…åº¦æœ€é«˜çš„snippet
    """
    
    # æ„å»ºåŒ¹é…Prompt
    prompt = f"""
ä½ æ˜¯æ‹›æŠ•æ ‡æ–‡æ¡£åŒ¹é…ä¸“å®¶ã€‚è¯·åˆ¤æ–­ä»¥ä¸‹æ ¼å¼æ–‡æ¡£æ˜¯å¦ä¸ç›®å½•èŠ‚ç‚¹åŒ¹é…ã€‚

ç›®å½•èŠ‚ç‚¹:
- æ ‡é¢˜: {node.title}
- å±‚çº§: ç¬¬{node.level}çº§
- è¯´æ˜: {node.notes or "æ— "}

å€™é€‰æ ¼å¼æ–‡æ¡£åˆ—è¡¨:
{format_snippets_for_prompt(snippets)}

è¯·ä¸ºæ¯ä¸ªæ ¼å¼æ–‡æ¡£æ‰“åˆ†ï¼ˆ0-100ï¼‰ï¼Œå¹¶è¿”å›JSON:
{{
  "matches": [
    {{"snippet_id": "snippet_001", "score": 95, "reason": "æ ‡é¢˜å®Œå…¨åŒ¹é…"}},
    {{"snippet_id": "snippet_002", "score": 60, "reason": "éƒ¨åˆ†ç›¸å…³"}},
    ...
  ]
}}

è¯„åˆ†æ ‡å‡†:
- 95-100: å®Œå…¨åŒ¹é…ï¼ˆæ ‡é¢˜ç›¸åŒæˆ–åŒä¹‰ï¼‰
- 80-94: é«˜åº¦ç›¸å…³ï¼ˆå†…å®¹é«˜åº¦å»åˆï¼‰
- 60-79: éƒ¨åˆ†ç›¸å…³ï¼ˆæœ‰ä¸€å®šå…³è”ï¼‰
- 0-59: ä¸ç›¸å…³æˆ–æ— å…³

åªè¿”å›JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚
"""
    
    # è°ƒç”¨LLM
    response = await llm.chat(
        messages=[{"role": "user", "content": prompt}],
        model_id="gpt-4o-mini",  # ä½¿ç”¨å¿«é€Ÿå°æ¨¡å‹
        temperature=0.0,
        max_tokens=1000
    )
    
    # è§£æç»“æœ
    result = parse_json(response)
    matches = result.get("matches", [])
    
    # æ‰¾åˆ°æœ€é«˜åˆ†çš„åŒ¹é…ï¼ˆé˜ˆå€¼80åˆ†ï¼‰
    best_match = max(matches, key=lambda m: m["score"], default=None)
    if best_match and best_match["score"] >= 80:
        snippet_id = best_match["snippet_id"]
        return next((s for s in snippets if s.id == snippet_id), None)
    
    return None
```

**ä¼˜ç‚¹**:
- âœ… å‡†ç¡®ç‡é«˜ï¼ˆé¢„è®¡90-95%ï¼‰
- âœ… ç†è§£è¯­ä¹‰ï¼Œèƒ½å¤„ç†åŒä¹‰è¯ã€è¿‘ä¹‰è¯
- âœ… é€‚åº”æ€§å¼ºï¼Œæ— éœ€ç»´æŠ¤è§„åˆ™
- âœ… èƒ½ç»™å‡ºåŒ¹é…ç†ç”±ï¼Œæ–¹ä¾¿è°ƒè¯•

**ç¼ºç‚¹**:
- âŒ éœ€è¦è°ƒç”¨LLMï¼Œå¢åŠ æˆæœ¬ï¼ˆçº¦$0.001-0.002/èŠ‚ç‚¹ï¼‰
- âŒ é€Ÿåº¦ç•¥æ…¢ï¼ˆæ¯æ‰¹10-20ä¸ªèŠ‚ç‚¹ï¼Œçº¦2-3ç§’ï¼‰
- âŒ å®ç°å¤æ‚åº¦ä¸­ç­‰

**æˆæœ¬åˆ†æ**:
```
å‡è®¾:
- æ¯ä¸ªé¡¹ç›®å¹³å‡30ä¸ªç›®å½•èŠ‚ç‚¹
- æ¯ä¸ªé¡¹ç›®å¹³å‡15ä¸ªæ ¼å¼æ–‡æ¡£
- ä½¿ç”¨GPT-4o-miniæ‰¹é‡åŒ¹é…

æˆæœ¬:
- è¾“å…¥: 30ä¸ªèŠ‚ç‚¹ Ã— (èŠ‚ç‚¹ä¿¡æ¯100 tokens + 15ä¸ªsnippets Ã— 50 tokens) = 30 Ã— 850 = 25,500 tokens
- è¾“å‡º: 30ä¸ªèŠ‚ç‚¹ Ã— 100 tokens = 3,000 tokens
- æ€»è®¡: 28,500 tokens
- æˆæœ¬: 28,500 Ã— $0.15/1M (è¾“å…¥) + 3,000 Ã— $0.6/1M (è¾“å‡º) = $0.0043 + $0.0018 = $0.0061
- çº¦0.6åˆ†é’±/é¡¹ç›® âœ… å¯æ¥å—

é€Ÿåº¦:
- å¯æ‰¹é‡å¤„ç†ï¼Œ30ä¸ªèŠ‚ç‚¹çº¦3-5ç§’
```

**é€‚ç”¨åœºæ™¯**: ä¸­é•¿æœŸæ–¹æ¡ˆï¼Œè¿½æ±‚é«˜å‡†ç¡®ç‡

---

### æ–¹æ¡ˆCï¼šæ··åˆæ–¹æ¡ˆï¼ˆå¹³è¡¡ï¼Œæœ€ä¼˜ï¼‰â­â­â­â­â­

**æ ¸å¿ƒæ€æƒ³**: è§„åˆ™åŒ¹é… + LLMå…œåº•

**åŒ¹é…æµç¨‹**:

```python
async def match_snippet_hybrid(
    node: DirectoryNode,
    snippets: List[Snippet],
    llm: Optional[LLMClient] = None
) -> Optional[Snippet]:
    """
    æ··åˆåŒ¹é…ç­–ç•¥
    
    æµç¨‹:
    1. å…ˆç”¨è§„åˆ™å¿«é€ŸåŒ¹é…ï¼ˆé«˜ç½®ä¿¡åº¦casesï¼‰
    2. è§„åˆ™æ— æ³•åŒ¹é…æ—¶ï¼Œç”¨LLMå…œåº•
    """
    
    # Phase 1: è§„åˆ™åŒ¹é…
    matched, confidence = match_by_rules_with_confidence(node, snippets)
    
    if confidence >= 0.9:  # é«˜ç½®ä¿¡åº¦ï¼Œç›´æ¥è¿”å›
        logger.info(f"Node '{node.title}' matched by rules with confidence {confidence}")
        return matched
    
    # Phase 2: LLMå…œåº•ï¼ˆä»…å¤„ç†ä¸ç¡®å®šçš„casesï¼‰
    if llm:
        logger.info(f"Node '{node.title}' low confidence ({confidence}), using LLM")
        matched_llm = await match_by_llm(node, snippets, llm)
        if matched_llm:
            return matched_llm
    
    # Phase 3: è¿”å›è§„åˆ™åŒ¹é…ç»“æœï¼ˆå¦‚æœæœ‰ï¼‰
    if matched and confidence >= 0.6:
        logger.warning(f"Node '{node.title}' matched by rules with low confidence {confidence}")
        return matched
    
    return None  # æ— åŒ¹é…
```

**ä¼˜ç‚¹**:
- âœ… å…¼å…·é€Ÿåº¦å’Œå‡†ç¡®ç‡
- âœ… æˆæœ¬ä½ï¼ˆåªæœ‰20-30%çš„caseséœ€è¦LLMï¼‰
- âœ… å¯é æ€§é«˜ï¼ˆå¤šé‡ä¿éšœï¼‰

**é¢„æœŸæ•ˆæœ**:
- 70%çš„casesé€šè¿‡è§„åˆ™åŒ¹é…ï¼ˆé«˜ç½®ä¿¡åº¦ï¼‰
- 20%çš„casesé€šè¿‡LLMåŒ¹é…ï¼ˆä¸­ç­‰éš¾åº¦ï¼‰
- 10%çš„casesæ— æ³•åŒ¹é…ï¼ˆéœ€è¦äººå·¥ç¡®è®¤ï¼‰

**æˆæœ¬**: çº¦$0.002/é¡¹ç›®ï¼ˆæ¯”çº¯LLMæ–¹æ¡ˆé™ä½70%ï¼‰

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### æ–°å¢å­—æ®µ

```sql
-- directory_nodes è¡¨å¢åŠ å­—æ®µ
ALTER TABLE directory_nodes ADD COLUMN IF NOT EXISTS body TEXT;
ALTER TABLE directory_nodes ADD COLUMN IF NOT EXISTS auto_filled BOOLEAN DEFAULT FALSE;
ALTER TABLE directory_nodes ADD COLUMN IF NOT EXISTS matched_snippet_id TEXT;
ALTER TABLE directory_nodes ADD COLUMN IF NOT EXISTS match_confidence FLOAT;
ALTER TABLE directory_nodes ADD COLUMN IF NOT EXISTS match_method VARCHAR(50);  -- 'rules', 'llm', 'manual'

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX IF NOT EXISTS idx_directory_nodes_auto_filled 
  ON directory_nodes(project_id, auto_filled);
```

### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `body` | TEXT | èŠ‚ç‚¹æ­£æ–‡å†…å®¹ï¼ˆæ ¼å¼æ–‡æ¡£å†…å®¹ï¼‰ | "æŠ•æ ‡å‡½æ ¼å¼ï¼š\n\nè‡´ï¼šXXæ‹›æ ‡ä»£ç†..." |
| `auto_filled` | BOOLEAN | æ˜¯å¦è‡ªåŠ¨å¡«å…… | true/false |
| `matched_snippet_id` | TEXT | åŒ¹é…çš„æ ¼å¼æ–‡æ¡£ID | "snippet_abc123" |
| `match_confidence` | FLOAT | åŒ¹é…ç½®ä¿¡åº¦ï¼ˆ0-1ï¼‰ | 0.95 |
| `match_method` | VARCHAR | åŒ¹é…æ–¹æ³• | "rules", "llm", "manual" |

---

## ğŸš€ å®æ–½æ­¥éª¤

### Phase 1: æ ¸å¿ƒåŠŸèƒ½å¼€å‘ï¼ˆ1-2å¤©ï¼‰

#### 1.1 æ•°æ®åº“è¿ç§»
```bash
# æ·»åŠ æ–°å­—æ®µ
alembic revision -m "add_directory_body_fields"
alembic upgrade head
```

#### 1.2 å®ç°åŒ¹é…æœåŠ¡
```python
# backend/app/services/directory_body_matcher.py
class DirectoryBodyMatcher:
    """ç›®å½•èŠ‚ç‚¹ä¸æ ¼å¼æ–‡æ¡£åŒ¹é…æœåŠ¡"""
    
    async def match_and_fill(
        self,
        project_id: str,
        nodes: List[DirectoryNode],
        use_llm: bool = True
    ) -> List[DirectoryNode]:
        """
        åŒ¹é…å¹¶å¡«å……ç›®å½•èŠ‚ç‚¹
        
        Returns:
            å¡«å……åçš„èŠ‚ç‚¹åˆ—è¡¨
        """
        # 1. è·å–é¡¹ç›®çš„æ‰€æœ‰æ ¼å¼æ–‡æ¡£
        snippets = await self._get_project_snippets(project_id)
        
        if not snippets:
            logger.warning(f"No snippets found for project {project_id}")
            return nodes
        
        # 2. å¯¹æ¯ä¸ªèŠ‚ç‚¹è¿›è¡ŒåŒ¹é…
        filled_nodes = []
        for node in nodes:
            matched = await self.match_snippet_hybrid(node, snippets, use_llm)
            
            if matched:
                node.body = matched.content
                node.auto_filled = True
                node.matched_snippet_id = matched.id
                node.match_confidence = matched.confidence
                node.match_method = matched.method
                logger.info(f"Node '{node.title}' matched with snippet '{matched.title}'")
            
            filled_nodes.append(node)
        
        return filled_nodes
```

#### 1.3 é›†æˆåˆ°ç›®å½•ç”Ÿæˆæµç¨‹
```python
# backend/app/services/tender_service.py

def generate_directory(self, project_id: str, model_id: str, run_id: str):
    # ... ç°æœ‰ä»£ç  ...
    
    # 6. ä¿å­˜ï¼ˆä½¿ç”¨replace_directoryï¼‰
    self.dao.replace_directory(project_id, nodes_with_tree)
    
    # âœ¨ 7. æ–°å¢ï¼šåŒ¹é…å¹¶å¡«å……æ ¼å¼æ–‡æ¡£
    from app.services.directory_body_matcher import DirectoryBodyMatcher
    matcher = DirectoryBodyMatcher(self.pool, self.llm)
    
    filled_nodes = run_async(matcher.match_and_fill(
        project_id=project_id,
        nodes=nodes_with_tree,
        use_llm=True  # ä½¿ç”¨æ··åˆåŒ¹é…
    ))
    
    # 8. æ›´æ–°èŠ‚ç‚¹ï¼ˆä¿å­˜bodyï¼‰
    self.dao.update_directory_nodes_body(project_id, filled_nodes)
    
    logger.info(f"[generate_directory] Matched {sum(1 for n in filled_nodes if n.auto_filled)}/{len(filled_nodes)} nodes")
```

---

### Phase 2: å‰ç«¯å±•ç¤ºä¼˜åŒ–ï¼ˆ0.5-1å¤©ï¼‰

#### 2.1 ç›®å½•æ ‘å±•ç¤ºå¢å¼º

```typescript
// frontend/src/components/tender/DirectoryTree.tsx

export type DirectoryNode = {
  id: string;
  title: string;
  level: number;
  required: boolean;
  // âœ¨ æ–°å¢å­—æ®µ
  body?: string;              // æ­£æ–‡å†…å®¹
  auto_filled?: boolean;      // æ˜¯å¦è‡ªåŠ¨å¡«å……
  match_confidence?: number;  // åŒ¹é…ç½®ä¿¡åº¦
};

function DirectoryNodeItem({ node }: { node: DirectoryNode }) {
  return (
    <div className="directory-node">
      <div className="node-title">
        {node.title}
        
        {/* âœ¨ æ˜¾ç¤ºè‡ªåŠ¨å¡«å……æ ‡è¯† */}
        {node.auto_filled && (
          <span className="auto-fill-badge" title={`è‡ªåŠ¨å¡«å…… (ç½®ä¿¡åº¦: ${(node.match_confidence * 100).toFixed(0)}%)`}>
            âœ… å·²å¡«å……
          </span>
        )}
      </div>
      
      {/* âœ¨ æ˜¾ç¤ºæ­£æ–‡é¢„è§ˆ */}
      {node.body && (
        <div className="node-body-preview">
          {node.body.substring(0, 100)}...
        </div>
      )}
    </div>
  );
}
```

#### 2.2 æ­£æ–‡ç¼–è¾‘åŠŸèƒ½

```typescript
function DirectoryBodyEditor({ node, onSave }: Props) {
  const [body, setBody] = useState(node.body || '');
  const [isEditing, setIsEditing] = useState(false);
  
  const handleSave = async () => {
    await api.put(`/api/apps/tender/projects/${projectId}/directory/nodes/${node.id}/body`, {
      body: body
    });
    onSave(body);
    setIsEditing(false);
  };
  
  return (
    <div className="directory-body-editor">
      {node.auto_filled && (
        <div className="auto-fill-info">
          <Icon name="check-circle" />
          <span>æ­¤å†…å®¹ç”±ç³»ç»Ÿè‡ªåŠ¨å¡«å……</span>
          {node.match_confidence && (
            <span className="confidence">
              (ç½®ä¿¡åº¦: {(node.match_confidence * 100).toFixed(0)}%)
            </span>
          )}
        </div>
      )}
      
      {isEditing ? (
        <>
          <textarea
            value={body}
            onChange={(e) => setBody(e.target.value)}
            rows={20}
          />
          <button onClick={handleSave}>ä¿å­˜</button>
          <button onClick={() => setIsEditing(false)}>å–æ¶ˆ</button>
        </>
      ) : (
        <>
          <div className="body-content">{body || 'æš‚æ— å†…å®¹'}</div>
          <button onClick={() => setIsEditing(true)}>ç¼–è¾‘</button>
        </>
      )}
    </div>
  );
}
```

---

### Phase 3: ä¼˜åŒ–ä¸æ‰©å±•ï¼ˆ1-2å¤©ï¼‰

#### 3.1 æ‰¹é‡é‡æ–°åŒ¹é…

```python
@router.post("/projects/{project_id}/directory/rematch")
async def rematch_directory_bodies(
    project_id: str,
    request: RematchRequest,
    user=Depends(get_current_user_sync)
):
    """
    é‡æ–°åŒ¹é…ç›®å½•èŠ‚ç‚¹ä¸æ ¼å¼æ–‡æ¡£
    
    é€‚ç”¨åœºæ™¯:
    - æ ¼å¼æ–‡æ¡£æ›´æ–°å
    - åŒ¹é…æ•ˆæœä¸ç†æƒ³
    - ç”¨æˆ·æ‰‹åŠ¨è§¦å‘
    """
    from app.services.directory_body_matcher import DirectoryBodyMatcher
    
    # è·å–ç°æœ‰èŠ‚ç‚¹
    nodes = tender_dao.get_directory_nodes(project_id)
    
    # é‡æ–°åŒ¹é…
    matcher = DirectoryBodyMatcher(pool, llm)
    filled_nodes = await matcher.match_and_fill(
        project_id=project_id,
        nodes=nodes,
        use_llm=request.use_llm
    )
    
    # æ›´æ–°æ•°æ®åº“
    tender_dao.update_directory_nodes_body(project_id, filled_nodes)
    
    return {
        "status": "success",
        "matched": sum(1 for n in filled_nodes if n.auto_filled),
        "total": len(filled_nodes)
    }
```

#### 3.2 åŒ¹é…è´¨é‡æŠ¥å‘Š

```python
def generate_match_report(project_id: str) -> Dict[str, Any]:
    """
    ç”ŸæˆåŒ¹é…è´¨é‡æŠ¥å‘Š
    
    Returns:
        {
            "total_nodes": 30,
            "auto_filled": 25,
            "manual_filled": 2,
            "not_filled": 3,
            "avg_confidence": 0.92,
            "match_methods": {
                "rules": 18,
                "llm": 7,
                "manual": 2
            },
            "low_confidence_nodes": [
                {"title": "å…¶ä»–æ–‡ä»¶", "confidence": 0.65}
            ]
        }
    """
    pass
```

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### æ•ˆç‡æå‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **ç›®å½•èŠ‚ç‚¹å¡«å……æ—¶é—´** | 30ä¸ªèŠ‚ç‚¹ Ã— 2åˆ†é’Ÿ = 60åˆ†é’Ÿ | è‡ªåŠ¨å¡«å…… < 10ç§’ | â¬† 99% |
| **åŒ¹é…å‡†ç¡®ç‡** | äººå·¥åŒ¹é… 95% | è‡ªåŠ¨åŒ¹é… 90% | - |
| **ç”¨æˆ·æ“ä½œæ­¥éª¤** | 30æ¬¡ï¼ˆæ¯èŠ‚ç‚¹1æ¬¡ï¼‰ | 1æ¬¡ï¼ˆç‚¹å‡»ç”Ÿæˆï¼‰ | â¬‡ 97% |
| **æ ¼å¼æ–‡æ¡£åˆ©ç”¨ç‡** | 60%ï¼ˆéƒ¨åˆ†é—æ¼ï¼‰ | 95%ï¼ˆå…¨é¢è¦†ç›–ï¼‰ | â¬† 58% |

### ç”¨æˆ·ä½“éªŒ

**ä¼˜åŒ–å‰æµç¨‹**:
```
1. ç‚¹å‡»"ç”Ÿæˆç›®å½•" â†’ ç­‰å¾…30ç§’
2. æ‰‹åŠ¨æŸ¥æ‰¾æ ¼å¼æ–‡æ¡£ç« èŠ‚ â†’ 5-10åˆ†é’Ÿ
3. é€ä¸ªå¤åˆ¶ç²˜è´´ â†’ æ¯ä¸ª2åˆ†é’Ÿ Ã— 30ä¸ª = 60åˆ†é’Ÿ
4. æ£€æŸ¥æ˜¯å¦æœ‰é—æ¼ â†’ 10åˆ†é’Ÿ

æ€»è®¡: çº¦75-85åˆ†é’Ÿ âŒ
```

**ä¼˜åŒ–åæµç¨‹**:
```
1. ç‚¹å‡»"ç”Ÿæˆç›®å½•" â†’ ç­‰å¾…30ç§’
2. ç³»ç»Ÿè‡ªåŠ¨åŒ¹é…å¡«å…… â†’ 5ç§’
3. ç”¨æˆ·æ£€æŸ¥å’Œå¾®è°ƒï¼ˆå¯é€‰ï¼‰ â†’ 10åˆ†é’Ÿ

æ€»è®¡: çº¦10-15åˆ†é’Ÿ âœ…
```

**èŠ‚çœæ—¶é—´**: çº¦60-75åˆ†é’Ÿ/é¡¹ç›®

---

## ğŸ’° æˆæœ¬åˆ†æ

### å¼€å‘æˆæœ¬

| é˜¶æ®µ | å·¥ä½œé‡ | è¯´æ˜ |
|------|--------|------|
| **Phase 1: æ ¸å¿ƒåŠŸèƒ½** | 1-2å¤© | åŒ¹é…ç®—æ³• + æ•°æ®åº“ + API |
| **Phase 2: å‰ç«¯å±•ç¤º** | 0.5-1å¤© | ç›®å½•æ ‘å¢å¼º + ç¼–è¾‘å™¨ |
| **Phase 3: ä¼˜åŒ–æ‰©å±•** | 1-2å¤© | é‡æ–°åŒ¹é… + è´¨é‡æŠ¥å‘Š |
| **æ€»è®¡** | 2.5-5å¤© | å«æµ‹è¯•å’Œè°ƒè¯• |

### è¿è¡Œæˆæœ¬

**æ–¹æ¡ˆAï¼ˆçº¯è§„åˆ™ï¼‰**: $0/é¡¹ç›®  
**æ–¹æ¡ˆBï¼ˆçº¯LLMï¼‰**: $0.006/é¡¹ç›®  
**æ–¹æ¡ˆCï¼ˆæ··åˆï¼Œæ¨èï¼‰**: $0.002/é¡¹ç›® âœ…

å‡è®¾æ¯æœˆå¤„ç†100ä¸ªé¡¹ç›®ï¼š
- æœˆæˆæœ¬ï¼š$0.002 Ã— 100 = $0.2
- å¹´æˆæœ¬ï¼š$2.4

**æˆæœ¬æ”¶ç›Šæ¯”**:
- æ¯é¡¹ç›®èŠ‚çœ60-75åˆ†é’ŸäººåŠ›æ—¶é—´
- å‡è®¾äººåŠ›æˆæœ¬50å…ƒ/å°æ—¶
- æ¯é¡¹ç›®èŠ‚çœï¼š50å…ƒ Ã— 1.2å°æ—¶ = 60å…ƒ
- æœˆæ”¶ç›Šï¼š60å…ƒ Ã— 100 = 6000å…ƒ
- **ROI: 30000å€** âœ…

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### åŠŸèƒ½æµ‹è¯•

1. **æ ‡å‡†åŒ–é¡¹ç›®æµ‹è¯•**
   - ä½¿ç”¨å…¸å‹çš„æ”¿åºœé‡‡è´­æ‹›æ ‡æ–‡ä»¶
   - éªŒè¯åŒ¹é…å‡†ç¡®ç‡ â‰¥ 90%

2. **éæ ‡é¡¹ç›®æµ‹è¯•**
   - ä½¿ç”¨æ ¼å¼ä¸è§„èŒƒçš„æ‹›æ ‡æ–‡ä»¶
   - éªŒè¯ç³»ç»Ÿçš„å®¹é”™èƒ½åŠ›

3. **è¾¹ç•Œæµ‹è¯•**
   - æ— æ ¼å¼æ–‡æ¡£çš„é¡¹ç›®
   - æ ¼å¼æ–‡æ¡£å¾ˆå¤šï¼ˆ50+ï¼‰çš„é¡¹ç›®
   - ç›®å½•èŠ‚ç‚¹å¾ˆå¤šï¼ˆ100+ï¼‰çš„é¡¹ç›®

### æ€§èƒ½æµ‹è¯•

```
æµ‹è¯•åœºæ™¯:
- 30ä¸ªç›®å½•èŠ‚ç‚¹ + 15ä¸ªæ ¼å¼æ–‡æ¡£
- æ··åˆåŒ¹é…ç­–ç•¥

é¢„æœŸæ€§èƒ½:
- æ€»è€—æ—¶ < 10ç§’
- å†…å­˜å ç”¨ < 100MB
- æ•°æ®åº“æŸ¥è¯¢ < 10æ¬¡
```

---

## ğŸ”® æœªæ¥æ‰©å±•

### æ‰©å±•1: æ™ºèƒ½å†…å®¹ç”Ÿæˆ

å½“æ ¼å¼æ–‡æ¡£æœªæä¾›æ—¶ï¼Œæ ¹æ®èŠ‚ç‚¹æ ‡é¢˜è‡ªåŠ¨ç”Ÿæˆæ¨¡æ¿å†…å®¹ï¼š

```python
async def generate_template_content(node: DirectoryNode) -> str:
    """
    åŸºäºèŠ‚ç‚¹æ ‡é¢˜ç”Ÿæˆæ¨¡æ¿å†…å®¹
    
    ç¤ºä¾‹:
    - èŠ‚ç‚¹: "æŠ•æ ‡å‡½"
    - ç”Ÿæˆ: æ ‡å‡†æŠ•æ ‡å‡½æ¨¡æ¿ï¼ˆåŒ…å«å¸¸è§å­—æ®µå ä½ç¬¦ï¼‰
    """
    prompt = f"""
è¯·ç”Ÿæˆã€Œ{node.title}ã€çš„æ ‡å‡†æ ¼å¼æ¨¡æ¿ã€‚

è¦æ±‚:
1. ç¬¦åˆæ‹›æŠ•æ ‡è§„èŒƒ
2. åŒ…å«å¿…è¦çš„å­—æ®µå ä½ç¬¦
3. æ ¼å¼è§„èŒƒï¼Œæ˜“äºå¡«å†™

åªè¿”å›æ¨¡æ¿å†…å®¹ï¼Œä¸è¦å…¶ä»–è¯´æ˜ã€‚
"""
    
    content = await llm.chat(...)
    return content
```

### æ‰©å±•2: å¤šç‰ˆæœ¬ç®¡ç†

æ”¯æŒä¿å­˜å¤šä¸ªç‰ˆæœ¬çš„æ­£æ–‡å†…å®¹ï¼š

```sql
CREATE TABLE directory_node_body_versions (
  id TEXT PRIMARY KEY,
  node_id TEXT NOT NULL,
  version INT NOT NULL,
  body TEXT,
  source VARCHAR(50),  -- 'auto', 'manual', 'generated'
  created_at TIMESTAMP,
  created_by TEXT
);
```

### æ‰©å±•3: ååŒç¼–è¾‘

æ”¯æŒå¤šäººåŒæ—¶ç¼–è¾‘ç›®å½•æ­£æ–‡ï¼Œå®æ—¶åŒæ­¥ï¼š

```typescript
// ä½¿ç”¨ WebSocket æˆ– Yjs å®ç°
const { provider, doc } = useCollaboration(nodeId);
```

---

## âœ… æ¨èæ–¹æ¡ˆ

**å»ºè®®é‡‡ç”¨ã€Œæ–¹æ¡ˆCï¼šæ··åˆæ–¹æ¡ˆã€**

**ç†ç”±**:
1. âœ… å‡†ç¡®ç‡é«˜ï¼ˆ90%+ï¼‰
2. âœ… æˆæœ¬ä½ï¼ˆ$0.002/é¡¹ç›®ï¼‰
3. âœ… é€Ÿåº¦å¿«ï¼ˆ< 10ç§’ï¼‰
4. âœ… å¯é æ€§å¥½ï¼ˆè§„åˆ™ + LLMåŒä¿é™©ï¼‰
5. âœ… æ˜“äºç»´æŠ¤ï¼ˆè§„åˆ™è¦†ç›–å¸¸è§casesï¼ŒLLMå¤„ç†è¾¹ç¼˜casesï¼‰

**å®æ–½ä¼˜å…ˆçº§**:
1. **P0 (å¿…é¡»)**: Phase 1 - æ ¸å¿ƒåŒ¹é…åŠŸèƒ½
2. **P1 (é‡è¦)**: Phase 2 - å‰ç«¯å±•ç¤º
3. **P2 (å¯é€‰)**: Phase 3 - ä¼˜åŒ–æ‰©å±•

**é¢„æœŸé‡Œç¨‹ç¢‘**:
- Week 1: å®ŒæˆPhase 1ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
- Week 2: å®ŒæˆPhase 2ï¼ˆå‰ç«¯å±•ç¤ºï¼‰+ æµ‹è¯•
- Week 3: å®ŒæˆPhase 3ï¼ˆä¼˜åŒ–æ‰©å±•ï¼‰+ ä¸Šçº¿

---

**æ–¹æ¡ˆåˆ¶å®šæ—¶é—´**: 2025-12-25  
**é¢„è®¡å¼€å‘æ—¶é—´**: 2.5-5å¤©  
**é¢„æœŸæ•ˆæœ**: èŠ‚çœ60-75åˆ†é’Ÿ/é¡¹ç›®ï¼Œå‡†ç¡®ç‡90%+
