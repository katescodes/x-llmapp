# æ‹›æŠ•æ ‡ä¸šåŠ¡æµç¨‹è¯¦è§£

**ç”Ÿæˆæ—¥æœŸ**: 2025-12-20  
**ç³»ç»Ÿç‰ˆæœ¬**: 0.2.0  
**æµç¨‹ç‰ˆæœ¬**: V2 (NEW_ONLY æ¨¡å¼)

---

## ğŸ“‹ ç›®å½•

1. [ä¸šåŠ¡æ¦‚è§ˆ](#ä¸šåŠ¡æ¦‚è§ˆ)
2. [å®Œæ•´æµç¨‹å›¾](#å®Œæ•´æµç¨‹å›¾)
3. [Step 0: åˆ›å»ºé¡¹ç›®](#step-0-åˆ›å»ºé¡¹ç›®)
4. [Step 1: ä¸Šä¼ æ‹›æ ‡æ–‡ä»¶](#step-1-ä¸Šä¼ æ‹›æ ‡æ–‡ä»¶)
5. [Step 2: æå–é¡¹ç›®ä¿¡æ¯](#step-2-æå–é¡¹ç›®ä¿¡æ¯)
6. [Step 3: è¯†åˆ«é£é™©](#step-3-è¯†åˆ«é£é™©)
7. [Step 4: ç”Ÿæˆç›®å½•](#step-4-ç”Ÿæˆç›®å½•)
8. [Step 5: ä¸Šä¼ æŠ•æ ‡æ–‡ä»¶](#step-5-ä¸Šä¼ æŠ•æ ‡æ–‡ä»¶)
9. [Step 6: è¿è¡Œå®¡æŸ¥](#step-6-è¿è¡Œå®¡æŸ¥)
10. [Step 7: å¯¼å‡ºæ–‡æ¡£](#step-7-å¯¼å‡ºæ–‡æ¡£)
11. [æ•°æ®æµè½¬](#æ•°æ®æµè½¬)
12. [å‰åç«¯äº¤äº’](#å‰åç«¯äº¤äº’)

---

## ä¸šåŠ¡æ¦‚è§ˆ

### æ ¸å¿ƒåœºæ™¯

äº¿æ—äº¿é—®æ‹›æŠ•æ ‡ç³»ç»Ÿå¸®åŠ©ç”¨æˆ·å¤„ç†æ‹›æŠ•æ ‡æ–‡ä»¶,ä¸»è¦è§£å†³ä»¥ä¸‹ç—›ç‚¹:

1. **ä¿¡æ¯æå–éš¾**: ä»åšé‡çš„æ‹›æ ‡æ–‡ä»¶ä¸­å¿«é€Ÿæå–å…³é”®ä¿¡æ¯
2. **é£é™©é—æ¼**: è‡ªåŠ¨è¯†åˆ«æ‹›æ ‡æ–‡ä»¶ä¸­çš„é£é™©ç‚¹å’Œé—®é¢˜
3. **å“åº”ä½æ•ˆ**: å¿«é€Ÿç”Ÿæˆæ ‡ä¹¦å“åº”ç›®å½•ç»“æ„
4. **å®¡æŸ¥è€—æ—¶**: è‡ªåŠ¨å®¡æŸ¥æ ‡ä¹¦çš„åˆè§„æ€§å’Œå®Œæ•´æ€§
5. **æ ¼å¼ä¸è§„èŒƒ**: è‡ªåŠ¨ç”Ÿæˆæ ¼å¼è§„èŒƒçš„ Word æ–‡æ¡£

### å…¸å‹ç”¨æˆ·è§’è‰²

- **æŠ•æ ‡äººå‘˜**: å‚ä¸æŠ•æ ‡çš„ä¼ä¸šäººå‘˜
- **åˆè§„å®¡æŸ¥å‘˜**: è´Ÿè´£å®¡æŸ¥æ ‡ä¹¦åˆè§„æ€§çš„äººå‘˜
- **é¡¹ç›®ç»ç†**: è´Ÿè´£æ•´ä½“æŠŠæ§æŠ•æ ‡é¡¹ç›®çš„ç®¡ç†è€…

### ä¸šåŠ¡ä»·å€¼

- â±ï¸ **èŠ‚çœæ—¶é—´**: è‡ªåŠ¨åŒ–å¤„ç†å‡å°‘80%çš„äººå·¥å·¥ä½œé‡
- ğŸ¯ **æé«˜å‡†ç¡®æ€§**: AIè¯†åˆ«å‡å°‘é—æ¼å’Œé”™è¯¯
- ğŸ“Š **å¯è¿½æº¯**: æ‰€æœ‰ç»“æœéƒ½æœ‰è¯æ®é“¾,å¯å®¡è®¡
- ğŸš€ **æå‡æ•ˆç‡**: ä»å‡ å¤©ç¼©çŸ­åˆ°å‡ å°æ—¶

---

## å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ‹›æŠ•æ ‡ä¸šåŠ¡å®Œæ•´æµç¨‹                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 0: åˆ›å»ºé¡¹ç›®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·åˆ›å»ºé¡¹ç›®                        â”‚
â”‚  â”œâ”€ è¾“å…¥é¡¹ç›®åç§°                    â”‚
â”‚  â”œâ”€ è¾“å…¥é¡¹ç›®æè¿°(å¯é€‰)              â”‚
â”‚  â””â”€ ç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºå…³è”çŸ¥è¯†åº“          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
Step 1: ä¸Šä¼ æ‹›æ ‡æ–‡ä»¶
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ä¸Šä¼ æ‹›æ ‡æ–‡ä»¶ (PDF/DOCX)        â”‚
â”‚  â”œâ”€ ç³»ç»Ÿå­˜å‚¨æ–‡ä»¶                    â”‚
â”‚  â”œâ”€ æ–‡æ¡£è§£æ (PyMuPDF/python-docx)  â”‚
â”‚  â”œâ”€ æ–‡æœ¬åˆ†å— (Chunking)             â”‚
â”‚  â”œâ”€ å‘é‡åŒ– (Embedding)              â”‚
â”‚  â””â”€ å­˜å‚¨åˆ° doc_segments + pgvector  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
Step 2: æå–é¡¹ç›®ä¿¡æ¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç³»ç»Ÿè‡ªåŠ¨æå–é¡¹ç›®åŸºæœ¬ä¿¡æ¯            â”‚
â”‚  â”œâ”€ åŸºæœ¬ä¿¡æ¯ (é¡¹ç›®åç§°ã€é¢„ç®—ç­‰)     â”‚
â”‚  â”œâ”€ æŠ€æœ¯å‚æ•° (åŠŸèƒ½è¦æ±‚ã€æ€§èƒ½æŒ‡æ ‡)   â”‚
â”‚  â”œâ”€ å•†åŠ¡æ¡æ¬¾ (ä»˜æ¬¾ã€éªŒæ”¶ã€è´¨ä¿)     â”‚
â”‚  â””â”€ è¯„åˆ†æ ‡å‡† (è¯„æ ‡åŠæ³•ã€è¯„åˆ†ç»†åˆ™)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
Step 3: è¯†åˆ«é£é™©
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«é£é™©ç‚¹                  â”‚
â”‚  â”œâ”€ æŠ€æœ¯é£é™© (å‚æ•°è¿‡é«˜ã€æ—¶é—´ç´§)     â”‚
â”‚  â”œâ”€ å•†åŠ¡é£é™© (ä»˜æ¬¾ä¸åˆ©ã€è¿çº¦é‡)     â”‚
â”‚  â”œâ”€ åˆè§„é£é™© (èµ„è´¨è¦æ±‚ã€å¼ºåˆ¶æ¡æ¬¾)   â”‚
â”‚  â””â”€ å…¶ä»–é£é™© (æ‹›æ ‡ç‘•ç–µã€æ­§è§†æ€§)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
Step 4: ç”Ÿæˆç›®å½•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆå“åº”æ–‡ä»¶ç›®å½•            â”‚
â”‚  â”œâ”€ è§£ææ‹›æ ‡æ–‡ä»¶è¦æ±‚çš„ç›®å½•ç»“æ„      â”‚
â”‚  â”œâ”€ è¯†åˆ«å¿…å¡«é¡¹å’Œé€‰å¡«é¡¹              â”‚
â”‚  â”œâ”€ ç”Ÿæˆå±‚çº§åŒ–çš„ç›®å½•æ ‘              â”‚
â”‚  â””â”€ ç”¨æˆ·å¯æ‰‹åŠ¨è°ƒæ•´ç›®å½•              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
Step 4.1: è‡ªåŠ¨å¡«å……æ ·ä¾‹ (å¯é€‰)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»æ‹›æ ‡æ–‡ä»¶ä¸­æå–æ ¼å¼èŒƒæœ¬            â”‚
â”‚  â”œâ”€ è¯†åˆ«è¡¨æ ¼ã€æ®µè½ç­‰æ ¼å¼            â”‚
â”‚  â”œâ”€ æå–ä¸ºå¯å¤ç”¨çš„æ¨¡æ¿              â”‚
â”‚  â””â”€ å¡«å……åˆ°ç›®å½•èŠ‚ç‚¹                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
Step 5: ä¸Šä¼ æŠ•æ ‡æ–‡ä»¶
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ä¸Šä¼ æŠ•æ ‡æ–‡ä»¶ (DOCX)            â”‚
â”‚  â”œâ”€ æŒ‡å®šæŠ•æ ‡äººåç§°                  â”‚
â”‚  â”œâ”€ ç³»ç»Ÿå­˜å‚¨æ–‡ä»¶                    â”‚
â”‚  â”œâ”€ æ–‡æ¡£è§£æå’Œåˆ†å—                  â”‚
â”‚  â”œâ”€ å‘é‡åŒ–                          â”‚
â”‚  â””â”€ å­˜å‚¨åˆ°æ•°æ®åº“                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
Step 6: è¿è¡Œå®¡æŸ¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç³»ç»Ÿå®¡æŸ¥æŠ•æ ‡æ–‡ä»¶çš„åˆè§„æ€§            â”‚
â”‚  â”œâ”€ å¯¹æ¯”å®¡æŸ¥ (æ‹›æ ‡è¦æ±‚ vs æŠ•æ ‡å“åº”) â”‚
â”‚  â”œâ”€ è§„åˆ™å®¡æŸ¥ (æ‰§è¡Œç¡®å®šæ€§è§„åˆ™)       â”‚
â”‚  â”œâ”€ ç”Ÿæˆå®¡æŸ¥ç»“æœåˆ—è¡¨                â”‚
â”‚  â””â”€ æ ‡æ³¨ pass/risk/fail             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
Step 7: å¯¼å‡ºæ–‡æ¡£
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¯¼å‡ºä¸ºæ ¼å¼åŒ–çš„ Word æ–‡æ¡£            â”‚
â”‚  â”œâ”€ åº”ç”¨æ¨¡æ¿æ ·å¼                    â”‚
â”‚  â”œâ”€ ç”Ÿæˆç›®å½•                        â”‚
â”‚  â”œâ”€ å¡«å……å†…å®¹                        â”‚
â”‚  â””â”€ ä¸‹è½½ DOCX æ–‡ä»¶                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Step 0: åˆ›å»ºé¡¹ç›®

### ä¸šåŠ¡ç›®æ ‡

ä¸ºæ‹›æŠ•æ ‡å·¥ä½œåˆ›å»ºä¸€ä¸ªé¡¹ç›®å®¹å™¨,ç”¨äºç»„ç»‡æ‰€æœ‰ç›¸å…³æ–‡ä»¶å’Œæ•°æ®ã€‚

### å‰ç«¯æ“ä½œ

```typescript
// frontend/src/components/TenderWorkspace.tsx

// 1. ç”¨æˆ·ç‚¹å‡»"æ–°å»ºé¡¹ç›®"æŒ‰é’®
const handleCreateProject = async () => {
  const name = prompt('è¯·è¾“å…¥é¡¹ç›®åç§°');
  if (!name) return;
  
  // 2. è°ƒç”¨ API åˆ›å»ºé¡¹ç›®
  const project = await api.post('/api/apps/tender/projects', {
    name: name,
    description: ''
  });
  
  // 3. æ›´æ–°é¡¹ç›®åˆ—è¡¨
  setProjects([...projects, project]);
  setCurrentProject(project);
};
```

### API æ¥å£

```http
POST /api/apps/tender/projects
Content-Type: application/json

Request:
{
  "name": "XXåŒ»é™¢ä¿¡æ¯åŒ–å»ºè®¾é¡¹ç›®",
  "description": "2025å¹´ä¿¡æ¯åŒ–å»ºè®¾é‡‡è´­é¡¹ç›®"
}

Response:
{
  "id": "tp_1234567890",
  "name": "XXåŒ»é™¢ä¿¡æ¯åŒ–å»ºè®¾é¡¹ç›®",
  "description": "2025å¹´ä¿¡æ¯åŒ–å»ºè®¾é‡‡è´­é¡¹ç›®",
  "kb_id": "kb_9876543210",
  "owner_id": "user_123",
  "status": "draft",
  "created_at": "2025-12-20T10:00:00Z",
  "updated_at": "2025-12-20T10:00:00Z"
}
```

### åç«¯å¤„ç†æµç¨‹

```python
# backend/app/routers/tender.py

@router.post("/projects", response_model=ProjectOut)
def create_project(req: ProjectCreateReq, request: Request, user=Depends(get_current_user_sync)):
    """
    åˆ›å»ºé¡¹ç›®æµç¨‹:
    1. å…ˆåˆ›å»ºçŸ¥è¯†åº“ (KB)
    2. åˆ›å»ºé¡¹ç›®å¹¶å…³è” KB
    3. è¿”å›é¡¹ç›®ä¿¡æ¯
    """
    
    # 1. åˆ›å»ºçŸ¥è¯†åº“
    kb_id = kb_service.create_kb(
        name=f"æ‹›æŠ•æ ‡-{req.name}",
        description=req.description or f"æ‹›æŠ•æ ‡é¡¹ç›®ï¼š{req.name}",
        category_id="cat_knowledge"
    )
    
    # 2. åˆ›å»ºé¡¹ç›®è®°å½•
    dao = TenderDAO(_get_pool(request))
    project = dao.create_project(
        kb_id=kb_id,
        name=req.name,
        description=req.description,
        owner_id=user.user_id
    )
    
    return project
```

### æ•°æ®åº“å˜æ›´

```sql
-- 1. æ’å…¥çŸ¥è¯†åº“åˆ†ç±»
INSERT INTO kb_categories (id, name, description, created_at)
VALUES ('kb_9876543210', 'æ‹›æŠ•æ ‡-XXåŒ»é™¢ä¿¡æ¯åŒ–å»ºè®¾é¡¹ç›®', 'æ‹›æŠ•æ ‡é¡¹ç›®ï¼šXXåŒ»é™¢ä¿¡æ¯åŒ–å»ºè®¾é¡¹ç›®', NOW());

-- 2. æ’å…¥é¡¹ç›®è®°å½•
INSERT INTO tender_projects (id, name, description, kb_id, owner_id, status, created_at, updated_at)
VALUES ('tp_1234567890', 'XXåŒ»é™¢ä¿¡æ¯åŒ–å»ºè®¾é¡¹ç›®', '2025å¹´ä¿¡æ¯åŒ–å»ºè®¾é‡‡è´­é¡¹ç›®', 
        'kb_9876543210', 'user_123', 'draft', NOW(), NOW());
```

### å…³é”®ä»£ç ä½ç½®

- å‰ç«¯ç»„ä»¶: `frontend/src/components/TenderWorkspace.tsx`
- API è·¯ç”±: `backend/app/routers/tender.py` - `create_project()`
- æ•°æ®è®¿é—®: `backend/app/services/dao/tender_dao.py` - `create_project()`
- çŸ¥è¯†åº“æœåŠ¡: `backend/app/services/kb_service.py` - `create_kb()`

---

## Step 1: ä¸Šä¼ æ‹›æ ‡æ–‡ä»¶

### ä¸šåŠ¡ç›®æ ‡

ä¸Šä¼ æ‹›æ ‡æ–‡ä»¶(é€šå¸¸æ˜¯ PDF æˆ– Word æ ¼å¼),ç³»ç»Ÿè‡ªåŠ¨è§£æã€åˆ†å—ã€å‘é‡åŒ–,ä¸ºåç»­çš„ä¿¡æ¯æå–å’Œæ£€ç´¢åšå‡†å¤‡ã€‚

### å‰ç«¯æ“ä½œ

```typescript
// frontend/src/components/TenderWorkspace.tsx

// 1. ç”¨æˆ·é€‰æ‹©æ–‡ä»¶
const handleFilesChange = (e: React.ChangeEvent<HTMLInputElement>) => {
  if (e.target.files) {
    setFiles(Array.from(e.target.files));
  }
};

// 2. ç”¨æˆ·ç‚¹å‡»ä¸Šä¼ 
const handleUpload = async () => {
  if (!currentProject || files.length === 0) {
    alert('è¯·é€‰æ‹©æ–‡ä»¶');
    return;
  }

  // 3. æ„å»º FormData
  const formData = new FormData();
  formData.append('kind', 'tender');  // æ–‡ä»¶ç±»å‹: tender
  files.forEach(f => formData.append('files', f));

  // 4. ä¸Šä¼ æ–‡ä»¶
  const newAssets = await api.post(
    `/api/apps/tender/projects/${currentProject.id}/assets/import`,
    formData
  );

  // 5. æ›´æ–°èµ„äº§åˆ—è¡¨
  setAssets([...assets, ...newAssets]);
  setFiles([]);
  alert('ä¸Šä¼ æˆåŠŸ');
};
```

### API æ¥å£

```http
POST /api/apps/tender/projects/{project_id}/assets/import
Content-Type: multipart/form-data

Request:
- kind: "tender"
- files: [File1.pdf, File2.docx]

Response:
[
  {
    "id": "asset_abc123",
    "project_id": "tp_1234567890",
    "file_name": "æ‹›æ ‡å…¬å‘Š.pdf",
    "kind": "tender",
    "kb_doc_id": "doc_xyz789",
    "created_at": "2025-12-20T10:05:00Z"
  },
  ...
]
```

### åç«¯å¤„ç†æµç¨‹

```python
# backend/app/routers/tender.py

@router.post("/projects/{project_id}/assets/import")
async def import_assets(
    project_id: str,
    files: List[UploadFile] = File(...),
    kind: str = Form(...),  # tender | bid | rule | template
    bidder_name: Optional[str] = Form(None),
    request: Request = None,
):
    """
    ä¸Šä¼ æ–‡ä»¶æµç¨‹:
    1. éªŒè¯é¡¹ç›®å­˜åœ¨
    2. ä¿å­˜æ–‡ä»¶åˆ°ç£ç›˜
    3. è°ƒç”¨æ–‡æ¡£æ‘„å…¥æœåŠ¡ (IngestV2)
    4. åˆ›å»ºèµ„äº§è®°å½•
    5. è¿”å›èµ„äº§åˆ—è¡¨
    """
    
    svc = _svc(request)
    assets = []
    
    for file in files:
        # 1. ä¿å­˜æ–‡ä»¶
        file_path = await save_file(file, project_id)
        
        # 2. è°ƒç”¨æ‘„å…¥æœåŠ¡ (å¼‚æ­¥ä»»åŠ¡)
        ingest_result = await svc.ingest_document(
            project_id=project_id,
            file_path=file_path,
            doc_type=kind,
            bidder_name=bidder_name
        )
        
        # 3. åˆ›å»ºèµ„äº§è®°å½•
        asset = svc.dao.create_asset(
            project_id=project_id,
            file_name=file.filename,
            kind=kind,
            bidder_name=bidder_name,
            kb_doc_id=ingest_result['kb_doc_id']
        )
        
        assets.append(asset)
    
    return assets
```

### æ–‡æ¡£æ‘„å…¥æµç¨‹ (IngestV2)

```python
# backend/app/platform/ingest/ingest_v2_service.py

class IngestV2Service:
    """æ–‡æ¡£æ‘„å…¥æœåŠ¡ V2"""
    
    async def ingest_document(
        self,
        project_id: str,
        file_path: str,
        doc_type: str,
        bidder_name: Optional[str] = None
    ) -> Dict:
        """
        æ–‡æ¡£æ‘„å…¥æµç¨‹:
        1. è§£ææ–‡æ¡£ (PDF/DOCX)
        2. æ–‡æœ¬åˆ†å— (Chunking)
        3. å‘é‡åŒ– (Embedding)
        4. å­˜å‚¨åˆ°æ•°æ®åº“ (doc_segments + pgvector)
        """
        
        # 1. è§£ææ–‡æ¡£
        if file_path.endswith('.pdf'):
            text, pages = self._parse_pdf(file_path)
        elif file_path.endswith('.docx'):
            text, pages = self._parse_docx(file_path)
        else:
            raise ValueError(f"Unsupported file format: {file_path}")
        
        # 2. åˆ›å»ºæ–‡æ¡£è®°å½•
        doc_id = self._create_document(project_id, doc_type, file_path)
        doc_version_id = self._create_document_version(doc_id, file_path, len(pages))
        
        # 3. æ–‡æœ¬åˆ†å—
        chunks = self._chunk_text(text, chunk_size=1000, overlap=200)
        
        # 4. å‘é‡åŒ– (æ‰¹é‡)
        embeddings = await self._embed_chunks(chunks)
        
        # 5. å­˜å‚¨åˆ°æ•°æ®åº“
        for i, (chunk, embedding) in enumerate(zip(chunks, embeddings)):
            self._create_doc_segment(
                doc_version_id=doc_version_id,
                position=i,
                content=chunk['text'],
                page_no=chunk['page_no'],
                embedding=embedding
            )
        
        return {
            'document_id': doc_id,
            'doc_version_id': doc_version_id,
            'kb_doc_id': kb_doc_id,  # å…¼å®¹æ—§è¡¨
            'chunk_count': len(chunks)
        }
```

### æ•°æ®åº“å˜æ›´

```sql
-- 1. åˆ›å»ºæ–‡æ¡£è®°å½•
INSERT INTO documents (document_id, project_id, doc_type, original_name, created_at)
VALUES ('doc_xyz789', 'tp_1234567890', 'tender', 'æ‹›æ ‡å…¬å‘Š.pdf', NOW());

-- 2. åˆ›å»ºæ–‡æ¡£ç‰ˆæœ¬è®°å½•
INSERT INTO document_versions (doc_version_id, document_id, version_no, is_current, file_path, page_count, created_at)
VALUES ('docver_aaa111', 'doc_xyz789', 1, TRUE, '/app/storage/tender/tp_1234567890/asset_abc123.pdf', 50, NOW());

-- 3. åˆ›å»ºæ–‡æ¡£å—è®°å½• (å¤šæ¡)
INSERT INTO doc_segments (segment_id, doc_version_id, position, content, page_no, embedding, created_at)
VALUES 
  ('seg_001', 'docver_aaa111', 0, 'ç¬¬ä¸€ç«  é¡¹ç›®æ¦‚è¿°\n\n1.1 é¡¹ç›®åç§°...', 1, '[0.123, 0.456, ...]', NOW()),
  ('seg_002', 'docver_aaa111', 1, '1.2 é¡¹ç›®é¢„ç®—...', 2, '[0.789, 0.012, ...]', NOW()),
  ...

-- 4. åˆ›å»ºèµ„äº§è®°å½•
INSERT INTO tender_assets (id, project_id, file_name, kind, kb_doc_id, created_at)
VALUES ('asset_abc123', 'tp_1234567890', 'æ‹›æ ‡å…¬å‘Š.pdf', 'tender', 'doc_xyz789', NOW());
```

### å…³é”®ä»£ç ä½ç½®

- å‰ç«¯ç»„ä»¶: `frontend/src/components/TenderWorkspace.tsx` - `handleUpload()`
- API è·¯ç”±: `backend/app/routers/tender.py` - `import_assets()`
- æ‘„å…¥æœåŠ¡: `backend/app/platform/ingest/ingest_v2_service.py`
- æ–‡æ¡£è§£æ: `backend/app/services/documents/parser.py`
- åˆ†å—å·¥å…·: `backend/app/services/segmenter/chunker.py`

---

## Step 2: æå–é¡¹ç›®ä¿¡æ¯

### ä¸šåŠ¡ç›®æ ‡

ä»æ‹›æ ‡æ–‡ä»¶ä¸­è‡ªåŠ¨æå–é¡¹ç›®çš„å…³é”®ä¿¡æ¯,åŒ…æ‹¬:
- åŸºæœ¬ä¿¡æ¯(é¡¹ç›®åç§°ã€é¢„ç®—ã€è”ç³»äººç­‰)
- æŠ€æœ¯å‚æ•°(åŠŸèƒ½è¦æ±‚ã€æ€§èƒ½æŒ‡æ ‡ç­‰)
- å•†åŠ¡æ¡æ¬¾(ä»˜æ¬¾ã€éªŒæ”¶ã€è´¨ä¿ç­‰)
- è¯„åˆ†æ ‡å‡†(è¯„æ ‡åŠæ³•ã€è¯„åˆ†ç»†åˆ™ç­‰)

### å‰ç«¯æ“ä½œ

```typescript
// frontend/src/components/TenderWorkspace.tsx

// 1. ç”¨æˆ·ç‚¹å‡»"Step 1: æå–é¡¹ç›®ä¿¡æ¯"æŒ‰é’®
const handleExtractProjectInfo = async () => {
  if (!currentProject) return;
  
  // 2. è°ƒç”¨ API å¼€å§‹æŠ½å–
  const result = await api.post(
    `/api/apps/tender/projects/${currentProject.id}/extract/project-info`,
    {
      model_id: selectedModelId,  // å¯é€‰,ä½¿ç”¨ç‰¹å®šæ¨¡å‹
      sync: 1  // åŒæ­¥æ‰§è¡Œ,ç­‰å¾…ç»“æœ
    }
  );
  
  // 3. æ˜¾ç¤ºæŠ½å–ç»“æœ
  if (result.status === 'success') {
    // è·å–é¡¹ç›®ä¿¡æ¯
    const projectInfo = await api.get(
      `/api/apps/tender/projects/${currentProject.id}/project-info`
    );
    setProjectInfo(projectInfo);
    alert('æå–æˆåŠŸ');
  }
};
```

### API æ¥å£

```http
POST /api/apps/tender/projects/{project_id}/extract/project-info?sync=1
Content-Type: application/json

Request:
{
  "model_id": "gpt-4"  // å¯é€‰
}

Response (sync=1 åŒæ­¥æ¨¡å¼):
{
  "run_id": "run_abc123",
  "status": "success",
  "progress": 1.0,
  "message": "Extraction completed"
}

Response (sync=0 å¼‚æ­¥æ¨¡å¼):
{
  "run_id": "run_abc123"
}
```

### è·å–æŠ½å–ç»“æœ

```http
GET /api/apps/tender/projects/{project_id}/project-info

Response:
{
  "project_id": "tp_1234567890",
  "data": {
    "base": {
      "projectName": "XXåŒ»é™¢ä¿¡æ¯åŒ–å»ºè®¾é¡¹ç›®",
      "ownerName": "XXå¸‚å«ç”Ÿå¥åº·å§”å‘˜ä¼š",
      "agencyName": "XXæ‹›æ ‡ä»£ç†æœ‰é™å…¬å¸",
      "bidDeadline": "2025å¹´1æœˆ15æ—¥ 9:00",
      "budget": "500ä¸‡å…ƒ",
      "contact": "å¼ ç»ç† 13800138000"
    },
    "technical_parameters": [
      {
        "category": "æœåŠ¡å™¨é…ç½®",
        "item": "æ•°æ®åº“æœåŠ¡å™¨",
        "requirement": "é«˜æ€§èƒ½æ•°æ®åº“æœåŠ¡å™¨",
        "parameters": [
          {
            "name": "CPU",
            "value": "Intel Xeon Gold 6248R Ã— 2",
            "unit": "é¢—",
            "remark": "20æ ¸40çº¿ç¨‹"
          },
          {
            "name": "å†…å­˜",
            "value": "256",
            "unit": "GB",
            "remark": "DDR4 ECC"
          }
        ],
        "evidence_chunk_ids": ["seg_012", "seg_013"]
      }
    ],
    "business_terms": [
      {
        "term": "ä»˜æ¬¾æ–¹å¼",
        "requirement": "åˆåŒç­¾è®¢åæ”¯ä»˜30%é¢„ä»˜æ¬¾,éªŒæ”¶åˆæ ¼åæ”¯ä»˜60%,è´¨ä¿æœŸæ»¡åæ”¯ä»˜10%",
        "evidence_chunk_ids": ["seg_045"]
      },
      {
        "term": "äº¤ä»˜æœŸ",
        "requirement": "åˆåŒç­¾è®¢å90ä¸ªè‡ªç„¶æ—¥å†…å®Œæˆå®‰è£…è°ƒè¯•",
        "evidence_chunk_ids": ["seg_046"]
      }
    ],
    "scoring_criteria": {
      "evaluationMethod": "ç»¼åˆè¯„åˆ†æ³•",
      "items": [
        {
          "category": "ä»·æ ¼åˆ†",
          "item": "æŠ•æ ‡æŠ¥ä»·",
          "score": "30åˆ†",
          "rule": "æœ€ä½ä»·å¾—æ»¡åˆ†,å…¶ä»–æŒ‰æ¯”ä¾‹é€’å‡",
          "evidence_chunk_ids": ["seg_078"]
        },
        {
          "category": "æŠ€æœ¯åˆ†",
          "item": "æŠ€æœ¯æ–¹æ¡ˆ",
          "score": "40åˆ†",
          "rule": "æ ¹æ®æŠ€æœ¯æ–¹æ¡ˆçš„å®Œæ•´æ€§ã€å¯è¡Œæ€§è¯„åˆ†",
          "evidence_chunk_ids": ["seg_079"]
        }
      ]
    }
  },
  "evidence_chunk_ids": ["seg_012", "seg_013", "seg_045", "seg_046", "seg_078", "seg_079"],
  "updated_at": "2025-12-20T10:10:00Z"
}
```

### åç«¯å¤„ç†æµç¨‹

```python
# backend/app/routers/tender.py

@router.post("/projects/{project_id}/extract/project-info")
def extract_project_info_api(
    project_id: str,
    req: ExtractReq,
    request: Request,
    bg: BackgroundTasks,
    sync: int = 0,
    user=Depends(get_current_user_sync),
):
    """
    æå–é¡¹ç›®ä¿¡æ¯ API
    
    å‚æ•°:
    - sync=0: å¼‚æ­¥æ‰§è¡Œ(è¿”å› run_id,åå°å¤„ç†)
    - sync=1: åŒæ­¥æ‰§è¡Œ(ç­‰å¾…å®Œæˆ,è¿”å›å®Œæ•´ç»“æœ)
    """
    
    # 1. åˆ›å»ºè¿è¡Œè®°å½•
    dao = TenderDAO(_get_pool(request))
    run_id = dao.create_run(project_id, "extract")
    dao.update_run(run_id, "running", progress=0.01, message="running")
    
    # 2. è·å–æœåŠ¡
    svc = _svc(request)
    owner_id = user.user_id if user else None
    
    # 3. å®šä¹‰ä»»åŠ¡å‡½æ•°
    def job():
        try:
            svc.extract_project_info(
                project_id=project_id,
                model_id=req.model_id,
                run_id=run_id,
                owner_id=owner_id,
            )
        except Exception as e:
            logger.exception(f"Extract failed: {e}")
            dao.update_run(run_id, "failed", message=str(e))
    
    # 4. åŒæ­¥æˆ–å¼‚æ­¥æ‰§è¡Œ
    run_sync = (sync == 1) or (request.headers.get("X-Run-Sync") == "1")
    
    if run_sync:
        # åŒæ­¥æ‰§è¡Œ
        job()
        # è¿”å›æœ€æ–°çŠ¶æ€
        run = dao.get_run(run_id)
        return {
            "run_id": run_id,
            "status": run.get("status") if run else "unknown",
            "progress": run.get("progress") if run else 0,
            "message": run.get("message") if run else "",
        }
    else:
        # å¼‚æ­¥æ‰§è¡Œ
        bg.add_task(job)
        return {"run_id": run_id}
```

### æŠ½å–å¼•æ“æ‰§è¡Œæµç¨‹

```python
# backend/app/services/tender_service.py

class TenderService:
    def extract_project_info(
        self,
        project_id: str,
        model_id: Optional[str],
        run_id: Optional[str] = None,
        owner_id: Optional[str] = None,
    ):
        """
        æŠ½å–é¡¹ç›®ä¿¡æ¯ - ä¸»æ§æ–¹æ³•
        
        æµç¨‹:
        1. æ£€æŸ¥ cutover æ¨¡å¼(å¿…é¡» NEW_ONLY)
        2. åˆ›å»º platform job(å¯é€‰)
        3. è°ƒç”¨ V2 æŠ½å–æœåŠ¡
        4. ä¿å­˜ç»“æœåˆ°æ•°æ®åº“
        5. æ›´æ–°è¿è¡ŒçŠ¶æ€
        """
        
        # 1. æ£€æŸ¥æ¨¡å¼
        cutover = get_cutover_config()
        extract_mode = cutover.get_mode("extract", project_id)
        if extract_mode.value != "NEW_ONLY":
            raise RuntimeError("Legacy extraction deleted. Set EXTRACT_MODE=NEW_ONLY")
        
        # 2. åˆ›å»º job(å¯é€‰)
        if self.jobs_service:
            job_id = self.jobs_service.create_job(
                job_type="extract",
                project_id=project_id,
                run_id=run_id,
                owner_id=owner_id
            )
        
        # 3. è°ƒç”¨ V2 æŠ½å–æœåŠ¡
        from app.works.tender.extract_v2_service import ExtractV2Service
        pool = _get_pool()
        extract_v2 = ExtractV2Service(pool, self.llm)
        
        v2_result = asyncio.run(extract_v2.extract_project_info_v2(
            project_id=project_id,
            model_id=model_id,
            run_id=run_id
        ))
        
        # 4. ä¿å­˜åˆ°æ•°æ®åº“
        data = v2_result["data"]
        evidence_chunk_ids = v2_result["evidence_chunk_ids"]
        
        self.dao.upsert_project_info(
            project_id=project_id,
            data_json=data,
            evidence_chunk_ids=evidence_chunk_ids
        )
        
        # 5. æ›´æ–°çŠ¶æ€
        if run_id:
            self.dao.update_run(
                run_id,
                status="success",
                progress=1.0,
                message="Extraction completed",
                result_json=v2_result
            )
```

### V2 æŠ½å–æœåŠ¡æµç¨‹

```python
# backend/app/works/tender/extract_v2_service.py

class ExtractV2Service:
    """æ‹›æŠ•æ ‡æŠ½å–æœåŠ¡ V2"""
    
    async def extract_project_info_v2(
        self,
        project_id: str,
        model_id: Optional[str],
        run_id: Optional[str] = None,
    ) -> Dict[str, Any]:
        """
        æŠ½å–é¡¹ç›®ä¿¡æ¯ V2
        
        æµç¨‹:
        1. è·å– embedding provider
        2. æ„å»ºæŠ½å–è§„æ ¼(ExtractionSpec)
        3. è°ƒç”¨å¹³å°æŠ½å–å¼•æ“(ExtractionEngine)
        4. è¿”å›ç»“æ„åŒ–ç»“æœ
        """
        
        # 1. è·å– embedding provider
        embedding_provider = get_embedding_store().get_default()
        if not embedding_provider:
            raise ValueError("No embedding provider configured")
        
        # 2. æ„å»ºæŠ½å–è§„æ ¼
        spec = build_project_info_spec()
        
        # 3. è°ƒç”¨å¹³å°æŠ½å–å¼•æ“
        result = await self.engine.run(
            spec=spec,
            retriever=self.retriever,  # RetrievalFacade
            llm=self.llm,               # LLM Orchestrator
            project_id=project_id,
            model_id=model_id,
            run_id=run_id,
            embedding_provider=embedding_provider,
        )
        
        # 4. è¿”å›ç»“æœ
        return {
            "data": result.data,
            "evidence_chunk_ids": result.evidence_chunk_ids,
            "evidence_spans": result.evidence_spans,
            "retrieval_trace": result.retrieval_trace.__dict__ if result.retrieval_trace else {}
        }
```

### æŠ½å–è§„æ ¼é…ç½®

```python
# backend/app/works/tender/extraction_specs/project_info_v2.py

def build_project_info_spec() -> ExtractionSpec:
    """æ„å»ºé¡¹ç›®ä¿¡æ¯æŠ½å–è§„æ ¼"""
    
    # åŠ è½½ Prompt æ¨¡æ¿
    prompt = _load_prompt("project_info_v2.md")
    
    # å››ä¸ªæŸ¥è¯¢ç»´åº¦
    queries = {
        "base": "æ‹›æ ‡å…¬å‘Š é¡¹ç›®åç§° é¡¹ç›®ç¼–å· é¢„ç®—é‡‘é¢ é‡‡è´­äºº ä»£ç†æœºæ„ æŠ•æ ‡æˆªæ­¢ å¼€æ ‡ æ—¶é—´ åœ°ç‚¹ è”ç³»äºº ç”µè¯",
        "technical": "æŠ€æœ¯è¦æ±‚ æŠ€æœ¯è§„èŒƒ æŠ€æœ¯å‚æ•° è®¾å¤‡å‚æ•° æ€§èƒ½æŒ‡æ ‡ åŠŸèƒ½è¦æ±‚ è§„æ ¼ å‹å· å‚æ•°è¡¨",
        "business": "å•†åŠ¡æ¡æ¬¾ åˆåŒæ¡æ¬¾ ä»˜æ¬¾æ–¹å¼ äº¤ä»˜æœŸ å·¥æœŸ è´¨ä¿ éªŒæ”¶ è¿çº¦è´£ä»» å‘ç¥¨",
        "scoring": "è¯„åˆ†æ ‡å‡† è¯„æ ‡åŠæ³• è¯„å®¡åŠæ³• è¯„åˆ†ç»†åˆ™ åˆ†å€¼ æƒé‡ åŠ åˆ†é¡¹ å¦å†³é¡¹ èµ„æ ¼å®¡æŸ¥",
    }
    
    # æ£€ç´¢å‚æ•°
    topk_per_query = int(os.getenv("V2_RETRIEVAL_TOPK_PER_QUERY", "30"))
    topk_total = int(os.getenv("V2_RETRIEVAL_TOPK_TOTAL", "120"))
    
    return ExtractionSpec(
        prompt=prompt,
        queries=queries,
        topk_per_query=topk_per_query,
        topk_total=topk_total,
        doc_types=["tender"],
        temperature=0.0,  # ç¡®å®šæ€§è¾“å‡º
    )
```

### å¹³å°æŠ½å–å¼•æ“æ‰§è¡Œ

```python
# backend/app/platform/extraction/engine.py

class ExtractionEngine:
    async def run(
        self,
        spec: ExtractionSpec,
        retriever: Any,
        llm: Any,
        project_id: str,
        model_id: Optional[str] = None,
        run_id: Optional[str] = None,
        embedding_provider: Optional[str] = None,
    ) -> ExtractionResult:
        """
        é€šç”¨æŠ½å–æµç¨‹:
        1. æ£€ç´¢ç›¸å…³æ–‡æ¡£å—
        2. æ„å»ºæ ‡è®°ä¸Šä¸‹æ–‡
        3. è°ƒç”¨ LLM
        4. è§£æ JSON
        5. ç”Ÿæˆè¯æ®é“¾
        6. è¿”å›ç»“æ„åŒ–ç»“æœ
        """
        
        # 1. æ£€ç´¢
        all_chunks, query_trace = await self._retrieve_chunks(
            spec=spec,
            retriever=retriever,
            project_id=project_id,
            embedding_provider=embedding_provider,
            ...
        )
        
        # 2. æ„å»ºä¸Šä¸‹æ–‡
        ctx = build_marked_context(all_chunks)
        
        # 3. è°ƒç”¨ LLM
        messages = [
            {"role": "system", "content": spec.prompt.strip()},
            {"role": "user", "content": f"æ‹›æ ‡æ–‡ä»¶åŸæ–‡ç‰‡æ®µï¼š\n{ctx}"},
        ]
        out_text = await call_llm(messages, llm, model_id, ...)
        
        # 4. è§£æ JSON
        try:
            obj = extract_json(out_text)
        except:
            obj = repair_json(out_text)
        
        # 5. æå–æ•°æ®å’Œè¯æ®
        data = obj.get("data", {})
        evidence_chunk_ids = obj.get("evidence_chunk_ids", [])
        
        # 6. ç”Ÿæˆè¯æ®ç‰‡æ®µ
        evidence_spans = self._generate_evidence_spans(all_chunks, evidence_chunk_ids)
        
        # 7. æ„å»ºè¿½è¸ªä¿¡æ¯
        trace = self._build_trace(query_trace, spec, len(all_chunks), ...)
        
        # 8. è¿”å›ç»“æœ
        return ExtractionResult(
            data=data,
            evidence_chunk_ids=evidence_chunk_ids,
            evidence_spans=evidence_spans,
            raw_model_output=out_text,
            retrieval_trace=trace
        )
```

### æ•°æ®åº“å˜æ›´

```sql
-- æ›´æ–°é¡¹ç›®ä¿¡æ¯è¡¨
INSERT INTO project_info (project_id, data_json, evidence_chunk_ids, updated_at)
VALUES (
  'tp_1234567890',
  '{"base": {"projectName": "XXåŒ»é™¢ä¿¡æ¯åŒ–å»ºè®¾é¡¹ç›®", ...}, ...}'::jsonb,
  ARRAY['seg_012', 'seg_013', 'seg_045', ...],
  NOW()
)
ON CONFLICT (project_id) DO UPDATE
SET
  data_json = EXCLUDED.data_json,
  evidence_chunk_ids = EXCLUDED.evidence_chunk_ids,
  updated_at = EXCLUDED.updated_at;

-- æ›´æ–°è¿è¡Œè®°å½•
UPDATE runs
SET
  status = 'success',
  progress = 1.0,
  message = 'Extraction completed',
  result_json = '{"data": {...}, "evidence_chunk_ids": [...], ...}'::jsonb,
  updated_at = NOW()
WHERE id = 'run_abc123';
```

### å…³é”®ä»£ç ä½ç½®

- å‰ç«¯ç»„ä»¶: `frontend/src/components/TenderWorkspace.tsx`
- API è·¯ç”±: `backend/app/routers/tender.py` - `extract_project_info_api()`
- æœåŠ¡ä¸»æ§: `backend/app/services/tender_service.py` - `extract_project_info()`
- V2 æœåŠ¡: `backend/app/works/tender/extract_v2_service.py`
- æŠ½å–è§„æ ¼: `backend/app/works/tender/extraction_specs/project_info_v2.py`
- æŠ½å–å¼•æ“: `backend/app/platform/extraction/engine.py`
- Prompt æ¨¡æ¿: `backend/app/works/tender/prompts/project_info_v2.md`

---

## Step 3: è¯†åˆ«é£é™©

### ä¸šåŠ¡ç›®æ ‡

ä»æ‹›æ ‡æ–‡ä»¶ä¸­è‡ªåŠ¨è¯†åˆ«æ½œåœ¨çš„é£é™©ç‚¹,åŒ…æ‹¬:
- æŠ€æœ¯é£é™©(å‚æ•°è¦æ±‚è¿‡é«˜ã€æ—¶é—´è¿‡ç´§ç­‰)
- å•†åŠ¡é£é™©(ä»˜æ¬¾æ¡ä»¶ä¸åˆ©ã€è¿çº¦è´£ä»»è¿‡é‡ç­‰)
- åˆè§„é£é™©(èµ„è´¨è¦æ±‚ã€å¼ºåˆ¶æ€§æ¡æ¬¾ç­‰)
- å…¶ä»–é£é™©(æ‹›æ ‡æ–‡ä»¶ç‘•ç–µã€æ­§è§†æ€§æ¡æ¬¾ç­‰)

### å‰ç«¯æ“ä½œ

```typescript
// frontend/src/components/TenderWorkspace.tsx

const handleExtractRisks = async () => {
  if (!currentProject) return;
  
  // è°ƒç”¨ API å¼€å§‹è¯†åˆ«é£é™©
  const result = await api.post(
    `/api/apps/tender/projects/${currentProject.id}/extract/risks`,
    { model_id: selectedModelId, sync: 1 }
  );
  
  if (result.status === 'success') {
    // è·å–é£é™©åˆ—è¡¨
    const risks = await api.get(
      `/api/apps/tender/projects/${currentProject.id}/risks`
    );
    setRisks(risks);
    alert(`è¯†åˆ«åˆ° ${risks.length} ä¸ªé£é™©ç‚¹`);
  }
};
```

### API æ¥å£

```http
POST /api/apps/tender/projects/{project_id}/extract/risks?sync=1
Content-Type: application/json

Request:
{
  "model_id": "gpt-4"
}

Response:
{
  "run_id": "run_def456",
  "status": "success",
  "progress": 1.0,
  "message": "Risk extraction completed"
}
```

### è·å–é£é™©ç»“æœ

```http
GET /api/apps/tender/projects/{project_id}/risks

Response:
[
  {
    "id": "risk_001",
    "project_id": "tp_1234567890",
    "risk_type": "technical",
    "title": "äº¤ä»˜æœŸè¿‡çŸ­",
    "description": "åˆåŒè¦æ±‚90å¤©å†…å®Œæˆå®‰è£…è°ƒè¯•,è€ƒè™‘åˆ°é¡¹ç›®è§„æ¨¡å’Œå¤æ‚åº¦,æ—¶é—´è¾ƒä¸ºç´§å¼ ",
    "suggestion": "å»ºè®®åœ¨æŠ€æœ¯æ–¹æ¡ˆä¸­æ˜ç¡®é¡¹ç›®é‡Œç¨‹ç¢‘,åˆç†å®‰æ’èµ„æº,å¿…è¦æ—¶ç”³è¯·å»¶æœŸ",
    "severity": "medium",
    "tags": ["äº¤ä»˜æœŸ", "æ—¶é—´é£é™©"],
    "evidence_chunk_ids": ["seg_046"],
    "evidence_spans": [
      {
        "source": "docver_aaa111",
        "page_no": 12,
        "snippet": "åˆåŒç­¾è®¢å90ä¸ªè‡ªç„¶æ—¥å†…å®Œæˆå®‰è£…è°ƒè¯•"
      }
    ],
    "created_at": "2025-12-20T10:15:00Z"
  },
  {
    "id": "risk_002",
    "risk_type": "commercial",
    "title": "ä»˜æ¬¾æ¡ä»¶ä¸åˆ©",
    "description": "é¢„ä»˜æ¬¾ä»…30%,è´¨ä¿æœŸç»“æŸåæ‰æ”¯ä»˜å°¾æ¬¾10%,èµ„é‡‘å‹åŠ›è¾ƒå¤§",
    "suggestion": "å»ºè®®ä¸ä¸šä¸»æ²Ÿé€š,äº‰å–æé«˜é¢„ä»˜æ¬¾æ¯”ä¾‹æˆ–ç¼©çŸ­è´¨ä¿æœŸ",
    "severity": "high",
    "tags": ["ä»˜æ¬¾æ–¹å¼", "èµ„é‡‘é£é™©"],
    "evidence_chunk_ids": ["seg_045"],
    "created_at": "2025-12-20T10:15:00Z"
  },
  {
    "id": "risk_003",
    "risk_type": "compliance",
    "title": "èµ„è´¨è¦æ±‚ä¸¥æ ¼",
    "description": "è¦æ±‚æŠ•æ ‡äººå…·æœ‰ä¿¡æ¯ç³»ç»Ÿé›†æˆåŠæœåŠ¡èµ„è´¨äºŒçº§åŠä»¥ä¸Š",
    "suggestion": "ç¡®è®¤å…¬å¸èµ„è´¨æ˜¯å¦æ»¡è¶³è¦æ±‚,å¦‚ä¸æ»¡è¶³éœ€è€ƒè™‘è”åˆä½“æŠ•æ ‡",
    "severity": "high",
    "tags": ["èµ„è´¨è¦æ±‚", "å‡†å…¥é—¨æ§›"],
    "evidence_chunk_ids": ["seg_020"],
    "created_at": "2025-12-20T10:15:00Z"
  }
]
```

### åç«¯å¤„ç†æµç¨‹

ä¸é¡¹ç›®ä¿¡æ¯æŠ½å–ç±»ä¼¼,é£é™©è¯†åˆ«ä¹Ÿä½¿ç”¨å¹³å°æŠ½å–å¼•æ“,åªæ˜¯ä½¿ç”¨ä¸åŒçš„ Spec é…ç½®:

```python
# backend/app/works/tender/extraction_specs/risks_v2.py

def build_risks_spec() -> ExtractionSpec:
    """æ„å»ºé£é™©è¯†åˆ«è§„æ ¼"""
    
    # åŠ è½½ Prompt æ¨¡æ¿
    prompt = _load_prompt("risks_v2.md")
    
    # æŸ¥è¯¢ç»´åº¦
    queries = {
        "technical": "æŠ€æœ¯è¦æ±‚ æŠ€æœ¯éš¾åº¦ æŠ€æœ¯é£é™© å‚æ•° æŒ‡æ ‡ æ—¶é—´ å·¥æœŸ",
        "commercial": "ä»˜æ¬¾ è´¨ä¿ éªŒæ”¶ è¿çº¦ ç½šæ¬¾ ä¿è¯é‡‘ å•†åŠ¡æ¡æ¬¾",
        "compliance": "èµ„è´¨ è¯ä¹¦ ä¸šç»© äººå‘˜ å¼ºåˆ¶ ç¦æ­¢ å¦å†³",
        "other": "æ­§è§† å€¾å‘ æ’ä»– é™åˆ¶ ç‰¹å®š å“ç‰Œ å‹å·",
    }
    
    return ExtractionSpec(
        prompt=prompt,
        queries=queries,
        topk_per_query=30,
        topk_total=120,
        doc_types=["tender"],
        temperature=0.0,
    )
```

### æ•°æ®åº“å˜æ›´

```sql
-- æ’å…¥é£é™©è®°å½•(å¤šæ¡)
INSERT INTO risks (id, project_id, risk_type, title, description, suggestion, severity, tags, evidence_chunk_ids, created_at)
VALUES
  ('risk_001', 'tp_1234567890', 'technical', 'äº¤ä»˜æœŸè¿‡çŸ­', 'åˆåŒè¦æ±‚90å¤©...', 'å»ºè®®åœ¨æŠ€æœ¯æ–¹æ¡ˆ...', 'medium', 
   ARRAY['äº¤ä»˜æœŸ', 'æ—¶é—´é£é™©'], ARRAY['seg_046'], NOW()),
  ('risk_002', 'tp_1234567890', 'commercial', 'ä»˜æ¬¾æ¡ä»¶ä¸åˆ©', 'é¢„ä»˜æ¬¾ä»…30%...', 'å»ºè®®ä¸ä¸šä¸»æ²Ÿé€š...', 'high',
   ARRAY['ä»˜æ¬¾æ–¹å¼', 'èµ„é‡‘é£é™©'], ARRAY['seg_045'], NOW()),
  ('risk_003', 'tp_1234567890', 'compliance', 'èµ„è´¨è¦æ±‚ä¸¥æ ¼', 'è¦æ±‚æŠ•æ ‡äººå…·æœ‰...', 'ç¡®è®¤å…¬å¸èµ„è´¨...', 'high',
   ARRAY['èµ„è´¨è¦æ±‚', 'å‡†å…¥é—¨æ§›'], ARRAY['seg_020'], NOW());

-- æ›´æ–°è¿è¡Œè®°å½•
UPDATE runs
SET status = 'success', progress = 1.0, message = 'Risk extraction completed', updated_at = NOW()
WHERE id = 'run_def456';
```

### å…³é”®ä»£ç ä½ç½®

- V2 æœåŠ¡: `backend/app/works/tender/extract_v2_service.py` - `extract_risks_v2()`
- æŠ½å–è§„æ ¼: `backend/app/works/tender/extraction_specs/risks_v2.py`
- Prompt æ¨¡æ¿: `backend/app/works/tender/prompts/risks_v2.md`
- æ•°æ®è®¿é—®: `backend/app/services/dao/tender_dao.py` - `insert_risks()`

---

## Step 4: ç”Ÿæˆç›®å½•

### ä¸šåŠ¡ç›®æ ‡

æ ¹æ®æ‹›æ ‡æ–‡ä»¶çš„è¦æ±‚,è‡ªåŠ¨ç”Ÿæˆå“åº”æ–‡ä»¶(æŠ•æ ‡æ–‡ä»¶)çš„ç›®å½•ç»“æ„ã€‚

### å‰ç«¯æ“ä½œ

```typescript
const handleGenerateDirectory = async () => {
  if (!currentProject) return;
  
  // è°ƒç”¨ API ç”Ÿæˆç›®å½•
  const result = await api.post(
    `/api/apps/tender/projects/${currentProject.id}/directory/generate`,
    { sync: 1 }
  );
  
  if (result.status === 'success') {
    // è·å–ç›®å½•æ ‘
    const nodes = await api.get(
      `/api/apps/tender/projects/${currentProject.id}/directory/nodes`
    );
    setDirectoryNodes(nodes);
    alert('ç›®å½•ç”ŸæˆæˆåŠŸ');
  }
};
```

### API æ¥å£

```http
POST /api/apps/tender/projects/{project_id}/directory/generate?sync=1

Response:
{
  "run_id": "run_ghi789",
  "status": "success",
  "progress": 1.0,
  "message": "Directory generated"
}
```

### è·å–ç›®å½•ç»“æœ

```http
GET /api/apps/tender/projects/{project_id}/directory/nodes

Response:
[
  {
    "id": "node_001",
    "parent_id": null,
    "order_no": 1,
    "numbering": "ç¬¬ä¸€å·",
    "level": 1,
    "title": "å•†åŠ¡æ–‡ä»¶",
    "required": true,
    "source": "tender",
    "notes": "",
    "volume": "ç¬¬ä¸€å·",
    "evidence_chunk_ids": ["seg_080"]
  },
  {
    "id": "node_002",
    "parent_id": "node_001",
    "order_no": 1,
    "numbering": "1",
    "level": 2,
    "title": "æŠ•æ ‡å‡½",
    "required": true,
    "source": "tender",
    "evidence_chunk_ids": ["seg_081"]
  },
  {
    "id": "node_003",
    "parent_id": "node_001",
    "order_no": 2,
    "numbering": "2",
    "level": 2,
    "title": "æ³•å®šä»£è¡¨äººèº«ä»½è¯æ˜",
    "required": true,
    "source": "tender",
    "evidence_chunk_ids": ["seg_082"]
  },
  ...
]
```

### åç«¯å¤„ç†æµç¨‹

ç›®å½•ç”Ÿæˆé€»è¾‘è¾ƒä¸ºå¤æ‚,æ¶‰åŠ:
1. ä»æ‹›æ ‡æ–‡ä»¶ä¸­æå–ç›®å½•ç»“æ„è¦æ±‚
2. è¯†åˆ«å¿…å¡«é¡¹å’Œé€‰å¡«é¡¹
3. ç”Ÿæˆå±‚çº§åŒ–çš„ç›®å½•æ ‘
4. ä¿å­˜åˆ°æ•°æ®åº“

```python
# backend/app/services/tender_service.py

class TenderService:
    def generate_directory(
        self,
        project_id: str,
        model_id: Optional[str],
        run_id: Optional[str] = None,
    ):
        """
        ç”Ÿæˆç›®å½•æµç¨‹:
        1. åŠ è½½æ‹›æ ‡æ–‡ä»¶chunks
        2. è°ƒç”¨ LLM æå–ç›®å½•ç»“æ„
        3. è§£æä¸ºç›®å½•èŠ‚ç‚¹åˆ—è¡¨
        4. ä¿å­˜åˆ°æ•°æ®åº“
        """
        
        # 1. åŠ è½½æ‹›æ ‡æ–‡ä»¶chunks(é‡ç‚¹å…³æ³¨ç›®å½•ç›¸å…³éƒ¨åˆ†)
        chunks = self.dao.load_chunks_by_project(
            project_id,
            doc_types=["tender"],
            queries=["æŠ•æ ‡æ–‡ä»¶æ ¼å¼", "æŠ•æ ‡æ–‡ä»¶ç»„æˆ", "ç›®å½•è¦æ±‚"],
            limit=100
        )
        
        # 2. æ„å»ºprompt
        ctx = _build_marked_context(chunks)
        messages = [
            {"role": "system", "content": self.DIRECTORY_PROMPT.strip()},
            {"role": "user", "content": f"æ‹›æ ‡æ–‡ä»¶åŸæ–‡ç‰‡æ®µï¼š\n{ctx}"},
        ]
        
        # 3. è°ƒç”¨ LLM
        out_text = self._llm_text(LLMCall(model_id=model_id, messages=messages))
        nodes_data = _extract_json(out_text)
        
        # 4. ä¿å­˜åˆ°æ•°æ®åº“
        self.dao.delete_directory_nodes(project_id)  # å…ˆåˆ é™¤æ—§çš„
        for node_data in nodes_data:
            self.dao.create_directory_node(project_id, node_data)
        
        # 5. æ›´æ–°è¿è¡ŒçŠ¶æ€
        if run_id:
            self.dao.update_run(run_id, "success", message="Directory generated")
```

### æ•°æ®åº“å˜æ›´

```sql
-- åˆ é™¤æ—§çš„ç›®å½•èŠ‚ç‚¹
DELETE FROM directory_nodes WHERE project_id = 'tp_1234567890';

-- æ’å…¥æ–°çš„ç›®å½•èŠ‚ç‚¹(å¤šæ¡)
INSERT INTO directory_nodes 
  (id, project_id, parent_id, order_no, numbering, level, title, is_required, source, evidence_chunk_ids, created_at)
VALUES
  ('node_001', 'tp_1234567890', NULL, 1, 'ç¬¬ä¸€å·', 1, 'å•†åŠ¡æ–‡ä»¶', TRUE, 'tender', ARRAY['seg_080'], NOW()),
  ('node_002', 'tp_1234567890', 'node_001', 1, '1', 2, 'æŠ•æ ‡å‡½', TRUE, 'tender', ARRAY['seg_081'], NOW()),
  ('node_003', 'tp_1234567890', 'node_001', 2, '2', 2, 'æ³•å®šä»£è¡¨äººèº«ä»½è¯æ˜', TRUE, 'tender', ARRAY['seg_082'], NOW()),
  ...
```

---

## Step 5: ä¸Šä¼ æŠ•æ ‡æ–‡ä»¶

ä¸ Step 1 ä¸Šä¼ æ‹›æ ‡æ–‡ä»¶ç±»ä¼¼,åªæ˜¯ `kind` å‚æ•°ä¸º `"bid"`,å¹¶éœ€è¦æŒ‡å®šæŠ•æ ‡äººåç§°ã€‚

```typescript
const formData = new FormData();
formData.append('kind', 'bid');
formData.append('bidder_name', 'åŒ—äº¬XXç§‘æŠ€æœ‰é™å…¬å¸');
files.forEach(f => formData.append('files', f));

await api.post(
  `/api/apps/tender/projects/${currentProject.id}/assets/import`,
  formData
);
```

---

## Step 6: è¿è¡Œå®¡æŸ¥

### ä¸šåŠ¡ç›®æ ‡

å¯¹æ¯”æ‹›æ ‡æ–‡ä»¶çš„è¦æ±‚å’ŒæŠ•æ ‡æ–‡ä»¶çš„å“åº”,ç”Ÿæˆå®¡æŸ¥ç»“æœ,åŒ…æ‹¬:
- å¯¹æ¯”å®¡æŸ¥: LLM å¯¹æ¯”æ‹›æ ‡è¦æ±‚vsæŠ•æ ‡å“åº”
- è§„åˆ™å®¡æŸ¥: æ‰§è¡Œç¡®å®šæ€§è§„åˆ™(å¦‚å¿…å‘½ä¸­è§„åˆ™MUST_HIT_001)

### å‰ç«¯æ“ä½œ

```typescript
const handleRunReview = async () => {
  if (!currentProject) return;
  
  // é€‰æ‹©æŠ•æ ‡äººå’ŒæŠ•æ ‡æ–‡ä»¶
  const bidderName = 'åŒ—äº¬XXç§‘æŠ€æœ‰é™å…¬å¸';
  const bidAssetIds = ['asset_bid123'];
  
  // è°ƒç”¨ API è¿è¡Œå®¡æŸ¥
  const result = await api.post(
    `/api/apps/tender/projects/${currentProject.id}/review/run`,
    {
      bidder_name: bidderName,
      bid_asset_ids: bidAssetIds,
      custom_rule_asset_ids: [],  // å¯é€‰:è‡ªå®šä¹‰è§„åˆ™æ–‡ä»¶
      sync: 1
    }
  );
  
  if (result.status === 'success') {
    // è·å–å®¡æŸ¥ç»“æœ
    const reviewItems = await api.get(
      `/api/apps/tender/projects/${currentProject.id}/review?bidder_name=${bidderName}`
    );
    setReviewItems(reviewItems);
    alert(`å®¡æŸ¥å®Œæˆ,å…± ${reviewItems.length} æ¡ç»“æœ`);
  }
};
```

### API æ¥å£

```http
POST /api/apps/tender/projects/{project_id}/review/run?sync=1
Content-Type: application/json

Request:
{
  "bidder_name": "åŒ—äº¬XXç§‘æŠ€æœ‰é™å…¬å¸",
  "bid_asset_ids": ["asset_bid123"],
  "custom_rule_asset_ids": [],
  "model_id": "gpt-4"
}

Response:
{
  "run_id": "run_jkl012",
  "status": "success",
  "progress": 1.0,
  "message": "Review completed"
}
```

### è·å–å®¡æŸ¥ç»“æœ

```http
GET /api/apps/tender/projects/{project_id}/review?bidder_name=åŒ—äº¬XXç§‘æŠ€æœ‰é™å…¬å¸

Response:
[
  {
    "id": "review_001",
    "project_id": "tp_1234567890",
    "bidder_name": "åŒ—äº¬XXç§‘æŠ€æœ‰é™å…¬å¸",
    "source": "compare",
    "dimension": "æŠ€æœ¯å‚æ•°-CPUé…ç½®",
    "requirement_text": "Intel Xeon Gold 6248R Ã— 2",
    "response_text": "Intel Xeon Gold 6248R Ã— 2",
    "result": "pass",
    "rigid": true,
    "evidence_chunk_ids": ["seg_012", "bid_seg_034"],
    "created_at": "2025-12-20T10:30:00Z"
  },
  {
    "id": "review_002",
    "source": "compare",
    "dimension": "äº¤ä»˜æœŸ",
    "requirement_text": "åˆåŒç­¾è®¢å90ä¸ªè‡ªç„¶æ—¥å†…å®Œæˆ",
    "response_text": "åˆåŒç­¾è®¢å90ä¸ªè‡ªç„¶æ—¥å†…å®Œæˆå®‰è£…è°ƒè¯•",
    "result": "pass",
    "rigid": true,
    "evidence_chunk_ids": ["seg_046", "bid_seg_056"]
  },
  {
    "id": "review_003",
    "source": "rule",
    "rule_id": "MUST_HIT_001",
    "dimension": "æ‹›æ ‡äººä¿¡æ¯",
    "requirement_text": "å¿…é¡»æ˜ç¡®æ‹›æ ‡äººåç§°",
    "response_text": "æ‹›æ ‡äºº: XXå¸‚å«ç”Ÿå¥åº·å§”å‘˜ä¼š",
    "result": "pass",
    "rigid": true,
    "evidence_chunk_ids": ["bid_seg_002"]
  }
]
```

### åç«¯å¤„ç†æµç¨‹

```python
# backend/app/services/tender_service.py

class TenderService:
    def run_review(
        self,
        project_id: str,
        model_id: Optional[str],
        custom_rule_asset_ids: List[str],
        bidder_name: Optional[str],
        bid_asset_ids: List[str],
        run_id: Optional[str] = None,
    ):
        """
        è¿è¡Œå®¡æŸ¥æµç¨‹:
        1. åŠ è½½æ‹›æ ‡æ–‡ä»¶chunks
        2. åŠ è½½æŠ•æ ‡æ–‡ä»¶chunks
        3. åŠ è½½è‡ªå®šä¹‰è§„åˆ™(å¯é€‰)
        4. è°ƒç”¨ LLM è¿›è¡Œå¯¹æ¯”å®¡æŸ¥
        5. è°ƒç”¨è§„åˆ™å¼•æ“æ‰§è¡Œç¡®å®šæ€§è§„åˆ™
        6. åˆå¹¶ç»“æœå¹¶ä¿å­˜
        """
        
        # 1. åŠ è½½æ‹›æ ‡æ–‡ä»¶chunks
        tender_chunks = self.dao.load_chunks_by_assets(
            project_id,
            kinds=["tender"],
            limit=180
        )
        tender_ctx = _build_marked_context(tender_chunks)
        
        # 2. åŠ è½½æŠ•æ ‡æ–‡ä»¶chunks
        bid_chunks = self.dao.load_chunks_by_assets(
            project_id,
            kinds=["bid"],
            bidder_name=bidder_name,
            bid_asset_ids=bid_asset_ids,
            limit=180
        )
        bid_ctx = _build_marked_context(bid_chunks)
        
        # 3. åŠ è½½è‡ªå®šä¹‰è§„åˆ™(å¯é€‰)
        rule_ctx = ""
        if custom_rule_asset_ids:
            rule_chunks = self.dao.load_chunks_by_asset_ids(
                project_id,
                custom_rule_asset_ids,
                limit=120
            )
            rule_ctx = _build_marked_context(rule_chunks)
        
        # 4. è°ƒç”¨ LLM è¿›è¡Œå¯¹æ¯”å®¡æŸ¥
        messages = [
            {"role": "system", "content": self.REVIEW_PROMPT.strip()},
            {"role": "user", "content": f"""æ‹›æ ‡æ–‡ä»¶åŸæ–‡ç‰‡æ®µï¼š
{tender_ctx}

æŠ•æ ‡æ–‡ä»¶åŸæ–‡ç‰‡æ®µï¼š
{bid_ctx}

è‡ªå®šä¹‰å®¡æ ¸è§„åˆ™æ–‡ä»¶åŸæ–‡ç‰‡æ®µï¼ˆå¯ä¸ºç©ºï¼‰ï¼š
{rule_ctx or "(æ— )"}"""},
        ]
        out_text = self._llm_text(LLMCall(model_id=model_id, messages=messages))
        compare_items = _extract_json(out_text)
        
        # ä¸ºæ‰€æœ‰å¯¹æ¯”å®¡æŸ¥é¡¹æ·»åŠ  source å­—æ®µ
        for item in compare_items:
            if "source" not in item:
                item["source"] = "compare"
        
        # 5. è°ƒç”¨è§„åˆ™å¼•æ“æ‰§è¡Œç¡®å®šæ€§è§„åˆ™
        rule_items = []
        if self._should_run_rules():
            rule_engine = RulesEvaluatorV2()
            rule_set = self._load_active_rule_set()
            if rule_set:
                context = {
                    "tender_chunks": tender_chunks,
                    "bid_chunks": bid_chunks,
                    "project_info": self.dao.get_project_info(project_id),
                }
                rule_items = rule_engine.evaluate(rule_set, context)
        
        # 6. åˆå¹¶ç»“æœ
        all_items = compare_items + rule_items
        
        # 7. ä¿å­˜åˆ°æ•°æ®åº“
        self.dao.delete_review_items(project_id, bidder_name)
        for item in all_items:
            self.dao.create_review_item(project_id, bidder_name, item)
        
        # 8. æ›´æ–°è¿è¡ŒçŠ¶æ€
        if run_id:
            self.dao.update_run(run_id, "success", message="Review completed")
```

### æ•°æ®åº“å˜æ›´

```sql
-- åˆ é™¤æ—§çš„å®¡æŸ¥ç»“æœ
DELETE FROM review_items 
WHERE project_id = 'tp_1234567890' AND bidder_name = 'åŒ—äº¬XXç§‘æŠ€æœ‰é™å…¬å¸';

-- æ’å…¥æ–°çš„å®¡æŸ¥ç»“æœ(å¤šæ¡)
INSERT INTO review_items
  (id, project_id, bidder_name, source, dimension, requirement_text, response_text, 
   result, rigid, evidence_chunk_ids, rule_id, created_at)
VALUES
  ('review_001', 'tp_1234567890', 'åŒ—äº¬XXç§‘æŠ€æœ‰é™å…¬å¸', 'compare', 'æŠ€æœ¯å‚æ•°-CPUé…ç½®',
   'Intel Xeon Gold 6248R Ã— 2', 'Intel Xeon Gold 6248R Ã— 2', 'pass', TRUE,
   ARRAY['seg_012', 'bid_seg_034'], NULL, NOW()),
  ('review_002', 'tp_1234567890', 'åŒ—äº¬XXç§‘æŠ€æœ‰é™å…¬å¸', 'compare', 'äº¤ä»˜æœŸ',
   'åˆåŒç­¾è®¢å90ä¸ªè‡ªç„¶æ—¥å†…å®Œæˆ', 'åˆåŒç­¾è®¢å90ä¸ªè‡ªç„¶æ—¥å†…å®Œæˆå®‰è£…è°ƒè¯•', 'pass', TRUE,
   ARRAY['seg_046', 'bid_seg_056'], NULL, NOW()),
  ('review_003', 'tp_1234567890', 'åŒ—äº¬XXç§‘æŠ€æœ‰é™å…¬å¸', 'rule', 'æ‹›æ ‡äººä¿¡æ¯',
   'å¿…é¡»æ˜ç¡®æ‹›æ ‡äººåç§°', 'æ‹›æ ‡äºº: XXå¸‚å«ç”Ÿå¥åº·å§”å‘˜ä¼š', 'pass', TRUE,
   ARRAY['bid_seg_002'], 'MUST_HIT_001', NOW()),
  ...
```

---

## Step 7: å¯¼å‡ºæ–‡æ¡£

### ä¸šåŠ¡ç›®æ ‡

å°†é¡¹ç›®çš„æ‰€æœ‰ä¿¡æ¯(ç›®å½•ã€å®¡æŸ¥ç»“æœç­‰)å¯¼å‡ºä¸ºæ ¼å¼åŒ–çš„ Word æ–‡æ¡£ã€‚

### å‰ç«¯æ“ä½œ

```typescript
const handleExportDocx = async () => {
  if (!currentProject) return;
  
  // è°ƒç”¨ API å¯¼å‡º
  const blob = await api.getBlob(
    `/api/apps/tender/projects/${currentProject.id}/export/docx?bidder_name=${bidderName}`
  );
  
  // ä¸‹è½½æ–‡ä»¶
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${currentProject.name}-${bidderName}-æŠ•æ ‡æ–‡ä»¶.docx`;
  a.click();
  URL.revokeObjectURL(url);
};
```

### API æ¥å£

```http
GET /api/apps/tender/projects/{project_id}/export/docx?bidder_name=åŒ—äº¬XXç§‘æŠ€æœ‰é™å…¬å¸

Response:
Content-Type: application/vnd.openxmlformats-officedocument.wordprocessingml.document
Content-Disposition: attachment; filename="XXåŒ»é™¢ä¿¡æ¯åŒ–å»ºè®¾é¡¹ç›®-åŒ—äº¬XXç§‘æŠ€æœ‰é™å…¬å¸-æŠ•æ ‡æ–‡ä»¶.docx"

<binary DOCX data>
```

### åç«¯å¤„ç†æµç¨‹

```python
# backend/app/routers/tender.py

@router.get("/projects/{project_id}/export/docx")
def export_docx(
    project_id: str,
    bidder_name: Optional[str] = None,
    request: Request = None,
):
    """
    å¯¼å‡º DOCX
    
    æµç¨‹:
    1. è·å–é¡¹ç›®ä¿¡æ¯
    2. è·å–ç›®å½•æ ‘
    3. è·å–å®¡æŸ¥ç»“æœ(å¯é€‰)
    4. è°ƒç”¨å¯¼å‡ºæœåŠ¡ç”Ÿæˆ DOCX
    5. è¿”å›æ–‡ä»¶
    """
    
    svc = _svc(request)
    
    # 1. è·å–é¡¹ç›®ä¿¡æ¯
    project = svc.dao.get_project(project_id)
    project_info = svc.dao.get_project_info(project_id)
    
    # 2. è·å–ç›®å½•æ ‘
    directory_nodes = svc.dao.get_directory_nodes(project_id)
    
    # 3. è·å–å®¡æŸ¥ç»“æœ(å¦‚æœæŒ‡å®šäº†æŠ•æ ‡äºº)
    review_items = []
    if bidder_name:
        review_items = svc.dao.get_review_items(project_id, bidder_name)
    
    # 4. è°ƒç”¨å¯¼å‡ºæœåŠ¡
    from app.services.export.docx_exporter import DocxExporter
    exporter = DocxExporter()
    
    docx_file_path = exporter.export(
        project=project,
        project_info=project_info,
        directory_nodes=directory_nodes,
        review_items=review_items,
        bidder_name=bidder_name,
    )
    
    # 5. è¿”å›æ–‡ä»¶
    filename = f"{project['name']}-{bidder_name or 'æŠ•æ ‡æ–‡ä»¶'}.docx"
    return FileResponse(
        docx_file_path,
        media_type="application/vnd.openxmlformats-officedocument.wordprocessingml.document",
        filename=filename
    )
```

---

## æ•°æ®æµè½¬

### æ•´ä½“æ•°æ®æµ

```
ç”¨æˆ·ä¸Šä¼ æ‹›æ ‡æ–‡ä»¶(PDF/DOCX)
    â†“
æ–‡æ¡£è§£æ â†’ æ–‡æœ¬åˆ†å— â†’ å‘é‡åŒ–
    â†“
å­˜å‚¨åˆ°æ•°æ®åº“ (doc_segments + pgvector)
    â†“
ç”¨æˆ·è§¦å‘æå– â†’ æ£€ç´¢ç›¸å…³chunks â†’ è°ƒç”¨LLM â†’ è§£æJSON
    â†“
å­˜å‚¨ç»“æ„åŒ–æ•°æ® (project_info / risks / directory_nodes)
    â†“
ç”¨æˆ·ä¸Šä¼ æŠ•æ ‡æ–‡ä»¶ â†’ åŒæ ·çš„è§£ææµç¨‹
    â†“
ç”¨æˆ·è§¦å‘å®¡æŸ¥ â†’ æ£€ç´¢æ‹›æ ‡+æŠ•æ ‡chunks â†’ è°ƒç”¨LLM+è§„åˆ™å¼•æ“
    â†“
å­˜å‚¨å®¡æŸ¥ç»“æœ (review_items)
    â†“
ç”¨æˆ·å¯¼å‡ºæ–‡æ¡£ â†’ è¯»å–æ‰€æœ‰æ•°æ® â†’ ç”ŸæˆDOCX
```

### æ ¸å¿ƒæ•°æ®è¡¨å…³ç³»

```
tender_projects (é¡¹ç›®)
    â”œâ”€ kb_id â†’ kb_categories (çŸ¥è¯†åº“)
    â”œâ”€ tender_assets (èµ„äº§)
    â”‚   â””â”€ kb_doc_id â†’ documents (æ–‡æ¡£)
    â”‚       â””â”€ document_versions (æ–‡æ¡£ç‰ˆæœ¬)
    â”‚           â””â”€ doc_segments (æ–‡æ¡£å—) [å« embedding å‘é‡]
    â”œâ”€ project_info (é¡¹ç›®ä¿¡æ¯)
    â”œâ”€ risks (é£é™©)
    â”œâ”€ directory_nodes (ç›®å½•èŠ‚ç‚¹)
    â”œâ”€ review_items (å®¡æŸ¥ç»“æœ)
    â””â”€ runs (è¿è¡Œè®°å½•)
```

---

## å‰åç«¯äº¤äº’

### é€šä¿¡åè®®

- **åè®®**: HTTP/HTTPS
- **æ ¼å¼**: JSON (é™¤æ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½)
- **è®¤è¯**: JWT Token (é€šè¿‡ `Authorization: Bearer <token>` header)

### å¼‚æ­¥ä»»åŠ¡å¤„ç†

ç³»ç»Ÿæ”¯æŒä¸¤ç§æ‰§è¡Œæ¨¡å¼:

1. **åŒæ­¥æ¨¡å¼** (`sync=1`)
   - è¯·æ±‚é˜»å¡,ç­‰å¾…ä»»åŠ¡å®Œæˆ
   - ç›´æ¥è¿”å›æœ€ç»ˆç»“æœ
   - é€‚åˆå¿«é€Ÿä»»åŠ¡(<30ç§’)

2. **å¼‚æ­¥æ¨¡å¼** (`sync=0`, é»˜è®¤)
   - ç«‹å³è¿”å› `run_id`
   - åå°æ‰§è¡Œä»»åŠ¡
   - å‰ç«¯è½®è¯¢ `/api/apps/tender/runs/{run_id}` è·å–çŠ¶æ€
   - é€‚åˆè€—æ—¶ä»»åŠ¡(>30ç§’)

### å¼‚æ­¥è½®è¯¢ç¤ºä¾‹

```typescript
// 1. æäº¤å¼‚æ­¥ä»»åŠ¡
const { run_id } = await api.post('/api/apps/tender/projects/xxx/extract/project-info', {
  sync: 0  // å¼‚æ­¥
});

// 2. è½®è¯¢çŠ¶æ€
const pollInterval = setInterval(async () => {
  const run = await api.get(`/api/apps/tender/runs/${run_id}`);
  
  if (run.status === 'success') {
    clearInterval(pollInterval);
    alert('æå–å®Œæˆ');
    // åˆ·æ–°æ•°æ®
    loadProjectInfo();
  } else if (run.status === 'failed') {
    clearInterval(pollInterval);
    alert(`æå–å¤±è´¥: ${run.message}`);
  } else {
    // æ›´æ–°è¿›åº¦æ¡
    setProgress(run.progress);
  }
}, 2000);  // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
```

---

## æ€»ç»“

### å®Œæ•´æµç¨‹å›é¡¾

1. **åˆ›å»ºé¡¹ç›®** â†’ åˆ›å»ºé¡¹ç›®å®¹å™¨å’Œå…³è”çŸ¥è¯†åº“
2. **ä¸Šä¼ æ‹›æ ‡æ–‡ä»¶** â†’ è§£æã€åˆ†å—ã€å‘é‡åŒ–ã€å­˜å‚¨
3. **æå–é¡¹ç›®ä¿¡æ¯** â†’ æ£€ç´¢ + LLM â†’ ç»“æ„åŒ–æ•°æ®
4. **è¯†åˆ«é£é™©** â†’ æ£€ç´¢ + LLM â†’ é£é™©åˆ—è¡¨
5. **ç”Ÿæˆç›®å½•** â†’ æå–ç›®å½•ç»“æ„ â†’ ç›®å½•æ ‘
6. **ä¸Šä¼ æŠ•æ ‡æ–‡ä»¶** â†’ è§£æã€åˆ†å—ã€å­˜å‚¨
7. **è¿è¡Œå®¡æŸ¥** â†’ å¯¹æ¯” + è§„åˆ™ â†’ å®¡æŸ¥ç»“æœ
8. **å¯¼å‡ºæ–‡æ¡£** â†’ ç”Ÿæˆæ ¼å¼åŒ– Word æ–‡æ¡£

### å…³é”®ç‰¹ç‚¹

âœ… **å…¨è‡ªåŠ¨åŒ–**: å¤§éƒ¨åˆ†æµç¨‹æ— éœ€äººå·¥å¹²é¢„  
âœ… **å¯è¿½æº¯**: æ‰€æœ‰ç»“æœéƒ½æœ‰è¯æ®é“¾  
âœ… **çµæ´»é…ç½®**: é€šè¿‡ Spec å’Œç¯å¢ƒå˜é‡è°ƒæ•´è¡Œä¸º  
âœ… **é«˜è´¨é‡**: LLM + è§„åˆ™å¼•æ“åŒé‡ä¿éšœ  
âœ… **æ˜“æ‰©å±•**: å¹³å°åŒ–è®¾è®¡,æ˜“äºæ·»åŠ æ–°åŠŸèƒ½  

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-12-20  
**ç»´æŠ¤å›¢é˜Ÿ**: äº¿æ—äº¿é—®å¼€å‘å›¢é˜Ÿ

