# 范本提取失败诊断与解决方案

**问题**: 未抽取到范本（0个fragments）  
**时间**: 2025-12-25  
**影响**: 自动填充功能无法工作

---

## 🔍 问题原因分析

根据系统提示，范本提取失败的常见原因包括：

### 1️⃣ 文档格式问题

**问题**: 范本是图片/扫描件，无可复制文字
- ❌ **PDF扫描件**：纯图片，无文本层
- ❌ **DOCX中的图片表格**：表格以图片形式嵌入
- ❌ **不可编辑的内容**：保护模式、加密文档

**解决方案**:
```
✅ 上传可编辑的 DOCX 文件
✅ 确保文字可以复制粘贴
✅ 使用 OCR 将扫描件转换为可编辑文档
```

---

### 2️⃣ 标题识别问题

**问题**: 标题在表格中或非标准样式
- ❌ **标题在表格第一行**：未被识别为标题
- ❌ **标题不是 Heading 样式**：使用普通文本或加粗
- ❌ **标题格式不规范**：缺少"投标文件格式"等关键词

**现状**: 
- 系统主要依赖**规则匹配**（关键词+位置）
- 对表格内标题的识别有限
- LLM span定位虽然存在，但可能未生效

---

### 3️⃣ 定位算法问题

**问题**: 规则匹配失败，LLM定位未启用
- ❌ **规则匹配失败**：关键词不匹配、章节定位失败
- ❌ **LLM定位未生效**：虽然代码存在，但可能没有实际调用
- ❌ **置信度过滤**：LLM识别的片段置信度 < 0.55 被过滤

---

## 🛠️ 解决方案

### 方案1: 验证文档格式（立即）⭐⭐⭐⭐⭐

**步骤**:
1. 打开招标书DOCX
2. 尝试选中"投标文件格式"章节的内容
3. Ctrl+C 复制，Ctrl+V 粘贴到记事本
4. 如果能看到文字 → ✅ 可编辑
5. 如果只有图片 → ❌ 需要转换

**如果是扫描件**:
```bash
# 使用OCR工具转换（推荐）
1. Adobe Acrobat Pro：文件 > 识别文本 > 在此文件中
2. WPS Office：特色功能 > PDF转Word > OCR识别
3. 在线工具：iLovePDF、Smallpdf 等
```

---

### 方案2: 检查范本章节位置（立即）⭐⭐⭐⭐

**步骤**:
1. 打开招标书DOCX
2. 搜索关键词（Ctrl+F）：
   - "投标文件格式"
   - "投标文件样表"
   - "投标文件组成"
   - "附件"
   - "格式范本"

3. 找到后，检查：
   - ✅ 标题是否清晰
   - ✅ 内容是否完整
   - ✅ 是否在文档后半部分（通常在70%以后）

**提供给系统**:
```
如果找到了位置，记下：
- 章节名称：例如 "第六章 投标文件格式"
- 大致页码：例如 第50-80页
- 范本数量：例如 包含10个格式表格
```

---

### 方案3: 查看提取日志（诊断）⭐⭐⭐⭐

**命令**:
```bash
# 1. 查看范本提取日志
docker-compose logs backend | grep -E "(samples|extractor|fragments_detected|upserted_fragments)" | tail -100

# 2. 查看详细错误
docker-compose logs backend | grep -E "(ERROR|exception)" | grep -i "fragment" | tail -50

# 3. 查看auto_fill_samples执行情况
docker-compose logs backend | grep "auto_fill_samples" | tail -50
```

**关键信息**:
```
查找以下信息：
- "body_elements": X        # 文档元素数量
- "fragments_detected": X   # 规则检测到的片段数
- "upserted_fragments": X   # 最终入库的片段数（应该>0）
- "llm_used": true/false    # 是否使用了LLM定位
- "llm_spans_raw": X        # LLM识别的片段数
```

---

### 方案4: 启用LLM增强定位（推荐）⭐⭐⭐⭐⭐

**原理**: 
- 当前系统**已支持** LLM span定位
- 代码位置：`backend/app/services/fragment/fragment_extractor.py`
- 但可能因为规则匹配成功而未触发LLM

**验证LLM是否启用**:
```bash
# 查看日志
docker-compose logs backend | grep "llm spans" | tail -20

# 预期输出（如果LLM生效）：
# [samples] extractor: llm spans. project_id=xxx, raw=12, valid=10
```

**如果LLM未生效**（raw=0 或没有日志）:
1. 可能是因为规则匹配已成功，LLM作为fallback未触发
2. 可能是LLM调用失败（API问题、超时等）

**强制启用LLM的方式**:
修改代码逻辑，优先使用LLM而非fallback：

```python
# backend/app/services/fragment/fragment_extractor.py
# 在 extract_and_upsert_summary() 方法中

# 原有逻辑（第788行）：
if not valid_spans:
    # 仅当LLM spans为空时，才用规则

# 建议修改为：
# 优先使用LLM spans，规则作为补充
if valid_spans:
    use_llm_spans = True
else:
    # LLM失败，回退到规则
    use_rules = True
```

---

### 方案5: 优化规则匹配（开发）⭐⭐⭐

**问题**: 规则匹配对表格内标题的识别不足

**优化方向**:
1. **扩展关键词**（已在代码中）
   ```python
   # backend/app/services/fragment/fragment_extractor.py:149-155
   start_kw = [
       "投标文件格式", "响应文件格式", "投标文件样表",
       "样表", "格式", "范本", "表格", "附件",
       "投标文件", "响应文件", "投标书", "标书格式",
       "投标资料", "报价文件", "商务标", "技术标",
       "资格文件", "投标材料"
   ]
   ```

2. **增强表格识别**
   - 检测表格第一行是否包含标题
   - 识别"附件X：xxx"格式的标题

3. **放宽定位范围**
   - 不仅限于"投标文件格式"章节
   - 搜索整个文档后半部分

---

### 方案6: 使用内置范本库（兜底）⭐⭐⭐

**说明**: 
- 系统已实现**内置范本库**作为兜底
- 包含常见的投标函、授权书、报价表等8种类型
- 当范本提取失败时自动启用

**验证是否使用了内置库**:
```bash
# 查看日志
docker-compose logs backend | grep "使用内置范本库" | tail -20

# 或查看填充来源
docker-compose logs backend | grep "BUILTIN_SAMPLE" | tail -20
```

**内置范本的优缺点**:
- ✅ 优点：保证基本功能可用
- ✅ 优点：覆盖常见的8种类型
- ❌ 缺点：非项目特定，通用性内容
- ❌ 缺点：无法包含特殊要求的格式

---

## 📊 诊断流程图

```
上传招标书 DOCX
    ↓
提取 body 元素
    ↓
[规则定位] 查找"投标文件格式"章节
    ↓
    ├─ 找到 → 提取片段 → 入库
    │          ↓
    │       检查数量 > 0？
    │          ↓
    │       ✅ 成功
    │
    └─ 未找到 → [LLM定位] 语义识别
               ↓
            检查 LLM spans > 0？
               ↓
               ├─ 是 → 入库 → ✅ 成功
               │
               └─ 否 → [内置范本库]
                       ↓
                    ⚠️ 使用通用范本
```

---

## 🔧 快速修复步骤

### Step 1: 验证文档（5分钟）

```bash
# 1. 打开DOCX，搜索关键词
Ctrl+F → "投标文件格式"

# 2. 尝试复制内容
选中一段文字 → Ctrl+C → 粘贴到记事本

# 3. 如果是图片或无法复制
❌ 需要转换为可编辑文档
```

---

### Step 2: 查看提取日志（5分钟）

```bash
# 1. 连接到服务器
cd /aidata/x-llmapp1

# 2. 查看最近的auto_fill_samples日志
docker-compose logs backend | grep -A 30 "auto_fill_samples" | tail -100

# 3. 查找关键信息
# - upserted_fragments: X （应该 > 0）
# - warnings: [...]       （查看警告信息）
```

---

### Step 3: 尝试重新提取（2分钟）

```bash
# 前端操作
1. 点击"自动填充范本"按钮
2. 观察提示信息：
   - "本次抽取 X 条范本" → X 应该 > 0
   - "未能抽取到范本片段" → 失败，需要诊断
```

---

### Step 4: 应用解决方案

根据诊断结果选择：

**如果是文档格式问题**:
→ 使用OCR转换后重新上传

**如果是标题识别问题**:
→ 查看日志，确认是否需要优化关键词

**如果是LLM未生效**:
→ 检查LLM API配置，查看错误日志

**如果无法解决**:
→ 使用内置范本库（系统自动）

---

## 💡 最佳实践建议

### 上传招标书时

1. ✅ **使用可编辑的DOCX**（不是PDF扫描件）
2. ✅ **文件名清晰**（如：招标文件-XX项目.docx）
3. ✅ **确保完整性**（包含"投标文件格式"章节）
4. ✅ **标准格式**（标题使用Heading样式）

### 遇到问题时

1. 🔍 **先查看日志**（docker-compose logs）
2. 🔍 **手动检查文档**（搜索关键词）
3. 🔍 **验证文字可复制**（复制粘贴测试）
4. 🔍 **查看提取数量**（upserted_fragments）

### 报告问题时

提供以下信息：
- 📋 招标书文件名
- 📋 "投标文件格式"章节的位置（页码）
- 📋 提取日志（upserted_fragments、warnings）
- 📋 是否能复制文字

---

## 📞 技术支持

### 常见问题FAQ

**Q1: 为什么我的招标书提取不到范本？**
A: 最常见原因是：文档是扫描件（图片），建议用OCR转换。

**Q2: 内置范本库和实际提取有什么区别？**
A: 内置范本是通用模板，实际提取的是项目特定的格式要求。

**Q3: LLM定位比规则匹配更准确吗？**
A: 是的，LLM能理解语义，但成本略高，建议作为增强手段。

**Q4: 如何判断范本是否提取成功？**
A: 查看"自动填充范本"按钮的提示："本次抽取 X 条范本"，X > 0 即成功。

**Q5: 提取失败会影响目录生成吗？**
A: 不会。目录生成和范本提取是独立的，提取失败会使用内置范本库。

---

## 🔮 未来优化方向

### 短期（1周内）

1. ✅ **增强日志输出**
   - 显示具体的失败原因
   - 提供更明确的用户提示

2. ✅ **优化关键词匹配**
   - 扩展同义词表
   - 支持更多变体

### 中期（1月内）

1. 🔄 **改进LLM定位**
   - 降低置信度阈值（0.55 → 0.4）
   - 增加LLM重试机制

2. 🔄 **增强表格识别**
   - 专门处理表格内的标题
   - 识别"附件X"格式

### 长期（3月内）

1. 🎯 **智能文档预处理**
   - 自动检测文档类型
   - OCR集成（处理扫描件）

2. 🎯 **用户反馈机制**
   - 允许用户手动标注范本位置
   - 学习用户反馈，改进算法

---

**文档版本**: v1.0  
**创建时间**: 2025-12-25  
**适用场景**: 范本提取失败诊断与解决

