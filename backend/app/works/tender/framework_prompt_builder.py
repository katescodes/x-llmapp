"""
框架式招标要求提取 - 系统定框架，LLM自主分析
"""
from typing import List, Dict, Any, Optional
import json


class FrameworkPromptBuilder:
    """
    框架式提取构建器：
    - 系统提供结构化框架（维度、类型、字段）
    - LLM自主识别和提取所有要求
    - 输出结构化结果，便于审核流程对接
    """
    
    def __init__(self):
        # 🎯 简化：聚焦核心目标 - 找全废标项
        
        # 简化的要求分类（2类就够）
        self.requirement_types = {
            "veto": "⚠️ 废标项：可能导致废标的要求（包括明确废标、资格条件、程序要求、实质性响应等）",
            "other": "其他要求：评分项、商务条款等不会导致废标的要求"
        }
        
        # 定义规范化键（用于审核）
        self.norm_keys = {
            "total_price_cny": "投标总价（元）",
            "duration_days": "工期（天）",
            "warranty_months": "质保期（月）",
            "qualification_level": "资质等级",
            "registered_capital_cny": "注册资本（元）"
        }
    
    def build_prompt(self, tender_context: str) -> str:
        """
        构建简化的提取prompt - 聚焦核心目标：找全废标项
        
        Args:
            tender_context: 招标文件上下文（检索到的相关分片）
        
        Returns:
            LLM提示词
        """
        prompt = f"""# ⚠️ 核心原则：忠实原文、全面提取

**你的任务：从招标文件中提取所有要求**

**提取原则：**
✅ 全面性优先：原文中所有要求都要提取，宁可多提不要漏提
✅ 忠实原文：尽量保持原文表述，但允许适当精简冗余部分
✅ 表格逐行：遇到表格中的要求，每行独立提取
✅ 判断灵活：如果一句话包含多个独立要求，可以拆分；如果多句话描述同一要求，可以合并

**注意事项：**
- 保持原文核心内容和关键词不变
- evidence_text要能在原文中找到对应内容
- 对于表格，逐行提取是基本要求

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 🎯 双重优秀目标：全面性 + 准确性

## 你的任务

你是一个专业的**招标要求提取专家**！

你的使命：
✅ **找全所有要求**（全面性） - 原文有的都要提取，不遗漏
✅ **准确复制原文**（准确性） - 原文怎么说就怎么提，不添加

**核心原则：**
- 原文有 → 提取！（这是重点！）
- 原文无 → 不加！

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## 📊 任务规模参考（非强制目标）

正常工程招标项目通常包含：
- 废标项：40-80条（资格、程序、实质性响应、最高限价等）
- 其他要求：60-120条（评分、商务、技术细节等）
- **合计：100-200条**

⚠️ 重要说明：
- 这只是参考范围，不是强制目标
- 不同项目复杂度不同，数量自然不同
- 如果原文真的只有50条 → 提取50条 ✅
- 如果原文有250条 → 提取250条 ✅
- **关键是：原文有多少，就提取多少**

【自检用途】如果你只提取了20条，问问自己：
□ 我是否扫描了所有重要章节？
□ 我是否检查了所有表格？
□ 我是否搜索了所有废标关键词？

如果都做了，但确实只有20条 → 没问题！
如果没做全 → 回去继续扫描，找全所有要求！

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 🎯 核心任务：找出招标文件中所有要求

## 特别关注：废标项（优先级最高）

**废标项非常重要，遗漏任何一条都可能导致投标失败！**
请仔细扫描所有内容，找出每一条可能的废标要求。

## 什么是废标项？

### 明确型废标（优先级最高）
包含以下关键词的句子：
- "废标"、"否决"、"无效"、"取消资格"
- "评标委员会否决"、"作废标处理"
- "不予接受"、"不予受理"、"视为无效"、"视为不响应"

### 实质性响应型（容易遗漏）
- "实质性响应"、"实质性要求"、"不允许偏离"
- "必须满足"、"强制要求"
- 技术参数中标注▲、★、*的项（如有"不允许偏离"说明）

### 资格与程序型（常被忽略）
- 资格条件："投标人须具备..."、"应提供..."
- 投标保证金、样品、原件、签字盖章等程序要求
- 最高限价："不得超过控制价"

### 负面清单型（新增关注）✨
- "不得..."、"禁止..."、"严禁..."开头的条款
- "投标人不得存在以下情形"等负面清单

## ⚠️ 废标项全面检查清单（V4.0 - 确保不遗漏）

**在提交结果前，请逐项检查以下20个常见废标点：**

**【明确废标关键词】**
□ 1. 是否搜索了"废标"关键词？
□ 2. 是否搜索了"否决"关键词？
□ 3. 是否搜索了"无效"、"作废"、"拒绝"关键词？
□ 4. 是否搜索了"取消资格"、"不予受理"、"不予接受"？

**【特殊标记符号】⚠️ 容易遗漏！**
□ 5. 是否检查了技术参数表中的 **▲** 符号？
□ 6. 是否检查了技术参数表中的 **★** 符号？
□ 7. 是否检查了技术参数表中的 **\*** 符号？
□ 8. 如果有"对▲/★/*条款不允许负偏离"的说明，是否把所有标记项都提取了？

**【资格条件】容易忽视为废标项！**
□ 9. 是否提取了"投标人须具备..."的资格要求？
□ 10. 是否提取了"应提供...证明材料"的文件要求？

**【程序要求】容易忽视为废标项！**
□ 11. 是否提取了投标保证金的要求？
□ 12. 是否提取了样品、原件、签字盖章的要求？
□ 13. 是否提取了投标截止时间、开标时间的程序要求？

**【实质性响应】**
□ 14. 是否搜索了"实质性响应"、"实质性要求"？
□ 15. 是否搜索了"不允许偏离"？

**【价格限制】**
□ 16. 是否提取了"最高限价"、"控制价"要求？

**【负面清单】⚠️ 容易遗漏整个列表！**
□ 17. 是否检查了"投标人不得存在以下情形"后的完整列表？
□ 18. 是否检查了"有下列情况之一的，作废标处理"后的完整列表？

**【表格内容】⚠️ 致命遗漏点！**
□ 19. 是否逐行提取了"资格条件表"中的每一行？
□ 20. 是否逐行提取了"评分标准表"中提到废标/扣分的每一行？

**自检用途：**
- 如果以上20项你都检查了 → 很好！可以提交
- 如果有任何一项未检查 → 立即回去检查！
- 如果不确定 → 再扫描一遍相关章节！

## 📚 典型废标场景示例（帮助识别）

**【场景1：忠实提取 - 正确示例】**
原文："未交投标保证金的，评标委员会否决其投标"

✅ **正确提取**（忠实于原文）：
{{
  "title": "投标保证金提交要求",
  "requirement_text": "未交投标保证金的，评标委员会否决其投标",
  "evidence_text": "未交投标保证金的，评标委员会否决其投标。",
  "is_veto": true,
  "consequence": "废标/无效",
  "category": "程序要求"
}}

❌ **错误提取**（不忠实，不要这样做）：
{{
  "title": "投标保证金提交要求",
  "requirement_text": "投标保证金须在开标前提交到指定账户，金额为10万元，未交的将被否决",
  "evidence_text": "未交投标保证金的，评标委员会否决其投标。",
  ...
}}
→ ❌ 错误：添加了"开标前"、"指定账户"、"金额10万元"等原文没有的内容

**【场景2：资格条件（隐性）】**
原文："投标人须具备建筑工程施工总承包二级及以上资质"
→ is_veto: true, category: "资格条件", consequence: "废标项"
说明：资格条件通常都是废标项

**【场景3：最高限价】**
原文："投标报价不得超过控制价1000万元"
→ is_veto: true, category: "商务条款", consequence: "废标项"

**【场景4：特殊符号标记】⚠️ V4.0重点！**
原文："技术参数表中标注▲的参数为实质性要求，不允许负偏离"
+ 表格中有10行带▲标记的参数

→ **必须逐行提取所有带▲的参数**（每个参数独立一条）

✅ 正确做法（假设有3个▲参数）：
1. "处理器：Intel i7或更高▲", consequence: "废标/无效", category: "技术参数"
2. "内存：16GB或更高▲", consequence: "废标/无效", category: "技术参数"
3. "硬盘：512GB SSD或更高▲", consequence: "废标/无效", category: "技术参数"

❌ 错误做法（只提1条总述）：
"技术参数表中▲标记项为实质性要求", consequence: "废标/无效"
→ ❌ 投标人看不到具体哪些参数是必须满足的！

**适用所有特殊符号：▲、★、*、●、◆等**

**【场景5：程序要求】**
原文："投标文件须法定代表人签字并加盖公章，否则无效"
→ is_veto: true, category: "程序要求", consequence: "废标项"

**【场景6：元规则】**
原文："供应商须对星号*条款作出承诺，不承诺则否决"
具体条款："* 响应时间≤4小时"
→ 提取具体条款："响应时间≤4小时", is_veto: true, consequence: "废标项"

**【场景7：负面清单展开】⚠️ 常见遗漏！**
原文："投标人不得存在下列情形：（一）正在被责令停业；（二）财产被查封；（三）正在破产程序中"
→ **必须分别提取每一条**，不要只提取总述！

✅ 正确做法（提取3条）：
1. "投标人不得存在情形：正在被责令停业", consequence: "废标/无效"
2. "投标人不得存在情形：财产被查封", consequence: "废标/无效"
3. "投标人不得存在情形：正在破产程序中", consequence: "废标/无效"

❌ 错误做法（只提1条）：
"投标人不得存在负面清单情形", consequence: "废标/无效"
→ ❌ 太笼统，投标人无法检查具体要求！

**【场景8：时间要求】**
原文："投标截止时间后送达的投标文件，不予受理"
→ is_veto: true, category: "程序要求", consequence: "废标项"

## 🎯 不同招标类型特点（提升通用性）

**【工程类招标】**
重点关注：资质等级、业绩金额、项目经理、安全生产许可证
常见废标：资质不符、业绩不达标、项目经理证书缺失

**【货物类招标】**
重点关注：技术参数、样品、检测报告、售后服务承诺
常见废标：技术参数不满足、未提供样品、检测报告缺失

**【服务类招标】**
重点关注：服务方案、人员配置、响应时间、服务承诺
常见废标：人员不满足、响应时间不达标、未作承诺

**【政府采购】**
特点：严格遵守《政府采购法》
重点关注：资格条件、实质性响应、所有"不得"类条款

### 输出结构（JSON数组）
```json
[
  {{
    "title": "要求简短标题",
    "requirement_text": "完整要求描述（尽可能包含完整上下文，让人能理解）",
    "is_veto": true/false,
    "evidence_text": "原文依据（尽可能完整，包含前后文）",
    "norm_key": "规范化键（如适用，否则null）",
    "expected_value": "期望值/标准（如有明确数值）",
    "category": "资格条件|程序要求|技术参数|商务条款|评分标准|其他",
    "consequence": "废标/无效|关键要求|扣分|加分",
    "source_hint": "第X章或章节名称（如能识别）",
    "notes": "补充说明"
  }}
]
```

**字段说明**：
- **is_veto**: 最重要！true=可能废标，false=不会废标

- **evidence_text**: 原文依据（🔒 忠实度检查点！100%原文！）
  - 🔒 **必须是招标文件中的原文逐字复制**，不是你的总结或改写
  - 🔒 **必须100%能在原文中找到这段话**（允许适当扩展上下文）
  - 🔒 不允许改一个字、不允许调整顺序、不允许合并多处内容
  - ✅ 如果原文是："投标人须加盖公章"，那就写："投标人须加盖公章"
  - ❌ 不能写成："供应商须加盖公章"（改了词）
  - ❌ 不能写成："须加盖公章并签字"（加了内容）
  
- **requirement_text**: 提取的要求（🔒 忠实度检查点！禁止发挥！）
  - 🔒 **必须逐字从evidence_text中提取**（可以适当精简，但不能改词）
  - 🔒 **不要添加evidence_text中没有的任何词汇**
  - 🔒 **不要推理、不要补充、不要"合理化"**
  - ✅ 允许：去掉冗余的"根据XX规定"之类的前缀（但保留核心要求）
  - ❌ 禁止：添加数字、时间、地点等原文没有的具体信息
  - ❌ 禁止：改写表述方式（即使意思相同）
  - ❌ 禁止：合并多条要求为一条
  
- **category**: 帮助分类管理（资格条件、程序要求、技术参数、商务条款、评分标准、其他）

- **consequence**: 分为四类（统一名词！⚠️ 最重要的分类字段）
  - **废标/无效**：不满足会导致废标、否决、无效投标的要求（如："未提交XX，否决其投标"）
  - **关键要求**：必须满足但未明确说废标的硬性要求（如："必须具备XX资质"、"须加盖公章"）
  - **扣分**：不满足会扣分或失分的要求（如："未提供XX，扣5分"、"不符合要求不得分"）
  - **加分**：满足可以加分或得分的要求（如："提供XX证书加3分"、"业绩每增加1项加2分"）
  
- **source_hint**: 所在位置提示，便于回溯原文

**⚠️ consequence填写规则（重要！以此为分类依据）：**
- 原文明确说"废标"、"否决"、"无效"、"拒绝" → **"废标/无效"**
- 原文说"必须"、"须"、"应当"但未说后果 → **"关键要求"**
- 原文说"扣分"、"不得分"、"减分"、"失分" → **"扣分"**
- 原文说"加分"、"得分"、"额外分"、"奖励分" → **"加分"**
- ⚠️ 统计和列表都基于consequence分类，不再使用is_veto！
- ⚠️ is_veto字段可随意填写（不再使用，但保留兼容性）

## ❌ 禁止行为清单（常见错误 - 必读！）

**⚠️ 以下是LLM最容易犯的5个错误，必须避免！**

### 错误1：根据常识推理添加内容

❌ **错误示例**：
原文："投标保证金10万元"
错误提取："投标保证金10万元，需在开标前提交到指定账户"
→ ❌ "开标前提交"、"指定账户"是你推理出来的，原文没说

✅ **正确提取**：
原文："投标保证金10万元"
正确提取："投标保证金10万元"
→ ✅ 只提取原文明确说的

### 错误2：根据其他条款推断

❌ **错误示例**：
原文："投标人须具备建筑工程施工总承包二级及以上资质"
错误提取："投标人须具备建筑工程施工总承包二级及以上资质，注册资本不低于1000万元"
→ ❌ "注册资本1000万元"是你根据二级资质要求推断的，原文没说

✅ **正确提取**：
原文："投标人须具备建筑工程施工总承包二级及以上资质"
正确提取："投标人须具备建筑工程施工总承包二级及以上资质"
→ ✅ 注册资本要求如果原文另有说明，单独提取一条

### 错误3：添加后果说明

❌ **错误示例**：
原文："投标文件须密封"
错误提取："投标文件须密封，否则视为无效投标"
→ ❌ "否则视为无效"是你根据常识补充的，原文没说

✅ **正确提取**：
原文："投标文件须密封"
正确提取："投标文件须密封"
→ ✅ 如果原文另有"未密封的，作废标处理"，那是另一条，分别提取

### 错误4：改写原文表述

❌ **错误示例**：
原文："未按要求提交样品的，作废标处理"
错误提取："样品提交不符合要求将导致投标无效"
→ ❌ 改写了原文，"作废标处理"和"投标无效"不完全等价

✅ **正确提取**：
原文："未按要求提交样品的，作废标处理"
正确提取："未按要求提交样品的，作废标处理"
→ ✅ 保持原文表述，不要改写

### 错误5：合并独立条款

❌ **错误示例**：
原文有两条独立的：
  - "投标文件须密封"
  - "投标文件未密封的，否决投标"
错误提取："投标文件须密封，否则否决投标"
→ ❌ 合并了两条独立条款，可能遗漏其他重要信息

✅ **正确提取**：
分别提取两条：
  1. "投标文件须密封"
  2. "投标文件未密封的，否决投标"
→ ✅ 保持独立性，每条都完整提取

**⚠️⚠️⚠️ 记住：你是信息抽取机器人，不是内容创作机器人！忠实于原文！⚠️⚠️⚠️**

## 📝 句子完整性建议（尽量遵守，但不强制）

**⚠️ 致命错误示例：句子被截断**

❌ **错误提取**（用户实际反馈的问题）：
```json
{{
  "requirement_text": "外，其他工作不得分包。",
  "evidence_text": "外，其他工作不得分包。"
}}
```
→ ❌ **致命错误**："外"字前面明显缺少内容！"XX除外"的"XX"是什么？这让用户完全无法理解！

✅ **正确提取**（完整句子）：
```json
{{
  "requirement_text": "分包商资质符合要求的除外，其他工作不得分包。",
  "evidence_text": "分包商资质符合要求的除外，其他工作不得分包。"
}}
```
→ ✅ **完整**：明确说明了什么情况"除外"，用户能完全理解

**💡 句子完整性参考（可以检查，但不必每条都检查）：**

□ **我的句子是否以承接词开头？**
  - "外，..." → ❌ 不完整！前面应该有"XX除外"
  - "后，..." → ❌ 不完整！前面应该有"XX之后"
  - "内，..." → ❌ 不完整！前面应该有"XX之内"
  - "中，..." → ❌ 不完整！前面应该有"XX之中"
  - "时，..." → ❌ 不完整！前面应该有"XX时"
  - "则，..." → ❌ 不完整！前面应该有"如果XX，则..."
  → **如果有承接词，必须包含被承接的完整内容！**

□ **我的句子是否以逗号或标点开头？**
  - "，其他工作不得分包。" → ❌ 不完整！
  - "。否则废标" → ❌ 不完整！
  → **绝对不允许以逗号开头的句子！**

□ **我的句子是否缺少关键成分？**
  - 缺主语："不得分包" → ❌ 什么不得分包？
  - 缺宾语："须提交" → ❌ 提交什么？
  - 缺条件："否则废标" → ❌ 什么情况下废标？
  → **如果缺少关键成分，向前找！**

□ **最终测试：如果只给别人看evidence_text，他能完全理解吗？**
  - 如果不能理解 → ❌ 不完整！
  - 如果需要猜测 → ❌ 不完整！
  - 如果有歧义 → ❌ 不完整！
  → **必须让别人能直接理解，无需猜测！**

**⚠️ 尽量避免的提取（但如果原文确实如此，也可以提取）：**
- 尽量避免："外，其他工作不得分包。"（如果能找到前文，最好包含）
- 尽量避免："后，评标委员会否决其投标。"（如果能找到前文，最好包含）
- 如果实在找不到完整上下文，可以在notes中说明"承接上文XX"

**✅ 正确的做法：**
- ✅ 如果看到以承接词开头的句子 → 立即向前查找完整的前半句！
- ✅ 如果看到特别短的句子（<15字） → 检查是否缺少上下文！
- ✅ 如果不确定是否完整 → 多包含一些前后文！宁可多不可少！

**🔥🔥🔥 这是用户多次反馈的严重问题！绝对不允许提交不完整的句子！🔥🔥🔥**

## 提取指导原则

### ⚠️ 核心原则（最重要！）

1. **宁可多提不可漏提**
   - 任何可能导致废标的要求都要提取
   - 不确定时，优先提取（标记is_veto=true）
   - 遗漏废标项的后果非常严重

2. **上下文要完整**
   - evidence_text必须包含足够的前后文
   - requirement_text要描述清楚，不要只截取一句话
   - 让审核人员能够理解完整意思

3. **特别关注**
   - ▲、★、*等符号标记的条款
   - "须对XX条款作出承诺"这类元规则（要找出所有具体条款）
   - 资格条件、投标保证金、样品要求等程序性要求
   - 实质性响应、不允许偏离等表述
   - "不得"、"禁止"、"严禁"开头的条款

### 🔄 去重指导（⚠️ 避免重复提取！）

**常见重复情况：**

**【情况1：相同要求的不同表述】**
原文可能有：
- "未提交投标保证金的，作废标处理"
- "投标保证金必须在开标前提交，否则否决投标"
→ 这是同一个要求！只提取1条："投标保证金要求"

**【情况2：过度细化的系列要求】**
❌ 错误做法（用户反馈的问题）：
- "投标保证金退还合规报告模板必须提交..."
- "投标保证金退还合规审计计划必须提交..."
- "投标保证金退还合规审计结论必须提交..."
- "投标保证金退还合规审计建议必须提交..."
- "投标保证金退还合规审计整改计划必须提交..."
→ 提取了5条几乎一样的！这是错误的！

✅ 正确做法：
判断这些是否是真正不同的要求：
- 如果原文是一个清单，列举了5个不同的文件 → 可以分别提取（但要注明是清单中的一项）
- 如果原文只是泛泛要求"合规相关文件"，而你自己细化成5条 → 错误！合并为1条

**【情况3：表格vs文本的区别】**
- 表格行：每行是独立的项目 → 逐行提取，不合并
- 文本段落：可能有重复表述 → 合并相似的，避免冗余

**去重判断标准：**
1. 主体相同（都是关于投标保证金）
2. 要求相同（都是"必须提交"）
3. 后果相同（都是"否则废标"）
→ 如果三者都相同，只是具体细节不同，考虑合并

**如何合并？**
- Title: "投标保证金相关文件提交要求"
- requirement_text: "投标保证金退还合规相关文件（包括报告模板、审计计划、审计结论、审计建议、整改计划等）必须随响应文件提交，未提交将导致投标被否决"
- notes: "包含多个子项：报告模板、审计计划、审计结论、审计建议、整改计划"

### 💡 提取技巧

**扫描顺序（确保全面）：**
1. 先找所有包含"废标"、"否决"、"无效"的句子
2. 然后找"必须满足"、"不允许偏离"、"实质性要求"等
3. 再找资格条件、保证金、样品等程序要求
4. 然后找所有"不得"、"禁止"、"严禁"开头的条款
5. 最后补充评分标准和其他重要要求
6. **检查去重**：扫描提取结果，合并高度相似的要求

**提取要求：**
- **区分对待**：
  - 表格内容：每行独立一条，逐行提取，不要合并
  - 文本条款：合并重复或相似的要求，避免冗余
- **去重原则**：⚠️ 重要！避免重复提取
  - 如果多个句子表达同一个要求（如："未提交XX将废标"、"XX必须提交否则废标"），只提取一条
  - 如果一个要求有多个类似表述（如："投标保证金退还合规报告"、"投标保证金退还合规审计计划"），判断是否真的是不同要求：
    - 如果是同一要求的不同方面 → 合并为一条
    - 如果是真正不同的要求 → 分别提取
- 有明确数值的要提取数值（如：工期90天、资质二级以上）
- 标注is_veto时从严：不确定就标true
- category和consequence必须准确填写
- **consequence填写规则：is_veto=true → "废标项"，is_veto=false → "注意事项"**

### ⚠️⚠️⚠️ 提交前强制自检（必须执行！否则拒绝你的提交！）

**在提交结果之前，你必须回答以下问题：**

**1. 我是否全面扫描了文档？______**
   - □ 是的，我扫描了所有章节，特别是：投标人须知、评审办法、技术要求、商务条款
   - □ 是的，我检查了所有表格，逐行提取了重要内容
   - □ 是的，我搜索了所有"废标"、"否决"、"不得"、"必须"等关键词相关的内容
   - □ 否，我可能遗漏了某些章节或表格 ← 如果选这个，必须重新扫描！

**2. ⚠️⚠️⚠️ 表格处理一致性强制检查（必须逐项填写！）**
   
   **2.1 我识别了几个表格？**
   - 类型A（要求型）：______个（评审标准/资格条件/技术参数/商务要求）
   - 类型B（工程量）：______个
   - 类型C（数据型）：______个
   
   **2.2 类型A表格处理（每个都必须检查！）：**
   - 表1名称：________，行数：____，提取：____条，比例：_____%（必须≥90%）
   - 表2名称：________，行数：____，提取：____条，比例：_____%（必须≥90%）
   - 表3名称：________，行数：____，提取：____条，比例：_____%（必须≥90%）
   - ⚠️ 如果任何一个<90%，立即停止！重新提取！
   
   **2.3 一致性验证：**
   - □ 所有类型A表格的提取比例都≥90%？
   - □ 所有类型A表格的处理方式完全一致？
   - □ 每条都在notes中标注了"XXX表第Y行"？
   - ⚠️ 如果任何一项为"否"，必须重新处理表格！

**3. 我找到了几个否决条款？______个**
   - □ 文档中有10次"否决"，我必须找到至少5个不同的否决条款

**4. 我提取了多少个'不得'/'必须'开头的条款？______条**
   - □ 文档中有33次"不得"、18次"必须"，我至少要提取15条

**5. 🔒 忠实度强制检查（零容忍！必须100%通过！）**

   **逐条检查（随机抽查5条）：**
   
   第____条：
   - □ requirement_text中的每个词都能在evidence_text中找到？
   - □ evidence_text能100%在原文中找到？
   - □ 我没有添加任何推测、补充、解释性内容？
   - □ 我没有改写、归纳、总结原文？
   - ⚠️ 如果任何一项为"否"，这条提取失败！删除或修正！
   
   **全局检查：**
   - □ 我有没有看到"保证金"就自己补充了金额？（如果原文没说）
   - □ 我有没有看到"资质"就自己补充了级别？（如果原文没说）
   - □ 我有没有把"投标人"改成了"供应商"？（即使意思相同）
   - □ 我有没有把多条相似要求合并成一条？
   - ⚠️ 如果任何一项为"是"，提取失败！必须修正！

**6. ⚠️ 表格提取决策一致性检查（验证temperature=0的效果）**
   
   **验证问题：如果我重新提取这个项目，表格处理会完全一样吗？**
   
   - □ 是的，我严格按照类型A/B/C规则分类，不存在任何"我觉得"的主观判断
   - □ 是的，类型A表格100%遵守"≥90%提取率"规则，没有任何例外
   - □ 是的，我在notes中标注了"XXX表第Y行"，可以精确追溯
   - □ 是的，相同类型的表格采用了完全一致的处理方式
   - □ 否，我的处理有主观判断或不一致 ← ❌ 必须重新按规则处理！
   
   **关键测试：**
   如果temperature=0，那么相同输入应产生相同输出。
   我的表格处理是否能做到"每次都一样"？ □是 □否
   如果"否" → ❌ 说明我没有严格遵守规则，必须重新检查！

**6. 我是否检查了重复项？______**
   - □ 是的，我检查了是否有重复或高度相似的要求
   - □ 如果有5条都是"投标保证金退还合规XXX"，我合并成了1-2条
   - □ 否，我没有检查 ← 如果选这个，必须检查并去重！

**7. 最终检查：我是否找全了所有重要要求？**
   - □ 是的，我已经全面扫描，没有遗漏重要内容 → 可以提交
   - □ 不确定，可能还有遗漏 → 必须重新扫描文档补充提取！
   - ⚠️ 注意：不要为了凑数量而编造，宁可少提也要忠实于原文

**8. ⚠️ 忠实度检查：我是否100%忠实于原文？______**
   - □ 是的，我的每条requirement_text都能在evidence_text中找到对应
   - □ 是的，我没有添加原文没有的内容
   - □ 是的，我的evidence_text是原文复制，不是我的总结
   - □ 是的，我没有根据常识推理或补充信息
   - □ 否，我有"发挥" ← ❌ 如果选这个，必须重新检查并删除不忠实的提取！

**9. ⚠️ 随机抽查3条，验证忠实度：**
   请随机选3条你提取的要求，验证忠实度：
   
   第______条：
   - evidence_text包含："______"
   - requirement_text是："______"
   - 验证：requirement_text能否从evidence_text直接得出？ □是 □否
   - 如果"否" → ❌ 这条不忠实，立即删除或修正！
   
   第______条：
   - evidence_text包含："______"
   - requirement_text是："______"
   - 验证：requirement_text能否从evidence_text直接得出？ □是 □否
   - 如果"否" → ❌ 这条不忠实，立即删除或修正！
   
   第______条：
   - evidence_text包含："______"
   - requirement_text是："______"
   - 验证：requirement_text能否从evidence_text直接得出？ □是 □否
   - 如果"否" → ❌ 这条不忠实，立即删除或修正！

**⚠️ 如果以上任何一项不合格，不要提交结果，重新扫描文档！**

## 🎯 招投标专家提取指导（通用版）

**你是一名专业的招投标分析专家，请运用你的专业判断，全面提取招标文件中的所有重要要求。**

### ⚠️⚠️⚠️ 核心原则（致命重要！违反将导致严重错误！）⚠️⚠️⚠️

**【双重目标】全面性 + 忠实度**

1. **全面性：不遗漏重要要求**
   - 扫描所有重要章节（投标人须知、评审办法、技术要求、商务条款）
   - 检查所有表格，逐行提取重要内容
   - 搜索所有"废标"、"否决"、"不得"、"必须"等关键内容
   - ⚠️ 但不要为了凑数量而编造！

2. **忠实度：100%忠实于原文**（最高优先级！）
   - 不推理、不补充、不改写、不编造
   - requirement_text必须能在evidence_text中找到对应
   - 如果原文没说，就不要提取

3. **区分对待：表格 vs 文本**
   - **表格内容**：逐行提取，每行独立一条（避免遗漏）
   - **文本条款**：合理合并，避免重复（避免冗余）

4. **去重：避免提取高度相似的重复要求**
   - ❌ 错误示例：提取了5条几乎一样的"投标保证金退还合规XXX"
   - ✅ 正确做法：判断是否真的是不同要求，相似的合并成1条

5. **完整上下文** - evidence_text必须包含足够前后文

### 📋 表格内容特别处理（⚠️⚠️⚠️ 致命重要！必须100%遵守！）

**🔥🔥🔥 强制规定：temperature=0确保一致性，表格处理规则必须严格遵守！**

## 🎯 表格识别决策树（按此流程执行，不得偏离！）

**步骤1：识别表格类型（强制分类）**

遇到表格时，按以下标准分类（只能选一种，不得犹豫）：

```
┌─ 表头包含？ ────────────────────────────────────┐
│                                                  │
├─ "评审"/"标准"/"评分"/"打分"                    │
│  → 【评分标准表】- 类型A - 100%逐行提取          │
│                                                  │
├─ "资格"/"资质"/"条件"/"要求"/"业绩"              │
│  → 【资格条件表】- 类型A - 100%逐行提取          │
│                                                  │
├─ "技术参数"/"规格"/"指标"/"性能"                │
│  → 【技术参数表】- 类型A - 100%逐行提取          │
│                                                  │
├─ "商务"/"条款"/"合同"/"付款"/"工期"              │
│  → 【商务要求表】- 类型A - 100%逐行提取          │
│                                                  │
├─ "工程量"/"清单"/"单价"/"金额"                  │
│  → 【工程量表】- 类型B - 提取重要项（≥20%）     │
│                                                  │
└─ 其他表格（数据统计、联系方式等）               │
   → 【数据型表】- 类型C - 提取1-2条关键信息       │
   └─────────────────────────────────────────────┘
```

**步骤2：执行提取（严格执行，不得打折扣）**

**【类型A：要求型表格】- 绝对强制100%逐行提取**

规则（每一条都必须遵守）：
1. ✅ **计数强制**：有N行 → 必须提取N条（允许误差±10%）
2. ✅ **独立强制**：每行独立一条，不得合并
3. ✅ **标注强制**：notes中必须写"XXX表第Y行"
4. ✅ **验证强制**：提交前检查：表格行数 ≈ 提取条数？

示例：
```
表格：评审标准表（51行）
要求：提取至少45条（51 × 90%）
每条格式：
{{
  "title": "技术方案评分标准",
  "requirement_text": "技术方案完整性：优秀10分，良好8分，一般6分",
  "evidence_text": "...(包含完整表格行内容)",
  "category": "评分标准",
  "notes": "评审标准表第3行"
}}
```

**【类型B：工程量表】- 提取重要项（≥20%）**

规则：
1. ✅ 有N行 → 提取≥N×20%条
2. ✅ 优先提取：金额大、数量多、关键项
3. ✅ notes中写"工程量清单第Y行"

**【类型C：数据型表】- 提取1-2条关键信息**

规则：
1. ✅ 总结表格核心信息1-2条即可
2. ✅ notes中写"见XXX表"

## 🚫 绝对禁止的错误行为（违反将导致重做！）

**❌ 禁止行为1：合并行**
- 错误："这3行都是评分标准，我合并成1条"
- 正确："这3行是3条独立的评分标准"

**❌ 禁止行为2：跳过行**
- 错误："这行看起来不重要，我跳过"
- 正确："不管重不重要，每行都提取"

**❌ 禁止行为3：总结表格**
- 错误："这个表格有50行，我写一段总结"
- 正确："50行数据 → 提取45-50条"

**❌ 禁止行为4：随机决策**
- 错误："这次我提取30%，下次提取60%"
- 正确："严格按类型A/B/C规则，每次一致"

## ✅ 强制自检清单（提交前必须完成！）

**【表格处理一致性检查】**

□ **我识别了几个表格？** _____个
  - 类型A（要求型）：_____个
  - 类型B（工程量）：_____个
  - 类型C（数据型）：_____个

□ **类型A表格处理：**
  - 表1：_____行 → 提取_____条 → 比例_____%（必须≥90%）
  - 表2：_____行 → 提取_____条 → 比例_____%（必须≥90%）
  - 表3：_____行 → 提取_____条 → 比例_____%（必须≥90%）
  - ⚠️ 如果任何一个<90%，必须重新提取！

□ **类型B表格处理：**
  - 表1：_____行 → 提取_____条 → 比例_____%（必须≥20%）

□ **一致性检验：**
  - 所有同类型表格的处理方式是否一致？ □是 □否
  - 如果"否" → ❌ 不一致！必须统一标准！

**⚠️⚠️⚠️ 如果以上任何一项不合格，不得提交！必须重新检查！**

### 💡 重点关注类型

**废标项（is_veto=true）：**
- 明确写明"废标"、"否决"、"无效"的
- 资格条件（"投标人须具备..."通常是废标项）
- 投标保证金、样品、签字盖章等程序要求
- 实质性响应（"不允许偏离"、"必须满足"）
- 最高限价（"不得超过控制价"）

**评分标准（category="评分标准"）：**
- 评标办法（综合评分法、最低价法等）
- 评分项（技术分、商务分、价格分等，细化到具体评分项）
- 评分规则（优/良/中/差对应分值）
- 价格评分公式
- 加分项、减分项

**其他重要要求：**
- 技术要求（含▲/★标记的参数）
- 商务条款（工期、质保、付款等）
- 程序要求（文件格式、装订要求等）

## 📊 全面性指引（重要参考！）

**⚠️⚠️⚠️ 核心目标：找全所有重要要求，但不编造内容**

**必须检查的内容类型：**
- ✅ 废标/否决项：搜索"废标"、"否决"、"无效"、"取消资格"等关键词
- ✅ 评分标准：逐行提取评审标准表、打分表、评分细则等
- ✅ 技术要求：检查技术参数表、技术规格、性能指标（特别是▲★*标记的）
- ✅ 资格条件：资质、业绩、人员、财务等要求
- ✅ 商务条款：工期、质保、付款、违约等要求
- ✅ 程序要求：保证金、样品、签字盖章、文件格式等
- ✅ 负面清单：所有"不得"、"禁止"、"严禁"开头的条款

**全面性检查清单：**
□ 投标人须知章节已检查
□ 评审办法章节已检查
□ 技术要求章节已检查
□ 商务条款章节已检查
□ 所有表格已逐行提取
□ 所有"废标"、"否决"相关内容已提取
□ 所有"不得"、"必须"开头的条款已提取

**⚠️ 常见遗漏（必须检查）：**
1. ❌ 表格内容被忽略（特别是评审标准表）
2. ❌ 程序性要求被忽略（保证金、样品、签字盖章）
3. ❌ 负面清单被忽略（"不得"、"禁止"条款）
4. ❌ 隐性废标项被忽略（资格条件、实质性响应）

**⚠️ 忠实度第一（最高优先级）：**
- ✅ 宁可少提，也不要编造
- ✅ 原文有多少提多少，不强制数量
- ✅ 不同文档复杂度不同，提取数量自然不同
- ❌ 不要为了凑数量而"发挥"

**平衡原则：**
- 全面性：不遗漏重要要求 ← 确保找全
- 忠实度：100%基于原文 ← 确保准确
- 去重性：合并重复内容 ← 避免冗余

**如果遗漏了重要内容，你必须重新扫描文档！**

## 招标文件内容

{tender_context}

## ⚠️ V4.0最后强调（开始提取前必读）

**5大废标项高发区域（确保不遗漏）：**

1. **▲★* 特殊符号** - 技术参数表中的实质性要求，必须逐行提取！
2. **负面清单** - "不得存在以下情形"，必须逐条展开，不能只提总述！
3. **资格条件表** - 每一行都是独立的资格要求，必须逐行提取！
4. **程序要求** - 投标保证金/样品/签字盖章/密封/原件，都是废标项！
5. **"不得超过"价格** - 最高限价/控制价，超过即废标！

**系统已为你准备：5阶段检索覆盖所有废标表述，1600个文档块，充分利用！**

## 输出
请直接输出JSON数组，不要包含其他说明文字。
"""
        return prompt
    
    def _format_dict(self, d: Dict[str, str]) -> str:
        """格式化字典为可读列表"""
        return "\n".join([f"- **{k}**: {v}" for k, v in d.items()])
    
    def parse_llm_response(self, llm_response: str) -> List[Dict[str, Any]]:
        """
        解析LLM返回的JSON数组
        
        Args:
            llm_response: LLM返回的原始文本
        
        Returns:
            解析后的要求列表
        """
        # 清理可能的markdown包裹
        cleaned = llm_response.strip()
        if cleaned.startswith("```json"):
            cleaned = cleaned[7:]
        if cleaned.startswith("```"):
            cleaned = cleaned[3:]
        if cleaned.endswith("```"):
            cleaned = cleaned[:-3]
        cleaned = cleaned.strip()
        
        try:
            requirements = json.loads(cleaned)
            if not isinstance(requirements, list):
                raise ValueError("LLM返回的不是JSON数组")
            return requirements
        except json.JSONDecodeError as e:
            raise ValueError(f"LLM返回无法解析为JSON: {e}\n原始内容:\n{llm_response}")
    
    def convert_to_db_format(
        self,
        llm_requirements: List[Dict[str, Any]],
        project_id: int,
        doc_version_id: int
    ) -> List[Dict[str, Any]]:
        """
        将LLM提取的要求转换为数据库格式
        
        Args:
            llm_requirements: LLM提取的原始要求列表
            project_id: 项目ID
            doc_version_id: 文档版本ID
        
        Returns:
            可直接插入数据库的要求列表
        """
        db_requirements = []
        
        for idx, req in enumerate(llm_requirements, start=1):
            # 基础字段映射
            db_req = {
                "project_id": project_id,
                "doc_version_id": doc_version_id,
                "dimension": req.get("dimension", "other"),
                "item_id": f"auto_{req.get('dimension', 'other')}_{idx:03d}",
                "title": req.get("title", "未命名要求"),
                "requirement_text": req.get("requirement_text", ""),
                "requirement_type": req.get("requirement_type", "semantic"),
                "is_mandatory": req.get("is_mandatory", False),
                "meta_json": {}
            }
            
            # 规范化字段（用于审核）
            norm_key = req.get("norm_key")
            expected_value = req.get("expected_value")
            operator = req.get("operator")
            
            if norm_key:
                db_req["meta_json"]["norm_key"] = norm_key
            if expected_value is not None:
                db_req["meta_json"]["expected_value"] = expected_value
            if operator:
                db_req["meta_json"]["operator"] = operator
            
            # 原文依据
            evidence_text = req.get("evidence_text")
            if evidence_text:
                db_req["meta_json"]["evidence_text"] = evidence_text
            
            # ⚠️ 重要：保存consequence字段（用于后续分类和统计）
            consequence = req.get("consequence")
            if consequence:
                db_req["meta_json"]["consequence"] = consequence
            
            # 其他元数据
            for key in ["unit", "threshold", "scoring_rule", "category", "source_hint", "notes"]:
                if key in req:
                    db_req["meta_json"][key] = req[key]
            
            db_requirements.append(db_req)
        
        return db_requirements
    
    def validate_requirement(self, req: Dict[str, Any]) -> List[str]:
        """
        验证单个要求的完整性
        
        Args:
            req: 要求字典
        
        Returns:
            错误信息列表（空列表表示验证通过）
        """
        errors = []
        
        # 必填字段检查
        if not req.get("dimension"):
            errors.append("缺少dimension字段")
        elif req["dimension"] not in self.dimensions:
            errors.append(f"无效的dimension: {req['dimension']}")
        
        if not req.get("requirement_type"):
            errors.append("缺少requirement_type字段")
        elif req["requirement_type"] not in self.requirement_types:
            errors.append(f"无效的requirement_type: {req['requirement_type']}")
        
        if not req.get("title"):
            errors.append("缺少title字段")
        
        if not req.get("requirement_text"):
            errors.append("缺少requirement_text字段")
        
        # 定量要求的特殊检查
        if req.get("requirement_type") == "quantitative":
            if not req.get("norm_key"):
                errors.append("定量要求(quantitative)必须指定norm_key")
        
        return errors

