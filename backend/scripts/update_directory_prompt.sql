-- 更新 directory prompt 的幂等脚本
-- 用途：添加通用结构规则到现有 prompt

UPDATE prompt_templates
SET content = content || E'\n\n' || E'【通用结构规则 - 必须遵守】\n\n'
    || E'A. 一级标题规范化（必须）\n'
    || E'- 最终目录的一级标题应为三分册：资信及商务文件、技术文件、报价文件（或"磋商报价文件/报价响应文件"等同义）。\n'
    || E'- 若出现"投标文件/响应文件/磋商响应文件"等总标题，它仅是容器说明：不要把它输出为目录节点（不要占用编号/level）。你应直接输出三分册为 level=1 的节点。\n\n'
    || E'B. 分册语义归类优先于编号（必须）\n'
    || E'- 不得仅因出现 1.3.2 / 3.10 这类编号就把条目挂到"报价文件"。必须根据 title 语义归入正确分册，并用 parent_ref 指向对应分册。\n'
    || E'- 若编号结构与分册语义冲突，允许打散原编号体系：以分册归类正确为准（后续编号由系统重生成）。\n\n'
    || E'C. 评分项材料处理（必须）\n'
    || E'- 评分办法/评审因素中要求提供的证明材料与方案内容，必须拆解为目录节点，并按语义归入对应分册：\n'
    || E'  * 技术分相关 -> 技术文件\n'
    || E'  * 商务/资信分相关 -> 资信及商务文件\n'
    || E'  * 价格分相关 -> 报价文件\n'
    || E'- 禁止生成独立的"得分材料"分册。\n\n'
    || E'D. required 精确限制（避免规则句污染目录）\n'
    || E'- required=true/false 仅用于判断"交付物是否必须提交"；\n'
    || E'- 禁止把"否则无效/废标/否决/截止时间/上传解密"等规则句本身作为 title 节点输出；需要说明写 notes（≤60字）。\n'
WHERE module='directory' 
  AND content NOT LIKE '%【通用结构规则 - 必须遵守】%';
