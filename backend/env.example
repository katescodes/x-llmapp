# ==========================================
# 亿林亿问 Backend 环境变量配置示例
# ==========================================

# ----- LLM 配置 -----
LOCAL_LLM_BASE_URL=http://localhost:8001
LOCAL_LLM_MODEL=local-llm
LOCAL_LLM_ENDPOINT_PATH=/v1/chat/completions
# LOCAL_LLM_API_KEY=your_api_key_here

# 是否启用 Mock 模式（调试用）
MOCK_LLM=true

# ----- 搜索服务配置 -----
SEARXNG_BASE_URL=http://localhost:8080
SEARXNG_ENGINES_ALLOWLIST=wikipedia,github,arxiv

# Google Custom Search Engine (可选)
# GOOGLE_CSE_API_KEY=your_google_cse_api_key
# GOOGLE_CSE_CX=your_google_cse_cx
GOOGLE_CSE_COUNTRY_FILTERS=countryUS,countryCA,countryGB,countryDE,countryFR,countryNL,countrySE,countryFI,countryDK,countryNO,countryIE,countryIT,countryES,countryPT,countryBE,countryAT,countryCH
GOOGLE_CSE_LANGUAGE_RESTRICTIONS=lang_en
GOOGLE_CSE_HL=en
GOOGLE_CSE_MIN_RESULTS_PER_QUERY=30
GOOGLE_CSE_MAX_RESULTS_PER_QUERY=40

# 搜索模式: off, smart, force
SEARCH_MODE=smart
SEARCH_DAILY_WARN=100
SEARCH_DAILY_LIMIT=500
SEARCH_HTTP_TIMEOUT=15

# ----- 爬虫配置 -----
CRAWLER_BLOCKED_DOMAINS=facebook.com,webcache.googleusercontent.com
CRAWLER_DELAY_MIN=0.6
CRAWLER_DELAY_MAX=1.8
CRAWLER_DOMAIN_COOLDOWN=2.5
# CRAWLER_PROXIES=http://proxy1:port,http://proxy2:port

# ----- 数据存储配置 -----
APP_DATA_DIR=./data
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=localgpt
POSTGRES_USER=localgpt
POSTGRES_PASSWORD=localgpt
# POSTGRES_DSN=postgresql://user:pass@host:port/dbname
POSTGRES_POOL_MIN=1
POSTGRES_POOL_MAX=10

# ----- 语音转文字（ASR）配置 -----
ASR_ENABLED=true
# Whisper 模型: tiny, base, small, medium, large-v2, large-v3
ASR_MODEL=base
# 设备: cpu, cuda, auto
ASR_DEVICE=cpu
# 计算类型: int8, float16, float32
ASR_COMPUTE_TYPE=int8
# 语言: zh, en, auto (留空为自动检测)
# ASR_LANGUAGE=zh
ASR_BEAM_SIZE=5

# 音频预处理
ASR_ENABLE_PREPROCESSING=true
ASR_NOISE_REDUCTION=true
ASR_NORMALIZE_AUDIO=true

# 并发控制和重试配置
ASR_MAX_CONCURRENT=1  # 最大并发转录数（建议：先从1开始测试，稳定后可提高到2-3）
ASR_MAX_RETRIES=3     # 失败后最大重试次数
ASR_RETRY_DELAY=10    # 重试延迟（秒）- OOM错误会自动延长
ASR_REQUEST_TIMEOUT=300  # 请求超时（秒）

# 重要提示：
# 1. ASR_MAX_CONCURRENT 控制同时处理的转录请求数
# 2. 如果频繁OOM，降低此值到1
# 3. GPU显存充足且稳定后，可逐步提高到2-3
# 4. ASR服务本身的配置通过"系统设置-ASR配置"管理

# 说话人识别（需要额外的依赖）
ASR_ENABLE_DIARIZATION=false
ASR_DIARIZATION_MIN_SPEAKERS=1
ASR_DIARIZATION_MAX_SPEAKERS=10
# ASR_HF_TOKEN=your_huggingface_token

# 时间戳
ASR_ENABLE_TIMESTAMPS=true
ASR_WORD_TIMESTAMPS=false

# ----- 模板 LLM 分析配置 -----
TEMPLATE_LLM_ANALYSIS_ENABLED=true
TEMPLATE_LLM_ANALYSIS_MODEL=gpt-oss-120b
TEMPLATE_LLM_ANALYSIS_MAX_BLOCKS=400
TEMPLATE_LLM_ANALYSIS_MAX_CHARS_PER_BLOCK=300
TEMPLATE_LLM_ANALYSIS_CACHE_BY_SHA256=true
TEMPLATE_LLM_ANALYSIS_VERSION=v1

# ==========================================
# Feature Flags（功能开关）
# 所有新功能默认关闭，确保不影响现有系统
# ==========================================

# 平台任务调度能力
PLATFORM_JOBS_ENABLED=false

# 证据片段标注能力
EVIDENCE_SPANS_ENABLED=false

# 文档存储双写模式
DOCSTORE_DUALWRITE=false

# 评审案例双写模式
REVIEWCASE_DUALWRITE=false

# 规则集解析能力
RULESET_PARSE_ENABLED=false

# 规则评估引擎
RULES_EVALUATOR_ENABLED=false

# 异步文档摄入
ASYNC_INGEST_ENABLED=false

# ==========================================
# Cutover Control（切换控制）
# 用于逐步迁移旧逻辑到新逻辑，支持灰度发布和影子测试
# ==========================================

# 切换范围: project, tenant, user
CUTOVER_SCOPE=project

# 灰度项目 ID 列表（逗号分隔，空表示全部项目）
# 例如: CUTOVER_PROJECT_IDS=tp_abc123,tp_def456
CUTOVER_PROJECT_IDS=

# 各能力点的切换模式: OLD, SHADOW, PREFER_NEW, NEW_ONLY
# - OLD: 仅使用旧逻辑（默认）
# - SHADOW: 同时运行新旧逻辑，对比结果，返回旧逻辑结果
# - PREFER_NEW: 优先使用新逻辑，失败则降级到旧逻辑
# - NEW_ONLY: 仅使用新逻辑

# 检索能力切换模式
RETRIEVAL_MODE=OLD

# 摄入能力切换模式
INGEST_MODE=OLD

# 提取能力切换模式 (Step 6 & Step 7)
# OLD: 仅使用旧抽取逻辑
# SHADOW: 旧抽取为准，同时运行 v2 并记录差异 (Step 6)
# PREFER_NEW: 优先使用 v2 抽取，失败则回退到旧逻辑 (Step 7)
# NEW_ONLY: 仅使用 v2 抽取（失败则报错）
EXTRACT_MODE=OLD

# 审查能力切换模式 (Step 8)
# OLD: 仅使用旧审核逻辑
# SHADOW: 旧审核为准，同时运行 v2 并记录差异 (Step 8)
# PREFER_NEW: 优先使用 v2 审核，失败则回退到旧逻辑
# NEW_ONLY: 仅使用 v2 审核（失败则报错）
REVIEW_MODE=OLD

# 规则能力切换模式 (Step 9)
# OLD: 使用旧规则评估器（或不执行）
# SHADOW: 旧评估器为准，同时运行 v2 并记录差异 (Step 9)
# PREFER_NEW: 优先使用 v2 评估器，失败则回退到旧评估器
# NEW_ONLY: 仅使用 v2 评估器（失败则报错）
RULES_MODE=OLD

# === Step 10: 异步任务队列 ===
# Redis 连接配置
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=

# 异步任务开关（默认全部关闭，保持同步执行）
# true: 任务提交到队列异步执行，API 立即返回
# false: 任务同步执行，API 等待完成后返回
ASYNC_INGEST_ENABLED=false
ASYNC_EXTRACT_ENABLED=false
ASYNC_REVIEW_ENABLED=false

# ==========================================
# Debug（调试）
# ==========================================

# 启用调试模式（开启 /api/_debug 接口）
DEBUG=false

# 环境: dev, staging, production
ENV=production

# ==========================================
# DocStore & Ingest (Step 2 & Step 4)
# ==========================================

# DocStore 双写（Step 2）
DOCSTORE_DUALWRITE=false

# Milvus 新集合名称（Step 4）
MILVUS_COLLECTION_DOCSEG=doc_segments_v1

# ==========================================
# Extract V2 配置
# ==========================================

# v2 检索参数
V2_RETRIEVAL_TOPK_PER_QUERY=30    # 每个查询返回的最大 chunks 数
V2_RETRIEVAL_TOPK_TOTAL=120       # 合并后的总 chunks 数上限

# v2 抽取 trace 开关
EXTRACT_TRACE_ENABLED=true

