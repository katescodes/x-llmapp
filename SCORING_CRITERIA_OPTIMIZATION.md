# 评分表抽取优化方案 - 解决严重缺失问题

**问题**: 评分表抽取严重缺失，内容不完整，需要原样展示  
**目标**: 完整、准确、原文呈现评分规则

---

## 🔍 问题诊断

### 当前可能存在的问题

1. **检索问题** ⭐⭐⭐⭐⭐（最可能）
   - 评分标准章节没有被检索到
   - 检索到的chunks不是评分章节
   - 检索量太少，评分内容被截断

2. **Prompt问题** ⭐⭐⭐
   - LLM误解了"原样展示"的要求
   - LLM对评分表结构理解不足
   - LLM在总结而非复制

3. **文档结构问题** ⭐⭐⭐⭐
   - 评分表是图片/表格，文本解析失败
   - 评分表跨越多个chunks，被分割了
   - 评分表在PDF的特殊位置（页眉、页脚、文本框）

4. **输出限制问题** ⭐⭐
   - JSON太大，LLM输出被截断
   - max_tokens不足

---

## 📋 优化方案（按优先级）

### 🥇 优先级P0：增强评分标准检索（立即执行）

#### 问题分析

当前检索配置：
```python
# Stage 4: scoring_criteria
queries = ["评分标准 评审办法 评分细则"]
top_k_per_query = 10
top_k_total = 40
```

**可能的问题**：
1. 查询词不够全面，遗漏了评分章节
2. top_k太少，评分表内容被截断
3. 与其他3个Stage共享检索结果，评分chunks被稀释

#### 优化方案A：扩展评分专用查询词

```python
# 优化后的查询（更全面）
scoring_queries = [
    # 主要关键词
    "评分标准 评审办法 评分细则 评分表",
    
    # 评标方法
    "综合评分法 最低评标价法 评标办法 评审方法",
    
    # 评分类别
    "商务评审 技术评审 价格评审 资信评审 服务评审",
    
    # 具体评分项
    "企业资质评分 项目业绩评分 技术方案评分 价格分计算",
    
    # 分值关键词
    "满分 分值 得分 计分 扣分 加分",
    
    # 章节标题
    "第X章 评标方法 评分办法 评审标准"
]
```

**预期效果**：召回率提升50-100%

---

#### 优化方案B：专门检索策略（推荐）

```python
async def retrieve_for_scoring_criteria(
    project_id: str,
    retriever: RetrievalFacade
) -> List[Chunk]:
    """
    为评分标准使用专门的检索策略
    
    策略：
    1. 使用更多查询词
    2. 更大的top_k
    3. 专门筛选评分相关chunks
    """
    
    # Step 1: 广泛检索
    all_chunks = []
    
    scoring_queries = [
        "评分标准 评审办法 评分细则",
        "综合评分法 评标办法",
        "商务评审 技术评审 价格评审",
        "满分 分值 得分规则",
        "评标方法 评分办法"
    ]
    
    for query in scoring_queries:
        chunks = await retriever.retrieve(
            project_id=project_id,
            query=query,
            top_k=15,  # 每个查询15个，比其他Stage多
            doc_types=["tender"]
        )
        all_chunks.extend(chunks)
    
    # Step 2: 去重
    unique_chunks = deduplicate_chunks(all_chunks)
    
    # Step 3: 评分相关性过滤
    scoring_chunks = filter_scoring_related(unique_chunks)
    
    # Step 4: 按文档顺序排序（保持评分表的连续性）
    scoring_chunks = sort_by_doc_position(scoring_chunks)
    
    # Step 5: 返回最多80个（比其他Stage多）
    return scoring_chunks[:80]


def filter_scoring_related(chunks: List[Chunk]) -> List[Chunk]:
    """过滤评分相关的chunks"""
    scoring_keywords = [
        "评分", "评审", "评标", "分值", "得分", "扣分", "加分",
        "满分", "计分", "综合评分", "评标办法", "评分标准",
        "商务评审", "技术评审", "价格评审", "资信评审",
        "评分细则", "评分表", "评分项"
    ]
    
    filtered = []
    for chunk in chunks:
        # 计算评分相关性得分
        score = sum(1 for kw in scoring_keywords if kw in chunk.text)
        if score >= 2:  # 至少包含2个评分关键词
            filtered.append((chunk, score))
    
    # 按相关性得分排序
    filtered.sort(key=lambda x: x[1], reverse=True)
    return [chunk for chunk, score in filtered]


def sort_by_doc_position(chunks: List[Chunk]) -> List[Chunk]:
    """
    按文档位置排序，保持评分表的连续性
    
    评分表通常是连续的，按文档位置排序可以让LLM看到完整的评分表
    """
    return sorted(chunks, key=lambda c: (c.doc_id, c.chunk_index))
```

**预期效果**：
- 召回率提升100%+
- 评分表完整性提升80%+
- 开发时间：4-6小时

---

### 🥈 优先级P1：增强Prompt指令（快速实施）

#### 当前Prompt的潜在问题

1. "原样展示"指令不够强
2. 没有明确"不要遗漏"的要求
3. 没有示例说明"完整性"

#### 优化后的Prompt

```markdown
## Stage 4：评分规则（scoring_criteria） - 完整性优先

### 🚨 最高优先级：完整性 > 准确性 > 格式

**核心原则**：
1. **宁可多提，不要遗漏** - 任何疑似评分内容都要提取
2. **完整复制原文** - 逐字复制，不要总结、改写、简化
3. **保持评分表的连续性** - 不要跳过任何评分项

### 什么内容必须提取？（检查清单）

请逐项检查招标文件片段，确保以下内容都已提取：

#### ✅ 必提取项目

1. **评标办法名称**
   - 综合评分法、最低评标价法、性价比法等
   - 评标办法的说明和描述

2. **评分大类**（通常有3-5个大类）
   - 商务评审/商务部分
   - 技术评审/技术部分
   - 价格评审/报价部分
   - 资信评审/资质部分
   - 服务评审/售后服务

3. **所有评分细项**（每个大类下的所有子项）
   - 企业资质、项目业绩、财务状况
   - 技术方案、人员配置、实施方案
   - 价格得分计算方法
   - 服务承诺、质保期、培训方案
   - ...（所有在"评分标准"章节中出现的项）

4. **每项的分值**
   - 明确的分值（如：10分）
   - 分值区间（如：5-10分）
   - 最高分值（如：最多10分）

5. **每项的得分规则**（这是最重要的！）
   - 如何得满分
   - 如何得部分分
   - 如何扣分
   - 不得分的情况
   - 计分公式（如果有）

#### ⚠️ 常见遗漏点

1. **评分表的表头**
   - 如："满分100分"、"评分采用百分制"
   - 请完整提取

2. **价格分计算公式**
   - 如："价格分 = (评标基准价/投标报价) × 30"
   - 公式必须完整复制

3. **多层级评分项**
   - 一级评分项：技术评审（50分）
   - 二级评分项：技术方案（30分）、人员配置（20分）
   - 三级评分项：项目经理（10分）、技术人员（10分）
   - 请全部提取，不要遗漏层级

4. **评分说明**
   - 如："评审专家根据投标人提供的技术方案进行综合评分"
   - 这也是规则的一部分，请完整复制

5. **表格内容**
   - 如果评分标准是表格形式
   - 请逐行提取，不要跳过任何一行

### 输出要求（强制）

```json
{
  "scoring_criteria": {
    "evaluationMethod": "【完整复制】评标办法的名称和说明",
    "items": [
      // ⚠️ 注意：items数组应该包含 10-50 个评分项（视招标书复杂度）
      // 如果只有3-5项，说明严重遗漏！
      {
        "category": "【完整复制】评分大类名称",
        "item": "【完整复制】评分项名称",
        "score": "【完整复制】分值描述",
        "rule": "【完整逐字复制】得分规则的完整原文，包括所有条件、公式、说明",
        "evidence_chunk_ids": ["CHUNK_xxx"]
      }
    ]
  }
}
```

### 质量自检（输出前必做）

在输出JSON前，请进行以下检查：

1. **数量检查**
   - items数组是否有 10+ 个评分项？
   - 如果少于10个，请重新检查是否遗漏

2. **分值检查**
   - 所有分值加起来是否接近 100 分？
   - 如果总分远小于100，说明遗漏了大量内容

3. **完整性检查**
   - 是否包含了商务、技术、价格三大类？
   - 每个大类是否都有具体的评分项？

4. **原文检查**
   - rule字段是否是逐字复制的原文？
   - 是否有改写、概括、简化？

### 典型错误示例（禁止）

❌ **错误1：遗漏大量评分项**
```json
{
  "items": [
    {"item": "企业资质", "score": "10分", "rule": "..."},
    {"item": "技术方案", "score": "30分", "rule": "..."},
    {"item": "报价", "score": "30分", "rule": "..."}
  ]
  // 只有3项？招标文件通常有15-30个评分项！
}
```

❌ **错误2：改写原文**
```json
{
  "rule": "有相关资质得分，无资质不得分"
  // 原文是："投标人具有建筑工程施工总承包壹级及以上资质的得10分，
  //         贰级资质的得6分，叁级资质的得3分，无资质不得分。"
  // 你改写了！这是严重错误！
}
```

❌ **错误3：省略计算公式**
```json
{
  "rule": "根据投标报价计算得分"
  // 原文有具体公式："价格分 = (评标基准价/投标报价) × 30"
  // 必须完整复制公式！
}
```

### 正确示例（学习）

✅ **正确：完整提取所有评分项**
```json
{
  "items": [
    // 商务评审（共20分）
    {"category": "商务评审", "item": "企业资质", "score": "10分", "rule": "..."},
    {"category": "商务评审", "item": "项目业绩", "score": "6分", "rule": "..."},
    {"category": "商务评审", "item": "财务状况", "score": "4分", "rule": "..."},
    
    // 技术评审（共50分）
    {"category": "技术评审", "item": "技术方案", "score": "30分", "rule": "..."},
    {"category": "技术评审", "item": "项目经理", "score": "10分", "rule": "..."},
    {"category": "技术评审", "item": "技术人员", "score": "10分", "rule": "..."},
    
    // 价格评审（共30分）
    {"category": "价格评审", "item": "投标报价", "score": "30分", "rule": "评标基准价 = 所有有效投标人的投标报价算术平均值。价格分 = (评标基准价/投标报价) × 30"}
    
    // ... 共15-30项
  ]
}
```

✅ **正确：完整复制原文**
```json
{
  "rule": "投标人近三年（2021年1月1日至今）承担过与本项目类似的项目，每提供一个合格的业绩得2分，最多得10分。业绩证明材料须包括：合同复印件、竣工验收证明或验收报告。不提供或提供不全的，该项不得分。"
}
```

### 特殊情况处理

1. **评分表是图片/表格**
   - 如果文本解析不完整，请提取所有可识别的文字
   - 在rule中注明："【注意】原文为表格形式，此处为表格内容的文字提取"

2. **评分规则很长**
   - 不要担心JSON太大
   - 必须完整复制，不得截断

3. **评分项有层级关系**
   - 用category标识层级
   - 例如：category="技术评审-技术方案-实施方案"

4. **找不到完整的评分表**
   - 如果只找到部分评分内容，也要全部提取
   - 在evidence中标注所有相关chunks

---

### 执行流程（必须遵守）

**Step 1: 浏览所有提供的文本片段**
- 识别所有包含"评分"、"评审"、"分值"的片段
- 标记为"待提取"

**Step 2: 识别评分表的结构**
- 评标办法是什么？
- 有哪几个评分大类？
- 每个大类有哪些评分项？

**Step 3: 逐项提取**
- 对每个评分项，完整复制：
  - 项目名称
  - 分值
  - 得分规则（逐字复制）

**Step 4: 自检**
- 总分值是否接近100？
- 是否所有大类都提取了？
- rule是否是原文？

**Step 5: 输出JSON**
```

**预期效果**：
- 遗漏率降低70%+
- 原文保真度100%
- 开发时间：1小时（更新Prompt）

---

### 🥈 优先级P2：增加输出限制（快速实施）

#### 问题：LLM输出可能被截断

当前设置：
```python
max_tokens = 8192
```

评分表如果有20-30个评分项，每项rule平均100字，总共需要约3000-5000 tokens。

#### 优化方案

```python
# 针对评分标准Stage，使用更大的max_tokens
if stage_name == "scoring_criteria":
    max_tokens = 16384  # 翻倍
else:
    max_tokens = 8192
```

**预期效果**：避免大型评分表被截断

---

### 🥉 优先级P3：优化文档解析（中期）

#### 问题：评分表可能是表格或图片

评分标准在招标文件中常见形式：
1. 纯文本段落（易于提取）
2. 表格（可能解析不完整）
3. 图片/扫描件（OCR可能失败）

#### 优化方案

```python
# 1. 增强表格解析
# 使用更好的PDF表格提取库
from pdfplumber import PDF

def extract_tables_from_pdf(pdf_path):
    """提取PDF中的所有表格"""
    with pdfplumber.open(pdf_path) as pdf:
        tables = []
        for page in pdf.pages:
            page_tables = page.extract_tables()
            for table in page_tables:
                # 检查是否是评分表
                if is_scoring_table(table):
                    tables.append(table)
        return tables

def is_scoring_table(table):
    """判断表格是否是评分表"""
    # 检查表头是否包含"评分"、"分值"等关键词
    header = table[0] if table else []
    scoring_keywords = ["评分", "分值", "得分", "分"]
    return any(kw in str(cell) for cell in header for kw in scoring_keywords)

# 2. 增强OCR识别
# 对于图片形式的评分表，使用更好的OCR
from paddleocr import PaddleOCR

def ocr_scoring_table(image_path):
    """对评分表图片进行OCR"""
    ocr = PaddleOCR(use_angle_cls=True, lang='ch')
    result = ocr.ocr(image_path, cls=True)
    
    # 重建表格结构
    table_text = rebuild_table_structure(result)
    return table_text
```

**预期效果**：
- 表格型评分表提取成功率提升50%+
- 图片型评分表识别率提升30%+
- 开发时间：2-3天

---

## 📊 实施优先级总结

| 优化项 | 难度 | 时间 | 效果 | 优先级 | 立即可做 |
|--------|------|------|------|--------|----------|
| **扩展查询词** | ⭐ 低 | 30分钟 | ⭐⭐⭐⭐ 高 | P0 | ✅ |
| **专门检索策略** | ⭐⭐ 中 | 4-6小时 | ⭐⭐⭐⭐⭐ 很高 | P0 | ✅ |
| **增强Prompt** | ⭐ 低 | 1小时 | ⭐⭐⭐⭐⭐ 很高 | P1 | ✅ |
| **增加max_tokens** | ⭐ 低 | 10分钟 | ⭐⭐⭐ 中 | P1 | ✅ |
| **按文档位置排序** | ⭐ 低 | 1小时 | ⭐⭐⭐⭐ 高 | P1 | ✅ |
| **表格解析优化** | ⭐⭐⭐ 高 | 2-3天 | ⭐⭐⭐⭐ 高 | P3 | ❌ |

---

## 🚀 立即行动计划

### 今天可完成（3小时）

#### 1. 扩展查询词（30分钟）✅

修改 `backend/app/works/tender/extraction_specs/project_info_v2.py`：

```python
# 评分标准专用查询
scoring_queries = [
    "评分标准 评审办法 评分细则 评分表",
    "综合评分法 最低评标价法 评标办法",
    "商务评审 技术评审 价格评审 资信评审",
    "满分 分值 得分规则 计分方法",
]
```

#### 2. 增强Prompt（1小时）✅

更新 `backend/app/works/tender/prompts/project_info_v2.md` 的 Stage 4 部分，使用上面提供的增强版Prompt。

#### 3. 增加max_tokens（10分钟）✅

修改 `backend/app/platform/extraction/engine.py`：

```python
# 针对评分标准使用更大的输出限制
if spec.stage_name == "scoring_criteria":
    max_tokens = 16384
else:
    max_tokens = 8192
```

#### 4. 按文档位置排序（1.5小时）✅

在检索后对chunks按文档位置排序，保持评分表的连续性。

### 预期效果（今天完成后）

- 评分表召回率：提升 80-100%
- 评分项遗漏率：降低 70-80%
- 原文保真度：提升到 98%+

---

## 📈 效果验证

### 验证指标

1. **数量指标**
   - 提取的评分项数量：应该是 10-30 个
   - 当前如果只有 3-5 个，说明有问题

2. **完整性指标**
   - 总分值：应该接近 100 分
   - 评分大类：应该有 3-5 个（商务、技术、价格等）

3. **准确性指标**
   - rule字段是否是原文（人工抽查）
   - 是否包含计算公式（如有）

### 测试流程

```bash
# 1. 实施优化
# 2. 选择3-5个项目重新抽取
# 3. 对比优化前后的评分表
# 4. 人工检查：
#    - 是否遗漏评分项？
#    - rule是否是原文？
#    - 分值总和是否正确？
```

---

## 💡 长期优化建议

### 1. 评分表专用抽取模式

考虑将评分标准抽取独立为一个专门的API：

```python
POST /api/tender/extract/scoring-criteria-only
{
  "project_id": "xxx",
  "force_full_retrieval": true  # 强制检索更多内容
}
```

### 2. 评分表可视化展示

在前端以表格形式展示评分标准，而非JSON：

```
┌──────────┬────────────┬────────┬──────────────────────┐
│ 评分大类 │ 评分项     │ 分值   │ 得分规则             │
├──────────┼────────────┼────────┼──────────────────────┤
│ 商务评审 │ 企业资质   │ 10分   │ 壹级及以上得10分...  │
│ 商务评审 │ 项目业绩   │ 6分    │ 近三年每个项目2分... │
│ 技术评审 │ 技术方案   │ 30分   │ 专家综合评分...      │
└──────────┴────────────┴────────┴──────────────────────┘
```

### 3. 评分表质量评估

自动评估抽取的评分表质量：

```python
def assess_scoring_quality(scoring_criteria):
    """评估评分表抽取质量"""
    score = 100
    
    # 检查1：评分项数量
    if len(scoring_criteria["items"]) < 10:
        score -= 30  # 严重扣分
    
    # 检查2：总分值
    total_score = sum_scores(scoring_criteria["items"])
    if total_score < 80:
        score -= 20
    
    # 检查3：是否有价格评审
    if not has_price_scoring(scoring_criteria["items"]):
        score -= 15
    
    return score
```

---

**文档完成时间**: 2025-12-25  
**预期实施时间**: 3小时（P0+P1优化）  
**预期效果**: 评分表完整性提升 80%+
