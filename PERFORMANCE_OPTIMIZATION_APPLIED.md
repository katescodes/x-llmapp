# é¡¹ç›®ä¿¡æ¯æŠ½å–æ€§èƒ½ä¼˜åŒ–å·²å®æ–½

**å®æ–½æ—¶é—´**: 2025-12-25  
**é—®é¢˜**: é¡¹ç›®ä¿¡æ¯æŠ½å–éœ€è¦10-15åˆ†é’Ÿ  
**ç›®æ ‡**: å‡å°‘åˆ°6-9åˆ†é’Ÿï¼ˆç¬¬ä¸€æ­¥ï¼‰ï¼Œæœ€ç»ˆ3-4åˆ†é’Ÿ

---

## âœ… å·²å®æ–½ä¼˜åŒ–ï¼ˆç¬¬ä¸€æ­¥ï¼šå¿«é€Ÿä¼˜åŒ–ï¼‰

### 1. å‡å°‘æ£€ç´¢é‡ï¼ˆ50%ï¼‰

**æ–‡ä»¶**: `.env`

```bash
# ä»20é™åˆ°10 (å‡å°‘50%)
V2_RETRIEVAL_TOPK_PER_QUERY=10

# ä»80é™åˆ°40 (å‡å°‘50%)
V2_RETRIEVAL_TOPK_TOTAL=40
```

**æ•ˆæœ**:
- Contextå¤§å°: 96,000å­— â†’ 48,000å­— (å‡å°‘50%)
- æ£€ç´¢æ—¶é—´: æ¯ä¸ªStage 5ç§’ â†’ 2.5ç§’
- LLMæ¨ç†æ—¶é—´: å‡å°‘30-40%
- å•ä¸ªStageè€—æ—¶: 3-5åˆ†é’Ÿ â†’ 2-3åˆ†é’Ÿ

### 2. å¢åŠ LLMè¶…æ—¶ï¼ˆ2.5å€ï¼‰

**æ–‡ä»¶**: `backend/app/services/llm_client.py`

**ä¿®æ”¹1**: `llm_json` å‡½æ•°
```python
# ä»120ç§’å¢åŠ åˆ°300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰
with httpx.Client(timeout=300.0) as client:  # âœ… ä¼˜åŒ–
```

**ä¿®æ”¹2**: `llm_chat` å‡½æ•°
```python
# ä»120ç§’å¢åŠ åˆ°300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰
async with httpx.AsyncClient(timeout=300.0, follow_redirects=False) as client:  # âœ… ä¼˜åŒ–
```

**æ•ˆæœ**:
- Stage 2 ä¸å†å› è¶…æ—¶å¤±è´¥
- å‡å°‘é‡è¯•æ¬¡æ•°
- æé«˜æ•´ä½“æˆåŠŸç‡

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹è¿› |
|------|--------|--------|------|
| **æ£€ç´¢é‡** | 80 chunks | 40 chunks | â†“ 50% |
| **Contextå¤§å°** | 96KB | 48KB | â†“ 50% |
| **LLMè¶…æ—¶** | 120ç§’ | 300ç§’ | â†‘ 150% |
| **Stage 1 è€—æ—¶** | 2.5-3.5åˆ†é’Ÿ | 1.5-2åˆ†é’Ÿ | â†“ 40% |
| **Stage 2 è€—æ—¶** | 3.5-5.5åˆ†é’Ÿ | 2-3åˆ†é’Ÿ | â†“ 45% |
| **Stage 3 è€—æ—¶** | 2.5-3.5åˆ†é’Ÿ | 1.5-2åˆ†é’Ÿ | â†“ 40% |
| **Stage 4 è€—æ—¶** | 2-3åˆ†é’Ÿ | 1-1.5åˆ†é’Ÿ | â†“ 40% |
| **æ€»è€—æ—¶** | 10-15åˆ†é’Ÿ | **6-9åˆ†é’Ÿ** | â†“ 40-45% âœ… |

---

## ğŸ”„ å·²åº”ç”¨æ›´æ”¹

### æ›´æ”¹1: ç¯å¢ƒå˜é‡
```bash
# .env
V2_RETRIEVAL_TOPK_PER_QUERY=10
V2_RETRIEVAL_TOPK_TOTAL=40
```

### æ›´æ”¹2: LLMè¶…æ—¶é…ç½®
```python
# backend/app/services/llm_client.py (Line 150)
with httpx.Client(timeout=300.0) as client:  # ä»120.0å¢åŠ åˆ°300.0

# backend/app/services/llm_client.py (Line 281)
async with httpx.AsyncClient(timeout=300.0, follow_redirects=False) as client:  # ä»120.0å¢åŠ åˆ°300.0
```

### æ›´æ”¹3: åç«¯é‡å¯
```bash
docker-compose restart backend
```

---

## ğŸ§ª éªŒè¯æ–¹æ³•

### 1. æŸ¥çœ‹ç¯å¢ƒå˜é‡ç”Ÿæ•ˆ
```bash
docker exec localgpt-backend env | grep V2_RETRIEVAL
```

### 2. æŸ¥çœ‹æ£€ç´¢æ—¥å¿—
```bash
docker logs localgpt-backend 2>&1 | grep "chunks="
# åº”è¯¥çœ‹åˆ° chunks=40 å·¦å³ï¼ˆè€Œä¸æ˜¯80ï¼‰
```

### 3. æŸ¥çœ‹LLMè°ƒç”¨æ—¶é—´
```bash
docker logs localgpt-backend 2>&1 | grep "ExtractV2.*done"
# æŸ¥çœ‹æ¯ä¸ªStageçš„è€—æ—¶
```

### 4. å®é™…æµ‹è¯•
```
1. å‰ç«¯é€‰æ‹©ä¸€ä¸ªé¡¹ç›®
2. ç‚¹å‡»"å¼€å§‹æŠ½å–"
3. è§‚å¯Ÿæ¯ä¸ªStageçš„å®Œæˆæ—¶é—´
4. è®°å½•æ€»è€—æ—¶

é¢„æœŸï¼š
- Stage 1: 1.5-2åˆ†é’Ÿ âœ…
- Stage 2: 2-3åˆ†é’Ÿ âœ…
- Stage 3: 1.5-2åˆ†é’Ÿ âœ…
- Stage 4: 1-1.5åˆ†é’Ÿ âœ…
- æ€»è®¡: 6-9åˆ†é’Ÿ âœ…
```

---

## ğŸ“ˆ ä¸‹ä¸€æ­¥ä¼˜åŒ–ï¼ˆå»ºè®®ï¼‰

### ç¬¬äºŒæ­¥: åˆå¹¶Stageï¼ˆå¼€å‘æˆæœ¬ï¼š1å°æ—¶ï¼‰

**ç›®æ ‡**: ä»4æ¬¡LLMè°ƒç”¨å‡å°‘åˆ°2æ¬¡

```python
# å½“å‰: 4ä¸ªStage
Stage 1: base (åŸºæœ¬ä¿¡æ¯)
Stage 2: technical_parameters (æŠ€æœ¯å‚æ•°)
Stage 3: business_terms (å•†åŠ¡æ¡æ¬¾)
Stage 4: scoring_criteria (è¯„åˆ†è§„åˆ™)

# ä¼˜åŒ–: 2ä¸ªStage
Stage 1: base + scoring_criteria (åŸºæœ¬ä¿¡æ¯ + è¯„åˆ†è§„åˆ™)
Stage 2: technical_parameters + business_terms (æŠ€æœ¯ + å•†åŠ¡)
```

**é¢„æœŸæ•ˆæœ**: 6-9åˆ†é’Ÿ â†’ 4-6åˆ†é’Ÿ âœ…âœ…

### ç¬¬ä¸‰æ­¥: æ™ºèƒ½æŸ¥è¯¢ï¼ˆå¼€å‘æˆæœ¬ï¼š2å°æ—¶ï¼‰

**ç›®æ ‡**: æ¯ä¸ªStageä½¿ç”¨ä¸“é—¨ä¼˜åŒ–çš„æŸ¥è¯¢

```python
# å½“å‰: æ‰€æœ‰Stageä½¿ç”¨ç›¸åŒçš„4ä¸ªæŸ¥è¯¢
queries = {
    "base": "...",
    "technical": "...",
    "business": "...",
    "scoring": "..."
}

# ä¼˜åŒ–: æ¯ä¸ªStageä½¿ç”¨ä¸åŒçš„æŸ¥è¯¢
Stage 1 queries: ["base", "scoring"] â†’ æ£€ç´¢20 chunks
Stage 2 queries: ["technical", "business"] â†’ æ£€ç´¢40 chunks
```

**é¢„æœŸæ•ˆæœ**: 4-6åˆ†é’Ÿ â†’ 3-4åˆ†é’Ÿ âœ…âœ…âœ…

---

## ğŸ’¡ å…¶ä»–ä¼˜åŒ–å»ºè®®

### 1. ä½¿ç”¨æ›´å¿«çš„LLMæ¨¡å‹

| æ¨¡å‹ | é€Ÿåº¦ | å»ºè®® |
|------|------|------|
| GPT-4o | â­â­â­â­â­ | âœ… æ¨è |
| Claude-3.5-Haiku | â­â­â­â­â­ | âœ… æ¨è |
| GPT-4-Turbo | â­â­â­â­ | å¯é€‰ |

**æ•ˆæœ**: æ€»è€—æ—¶å†å‡å°‘50% â†’ æœ€ç»ˆ3-4åˆ†é’Ÿ

### 2. å¹¶è¡Œæ‰§è¡ŒStage

```python
# Stage 1, 3, 4 å¯ä»¥å¹¶è¡Œï¼ˆç‹¬ç«‹ï¼‰
# Stage 2 éœ€è¦ç­‰å¾…Stage 1ï¼ˆä¾èµ–contextï¼‰

import asyncio
results = await asyncio.gather(
    extract_stage_1(),
    extract_stage_3(),
    extract_stage_4()
)
result_stage_2 = await extract_stage_2(context=results[0])
```

**æ•ˆæœ**: æ€»è€—æ—¶å‡å°‘30-40%

### 3. ç¼“å­˜æ£€ç´¢ç»“æœ

```python
# ç¬¬ä¸€æ¬¡æ£€ç´¢åç¼“å­˜
cache_key = f"project:{project_id}:chunks"
redis.set(cache_key, chunks, ex=3600)

# åç»­Stageç›´æ¥ä½¿ç”¨ç¼“å­˜
cached = redis.get(cache_key)
```

**æ•ˆæœ**: æ¯ä¸ªStageèŠ‚çœ2-5ç§’æ£€ç´¢æ—¶é—´

---

## âœ¨ æ€»ç»“

### å·²å®Œæˆ
- âœ… å‡å°‘æ£€ç´¢é‡50%
- âœ… å¢åŠ LLMè¶…æ—¶åˆ°300ç§’
- âœ… é‡å¯åç«¯åº”ç”¨æ›´æ”¹

### é¢„æœŸæ•ˆæœ
- âœ… æ€»è€—æ—¶ä» 10-15åˆ†é’Ÿ â†’ **6-9åˆ†é’Ÿ** (å‡å°‘40-45%)

### ä¸‹ä¸€æ­¥
1. **éªŒè¯ä¼˜åŒ–æ•ˆæœ** - å®é™…æµ‹è¯•æŠ½å–é€Ÿåº¦
2. **è€ƒè™‘ç¬¬äºŒæ­¥ä¼˜åŒ–** - åˆå¹¶Stageï¼ˆå¦‚æœè¿˜éœ€è¦æ›´å¿«ï¼‰
3. **è€ƒè™‘ç¬¬ä¸‰æ­¥ä¼˜åŒ–** - æ™ºèƒ½æŸ¥è¯¢ï¼ˆå¦‚æœè¿˜éœ€è¦æ›´å¿«ï¼‰

### æŠ•å…¥äº§å‡ºæ¯”
- **æŠ•å…¥**: 10åˆ†é’Ÿé…ç½® + é‡å¯
- **äº§å‡º**: å‡å°‘40-45%æ—¶é—´
- **æ€§ä»·æ¯”**: â­â­â­â­â­ éå¸¸é«˜

---

**ä¼˜åŒ–å®Œæˆæ—¶é—´**: 2025-12-25  
**çŠ¶æ€**: âœ… å·²åº”ç”¨å¹¶é‡å¯
