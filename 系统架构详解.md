# äº¿æ—äº¿é—®æ‹›æŠ•æ ‡ç³»ç»Ÿæ¶æ„è¯¦è§£

**ç”Ÿæˆæ—¥æœŸ**: 2025-12-20  
**ç³»ç»Ÿç‰ˆæœ¬**: 0.2.0 (å¹³å°åŒ–é‡æ„å®Œæˆ)  
**åˆ†æ”¯**: platform-extraction-migration

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è§ˆ](#ç³»ç»Ÿæ¦‚è§ˆ)
2. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
3. [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
4. [æ ¸å¿ƒåˆ†å±‚è®¾è®¡](#æ ¸å¿ƒåˆ†å±‚è®¾è®¡)
5. [å¹³å°å±‚ Platform](#å¹³å°å±‚-platform)
6. [ä¸šåŠ¡å±‚ Apps](#ä¸šåŠ¡å±‚-apps)
7. [æœåŠ¡å±‚ Services](#æœåŠ¡å±‚-services)
8. [æ•°æ®å­˜å‚¨](#æ•°æ®å­˜å‚¨)
9. [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
10. [å…³é”®æŠ€æœ¯ç‚¹](#å…³é”®æŠ€æœ¯ç‚¹)

---

## ç³»ç»Ÿæ¦‚è§ˆ

**äº¿æ—äº¿é—®** æ˜¯ä¸€ä¸ªé¢å‘æ‹›æŠ•æ ‡åœºæ™¯çš„æ™ºèƒ½æ–‡æ¡£å¤„ç†ç³»ç»Ÿ,æ ¸å¿ƒèƒ½åŠ›åŒ…æ‹¬:

### ä¸»è¦åŠŸèƒ½

- âœ… **æ™ºèƒ½æŠ½å–**: ä»æ‹›æ ‡æ–‡ä»¶ä¸­è‡ªåŠ¨æå–é¡¹ç›®ä¿¡æ¯ã€æŠ€æœ¯å‚æ•°ã€å•†åŠ¡æ¡æ¬¾ã€è¯„åˆ†æ ‡å‡†
- âœ… **é£é™©è¯†åˆ«**: è‡ªåŠ¨è¯†åˆ«æ‹›æ ‡æ–‡ä»¶ä¸­çš„é£é™©ç‚¹å’Œé—®é¢˜
- âœ… **æ™ºèƒ½å®¡æŸ¥**: å¯¹æ ‡ä¹¦è¿›è¡Œåˆè§„æ€§å®¡æŸ¥,æ”¯æŒè‡ªå®šä¹‰è§„åˆ™
- âœ… **ç›®å½•ç”Ÿæˆ**: è‡ªåŠ¨ç”Ÿæˆå“åº”æ–‡ä»¶ç›®å½•ç»“æ„
- âœ… **æ–‡æ¡£å¯¼å‡º**: å¯¼å‡ºä¸ºæ ¼å¼åŒ–çš„ Word æ–‡æ¡£
- âœ… **çŸ¥è¯†åº“ç®¡ç†**: æ”¯æŒå¤šæ ¼å¼æ–‡æ¡£çš„çŸ¥è¯†åº“ç®¡ç†
- âœ… **æ™ºèƒ½å¯¹è¯**: åŸºäº RAG çš„æ™ºèƒ½é—®ç­”

### æŠ€æœ¯ç‰¹ç‚¹

- ğŸ¯ **å¹³å°åŒ–è®¾è®¡**: é€šç”¨èƒ½åŠ›æŠ½è±¡åˆ° Platform å±‚,ä¸šåŠ¡é€»è¾‘åœ¨ Apps å±‚
- ğŸ”„ **ç°åº¦åˆ‡æ¢**: æ”¯æŒ OLD/SHADOW/NEW_ONLY ä¸‰ç§æ¨¡å¼å¹³æ»‘è¿ç§»
- ğŸ“Š **é…ç½®é©±åŠ¨**: æŠ½å–è§„æ ¼(Spec)ã€æ£€ç´¢å‚æ•°ã€Prompt å…¨éƒ¨é…ç½®åŒ–
- ğŸ” **æ··åˆæ£€ç´¢**: PostgreSQL è¯æ³•æ£€ç´¢ + pgvector å‘é‡æ£€ç´¢
- ğŸ¤– **å¤šæ¨¡å‹æ”¯æŒ**: å¯åˆ‡æ¢å¤šä¸ª LLM æ¨¡å‹
- ğŸ“ **è¯æ®è¿½æº¯**: æ‰€æœ‰ç»“æœéƒ½æœ‰å®Œæ•´çš„è¯æ®é“¾

---

## æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å‰ç«¯ (React + TypeScript)                    â”‚
â”‚                        Port: 6173 (Nginx)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ èŠå¤©å¯¹è¯ç•Œé¢ â”‚ çŸ¥è¯†åº“ç®¡ç†   â”‚ æ‹›æŠ•æ ‡å·¥ä½œå° â”‚ ç³»ç»Ÿè®¾ç½®      â”‚ â”‚
â”‚  â”‚ ChatLayout   â”‚ KBManager    â”‚ TenderWorkspaceâ”‚ SystemSettingsâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ HTTP/WebSocket
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åç«¯ (FastAPI + Uvicorn)                        â”‚
â”‚                    Port: 9001 (å†…éƒ¨:8000)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    API è·¯ç”±å±‚ (Routers)                    â”‚  â”‚
â”‚  â”‚  /api/apps/tender  /api/chat  /api/kb  /api/auth          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              ä¸šåŠ¡åº”ç”¨å±‚ (Apps - ä¸šåŠ¡ç‰¹å®š)                 â”‚  â”‚
â”‚  â”‚  apps/tender/                                              â”‚  â”‚
â”‚  â”‚    â”œâ”€ extract_v2_service.py     # æ‹›æŠ•æ ‡æŠ½å–ç¼–æ’         â”‚  â”‚
â”‚  â”‚    â”œâ”€ review_v2_service.py      # æ‹›æŠ•æ ‡å®¡æŸ¥ç¼–æ’         â”‚  â”‚
â”‚  â”‚    â””â”€ extraction_specs/         # æŠ½å–é…ç½®(Spec)         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          å¹³å°å±‚ (Platform - é€šç”¨å¯å¤ç”¨èƒ½åŠ›)               â”‚  â”‚
â”‚  â”‚  platform/                                                 â”‚  â”‚
â”‚  â”‚    â”œâ”€ extraction/               # ğŸŒŸ é€šç”¨æŠ½å–å¼•æ“         â”‚  â”‚
â”‚  â”‚    â”‚   â”œâ”€ engine.py             # æŠ½å–å¼•æ“æ ¸å¿ƒ           â”‚  â”‚
â”‚  â”‚    â”‚   â”œâ”€ context.py            # ä¸Šä¸‹æ–‡æ„å»º             â”‚  â”‚
â”‚  â”‚    â”‚   â”œâ”€ llm_adapter.py        # LLM é€‚é…å™¨             â”‚  â”‚
â”‚  â”‚    â”‚   â””â”€ json_utils.py         # JSON è§£æ/ä¿®å¤         â”‚  â”‚
â”‚  â”‚    â”œâ”€ retrieval/                # ğŸ” æ£€ç´¢å¼•æ“            â”‚  â”‚
â”‚  â”‚    â”‚   â”œâ”€ facade.py             # æ£€ç´¢é—¨é¢(ç°åº¦åˆ‡æ¢)     â”‚  â”‚
â”‚  â”‚    â”‚   â””â”€ new_retriever.py      # æ–°æ£€ç´¢å™¨(pgvector)     â”‚  â”‚
â”‚  â”‚    â”œâ”€ rules/                    # ğŸ“‹ è§„åˆ™å¼•æ“            â”‚  â”‚
â”‚  â”‚    â”‚   â””â”€ evaluator_v2.py       # è§„åˆ™è¯„ä¼°å™¨             â”‚  â”‚
â”‚  â”‚    â”œâ”€ ingest/                   # ğŸ“¥ æ–‡æ¡£æ‘„å…¥            â”‚  â”‚
â”‚  â”‚    â”‚   â””â”€ ingest_v2_service.py  # æ–‡æ¡£è§£æ/åˆ†å—/å‘é‡åŒ–  â”‚  â”‚
â”‚  â”‚    â””â”€ docstore/                 # ğŸ“ æ–‡æ¡£å­˜å‚¨            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           æœåŠ¡å±‚ (Services - ä¼ ç»Ÿä¸šåŠ¡æœåŠ¡)                â”‚  â”‚
â”‚  â”‚  services/                                                 â”‚  â”‚
â”‚  â”‚    â”œâ”€ tender_service.py         # æ‹›æŠ•æ ‡æœåŠ¡ä¸»æ§         â”‚  â”‚
â”‚  â”‚    â”œâ”€ kb_service.py             # çŸ¥è¯†åº“æœåŠ¡             â”‚  â”‚
â”‚  â”‚    â”œâ”€ llm_orchestrator.py       # LLM ç¼–æ’å™¨             â”‚  â”‚
â”‚  â”‚    â”œâ”€ rag_service.py            # RAG æœåŠ¡               â”‚  â”‚
â”‚  â”‚    â”œâ”€ dao/                      # æ•°æ®è®¿é—®å¯¹è±¡           â”‚  â”‚
â”‚  â”‚    â”œâ”€ template/                 # æ¨¡æ¿æœåŠ¡               â”‚  â”‚
â”‚  â”‚    â”œâ”€ fragment/                 # ç‰‡æ®µå¤„ç†               â”‚  â”‚
â”‚  â”‚    â””â”€ export/                   # å¯¼å‡ºæœåŠ¡               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚            æ ¸å¿ƒå±‚ (Core - ç³»ç»ŸåŸºç¡€è®¾æ–½)                   â”‚  â”‚
â”‚  â”‚  core/                                                     â”‚  â”‚
â”‚  â”‚    â”œâ”€ cutover.py                # ç°åº¦åˆ‡æ¢æ§åˆ¶           â”‚  â”‚
â”‚  â”‚    â””â”€ shadow_diff.py            # Shadow æ¨¡å¼å·®å¼‚å¯¹æ¯”    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                        â”‚
           â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL 15       â”‚  â”‚  Redis 7             â”‚
â”‚  Port: 5432          â”‚  â”‚  Port: 6379          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ä¸šåŠ¡æ•°æ®       â”‚  â”‚  â”‚  â”‚ ä»»åŠ¡é˜Ÿåˆ—       â”‚  â”‚
â”‚  â”‚ - tender_*     â”‚  â”‚  â”‚  â”‚ - ingest       â”‚  â”‚
â”‚  â”‚ - kb_*         â”‚  â”‚  â”‚  â”‚ - extract      â”‚  â”‚
â”‚  â”‚ - doc_*        â”‚  â”‚  â”‚  â”‚ - review       â”‚  â”‚
â”‚  â”‚                â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚ å‘é‡å­˜å‚¨       â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚ - pgvector     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  RQ Worker           â”‚
                          â”‚  å¼‚æ­¥ä»»åŠ¡å¤„ç†å™¨       â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æŠ€æœ¯æ ˆ

### åç«¯æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **æ¡†æ¶ä¸æœåŠ¡å™¨** |
| FastAPI | 0.115.0 | Web æ¡†æ¶ |
| Uvicorn | 0.30.5 | ASGI æœåŠ¡å™¨ |
| Pydantic | 2.8.2 | æ•°æ®éªŒè¯ä¸åºåˆ—åŒ– |
| **æ•°æ®åº“ä¸å­˜å‚¨** |
| PostgreSQL | 15-alpine | å…³ç³»æ•°æ®åº“ |
| pgvector | latest | PostgreSQL å‘é‡æ‰©å±• |
| Redis | 7-alpine | ç¼“å­˜å’Œä»»åŠ¡é˜Ÿåˆ— |
| SQLAlchemy | 2.0.32+ | ORM æ¡†æ¶ |
| Psycopg | 3.1.18 | PostgreSQL é©±åŠ¨ |
| **ä»»åŠ¡é˜Ÿåˆ—** |
| RQ (Redis Queue) | latest | å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ— |
| **AI/ML ç›¸å…³** |
| tiktoken | 0.7.0 | Token è®¡æ•° |
| OpenAI SDK | latest | OpenAI API å®¢æˆ·ç«¯ |
| **æ–‡æ¡£å¤„ç†** |
| PyPDF | 4.0.2 | PDF åŸºç¡€å¤„ç† |
| PyMuPDF (fitz) | 1.24.10 | é«˜çº§ PDF å¤„ç† |
| python-docx | 1.1.2 | Word æ–‡æ¡£å¤„ç† |
| python-pptx | 0.6.23 | PPT æ–‡æ¡£å¤„ç† |
| **ç½‘ç»œä¸çˆ¬è™«** |
| httpx | 0.27.0 | HTTP å®¢æˆ·ç«¯ |
| BeautifulSoup4 | 4.12.3 | HTML è§£æ |
| Trafilatura | 1.6.3 | ç½‘é¡µå†…å®¹æå– |
| **å…¶ä»–å·¥å…·** |
| PyJWT | 2.8.0+ | JWT è®¤è¯ |
| PyYAML | latest | YAML è§£æ |
| rapidfuzz | 3.9.7 | æ¨¡ç³ŠåŒ¹é… |

### å‰ç«¯æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| React | 18.3.1 | UI æ¡†æ¶ |
| TypeScript | 5.5.4 | ç±»å‹ç³»ç»Ÿ |
| Vite | 5.4.0 | æ„å»ºå·¥å…· |
| react-markdown | 10.1.0 | Markdown æ¸²æŸ“ |
| remark-gfm | 4.0.0 | GitHub Flavored Markdown |
| Nginx | alpine | é™æ€æ–‡ä»¶æœåŠ¡ |

---

## æ ¸å¿ƒåˆ†å±‚è®¾è®¡

### è®¾è®¡ç†å¿µ

ç³»ç»Ÿé‡‡ç”¨**ä¸¥æ ¼çš„åˆ†å±‚æ¶æ„**,å®ç°äº†:

1. **Platform vs Apps è¾¹ç•Œæ¸…æ™°**
   - Platform: é€šç”¨ã€å¯å¤ç”¨ã€ä¸šåŠ¡æ— å…³
   - Apps: ä¸šåŠ¡ç‰¹å®šã€ä¸å¯å¤ç”¨ã€ä¸šåŠ¡æµç¨‹ç¼–æ’

2. **é…ç½®é©±åŠ¨** (Config-Driven)
   - Spec é…ç½®: promptã€queriesã€topkã€doc_types
   - ç¯å¢ƒå˜é‡: ç°åº¦æ¨¡å¼ã€æ£€ç´¢å‚æ•°

3. **ç°åº¦åˆ‡æ¢** (Cutover Control)
   - OLD: ä½¿ç”¨æ—§é€»è¾‘
   - SHADOW: åŒè·¯å¾„è¿è¡Œå¹¶å¯¹æ¯”
   - NEW_ONLY: ä»…ä½¿ç”¨æ–°å¹³å°å¼•æ“

### åˆ†å±‚èŒè´£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Apps Layer (ä¸šåŠ¡åº”ç”¨å±‚)         â”‚
â”‚  - ä¸šåŠ¡æµç¨‹ç¼–æ’                          â”‚
â”‚  - ä¸šåŠ¡è§„åˆ™é…ç½®                          â”‚
â”‚  - ä¸šåŠ¡æ•°æ®è½¬æ¢                          â”‚
â”‚  âœ“ å¯ä¾èµ–: Platform + Services          â”‚
â”‚  âœ— ä¸åº”åŒ…å«: é€šç”¨æŠ½å–/æ£€ç´¢/è§„åˆ™å®ç°      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Platform Layer (å¹³å°å±‚)          â”‚
â”‚  - é€šç”¨æŠ½å–å¼•æ“                          â”‚
â”‚  - é€šç”¨æ£€ç´¢å¼•æ“                          â”‚
â”‚  - é€šç”¨è§„åˆ™å¼•æ“                          â”‚
â”‚  - æ–‡æ¡£æ‘„å…¥å¼•æ“                          â”‚
â”‚  âœ“ å¯å¤ç”¨äºå¤šä¸šåŠ¡                        â”‚
â”‚  âœ— ä¸åº”æœ‰ä¸šåŠ¡ç‰¹å®šé€»è¾‘                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Services Layer (æœåŠ¡å±‚)           â”‚
â”‚  - ä¼ ç»Ÿä¸šåŠ¡æœåŠ¡                          â”‚
â”‚  - æ•°æ®è®¿é—®å¯¹è±¡(DAO)                     â”‚
â”‚  - å¤–éƒ¨ API è°ƒç”¨                         â”‚
â”‚  - æ¨¡æ¿/ç‰‡æ®µ/å¯¼å‡ºç­‰å·¥å…·                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Core Layer (æ ¸å¿ƒå±‚)              â”‚
â”‚  - é…ç½®ç®¡ç†                              â”‚
â”‚  - ç°åº¦åˆ‡æ¢                              â”‚
â”‚  - æ•°æ®åº“è¿æ¥                            â”‚
â”‚  - è®¤è¯æˆæƒ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¹³å°å±‚ Platform

Platform å±‚æ˜¯ç³»ç»Ÿçš„**æ ¸å¿ƒæŠ½è±¡å±‚**,æä¾›å¯å¤ç”¨çš„é€šç”¨èƒ½åŠ›ã€‚

### 1. æŠ½å–å¼•æ“ (extraction/)

**èŒè´£**: ç»Ÿä¸€çš„æ•°æ®æŠ½å–å¼•æ“,æ”¯æŒä»»æ„åœºæ™¯çš„ç»“æ„åŒ–æ•°æ®æå–

#### æ ¸å¿ƒç»„ä»¶

```python
# platform/extraction/engine.py
class ExtractionEngine:
    """
    é€šç”¨æŠ½å–å¼•æ“
    
    è¾“å…¥: ExtractionSpec (é…ç½®)
    è¾“å‡º: ExtractionResult (æ•°æ®+è¯æ®)
    """
    
    async def run(
        self,
        spec: ExtractionSpec,        # æŠ½å–è§„æ ¼
        retriever: Any,               # æ£€ç´¢å™¨
        llm: Any,                     # LLM ç¼–æ’å™¨
        project_id: str,
        model_id: Optional[str] = None,
        run_id: Optional[str] = None,
        embedding_provider: Optional[str] = None,
    ) -> ExtractionResult:
        """
        é€šç”¨æŠ½å–æµç¨‹:
        1. æ ¹æ® spec çš„ queries æ‰§è¡Œæ£€ç´¢
        2. æ„å»ºæ ‡è®°ä¸Šä¸‹æ–‡ (marked context)
        3. è°ƒç”¨ LLM
        4. è§£æ JSON (æ”¯æŒä¿®å¤)
        5. ç”Ÿæˆè¯æ®é“¾
        6. è¿”å›ç»“æ„åŒ–ç»“æœ
        """
```

#### æŠ½å–æµç¨‹

```
1. æ£€ç´¢é˜¶æ®µ (Retrieval)
   â”œâ”€ æ ¹æ® spec.queries æ„å»ºå¤šä¸ªæ£€ç´¢æŸ¥è¯¢
   â”œâ”€ è°ƒç”¨ retriever.retrieve() æ£€ç´¢æ–‡æ¡£å—
   â”œâ”€ å»é‡åˆå¹¶ç»“æœ
   â””â”€ è¿”å› top_k ä¸ªç›¸å…³ chunks

2. ä¸Šä¸‹æ–‡æ„å»º (Context Building)
   â”œâ”€ ä¸ºæ¯ä¸ª chunk æ·»åŠ  <chunk id="xxx"> æ ‡è®°
   â””â”€ æ‹¼æ¥ä¸ºå®Œæ•´ä¸Šä¸‹æ–‡å­—ç¬¦ä¸²

3. LLM è°ƒç”¨ (LLM Call)
   â”œâ”€ æ„å»º messages (system + user)
   â”œâ”€ è°ƒç”¨ llm_adapter.call_llm()
   â””â”€ è·å– LLM è¾“å‡ºæ–‡æœ¬

4. JSON è§£æ (JSON Parsing)
   â”œâ”€ å°è¯• extract_json() æå– JSON
   â”œâ”€ å¤±è´¥åˆ™å°è¯• repair_json() ä¿®å¤
   â””â”€ è¿”å›è§£æåçš„å¯¹è±¡

5. è¯æ®ç”Ÿæˆ (Evidence Generation)
   â”œâ”€ æå– evidence_chunk_ids
   â”œâ”€ ç”Ÿæˆ evidence_spans (page_no + snippet)
   â””â”€ æ„å»º retrieval_trace (æ£€ç´¢è¿½è¸ª)

6. è¿”å›ç»“æœ (Result)
   â””â”€ ExtractionResult(data, evidence_chunk_ids, evidence_spans, trace)
```

#### å…³é”®ç±»å‹å®šä¹‰

```python
# platform/extraction/types.py

@dataclass
class ExtractionSpec:
    """æŠ½å–è§„æ ¼ - é…ç½®é©±åŠ¨çš„æ ¸å¿ƒ"""
    prompt: str                          # System prompt
    queries: Dict[str, str]              # å¤šç»´åº¦æŸ¥è¯¢è¯
    topk_per_query: int = 30             # æ¯ä¸ªæŸ¥è¯¢çš„ top-k
    topk_total: int = 120                # æ€»è®¡ top-k
    doc_types: List[str] = None          # æ–‡æ¡£ç±»å‹è¿‡æ»¤
    temperature: float = 0.0             # LLM æ¸©åº¦

@dataclass
class ExtractionResult:
    """æŠ½å–ç»“æœ"""
    data: Any                            # ç»“æ„åŒ–æ•°æ®
    evidence_chunk_ids: List[str]        # è¯æ® chunk IDs
    evidence_spans: List[Dict]           # è¯æ®ç‰‡æ®µ (page_no + snippet)
    raw_model_output: str                # LLM åŸå§‹è¾“å‡º
    retrieval_trace: Optional[RetrievalTrace] = None  # æ£€ç´¢è¿½è¸ª
```

### 2. æ£€ç´¢å¼•æ“ (retrieval/)

**èŒè´£**: ç»Ÿä¸€çš„æ–‡æ¡£æ£€ç´¢æ¥å£,æ”¯æŒå¤šç§æ£€ç´¢ç­–ç•¥

#### æ ¸å¿ƒç»„ä»¶

```python
# platform/retrieval/facade.py
class RetrievalFacade:
    """
    æ£€ç´¢é—¨é¢ - æ”¯æŒç°åº¦åˆ‡æ¢
    
    æ ¹æ® cutover æ¨¡å¼è·¯ç”±åˆ°ä¸åŒçš„æ£€ç´¢å™¨:
    - OLD: æ—§æ£€ç´¢å™¨
    - SHADOW: åŒè·¯å¾„è¿è¡Œå¹¶å¯¹æ¯”
    - NEW_ONLY: æ–°æ£€ç´¢å™¨ (pgvector)
    """
    
    async def retrieve(
        self,
        query: str,
        project_id: str,
        doc_types: List[str],
        embedding_provider: Any,
        top_k: int = 30,
        **kwargs
    ) -> List[RetrievedChunk]:
        """ç»Ÿä¸€æ£€ç´¢æ¥å£"""
```

#### æ–°æ£€ç´¢å™¨ (NewRetriever)

```python
# platform/retrieval/new_retriever.py
class NewRetriever:
    """
    æ–°æ£€ç´¢å™¨ - åŸºäº pgvector çš„å‘é‡æ£€ç´¢
    
    ç‰¹ç‚¹:
    - ä½¿ç”¨ pgvector æ‰©å±•è¿›è¡Œå‘é‡ç›¸ä¼¼åº¦æ£€ç´¢
    - æ”¯æŒ doc_types è¿‡æ»¤
    - è¿”å›æ ‡å‡†åŒ–çš„ RetrievedChunk å¯¹è±¡
    """
    
    async def retrieve(
        self,
        query: str,
        project_id: str,
        doc_types: List[str],
        embedding_provider: Any,
        top_k: int = 30
    ) -> List[RetrievedChunk]:
        """
        æ£€ç´¢æµç¨‹:
        1. å°† query å‘é‡åŒ– (embedding)
        2. åœ¨ doc_segments æˆ– kb_chunks è¡¨ä¸­æ£€ç´¢
        3. ä½¿ç”¨ pgvector çš„ <=> è¿ç®—ç¬¦è®¡ç®—ç›¸ä¼¼åº¦
        4. æŒ‰ doc_types è¿‡æ»¤
        5. è¿”å› top_k ä¸ªæœ€ç›¸å…³ç»“æœ
        """
```

### 3. è§„åˆ™å¼•æ“ (rules/)

**èŒè´£**: ç¡®å®šæ€§è§„åˆ™æ‰§è¡Œå’Œè¯„ä¼°

```python
# platform/rules/evaluator_v2.py
class RulesEvaluatorV2:
    """
    è§„åˆ™è¯„ä¼°å™¨ V2
    
    æ”¯æŒ:
    - YAML è§„åˆ™å®šä¹‰
    - å¿…å‘½ä¸­è§„åˆ™ (MUST_HIT)
    - åˆšæ€§/æŸ”æ€§è§„åˆ™
    - è¯æ®è¿½è¸ª
    """
    
    def evaluate(
        self,
        rule_set: Dict,
        context: Dict
    ) -> List[ReviewFinding]:
        """
        è§„åˆ™è¯„ä¼°æµç¨‹:
        1. åŠ è½½è§„åˆ™é›† (YAML)
        2. æ‰§è¡Œæ¯æ¡è§„åˆ™çš„æ¡ä»¶åˆ¤æ–­
        3. ç”Ÿæˆå®¡æ ¸ç»“æœ (pass/risk/fail)
        4. è®°å½•è¯æ® chunk IDs
        """
```

### 4. æ–‡æ¡£æ‘„å…¥ (ingest/)

**èŒè´£**: æ–‡æ¡£è§£æã€åˆ†å—ã€å‘é‡åŒ–

```python
# platform/ingest/ingest_v2_service.py
class IngestV2Service:
    """
    æ–‡æ¡£æ‘„å…¥æœåŠ¡ V2
    
    æµç¨‹:
    1. è§£ææ–‡æ¡£ (PDF/DOCX/TXT)
    2. æ–‡æœ¬åˆ†å— (chunking)
    3. ç”Ÿæˆå‘é‡ (embedding)
    4. å­˜å‚¨åˆ°æ•°æ®åº“ (doc_segments + pgvector)
    """
```

---

## ä¸šåŠ¡å±‚ Apps

Apps å±‚åŒ…å«**ä¸šåŠ¡ç‰¹å®š**çš„é€»è¾‘å’Œæµç¨‹ç¼–æ’ã€‚

### æ‹›æŠ•æ ‡åº”ç”¨ (apps/tender/)

```
apps/tender/
â”œâ”€â”€ extract_v2_service.py          # æŠ½å–æœåŠ¡ç¼–æ’
â”œâ”€â”€ review_v2_service.py           # å®¡æŸ¥æœåŠ¡ç¼–æ’
â”œâ”€â”€ extraction_specs/              # æŠ½å–é…ç½®
â”‚   â”œâ”€â”€ project_info_v2.py         # é¡¹ç›®ä¿¡æ¯æŠ½å–é…ç½®
â”‚   â”œâ”€â”€ risks_v2.py                # é£é™©è¯†åˆ«é…ç½®
â”‚   â””â”€â”€ review_v2.py               # å®¡æŸ¥é…ç½®
â”œâ”€â”€ prompts/                       # Prompt æ¨¡æ¿
â”‚   â”œâ”€â”€ project_info_v2.md
â”‚   â”œâ”€â”€ risks_v2.md
â”‚   â””â”€â”€ review_v2.md
â””â”€â”€ contracts/                     # ä¸šåŠ¡å¥‘çº¦å®šä¹‰
    â””â”€â”€ tender_contract_v1.yaml    # æ‹›æŠ•æ ‡å¥‘çº¦
```

#### æŠ½å–æœåŠ¡ (ExtractV2Service)

```python
# apps/tender/extract_v2_service.py
class ExtractV2Service:
    """æ‹›æŠ•æ ‡æŠ½å–æœåŠ¡ - ä¸šåŠ¡ç¼–æ’å±‚"""
    
    async def extract_project_info_v2(
        self,
        project_id: str,
        model_id: Optional[str],
        run_id: Optional[str] = None,
    ) -> Dict[str, Any]:
        """
        æŠ½å–é¡¹ç›®ä¿¡æ¯
        
        ç¼–æ’æµç¨‹:
        1. è·å– embedding provider
        2. æ„å»ºæŠ½å–è§„æ ¼ (build_project_info_spec)
        3. è°ƒç”¨å¹³å°æŠ½å–å¼•æ“ (ExtractionEngine.run)
        4. è¿”å›ç»“æœ
        """
        
        # 1. è·å– embedding provider
        embedding_provider = get_embedding_store().get_default()
        
        # 2. æ„å»º spec
        spec = build_project_info_spec()
        
        # 3. è°ƒç”¨å¼•æ“
        result = await self.engine.run(
            spec=spec,
            retriever=self.retriever,
            llm=self.llm,
            project_id=project_id,
            model_id=model_id,
            run_id=run_id,
            embedding_provider=embedding_provider,
        )
        
        # 4. è¿”å›ç»“æœ
        return {
            "data": result.data,
            "evidence_chunk_ids": result.evidence_chunk_ids,
            "evidence_spans": result.evidence_spans,
            "retrieval_trace": result.retrieval_trace.__dict__
        }
```

#### æŠ½å–é…ç½® (Extraction Spec)

```python
# apps/tender/extraction_specs/project_info_v2.py
def build_project_info_spec() -> ExtractionSpec:
    """æ„å»ºé¡¹ç›®ä¿¡æ¯æŠ½å–è§„æ ¼"""
    
    # åŠ è½½ prompt æ¨¡æ¿
    prompt = _load_prompt("project_info_v2.md")
    
    # å››ä¸ªæŸ¥è¯¢ç»´åº¦
    queries = {
        "base": "æ‹›æ ‡å…¬å‘Š é¡¹ç›®åç§° é¡¹ç›®ç¼–å· é¢„ç®—é‡‘é¢ é‡‡è´­äºº ä»£ç†æœºæ„",
        "technical": "æŠ€æœ¯è¦æ±‚ æŠ€æœ¯è§„èŒƒ æŠ€æœ¯å‚æ•° æ€§èƒ½æŒ‡æ ‡",
        "business": "å•†åŠ¡æ¡æ¬¾ åˆåŒæ¡æ¬¾ ä»˜æ¬¾æ–¹å¼ éªŒæ”¶ è´¨ä¿",
        "scoring": "è¯„åˆ†æ ‡å‡† è¯„æ ‡åŠæ³• è¯„å®¡åŠæ³• è¯„åˆ†ç»†åˆ™",
    }
    
    return ExtractionSpec(
        prompt=prompt,
        queries=queries,
        topk_per_query=30,
        topk_total=120,
        doc_types=["tender"],
        temperature=0.0,
    )
```

---

## æœåŠ¡å±‚ Services

Services å±‚åŒ…å«ä¼ ç»Ÿçš„ä¸šåŠ¡æœåŠ¡å’Œå·¥å…·ç±»ã€‚

### ä¸»è¦æœåŠ¡

```
services/
â”œâ”€â”€ tender_service.py              # æ‹›æŠ•æ ‡æœåŠ¡ä¸»æ§
â”œâ”€â”€ kb_service.py                  # çŸ¥è¯†åº“æœåŠ¡
â”œâ”€â”€ llm_orchestrator.py            # LLM ç¼–æ’å™¨
â”œâ”€â”€ rag_service.py                 # RAG æœåŠ¡
â”œâ”€â”€ dao/                           # æ•°æ®è®¿é—®å¯¹è±¡
â”‚   â”œâ”€â”€ tender_dao.py
â”‚   â”œâ”€â”€ kb_dao.py
â”‚   â””â”€â”€ chat_dao.py
â”œâ”€â”€ template/                      # æ¨¡æ¿æœåŠ¡
â”œâ”€â”€ fragment/                      # ç‰‡æ®µå¤„ç†
â”œâ”€â”€ export/                        # å¯¼å‡ºæœåŠ¡
â”‚   â”œâ”€â”€ export_service.py
â”‚   â””â”€â”€ docx_exporter.py
â””â”€â”€ embedding_provider_store.py    # Embedding æä¾›å•†å­˜å‚¨
```

### TenderService (æ‹›æŠ•æ ‡æœåŠ¡ä¸»æ§)

```python
# services/tender_service.py
class TenderService:
    """æ‹›æŠ•æ ‡ä¸šåŠ¡é€»è¾‘æœåŠ¡"""
    
    def extract_project_info(
        self,
        project_id: str,
        model_id: Optional[str],
        run_id: Optional[str] = None,
        owner_id: Optional[str] = None,
    ):
        """
        æŠ½å–é¡¹ç›®ä¿¡æ¯ - ä¸»æ§æ–¹æ³•
        
        èŒè´£:
        1. æ£€æŸ¥ cutover æ¨¡å¼
        2. åˆ›å»º platform job (å¯é€‰)
        3. è°ƒç”¨ V2 æŠ½å–æœåŠ¡
        4. ä¿å­˜ç»“æœåˆ°æ—§è¡¨ (ä¿è¯å‰ç«¯å…¼å®¹)
        5. æ›´æ–°è¿è¡ŒçŠ¶æ€
        """
        
        # 1. æ£€æŸ¥æ¨¡å¼
        cutover = get_cutover_config()
        extract_mode = cutover.get_mode("extract", project_id)
        if extract_mode.value != "NEW_ONLY":
            raise RuntimeError("Set EXTRACT_MODE=NEW_ONLY")
        
        # 2. è°ƒç”¨ v2 æŠ½å–
        extract_v2 = ExtractV2Service(pool, self.llm)
        v2_result = asyncio.run(extract_v2.extract_project_info_v2(...))
        
        # 3. ä¿å­˜åˆ°æ—§è¡¨
        self.dao.upsert_project_info(project_id, data_json=data, ...)
        
        # 4. æ›´æ–°çŠ¶æ€
        if run_id:
            self.dao.update_run(run_id, "success", ...)
    
    def run_review(
        self,
        project_id: str,
        model_id: Optional[str],
        custom_rule_asset_ids: List[str],
        bidder_name: Optional[str],
        bid_asset_ids: List[str],
        run_id: Optional[str] = None,
    ):
        """
        è¿è¡Œå®¡æŸ¥ - ä¸»æ§æ–¹æ³•
        
        æµç¨‹:
        1. åŠ è½½æ‹›æ ‡æ–‡ä»¶ chunks
        2. åŠ è½½æŠ•æ ‡æ–‡ä»¶ chunks
        3. åŠ è½½è‡ªå®šä¹‰è§„åˆ™æ–‡ä»¶ (å¯é€‰)
        4. è°ƒç”¨ LLM è¿›è¡Œå¯¹æ¯”å®¡æŸ¥
        5. è°ƒç”¨è§„åˆ™å¼•æ“æ‰§è¡Œç¡®å®šæ€§è§„åˆ™
        6. åˆå¹¶ç»“æœ
        7. ä¿å­˜åˆ°æ•°æ®åº“
        """
```

---

## æ•°æ®å­˜å‚¨

### PostgreSQL æ•°æ®åº“

#### æ ¸å¿ƒè¡¨ç»“æ„

```sql
-- 1. æ‹›æŠ•æ ‡é¡¹ç›®è¡¨
CREATE TABLE tender_projects (
    id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(500) NOT NULL,
    kb_id VARCHAR(50),               -- å…³è”çŸ¥è¯†åº“ID
    owner_id VARCHAR(50),
    status VARCHAR(50),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 2. é¡¹ç›®èµ„äº§è¡¨ (æ–‡ä»¶)
CREATE TABLE tender_assets (
    id VARCHAR(50) PRIMARY KEY,
    project_id VARCHAR(50) REFERENCES tender_projects(id) ON DELETE CASCADE,
    file_name VARCHAR(500),
    kind VARCHAR(50),                -- tender | bid | rule | template
    bidder_name VARCHAR(200),        -- æŠ•æ ‡äººåç§° (kind=bidæ—¶ä½¿ç”¨)
    kb_doc_id VARCHAR(50),           -- å…³è”çŸ¥è¯†åº“æ–‡æ¡£ID
    created_at TIMESTAMP DEFAULT NOW()
);

-- 3. æ–‡æ¡£è¡¨ (æ–°)
CREATE TABLE documents (
    document_id VARCHAR(50) PRIMARY KEY,
    project_id VARCHAR(50),
    doc_type VARCHAR(50),            -- tender | bid | rule
    original_name VARCHAR(500),
    created_at TIMESTAMP DEFAULT NOW()
);

-- 4. æ–‡æ¡£ç‰ˆæœ¬è¡¨ (æ–°)
CREATE TABLE document_versions (
    doc_version_id VARCHAR(50) PRIMARY KEY,
    document_id VARCHAR(50) REFERENCES documents(document_id) ON DELETE CASCADE,
    version_no INTEGER DEFAULT 1,
    is_current BOOLEAN DEFAULT TRUE,
    file_path TEXT,
    page_count INTEGER,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 5. æ–‡æ¡£å—è¡¨ (æ–°) - æ ¸å¿ƒæ£€ç´¢è¡¨
CREATE TABLE doc_segments (
    segment_id VARCHAR(50) PRIMARY KEY,
    doc_version_id VARCHAR(50) REFERENCES document_versions(doc_version_id) ON DELETE CASCADE,
    position INTEGER,                -- å—åœ¨æ–‡æ¡£ä¸­çš„ä½ç½®
    content TEXT NOT NULL,           -- æ–‡æœ¬å†…å®¹
    page_no INTEGER,                 -- é¡µç 
    embedding VECTOR(1536),          -- å‘é‡ (pgvector)
    meta JSONB,                      -- å…ƒæ•°æ®
    created_at TIMESTAMP DEFAULT NOW()
);

-- ä¸ºå‘é‡æ£€ç´¢åˆ›å»ºç´¢å¼•
CREATE INDEX idx_doc_segments_embedding 
    ON doc_segments USING ivfflat (embedding vector_cosine_ops);

-- 6. çŸ¥è¯†åº“åˆ†å—è¡¨ (æ—§) - å‘åå…¼å®¹
CREATE TABLE kb_chunks (
    id SERIAL PRIMARY KEY,
    doc_id INTEGER REFERENCES kb_documents(id) ON DELETE CASCADE,
    kb_id INTEGER,
    chunk_index INTEGER,
    content TEXT NOT NULL,
    content_vector TSVECTOR,         -- å…¨æ–‡æ£€ç´¢
    created_at TIMESTAMP DEFAULT NOW()
);

-- 7. é¡¹ç›®ä¿¡æ¯è¡¨
CREATE TABLE project_info (
    project_id VARCHAR(50) PRIMARY KEY,
    data_json JSONB NOT NULL,        -- é¡¹ç›®ä¿¡æ¯ç»“æ„åŒ–æ•°æ®
    evidence_chunk_ids TEXT[],       -- è¯æ®chunk IDs
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 8. é£é™©è¡¨
CREATE TABLE risks (
    id VARCHAR(50) PRIMARY KEY,
    project_id VARCHAR(50) REFERENCES tender_projects(id) ON DELETE CASCADE,
    risk_type VARCHAR(100),
    title VARCHAR(500),
    description TEXT,
    suggestion TEXT,
    severity VARCHAR(50),            -- high | medium | low
    tags TEXT[],
    evidence_chunk_ids TEXT[],
    created_at TIMESTAMP DEFAULT NOW()
);

-- 9. å®¡æŸ¥ç»“æœè¡¨
CREATE TABLE review_items (
    id VARCHAR(50) PRIMARY KEY,
    project_id VARCHAR(50) REFERENCES tender_projects(id) ON DELETE CASCADE,
    bidder_name VARCHAR(200),
    source VARCHAR(50),              -- compare | rule
    dimension VARCHAR(200),
    requirement_text TEXT,
    response_text TEXT,
    result VARCHAR(50),              -- pass | risk | fail
    rigid BOOLEAN,                   -- æ˜¯å¦åˆšæ€§
    evidence_chunk_ids TEXT[],
    rule_id VARCHAR(50),             -- è§„åˆ™ID (å¦‚æœæ¥è‡ªè§„åˆ™å¼•æ“)
    created_at TIMESTAMP DEFAULT NOW()
);

-- 10. ç›®å½•èŠ‚ç‚¹è¡¨
CREATE TABLE directory_nodes (
    id VARCHAR(50) PRIMARY KEY,
    project_id VARCHAR(50) REFERENCES tender_projects(id) ON DELETE CASCADE,
    parent_id VARCHAR(50),
    order_no INTEGER,
    numbering VARCHAR(50),           -- ç« èŠ‚ç¼–å· (1.1.1)
    level INTEGER,
    title VARCHAR(500),
    is_required BOOLEAN,
    source VARCHAR(50),              -- tender | sample | manual
    notes TEXT,
    volume VARCHAR(50),              -- å·å·
    evidence_chunk_ids TEXT[],
    meta_json JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 11. è¿è¡Œè®°å½•è¡¨ (ä»»åŠ¡è¿½è¸ª)
CREATE TABLE runs (
    id VARCHAR(50) PRIMARY KEY,
    project_id VARCHAR(50) REFERENCES tender_projects(id) ON DELETE CASCADE,
    run_type VARCHAR(50),            -- extract | review | generate | ingest
    status VARCHAR(50),              -- pending | running | success | failed
    progress FLOAT,
    message TEXT,
    result_json JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 12. è§„åˆ™é›†è¡¨
CREATE TABLE rule_sets (
    id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(200),
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 13. è§„åˆ™é›†ç‰ˆæœ¬è¡¨
CREATE TABLE rule_set_versions (
    id VARCHAR(50) PRIMARY KEY,
    rule_set_id VARCHAR(50) REFERENCES rule_sets(id) ON DELETE CASCADE,
    version_no INTEGER,
    content_yaml TEXT,               -- YAML æ ¼å¼çš„è§„åˆ™å®šä¹‰
    is_current BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### Redis å­˜å‚¨

```
# ä»»åŠ¡é˜Ÿåˆ—
rq:queue:default                   # é»˜è®¤é˜Ÿåˆ—
rq:queue:ingest                    # æ–‡æ¡£æ‘„å…¥é˜Ÿåˆ—
rq:queue:extract                   # æ•°æ®æŠ½å–é˜Ÿåˆ—
rq:queue:review                    # å®¡æŸ¥é˜Ÿåˆ—

# Job æ•°æ®
rq:job:{job_id}                    # Job è¯¦æƒ…
rq:job:{job_id}:dependents         # Job ä¾èµ–å…³ç³»

# Worker æ³¨å†Œ
rq:workers                         # Worker æ³¨å†Œè¡¨
rq:worker:{worker_name}            # Worker å¿ƒè·³
```

### æ–‡ä»¶å­˜å‚¨

```
./storage/
â”œâ”€â”€ attachments/                   # èŠå¤©é™„ä»¶
â”‚   â””â”€â”€ {uuid}.{ext}
â”œâ”€â”€ recordings/                    # è¯­éŸ³å½•éŸ³
â”‚   â””â”€â”€ {uuid}.wav
â””â”€â”€ tender/                        # æ‹›æŠ•æ ‡æ–‡ä»¶
    â””â”€â”€ {project_id}/
        â”œâ”€â”€ {asset_id}.pdf         # æ‹›æ ‡æ–‡ä»¶
        â”œâ”€â”€ {asset_id}.docx        # æŠ•æ ‡æ–‡ä»¶
        â””â”€â”€ {asset_id}.yaml        # è§„åˆ™æ–‡ä»¶
```

---

## éƒ¨ç½²æ¶æ„

### Docker Compose æœåŠ¡

```yaml
version: '3.8'

services:
  # åç«¯æœåŠ¡
  backend:
    image: x-llm-backend:local
    ports:
      - "9001:8000"
    environment:
      - DATABASE_URL=postgresql://...
      - REDIS_URL=redis://redis:6379/0
      - EXTRACT_MODE=NEW_ONLY
      - RETRIEVAL_MODE=NEW_ONLY
    volumes:
      - ./data:/app/data
      - ./storage:/app/storage
    depends_on:
      - postgres
      - redis

  # Worker æœåŠ¡ (å¼‚æ­¥ä»»åŠ¡)
  worker:
    image: x-llm-backend:local
    command: python worker.py
    environment:
      - DATABASE_URL=postgresql://...
      - REDIS_URL=redis://redis:6379/0
    volumes:
      - ./data:/app/data
      - ./storage:/app/storage
    depends_on:
      - postgres
      - redis

  # å‰ç«¯æœåŠ¡
  frontend:
    image: x-llm-frontend:local
    ports:
      - "6173:5173"
    depends_on:
      - backend

  # PostgreSQL æ•°æ®åº“
  postgres:
    image: postgres:15-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=localgpt
      - POSTGRES_USER=localgpt
      - POSTGRES_PASSWORD=localgpt
    volumes:
      - ./data/postgres:/var/lib/postgresql/data

  # Redis ç¼“å­˜/é˜Ÿåˆ—
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
```

### ç«¯å£æ˜ å°„

| æœåŠ¡ | å®¹å™¨ç«¯å£ | å®¿ä¸»ç«¯å£ | è¯´æ˜ |
|------|---------|---------|------|
| Frontend | 5173 | 6173 | React + Nginx |
| Backend | 8000 | 9001 | FastAPI + Uvicorn |
| PostgreSQL | 5432 | 5432 | æ•°æ®åº“ |
| Redis | 6379 | 6379 | ç¼“å­˜/é˜Ÿåˆ— |

---

## å…³é”®æŠ€æœ¯ç‚¹

### 1. ç°åº¦åˆ‡æ¢æœºåˆ¶ (Cutover)

```python
# core/cutover.py
class CutoverMode(str, Enum):
    OLD = "OLD"              # ä»…ä½¿ç”¨æ—§é€»è¾‘
    SHADOW = "SHADOW"        # åŒè·¯å¾„è¿è¡Œå¹¶å¯¹æ¯”
    NEW_ONLY = "NEW_ONLY"    # ä»…ä½¿ç”¨æ–°å¹³å°å¼•æ“

# ç¯å¢ƒå˜é‡æ§åˆ¶
EXTRACT_MODE=NEW_ONLY         # æŠ½å–æ¨¡å¼
RETRIEVAL_MODE=NEW_ONLY       # æ£€ç´¢æ¨¡å¼
REVIEW_MODE=NEW_ONLY          # å®¡æŸ¥æ¨¡å¼
INGEST_MODE=NEW_ONLY          # æ‘„å…¥æ¨¡å¼
```

**ä½¿ç”¨åœºæ™¯**:
- é‡æ„è¿ç§»æ—¶ä¿è¯å¹³æ»‘è¿‡æ¸¡
- SHADOW æ¨¡å¼ç”¨äºéªŒè¯æ–°æ—§ä¸€è‡´æ€§
- é—®é¢˜æ—¶å¯å¿«é€Ÿå›æ»šåˆ° OLD æ¨¡å¼

### 2. é…ç½®é©±åŠ¨çš„æŠ½å– (Config-Driven Extraction)

æ‰€æœ‰æŠ½å–ä»»åŠ¡éƒ½é€šè¿‡ **ExtractionSpec** é…ç½®é©±åŠ¨:

```python
spec = ExtractionSpec(
    prompt="...",                    # System prompt (from .md file)
    queries={                        # å¤šç»´åº¦æ£€ç´¢æŸ¥è¯¢
        "base": "å…³é”®è¯1 å…³é”®è¯2",
        "technical": "å…³é”®è¯3 å…³é”®è¯4",
    },
    topk_per_query=30,               # æ¯ä¸ªæŸ¥è¯¢è¿”å›30ä¸ªå—
    topk_total=120,                  # æ€»è®¡æœ€å¤š120ä¸ªå—
    doc_types=["tender"],            # åªæ£€ç´¢æ‹›æ ‡æ–‡ä»¶
    temperature=0.0,                 # LLM æ¸©åº¦ (0.0 = ç¡®å®šæ€§)
)
```

**ä¼˜åŠ¿**:
- æ— éœ€ä¿®æ”¹ä»£ç å³å¯è°ƒæ•´æŠ½å–è¡Œä¸º
- Prompt é›†ä¸­ç®¡ç†åœ¨ `.md` æ–‡ä»¶ä¸­
- æ£€ç´¢å‚æ•°å¯é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–

### 3. å¤šæŸ¥è¯¢æ£€ç´¢ç­–ç•¥ (Multi-Query Retrieval)

ä½¿ç”¨å¤šä¸ªä¸åŒè§’åº¦çš„æŸ¥è¯¢,æé«˜å¬å›ç‡:

```python
queries = {
    "base": "é¡¹ç›®åç§° é¢„ç®— é‡‡è´­äºº è”ç³»äºº",
    "technical": "æŠ€æœ¯è¦æ±‚ æ€§èƒ½æŒ‡æ ‡ å‚æ•°è§„æ ¼",
    "business": "ä»˜æ¬¾æ–¹å¼ éªŒæ”¶ è´¨ä¿ è¿çº¦",
    "scoring": "è¯„åˆ†æ ‡å‡† è¯„åˆ†ç»†åˆ™ æƒé‡ åˆ†å€¼",
}

# æ¯ä¸ªæŸ¥è¯¢ç‹¬ç«‹æ£€ç´¢,ç„¶åå»é‡åˆå¹¶
for key, query in queries.items():
    chunks = await retriever.retrieve(query, top_k=30)
    all_chunks.extend(chunks)

# å»é‡å¹¶æˆªæ–­åˆ°æ€»é‡é™åˆ¶
unique_chunks = deduplicate(all_chunks)
final_chunks = unique_chunks[:topk_total]
```

### 4. æ ‡è®°ä¸Šä¸‹æ–‡ (Marked Context)

ä¸º LLM æä¾›å¸¦æ ‡è®°çš„ä¸Šä¸‹æ–‡,ä¾¿äºè¿½æº¯è¯æ®:

```xml
<chunk id="chunk_abc123">
ç¬¬ä¸€ç«  é¡¹ç›®æ¦‚è¿°

1.1 é¡¹ç›®åç§°: XXåŒ»é™¢ä¿¡æ¯åŒ–å»ºè®¾é¡¹ç›®
1.2 é¡¹ç›®é¢„ç®—: 500ä¸‡å…ƒ
</chunk>

<chunk id="chunk_def456">
ç¬¬äºŒç«  æŠ€æœ¯è¦æ±‚

2.1 æœåŠ¡å™¨é…ç½®
- CPU: Intel Xeon Gold 6248R Ã— 2
- å†…å­˜: 256GB DDR4 ECC
</chunk>
```

**ä¼˜åŠ¿**:
- LLM å¯ä»¥åœ¨è¾“å‡ºä¸­å¼•ç”¨ chunk_id
- ä¾¿äºéªŒè¯å’Œå®¡è®¡
- æ”¯æŒè¯æ®é“¾è¿½æº¯

### 5. JSON è§£æä¸ä¿®å¤ (JSON Repair)

LLM è¾“å‡ºçš„ JSON å¯èƒ½ä¸å®Œæ•´æˆ–æ ¼å¼é”™è¯¯,ç³»ç»Ÿæ”¯æŒè‡ªåŠ¨ä¿®å¤:

```python
# platform/extraction/json_utils.py

def extract_json(text: str) -> Any:
    """æå– JSON (æ”¯æŒ ```json ä»£ç å—)"""
    # 1. å°è¯•ç›´æ¥è§£æ
    try:
        return json.loads(text)
    except:
        pass
    
    # 2. å°è¯•æå– ```json ... ``` ä»£ç å—
    match = re.search(r'```json\s*(.*?)\s*```', text, re.DOTALL)
    if match:
        return json.loads(match.group(1))
    
    raise ValueError("No valid JSON found")

def repair_json(text: str) -> Any:
    """ä¿®å¤å¸¸è§ JSON é”™è¯¯"""
    # 1. ç§»é™¤å°¾éƒ¨é€—å·
    text = re.sub(r',\s*}', '}', text)
    text = re.sub(r',\s*]', ']', text)
    
    # 2. è¡¥å…¨ç¼ºå¤±çš„å¼•å·
    # ...
    
    # 3. å°è¯•è§£æ
    return json.loads(text)
```

### 6. è¯æ®è¿½æº¯ (Evidence Tracking)

æ‰€æœ‰ç»“æœéƒ½é™„å¸¦å®Œæ•´çš„è¯æ®é“¾:

```json
{
  "data": {
    "projectName": "XXåŒ»é™¢ä¿¡æ¯åŒ–å»ºè®¾é¡¹ç›®"
  },
  "evidence_chunk_ids": [
    "chunk_abc123",
    "chunk_def456"
  ],
  "evidence_spans": [
    {
      "source": "doc_version_xyz",
      "page_no": 5,
      "snippet": "é¡¹ç›®åç§°: XXåŒ»é™¢ä¿¡æ¯åŒ–å»ºè®¾é¡¹ç›®"
    }
  ],
  "retrieval_trace": {
    "retrieval_provider": "new",
    "retrieval_strategy": "multi_query",
    "queries": {
      "base": {
        "retrieved_count": 30,
        "top_ids": ["chunk_abc123", ...]
      }
    },
    "retrieved_count_total": 120
  }
}
```

### 7. å‘é‡æ£€ç´¢ (pgvector)

ä½¿ç”¨ PostgreSQL çš„ pgvector æ‰©å±•è¿›è¡Œé«˜æ•ˆå‘é‡æ£€ç´¢:

```sql
-- å®‰è£…æ‰©å±•
CREATE EXTENSION IF NOT EXISTS vector;

-- åˆ›å»ºå‘é‡åˆ—
ALTER TABLE doc_segments 
  ADD COLUMN embedding VECTOR(1536);

-- åˆ›å»ºç´¢å¼• (IVFFlat)
CREATE INDEX idx_doc_segments_embedding 
  ON doc_segments 
  USING ivfflat (embedding vector_cosine_ops)
  WITH (lists = 100);

-- å‘é‡æ£€ç´¢æŸ¥è¯¢
SELECT 
  segment_id,
  content,
  embedding <=> query_embedding AS distance
FROM doc_segments
WHERE project_id = 'proj_123'
  AND doc_type = 'tender'
ORDER BY embedding <=> query_embedding
LIMIT 30;
```

**ä¼˜åŠ¿**:
- æ— éœ€é¢å¤–çš„å‘é‡æ•°æ®åº“ (å¦‚ Milvus)
- åˆ©ç”¨ PostgreSQL çš„äº‹åŠ¡æ€§
- ç®€åŒ–è¿ç»´

### 8. å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ— (RQ)

ä½¿ç”¨ Redis Queue (RQ) å¤„ç†è€—æ—¶ä»»åŠ¡:

```python
# queue/tasks.py
from rq import Queue
from redis import Redis

redis_conn = Redis(host='redis', port=6379)
ingest_queue = Queue('ingest', connection=redis_conn)
extract_queue = Queue('extract', connection=redis_conn)

# æäº¤ä»»åŠ¡
job = extract_queue.enqueue(
    'app.services.tender_service.extract_project_info',
    project_id='proj_123',
    model_id='gpt-4',
    job_timeout='10m'
)

# worker.py - Worker è¿›ç¨‹
from rq import Worker

worker = Worker(
    ['default', 'ingest', 'extract', 'review'],
    connection=redis_conn
)
worker.work()
```

---

## æ€»ç»“

### ç³»ç»Ÿç‰¹ç‚¹

âœ… **å¹³å°åŒ–è®¾è®¡**: Platform å±‚å¯å¤ç”¨äºå¤šä¸šåŠ¡  
âœ… **é…ç½®é©±åŠ¨**: Spec é…ç½® + ç¯å¢ƒå˜é‡çµæ´»æ§åˆ¶  
âœ… **ç°åº¦åˆ‡æ¢**: æ”¯æŒå¹³æ»‘è¿ç§»å’Œå¿«é€Ÿå›æ»š  
âœ… **è¯æ®å¯è¿½æº¯**: å®Œæ•´çš„è¯æ®é“¾å’Œæ£€ç´¢è¿½è¸ª  
âœ… **æ€§èƒ½å¯æ§**: åˆ†é˜¶æ®µæ‰§è¡Œ,æœ‰æ—¶é—´ç»Ÿè®¡  
âœ… **é”™è¯¯å¤„ç†å®Œå–„**: å¤šçº§å›é€€å’Œè‡ªåŠ¨ä¿®å¤  
âœ… **å‘åå…¼å®¹**: æ”¯æŒæ–°æ—§æ•°æ®è¡¨  

### æŠ€æœ¯äº®ç‚¹

1. **åˆ†å±‚æ¸…æ™°**: Platform / Apps / Services / Core èŒè´£æ˜ç¡®
2. **é€šç”¨æŠ½å–å¼•æ“**: å¯æ”¯æŒä»»æ„ç»“æ„åŒ–æ•°æ®æå–
3. **å¤šæŸ¥è¯¢æ£€ç´¢**: 4ç»´åº¦æŸ¥è¯¢,æé«˜å¬å›ç‡
4. **æ ‡è®°ä¸Šä¸‹æ–‡**: ä¾¿äºLLMç†è§£å’Œè¯æ®è¿½æº¯
5. **JSONä¿®å¤**: æé«˜LLMè¾“å‡ºè§£ææˆåŠŸç‡
6. **pgvector**: æ— éœ€é¢å¤–å‘é‡æ•°æ®åº“
7. **å¼‚æ­¥ä»»åŠ¡**: RQé˜Ÿåˆ—å¤„ç†è€—æ—¶æ“ä½œ

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-12-20  
**ç»´æŠ¤å›¢é˜Ÿ**: äº¿æ—äº¿é—®å¼€å‘å›¢é˜Ÿ

