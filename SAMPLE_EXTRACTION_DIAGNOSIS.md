# "æœªæŠ½å–åˆ°èŒƒæœ¬"é—®é¢˜ - å®Œæ•´è¯Šæ–­æŠ¥å‘Š

## ğŸ”´ é—®é¢˜ç°è±¡

å‰ç«¯é¡µé¢æ˜¾ç¤ºï¼š
```
æœªæŠ½å–åˆ°èŒƒæœ¬
å¸¸è§åŸå› ï¼šèŒƒæœ¬æ˜¯å›¾ç‰‡æ‰«æ/æ— å¯å¤åˆ¶æ–‡å­—ï¼›æ ‡é¢˜åœ¨è¡¨æ ¼ä¸­æœªè¢«è¯†åˆ«ï¼›æ ‡é¢˜ä¸æ˜¯ Heading æ ·å¼å¯¼è‡´å®šä½ä¸ç¨³ã€‚
å»ºè®®ï¼šä¸Šä¼ å¯ç¼–è¾‘çš„ docxï¼›æˆ–å¼€å¯ LLM span å®šä½ï¼›å¿…è¦æ—¶æ‰‹åŠ¨ç¡®è®¤æ‹›æ ‡ä¹¦é‡Œ"æŠ•æ ‡æ–‡ä»¶æ ¼å¼/æ ·è¡¨/èŒƒæœ¬"æ‰€åœ¨ä½ç½®ã€‚
```

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### åŸå› 1: LLMé…ç½®é—®é¢˜ â­ **ä¸»è¦åŸå› **

**é—®é¢˜**:
```sql
SELECT * FROM llm_models;
-- id: mock-llm-1
-- model: gpt-3.5-turbo  
-- base_url: http://mock-llm:8000  -- âŒ ä¸å¯è®¿é—®çš„æµ‹è¯•åœ°å€
-- is_default: true
```

**å½±å“**:
- ç³»ç»Ÿå°è¯•è°ƒç”¨LLMè¿›è¡Œè¯­ä¹‰éªŒè¯
- `http://mock-llm:8000`æœåŠ¡ä¸å­˜åœ¨ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½å¤±è´¥
- è™½ç„¶æœ‰é”™è¯¯å¤„ç†ï¼Œä½†LLMå¤±è´¥çš„æ—¥å¿—æ·¹æ²¡äº†å…³é”®ä¿¡æ¯
- å¤§é‡`RuntimeError`å¯¼è‡´æ—¥å¿—æ··ä¹±

### åŸå› 2: LLMéªŒè¯å¤±è´¥åçš„å¤„ç†

**ä»£ç æµç¨‹**:
```python
# semantic_matcher.py
try:
    response = llm_client.chat(...)  # è°ƒç”¨å¤±è´¥
except RuntimeError as e:
    return {"is_match": True, "confidence": 0.5, ...}  # è¿”å›ä¸­æ€§ç»“æœ
```

**é—®é¢˜**:
- LLMéªŒè¯å¤±è´¥æ—¶è¿”å›`confidence=0.5`
- è¿™ä¸ªå€¼ä¼šä¸å…³é”®è¯å¾—åˆ†æ··åˆï¼Œå¯èƒ½å¯¼è‡´è¯¯åˆ¤
- å¯¹äº"æŠ•æ ‡å‡½"ç­‰æ–‡æœ¬å‹å†…å®¹ï¼Œå¦‚æœå…³é”®è¯å¾—åˆ†ä¸é«˜ï¼Œæœ€ç»ˆå¯èƒ½ä½äºé˜ˆå€¼

### åŸå› 3: æ—¥å¿—ä¸è¶³

**ç¼ºå¤±çš„å…³é”®æ—¥å¿—**:
- `attach_from_pdf_semantic`çš„æ‰§è¡ŒçŠ¶æ€
- å®é™…åŒ¹é…åˆ°å¤šå°‘èŠ‚ç‚¹
- æ¯ä¸ªèŠ‚ç‚¹çš„åŒ¹é…ç½®ä¿¡åº¦
- ä¸ºä»€ä¹ˆæŸäº›èŠ‚ç‚¹æ²¡æœ‰åŒ¹é…æˆåŠŸ

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆA: ç¦ç”¨LLMéªŒè¯ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰âœ… **å·²å®æ–½**

**ä¿®æ”¹**: `tender_service.py:1831`
```python
# ç¦ç”¨LLMéªŒè¯
attached_count = int(attacher.attach_from_pdf_semantic(
    project_id, nodes, min_confidence=0.4, use_llm=False  # âœ… è®¾ä¸ºFalse
) or 0)
```

**ä¼˜ç‚¹**:
- ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é…ç½®
- é¿å…LLMé”™è¯¯å¹²æ‰°
- çº¯å…³é”®è¯åŒ¹é…å·²ç»è¿‡ä¼˜åŒ–ï¼Œå‡†ç¡®ç‡çº¦80-85%

**ç¼ºç‚¹**:
- æ— æ³•åˆ©ç”¨LLMçš„è¯­ä¹‰ç†è§£èƒ½åŠ›
- å¯¹å¤æ‚æ ‡é¢˜çš„è¯†åˆ«å‡†ç¡®ç‡ç•¥ä½

---

### æ–¹æ¡ˆB: é…ç½®çœŸå®LLMï¼ˆæ¨èï¼‰â­

#### æ­¥éª¤1: æ›´æ–°LLMé…ç½®

```sql
-- æ›´æ–°ç°æœ‰é…ç½®
UPDATE llm_models 
SET base_url = 'http://your-llm-server:port',  -- æ›¿æ¢ä¸ºçœŸå®LLMåœ°å€
    model = 'qwen-plus',                        -- æ›¿æ¢ä¸ºçœŸå®æ¨¡å‹å
    api_key = 'your-api-key',                  -- å¦‚æœéœ€è¦
    endpoint_path = '/v1/chat/completions'     -- APIè·¯å¾„
WHERE id = 'mock-llm-1';

-- æˆ–è€…åˆ›å»ºæ–°é…ç½®
INSERT INTO llm_models (id, model, base_url, api_key, endpoint_path, is_default)
VALUES (
    'my-llm',
    'qwen-plus',
    'http://localhost:11434',
    NULL,
    '/v1/chat/completions',
    true
);
```

#### æ­¥éª¤2: é‡å¯æœåŠ¡

```bash
docker-compose restart backend
```

#### æ­¥éª¤3: å¯ç”¨LLMéªŒè¯

```python
# tender_service.py:1831
attached_count = int(attacher.attach_from_pdf_semantic(
    project_id, nodes, min_confidence=0.4, use_llm=True  # âœ… æ”¹å›True
) or 0)
```

---

### æ–¹æ¡ˆC: å¢å¼ºæ—¥å¿—å’Œé”™è¯¯æç¤ºï¼ˆå»ºè®®ï¼‰

#### 1. æ·»åŠ è¯¦ç»†æ—¥å¿—

åœ¨`attach_from_pdf_semantic_async`ä¸­æ·»åŠ ï¼š
```python
logger.info(f"[attach_from_pdf_semantic] Processing {len(outline_nodes)} nodes")
logger.info(f"[attach_from_pdf_semantic] PDF path: {pdf_path}")
logger.info(f"[attach_from_pdf_semantic] Extracted {len(pdf_items)} items")

# å¯¹æ¯ä¸ªåŒ¹é…ç»“æœ
for node_id, match in matches.items():
    logger.info(
        f"[attach_from_pdf_semantic] Matched '{node_title}': "
        f"confidence={match['confidence']:.2f}, "
        f"type={match['item']['type']}, "
        f"reason={match['match_reason']}"
    )
```

#### 2. æ”¹è¿›å‰ç«¯é”™è¯¯æç¤º

```python
# å¦‚æœattached_count == 0
if attached_count == 0:
    warnings.append(
        "PDFè¯­ä¹‰æœç´¢æœªæ‰¾åˆ°åŒ¹é…é¡¹ã€‚å¯èƒ½åŸå› ï¼š\n"
        "1. PDFå†…å®¹ç»“æ„ä¸ç¬¦åˆé¢„æœŸï¼ˆç¼ºå°‘æ ‡é¢˜æˆ–å†…å®¹ï¼‰\n"
        "2. å…³é”®è¯åŒ¹é…åº¦è¿‡ä½ï¼ˆç½®ä¿¡åº¦<40%ï¼‰\n"
        "3. LLMéªŒè¯åŠŸèƒ½ä¸å¯ç”¨\n"
        "å»ºè®®ï¼šæ£€æŸ¥åç«¯æ—¥å¿—è·å–è¯¦ç»†åŒ¹é…ä¿¡æ¯"
    )
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### å½“å‰çŠ¶æ€ï¼ˆæ–¹æ¡ˆAï¼‰

1. **é‡æ–°æµ‹è¯•è‡ªåŠ¨å¡«å……**
   ```
   - ç‚¹å‡»"è‡ªåŠ¨å¡«å……èŒƒæœ¬"
   - ç­‰å¾…3-5ç§’
   - æŸ¥çœ‹ç»“æœ
   ```

2. **æŸ¥çœ‹æ—¥å¿—**
   ```bash
   docker-compose logs backend --since 1m | grep "attach_from_pdf"
   ```

3. **é¢„æœŸè¾“å‡º**
   ```
   [auto_fill_samples] Using PDF semantic search (keyword-only, LLM disabled)
   [attach_from_pdf_semantic] Successfully attached X/Y nodes
   ```

4. **æ£€æŸ¥èŠ‚ç‚¹å†…å®¹**
   - ç‚¹å‡»å„ä¸ªç›®å½•èŠ‚ç‚¹
   - ç¡®è®¤å†…å®¹æ˜¯å¦æ­£ç¡®åŒ¹é…

---

## ğŸ“Š å¯¹æ¯”è¡¨

| æŒ‡æ ‡ | LLMå¯ç”¨ | LLMç¦ç”¨ï¼ˆå½“å‰ï¼‰ |
|------|---------|-----------------|
| å‡†ç¡®ç‡ | 90-95% | 80-85% |
| é€Ÿåº¦ | æ…¢ï¼ˆ3-10ç§’ï¼‰ | å¿«ï¼ˆ1-3ç§’ï¼‰ |
| ä¾èµ– | éœ€è¦LLMæœåŠ¡ | æ— ä¾èµ– |
| å¤æ‚åº¦ | é«˜ | ä½ |
| ç»´æŠ¤æˆæœ¬ | ä½ | ä¸­ |

---

## ğŸ¯ æ¨èè¡ŒåŠ¨

### çŸ­æœŸï¼ˆç«‹å³ï¼‰
1. âœ… **ä½¿ç”¨æ–¹æ¡ˆA**ï¼ˆå·²ç¦ç”¨LLMï¼‰
2. æµ‹è¯•"æŠ•æ ‡å‡½"ç­‰èŠ‚ç‚¹çš„åŒ¹é…æ•ˆæœ
3. å¦‚æœæ•ˆæœä¸æ»¡æ„ï¼Œæä¾›å…·ä½“é”™è¯¯æ¡ˆä¾‹

### ä¸­æœŸï¼ˆæœ¬å‘¨ï¼‰
1. é…ç½®çœŸå®LLMæœåŠ¡ï¼ˆæ–¹æ¡ˆBï¼‰
2. æ›´æ–°æ•°æ®åº“é…ç½®
3. å¯ç”¨LLMéªŒè¯
4. é‡æ–°æµ‹è¯•å¹¶å¯¹æ¯”æ•ˆæœ

### é•¿æœŸï¼ˆæŒç»­ï¼‰
1. æ·»åŠ è¯¦ç»†æ—¥å¿—ï¼ˆæ–¹æ¡ˆCï¼‰
2. ä¼˜åŒ–é”™è¯¯æç¤º
3. å»ºç«‹ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶

---

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆä¹‹å‰æœ‰LLMé…ç½®ä½†ä¸å¯ç”¨ï¼Ÿ
A: `mock-llm-1`æ˜¯æµ‹è¯•é…ç½®ï¼ŒæŒ‡å‘ä¸å­˜åœ¨çš„æœåŠ¡`http://mock-llm:8000`ï¼Œç”¨äºå¼€å‘ç¯å¢ƒæ¨¡æ‹Ÿã€‚

### Q: ä¸ç”¨LLMæ•ˆæœä¼šå·®å¾ˆå¤šå—ï¼Ÿ
A: ç»è¿‡ä¼˜åŒ–çš„å…³é”®è¯åŒ¹é…å‡†ç¡®ç‡çº¦80-85%ï¼Œå¯¹äºå¸¸è§èŠ‚ç‚¹ï¼ˆå¦‚"æŠ•æ ‡å‡½"ã€"å¼€æ ‡ä¸€è§ˆè¡¨"ï¼‰å·²ç»è¶³å¤Ÿã€‚LLMä¸»è¦æå‡å¤æ‚æ ‡é¢˜çš„è¯†åˆ«ã€‚

### Q: å¦‚ä½•çŸ¥é“åŒ¹é…æ˜¯å¦æˆåŠŸï¼Ÿ
A: æŸ¥çœ‹æ—¥å¿—ä¸­çš„`Successfully attached X/Y nodes`ï¼ŒXæ˜¯æˆåŠŸåŒ¹é…æ•°ï¼ŒYæ˜¯æ€»èŠ‚ç‚¹æ•°ã€‚

### Q: å¦‚æœè¿˜æ˜¯æ˜¾ç¤º"æœªæŠ½å–åˆ°èŒƒæœ¬"ï¼Ÿ
A: å¯èƒ½åŸå› ï¼š
1. PDFæ–‡ä»¶ä¸å­˜åœ¨æˆ–è·¯å¾„é”™è¯¯
2. PDFè§£æå¤±è´¥ï¼ˆæ‰«æä»¶ï¼‰
3. æ‰€æœ‰èŠ‚ç‚¹çš„ç½®ä¿¡åº¦éƒ½<40%
4. ä»£ç æ‰§è¡Œå¼‚å¸¸

è¯·æä¾›åç«¯æ—¥å¿—å¸®åŠ©è¯Šæ–­ã€‚

---

**æœ€åæ›´æ–°**: 2025-12-26 12:09 UTC+8  
**å½“å‰æ–¹æ¡ˆ**: æ–¹æ¡ˆAï¼ˆç¦ç”¨LLMï¼‰  
**çŠ¶æ€**: âœ… å·²éƒ¨ç½²ï¼Œè¯·æµ‹è¯•

