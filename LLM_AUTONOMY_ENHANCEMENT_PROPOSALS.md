# LLM自主识别能力增强方案

## 目标

**加大LLM的自主识别能力，减少约束**，让LLM更自主地：
1. 识别基本信息（而不是指定固定字段）
2. 识别技术功能和参数（自己判断如何分类和结构化）
3. 识别商务参数（自己判断哪些是商务相关）

---

## 当前约束分析

### 约束点1：固定的字段名（base）

**当前约束**：
```json
{
  "projectName": "项目名称",
  "ownerName": "招标人/业主/采购人",
  "agencyName": "代理机构",
  "bidDeadline": "投标截止时间",
  "bidOpeningTime": "开标时间",
  "budget": "预算金额",
  "maxPrice": "最高限价",
  ...
}
```

**问题**：
- ❌ 字段名固定（projectName, ownerName等）
- ❌ LLM必须记住这些英文字段名
- ❌ 如果文档中有其他基本信息（如"项目规模"、"建设单位"），LLM不知道该放在哪个字段

**影响度**：⭐⭐（前端依赖这些字段名）

---

### 约束点2：固定的结构（technical_parameters/business_terms）

**当前约束**：
```json
{
  "category": "设备参数/性能指标/...",
  "item": "条目标题",
  "requirement": "要求描述",
  "parameters": [
    {"name": "参数名", "value": "参数值", "unit": "单位", "remark": "备注"}
  ],
  "evidence_chunk_ids": ["..."]
}
```

**问题**：
- ❌ 结构固定（必须有category, item, requirement, parameters）
- ❌ parameters必须是数组，且每个元素必须有name/value/unit/remark
- ❌ LLM需要判断如何将内容塞入这个固定结构
- ❌ 对于复杂的技术描述，可能不适合这个结构

**影响度**：⭐⭐⭐（前端强依赖这个结构）

---

### 约束点3：预定义的分类（category/term）

**当前约束**：
```
category: "设备参数/性能指标/配置参数/标准规范/工艺要求/测试要求/..."
term: "付款方式/交货期/质保期/验收标准/违约责任/..."
```

**问题**：
- ❌ 虽然已经放宽，但仍然给出了建议值
- ❌ LLM可能倾向于使用给定的分类，而不是自己判断
- ❌ 限制了LLM的创造性分类

**影响度**：⭐（前端不校验，影响小）

---

### 约束点4：严格的JSON格式要求

**当前约束**：
```
必须严格按上述格式输出 JSON
四个板块必须都存在：base, technical_parameters, business_terms, scoring_criteria
technical_parameters 是数组
business_terms 是数组
```

**问题**：
- ❌ 对JSON格式要求严格
- ❌ 即使某个板块为空，也必须存在
- ❌ LLM需要花费token来生成格式，而不是内容

**影响度**：⭐⭐⭐（后端/前端强依赖）

---

### 约束点5：详细的提取指南和示例

**当前约束**：
- 11类技术参数的详细说明
- 13类商务条款的详细说明
- 10个详细示例
- 边界案例处理指南

**问题**：
- ❌ Prompt过长（~300行）
- ❌ 可能限制了LLM的自主判断
- ❌ LLM可能过度依赖示例，而不是理解招标文件本身

**影响度**：⭐（这是好的约束，帮助LLM理解）

---

## 改进方案

### 方案A：动态字段名（保守） ⭐

**核心思想**：保持JSON结构，但允许LLM自定义base中的字段名。

#### 修改内容

**base字段放宽**：
```json
{
  "base": {
    // 核心字段（仍保留，确保兼容）
    "projectName": "项目名称",
    "ownerName": "招标人",
    "budget": "预算金额",
    "maxPrice": "最高限价",
    
    // 自定义字段（LLM自己识别并添加）
    "项目规模": "xxx",
    "建设单位": "xxx",
    "资金来源": "xxx",
    "项目性质": "xxx",
    ...任何LLM认为是基本信息的字段
  }
}
```

**Prompt修改**：
```markdown
## base字段说明

base字段应包含项目的基本信息。除了以下**核心字段**必须尽量填写外，你可以自由添加其他基本信息字段：

**核心字段（尽量填写）**：
- projectName: 项目名称
- ownerName: 招标人/业主
- budget: 预算金额
- maxPrice: 最高限价/招标控制价
- bidDeadline: 投标截止时间
- bidOpeningTime: 开标时间

**自定义字段（自由添加）**：
你可以根据文档内容，自由添加其他基本信息字段，例如：
- 项目规模、建设地点、资金来源、项目性质、招标方式、建设周期 等

**原则**：
- 字段名应简洁明了（可以用中文）
- 字段值应准确提取
- 如果某个核心字段没有找到，填空字符串
```

#### 优点
- ✅ 保持核心字段不变，前端兼容性强
- ✅ 允许LLM添加新字段，提取更全面
- ✅ 实施简单，风险低

#### 缺点
- ❌ 前端可能不知道如何展示自定义字段
- ❌ 仍然有核心字段的约束

#### 兼容性
- ✅ **前端兼容**：核心字段保持不变，前端可以正常显示
- ✅ **数据库兼容**：JSONB可以存储额外字段
- ⚠️ **展示问题**：前端需要能动态展示额外字段

#### 实施难度
⭐（容易）

---

### 方案B：简化结构，增加描述字段（中等） ⭐⭐

**核心思想**：保持大框架，但简化内部结构，增加自由描述字段。

#### 修改内容

**technical_parameters简化**：
```json
{
  "technical_parameters": [
    {
      "title": "条目标题（LLM自己定义）",
      "category": "分类（LLM自己定义，可选）",
      "content": "详细内容（自由描述，可以是段落、列表、表格等）",
      "structured_params": [  // 可选，如果能结构化就填
        {"name": "参数名", "value": "参数值", "unit": "单位"}
      ],
      "evidence_chunk_ids": ["..."]
    }
  ]
}
```

**关键变化**：
1. `item` + `requirement` + `parameters` → 简化为 `title` + `content` + `structured_params`
2. `content` 可以是自由文本，不限制格式
3. `structured_params` 变成可选的
4. `category` 完全自由，不给建议

**business_terms简化**：
```json
{
  "business_terms": [
    {
      "title": "条款标题（LLM自己定义）",
      "type": "条款类型（LLM自己判断，可选）",
      "content": "条款内容（自由描述）",
      "evidence_chunk_ids": ["..."]
    }
  ]
}
```

**Prompt修改**：
```markdown
## technical_parameters说明

提取所有与技术相关的内容，包括但不限于：设备参数、性能指标、标准规范、工艺要求、测试要求、配置清单等。

**结构说明**：
- title: 给这个技术条目起一个清晰的标题
- category: 可选，如果你认为需要分类，可以自己定义分类名称
- content: 详细描述这个技术条目的内容（可以是段落文字，也可以是结构化描述）
- structured_params: 可选，如果内容中有明确的参数（如"功率≥55kW"），可以提取到这里

**提取原则**：
- 宁可多提取，不要遗漏
- title和content是必填的，其他字段可选
- content可以自由描述，不限制格式
- 如果能结构化为参数，就填structured_params；如果不能，就只填content
```

#### 优点
- ✅ 结构更简单，LLM更容易理解
- ✅ content字段允许自由描述，不限制格式
- ✅ structured_params是可选的，减少了结构化压力
- ✅ 仍保持数组结构，前端可以遍历展示

#### 缺点
- ❌ 前端需要适配新的字段名（title, content, structured_params）
- ❌ content可能是长文本，前端展示需要处理

#### 兼容性
- ⚠️ **前端不兼容**：字段名变了（item→title, requirement→content, parameters→structured_params）
- ✅ **数据库兼容**：JSONB可以存储
- ❌ **需要修改前端代码**

#### 实施难度
⭐⭐（中等，需要修改前端）

---

### 方案C：完全自主提取（激进） ⭐⭐⭐

**核心思想**：只给大框架，LLM完全自主决定如何组织信息。

#### 修改内容

**Prompt完全简化**：
```markdown
# 项目信息抽取提示词 (v3 - 自主提取)

你是招投标专家。请从"招标文件原文片段"中智能抽取项目信息。

## 输出格式

```json
{
  "base": {
    // 基本信息：项目名称、招标人、预算、时间等
    // 字段名和结构由你自己决定
    // 例如：{"项目名称": "xxx", "招标人": "xxx", "预算": "xxx"}
  },
  
  "technical": {
    // 技术相关信息：设备参数、技术标准、工艺要求等
    // 结构由你自己决定，可以是数组、对象、嵌套等
    // 原则：清晰、结构化、易读
  },
  
  "business": {
    // 商务相关信息：付款、交货、质保、投标要求等
    // 结构由你自己决定
  },
  
  "scoring": {
    // 评分标准
    // 结构由你自己决定
  },
  
  "evidence_chunk_ids": ["CHUNK_xxx"]
}
```

## 提取原则

1. **智能识别**：自己判断哪些是基本信息、哪些是技术信息、哪些是商务信息
2. **自主结构化**：自己决定如何组织信息（数组、对象、嵌套都可以）
3. **清晰易读**：让人容易理解
4. **尽量完整**：不要遗漏重要信息
5. **提供证据**：每个信息都要有对应的chunk_id

## 注意事项

- base/technical/business/scoring 这四个顶级字段必须存在（即使为空对象）
- 其余结构完全由你自己决定
- 优先考虑信息的完整性和可读性，而不是格式的统一性
```

#### 示例输出

```json
{
  "base": {
    "项目名称": "成都市第六再生水厂二期项目智慧化及自控系统设备采购",
    "招标人": "成都环境建设管理有限公司",
    "项目编号": "川投资备【2211-510108-04-01-536830】",
    "预算金额": "4019.99万元",
    "招标控制价": "40199936.16元",
    "投标截止时间": "2024年12月12日10时30分",
    "开标时间": "2024年12月12日10时30分",
    "投标保证金": "50万元"
  },
  
  "technical": {
    "供货范围": "全厂自动化系统、智慧无人化系统和所有管材、线缆、桥架、附件等材料",
    "供货期": "合同签订后90个日历天内完成供货及安装调试",
    "质量要求": "达到国家现行有关规范要求的合格标准",
    
    "主要设备": [
      {
        "设备名称": "PLC设备",
        "技术要求": "需符合项目技术标准，具备防腐涂层，IP55机柜",
        "参数": {
          "防护等级": "IP55",
          "供电电压": "220V"
        }
      },
      {
        "设备名称": "超融合一体机",
        "技术要求": "..."
      }
    ],
    
    "技术标准": [
      {
        "标准名称": "焊接标准",
        "要求": "所有钢结构件应进行金属电弧焊接，并满足BS5135或同等国际标准的要求"
      },
      {
        "标准名称": "防护等级",
        "要求": "设备安装地点应符合BSEN60529规范所确定的电气IP防护等级"
      }
    ],
    
    "工艺要求": {
      "涂装": "油漆应在混合后规定的时间内涂漆，只能使用装在密封罐内的油漆",
      "安装": "在设备安装结束后，应立即对被损坏的油漆进行修补"
    }
  },
  
  "business": {
    "付款方式": "按合同约定分期付款",
    "交货地点": "交货至项目所在地或买方指定的其他卸货仓库",
    "质保期": "按合同约定",
    
    "投标限制": [
      "一个制造商对同一品牌同一型号的货物，仅能委托一个代理商参加投标",
      "本次招标不接受联合体投标"
    ],
    
    "投标保证金要求": {
      "金额": "50万元",
      "交纳方式": "银行转账、电子保函或电子保证保险",
      "时间要求": "投标截止前1个工作日16:00前"
    },
    
    "合同管理": {
      "合同返回": "中标人须在收到合同文本后7个日历天内返回"
    },
    
    "报价要求": "投标报价应涵盖为完成合同规定内容涉及的一切费用"
  },
  
  "scoring": {
    "评标方法": "综合评分法",
    "评分项": [...]
  },
  
  "evidence_chunk_ids": ["seg_1", "seg_2", "..."]
}
```

#### 优点
- ✅ **最大自由度**：LLM完全自主决定结构
- ✅ **最简Prompt**：只有核心指导，没有繁琐约束
- ✅ **最灵活**：可以适应各种复杂的文档结构
- ✅ **最直观**：输出结果更符合人类阅读习惯

#### 缺点
- ❌ **前端完全不兼容**：需要重写前端展示逻辑
- ❌ **结构不统一**：每次提取的结构可能不同
- ❌ **难以校验**：无法用Pydantic等工具校验
- ❌ **后续处理困难**：其他系统可能无法解析

#### 兼容性
- ❌ **前端完全不兼容**：需要完全重写
- ✅ **数据库兼容**：JSONB可以存储
- ❌ **后端可能不兼容**：如果有代码依赖特定字段

#### 实施难度
⭐⭐⭐（困难，需要大量改动）

---

### 方案D：混合模式（推荐） ⭐⭐

**核心思想**：核心字段保持结构，非核心部分自由发挥。

#### 修改内容

**保持核心结构 + 增加自由字段**：
```json
{
  "base": {
    // 核心字段（结构化，前端依赖）
    "projectName": "项目名称",
    "ownerName": "招标人",
    "budget": "预算金额",
    "maxPrice": "最高限价",
    "bidDeadline": "投标截止时间",
    "bidOpeningTime": "开标时间",
    
    // 自由字段（LLM自己添加）
    "additional": {
      "项目规模": "xxx",
      "建设单位": "xxx",
      ...任何其他基本信息
    }
  },
  
  "technical_parameters": [
    {
      // 结构化字段（前端依赖）
      "title": "条目标题",
      "category": "分类（LLM自由定义）",
      
      // 核心内容（两种方式二选一或同时使用）
      "description": "自由描述（段落文字）",
      "structured": {
        // LLM自己决定如何结构化
        // 可以是参数列表、表格、嵌套对象等
      },
      
      "evidence_chunk_ids": ["..."]
    }
  ],
  
  "business_terms": [
    {
      "title": "条款标题",
      "type": "条款类型（LLM自由定义）",
      "description": "自由描述",
      "structured": {
        // 如果能结构化，LLM自己决定结构
      },
      "evidence_chunk_ids": ["..."]
    }
  ],
  
  "scoring_criteria": {
    "evaluationMethod": "评标方法",
    "items": [
      {
        "title": "评分项",
        "description": "自由描述",
        "structured": {
          // 如果能结构化
        },
        "evidence_chunk_ids": ["..."]
      }
    ]
  }
}
```

**Prompt核心思想**：
```markdown
## 结构说明

### base字段
**核心字段（尽量填写）**：projectName, ownerName, budget, maxPrice, bidDeadline, bidOpeningTime
**其他信息**：放入 additional 对象，由你自己组织

### technical_parameters/business_terms
每个条目包含：
- title: 条目标题（必填）
- category/type: 分类（可选，自由定义）
- description: 自由文字描述（如果内容复杂，用这个）
- structured: 结构化信息（如果能结构化，用这个；由你自己决定结构）
- evidence_chunk_ids: 证据（必填）

**自由发挥原则**：
1. description和structured可以同时使用，也可以只用一个
2. structured的结构由你自己决定（可以是数组、对象、嵌套等）
3. 优先考虑信息的清晰性和完整性

## 提取原则

1. **核心字段**：尽量按规定填写（方便系统处理）
2. **自由字段**：自己决定如何组织（方便人类阅读）
3. **宁可多提取**：不要遗漏信息
4. **灵活结构化**：能结构化就结构化，不能就用描述
```

#### 优点
- ✅ **核心兼容**：核心字段保持不变，前端基本功能不受影响
- ✅ **扩展自由**：additional和structured字段完全自由
- ✅ **平衡折中**：在兼容性和灵活性之间取得平衡
- ✅ **渐进迁移**：可以逐步从旧格式迁移到新格式

#### 缺点
- ⚠️ **前端需要适配**：需要能展示description和structured字段
- ⚠️ **结构复杂度**：既有固定字段，又有自由字段

#### 兼容性
- ✅ **部分兼容**：核心字段保持，前端基本功能正常
- ⚠️ **需要增强前端**：需要能动态展示description和structured
- ✅ **数据库兼容**：JSONB可以存储

#### 实施难度
⭐⭐（中等，需要适度调整前端）

---

## 方案对比

| 维度 | 方案A（动态字段） | 方案B（简化结构） | 方案C（完全自主） | 方案D（混合模式）⭐ |
|------|------------------|------------------|------------------|-------------------|
| **LLM自由度** | ⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **前端兼容性** | ✅ 完全兼容 | ❌ 不兼容 | ❌ 完全不兼容 | ⚠️ 部分兼容 |
| **实施难度** | ⭐ 容易 | ⭐⭐ 中等 | ⭐⭐⭐ 困难 | ⭐⭐ 中等 |
| **信息完整性** | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **结构一致性** | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐ 不一致 | ⭐⭐⭐ |
| **易读性** | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **后续处理** | ✅ 容易 | ⚠️ 需要适配 | ❌ 困难 | ⚠️ 需要适配 |

---

## 推荐方案

### 🎯 推荐：方案D（混合模式）

**理由**：
1. ✅ **平衡性好**：在兼容性和灵活性之间取得很好的平衡
2. ✅ **可渐进实施**：不需要一次性重写所有代码
3. ✅ **风险可控**：核心功能不受影响
4. ✅ **扩展性强**：description和structured字段可以承载任意复杂信息

### 实施步骤

#### 阶段1：修改Prompt（立即可做）
- 保持核心字段定义
- 增加additional/description/structured字段
- 明确"自由组织"原则

#### 阶段2：测试验证（修改后）
- 重新提取项目信息
- 查看structured字段的内容
- 评估信息完整性

#### 阶段3：前端适配（可选，后续做）
- 增加additional字段的展示
- 增加description的展示
- 增加structured的动态展示（根据实际结构）

---

## 次优方案

### 方案A（动态字段名）

**适用场景**：
- 只想增加base字段的灵活性
- 不想大幅修改系统
- 快速见效

**优点**：
- 实施最简单
- 风险最低
- 立即可见效果

---

## 不推荐方案

### 方案C（完全自主）

**不推荐理由**：
- ❌ 前端需要完全重写
- ❌ 结构不一致，难以统一处理
- ❌ 可能带来更多问题

**仅适用于**：
- 从零开始的新系统
- 或者作为长期目标（v3版本）

---

## 总结

### 🎯 建议实施路径

**短期（立即）**：
- 实施**方案D（混合模式）**
- 修改prompt，增加自由字段
- 测试验证效果

**中期（1-2周）**：
- 根据实际提取效果，优化prompt
- 增强前端展示能力（展示description和structured）

**长期（可选）**：
- 如果效果好，可以逐步迁移到更自由的格式
- 或者保持方案D，持续优化

### 核心价值

**方案D的核心价值**：
1. 让LLM有更大的自由度组织信息
2. 保持系统的核心功能稳定
3. 为未来的演进留下空间

---

**请选择您想实施的方案，我可以立即开始修改！** 🚀

