import React, { useEffect, useMemo, useRef, useState } from "react";
import {
  EvidenceChunk,
  FormatTemplate,
  TenderDirectoryNode,
  TenderProject,
  TenderProjectDoc,
  TenderReviewItem,
  TenderRisk
} from "../types/tender";

type StepKey = "project" | "risks" | "directory" | "template" | "review";

const API_BASE = (import.meta as any).env?.VITE_API_BASE_URL || "";

function getAuthHeader(): Record<string, string> {
  const token =
    localStorage.getItem("access_token") ||
    localStorage.getItem("token") ||
    localStorage.getItem("jwt") ||
    "";
  return token ? { Authorization: `Bearer ${token}` } : {};
}

async function apiFetch(path: string, init?: RequestInit) {
  const res = await fetch(`${API_BASE}${path}`, {
    ...init,
    headers: {
      "Content-Type": "application/json",
      ...(init?.headers || {}),
      ...getAuthHeader()
    }
  });
  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`HTTP ${res.status}: ${txt || res.statusText}`);
  }
  return res;
}

function Badge({ text, kind }: { text: string; kind?: "ok" | "warn" | "bad" | "neutral" }) {
  const bg =
    kind === "ok"
      ? "rgba(34, 197, 94, 0.15)"
      : kind === "warn"
      ? "rgba(251, 191, 36, 0.15)"
      : kind === "bad"
      ? "rgba(239, 68, 68, 0.15)"
      : "rgba(148, 163, 184, 0.12)";
  const bd =
    kind === "ok"
      ? "rgba(34, 197, 94, 0.25)"
      : kind === "warn"
      ? "rgba(251, 191, 36, 0.25)"
      : kind === "bad"
      ? "rgba(239, 68, 68, 0.25)"
      : "rgba(148, 163, 184, 0.2)";
  return (
    <span
      style={{
        padding: "2px 8px",
        borderRadius: 999,
        border: `1px solid ${bd}`,
        background: bg,
        color: "#e5e7eb",
        fontSize: 12,
        whiteSpace: "nowrap"
      }}
    >
      {text}
    </span>
  );
}

function TabBtn({
  active,
  onClick,
  children
}: {
  active: boolean;
  onClick: () => void;
  children: React.ReactNode;
}) {
  return (
    <button
      onClick={onClick}
      style={{
        padding: "8px 12px",
        borderRadius: 8,
        border: "1px solid rgba(148, 163, 184, 0.18)",
        background: active ? "rgba(79, 70, 229, 0.18)" : "rgba(15, 23, 42, 0.5)",
        color: "#e5e7eb",
        cursor: "pointer",
        fontSize: 13
      }}
    >
      {children}
    </button>
  );
}

function Card({
  title,
  right,
  children
}: {
  title: string;
  right?: React.ReactNode;
  children: React.ReactNode;
}) {
  return (
    <div
      style={{
        border: "1px solid rgba(148, 163, 184, 0.18)",
        background: "rgba(15, 23, 42, 0.6)",
        borderRadius: 12,
        padding: 12,
        marginBottom: 12
      }}
    >
      <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", gap: 12 }}>
        <div style={{ fontSize: 14, fontWeight: 650, color: "#f1f5f9" }}>{title}</div>
        {right}
      </div>
      <div style={{ marginTop: 10 }}>{children}</div>
    </div>
  );
}

function KVGrid({
  data,
  onEvidence
}: {
  data: Record<string, any>;
  onEvidence: (ids: string[], title: string) => void;
}) {
  const items = Object.entries(data || {});
  if (items.length === 0) return <div style={{ color: "#9ca3af" }}>暂无数据</div>;
  return (
    <div style={{ display: "grid", gridTemplateColumns: "1fr 2fr auto", gap: 10 }}>
      {items.map(([k, v]) => {
        const value = typeof v === "object" && v ? (v.value ?? JSON.stringify(v)) : String(v ?? "");
        const conf = typeof v === "object" && v ? Number(v.confidence ?? 0) : 0;
        const ev = typeof v === "object" && v ? (v.evidence_chunk_ids ?? []) : [];
        return (
          <React.Fragment key={k}>
            <div style={{ color: "#94a3b8", fontSize: 12 }}>{k}</div>
            <div style={{ color: "#e5e7eb", fontSize: 13, lineHeight: 1.6 }}>{value || <span style={{ color: "#64748b" }}>（空）</span>}</div>
            <div style={{ display: "flex", gap: 8, alignItems: "center", justifyContent: "flex-end" }}>
              {conf > 0 ? <span style={{ color: "#9ca3af", fontSize: 12 }}>{Math.round(conf * 100)}%</span> : <span style={{ color: "#64748b", fontSize: 12 }}>—</span>}
              <button
                disabled={!ev || ev.length === 0}
                onClick={() => onEvidence(ev, `字段证据：${k}`)}
                style={{
                  padding: "4px 8px",
                  borderRadius: 8,
                  border: "1px solid rgba(148, 163, 184, 0.2)",
                  background: "rgba(15, 23, 42, 0.7)",
                  color: ev && ev.length > 0 ? "#e5e7eb" : "#64748b",
                  cursor: ev && ev.length > 0 ? "pointer" : "not-allowed",
                  fontSize: 12
                }}
                title="查看证据"
              >
                证据
              </button>
            </div>
          </React.Fragment>
        );
      })}
    </div>
  );
}
