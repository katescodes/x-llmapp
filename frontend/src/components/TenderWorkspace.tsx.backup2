/**
 * æ‹›æŠ•æ ‡å·¥ä½œå°ç»„ä»¶ V2
 * - ç§»é™¤KBé€‰æ‹©ï¼Œæ”¹ä¸ºå…ˆå»ºé¡¹ç›®â†’è‡ªåŠ¨åˆ›å»ºKBâ†’é¡¹ç›®å†…ä¸Šä¼ 
 * - ä½¿ç”¨æ·±è‰²ä¸»é¢˜ï¼Œä¸ç³»ç»Ÿé£æ ¼ä¸€è‡´
 * - ä½¿ç”¨ç»Ÿä¸€ API è¯·æ±‚æ–¹æ³•ï¼ˆè‡ªåŠ¨å¸¦ Authorizationï¼‰
 */
import React, { useState, useEffect, useMemo, useCallback, useRef } from 'react';
import { api } from '../config/api';

// ==================== ç±»å‹å®šä¹‰ ====================

type TenderAssetKind = 'tender' | 'bid' | 'template' | 'custom_rule';

interface TenderProject {
  id: string;
  kb_id: string;
  name: string;
  description?: string;
  created_at?: string;
}

interface TenderAsset {
  id: string;
  project_id: string;
  kind: TenderAssetKind;
  filename?: string;
  mime_type?: string;
  size_bytes?: number;
  kb_doc_id?: string;
  storage_path?: string;
  bidder_name?: string;
  created_at?: string;
}

interface TenderRun {
  id: string;
  project_id?: string;
  kind?: string;
  status: 'pending' | 'running' | 'success' | 'failed';
  progress?: number;
  message?: string;
  result_json?: any;
}

interface ProjectInfo {
  project_id: string;
  data_json: Record<string, any>;
  evidence_chunk_ids: string[];
}

interface TenderRisk {
  id: string;
  project_id: string;
  risk_type: 'mustReject' | 'other';
  title: string;
  description?: string;
  suggestion?: string;
  severity?: string;
  tags: string[];
  evidence_chunk_ids: string[];
}

interface DirectoryNode {
  numbering: string;
  level: number;
  title: string;
  required: boolean;
  notes?: string;
  evidence_chunk_ids: string[];
}

interface RuleSet {
  id: string;
  project_id: string;
  name: string;
  description?: string;
  source_asset_ids: string[];
  rules_json: any[];
  created_at?: string;
}

interface ReviewItem {
  id: string;
  project_id: string;
  dimension: string;
  requirement_text?: string;
  response_text?: string;
  result: 'pass' | 'risk' | 'fail';
  remark?: string;
  rigid: boolean;
  tender_evidence_chunk_ids: string[];
  bid_evidence_chunk_ids: string[];
}

interface Chunk {
  chunk_id: string;
  doc_id: string;
  title: string;
  content: string;
  position?: number;
}

// ==================== ä¸»ç»„ä»¶ ====================

export default function TenderWorkspace() {
  // -------------------- çŠ¶æ€ç®¡ç† --------------------
  const [projects, setProjects] = useState<TenderProject[]>([]);
  const [currentProject, setCurrentProject] = useState<TenderProject | null>(null);
  
  // æ–°å»ºé¡¹ç›®è¡¨å•
  const [newProjectName, setNewProjectName] = useState('');
  const [newProjectDesc, setNewProjectDesc] = useState('');
  
  // ä¸Šä¼ ç›¸å…³
  const [uploadKind, setUploadKind] = useState<TenderAssetKind>('tender');
  const [bidderName, setBidderName] = useState('');
  const [files, setFiles] = useState<File[]>([]);
  const [assets, setAssets] = useState<TenderAsset[]>([]);
  
  // äº”æ­¥å·¥ä½œæµ
  const [activeTab, setActiveTab] = useState<number>(1);
  
  // Step1: é¡¹ç›®ä¿¡æ¯
  const [projectInfo, setProjectInfo] = useState<ProjectInfo | null>(null);
  const [infoRun, setInfoRun] = useState<TenderRun | null>(null);
  
  // Step2: é£é™©
  const [risks, setRisks] = useState<TenderRisk[]>([]);
  const [riskRun, setRiskRun] = useState<TenderRun | null>(null);
  
  // Step3: ç›®å½• + è§„åˆ™é›†
  const [directory, setDirectory] = useState<DirectoryNode[]>([]);
  const [dirRun, setDirRun] = useState<TenderRun | null>(null);
  const [ruleSets, setRuleSets] = useState<RuleSet[]>([]);
  const [selectedRuleAssets, setSelectedRuleAssets] = useState<string[]>([]);
  const [newRuleSetName, setNewRuleSetName] = useState('');
  const [newRuleSetDesc, setNewRuleSetDesc] = useState('');
  const [ruleSetRun, setRuleSetRun] = useState<TenderRun | null>(null);
  
  // Step4: æ¨¡æ¿
  const [selectedTemplateId, setSelectedTemplateId] = useState('');
  
  // Step5: å®¡æ ¸
  const [selectedBidder, setSelectedBidder] = useState('');
  const [selectedRuleSetIds, setSelectedRuleSetIds] = useState<string[]>([]);
  const [reviewItems, setReviewItems] = useState<ReviewItem[]>([]);
  const [reviewRun, setReviewRun] = useState<TenderRun | null>(null);
  
  // è¯æ®é¢æ¿
  const [evidencePanelOpen, setEvidencePanelOpen] = useState(true);
  const [evidenceChunks, setEvidenceChunks] = useState<Chunk[]>([]);
  
  // è½®è¯¢ ref
  const pollTimerRef = useRef<NodeJS.Timeout | null>(null);

  // -------------------- æ•°æ®åŠ è½½ --------------------

  const loadProjects = useCallback(async () => {
    try {
      const data = await api.get('/api/apps/tender/projects');
      setProjects(data);
    } catch (err) {
      console.error('Failed to load projects:', err);
    }
  }, []);

  const loadAssets = useCallback(async () => {
    if (!currentProject) return;
    try {
      const data = await api.get(`/api/apps/tender/projects/${currentProject.id}/assets`);
      setAssets(data);
    } catch (err) {
      console.error('Failed to load assets:', err);
    }
  }, [currentProject]);

  const loadProjectInfo = useCallback(async () => {
    if (!currentProject) return;
    try {
      const data = await api.get(`/api/apps/tender/projects/${currentProject.id}/project-info`);
      setProjectInfo(data);
    } catch (err) {
      console.error('Failed to load project info:', err);
    }
  }, [currentProject]);

  const loadRisks = useCallback(async () => {
    if (!currentProject) return;
    try {
      const data = await api.get(`/api/apps/tender/projects/${currentProject.id}/risks`);
      setRisks(data);
    } catch (err) {
      console.error('Failed to load risks:', err);
    }
  }, [currentProject]);

  const loadDirectory = useCallback(async () => {
    if (!currentProject) return;
    try {
      const data = await api.get(`/api/apps/tender/projects/${currentProject.id}/directory`);
      setDirectory(data);
    } catch (err) {
      console.error('Failed to load directory:', err);
    }
  }, [currentProject]);

  const loadRuleSets = useCallback(async () => {
    if (!currentProject) return;
    try {
      const data = await api.get(`/api/apps/tender/projects/${currentProject.id}/rule-sets`);
      setRuleSets(data);
    } catch (err) {
      console.error('Failed to load rule sets:', err);
    }
  }, [currentProject]);

  const loadReview = useCallback(async () => {
    if (!currentProject) return;
    try {
      const data = await api.get(`/api/apps/tender/projects/${currentProject.id}/review`);
      setReviewItems(data);
    } catch (err) {
      console.error('Failed to load review:', err);
    }
  }, [currentProject]);

  // -------------------- é¡¹ç›®æ“ä½œ --------------------

  const createProject = async () => {
    if (!newProjectName.trim()) {
      alert('è¯·è¾“å…¥é¡¹ç›®åç§°');
      return;
    }
    try {
      const data = await api.post('/api/apps/tender/projects',
        name: newProjectName,
        description: newProjectDesc,
      });
      setProjects([data, ...projects]);
      setNewProjectName('');
      setNewProjectDesc('');
      alert('é¡¹ç›®åˆ›å»ºæˆåŠŸï¼ˆå·²è‡ªåŠ¨åˆ›å»ºçŸ¥è¯†åº“ï¼‰');
    } catch (err) {
      alert(`åˆ›å»ºå¤±è´¥: ${err}`);
    }
  };

  const selectProject = (proj: TenderProject) => {
    setCurrentProject(proj);
    setActiveTab(1);
    // æ¸…ç©ºçŠ¶æ€
    setAssets([]);
    setProjectInfo(null);
    setRisks([]);
    setDirectory([]);
    setRuleSets([]);
    setReviewItems([]);
    setEvidenceChunks([]);
  };

  // -------------------- æ–‡ä»¶ä¸Šä¼  --------------------

  const handleFilesChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files) {
      setFiles(Array.from(e.target.files));
    }
  };

  const handleUpload = async () => {
    if (!currentProject || files.length === 0) {
      alert('è¯·é€‰æ‹©æ–‡ä»¶');
      return;
    }
    if (uploadKind === 'bid' && !bidderName.trim()) {
      alert('æŠ•æ ‡æ–‡ä»¶éœ€è¦å¡«å†™æŠ•æ ‡äººåç§°');
      return;
    }

    const formData = new FormData();
    formData.append('kind', uploadKind);
    if (bidderName) {
      formData.append('bidder_name', bidderName);
    }
    files.forEach(f => formData.append('files', f));

    try {
      const newAssets = await api.post(
        `/api/apps/tender/projects/${currentProject.id}/assets/import`,
        formData
      );
      setAssets([...assets, ...newAssets]);
      setFiles([]);
      setBidderName('');
      alert('ä¸Šä¼ æˆåŠŸ');
    } catch (err) {
      alert(`ä¸Šä¼ å¤±è´¥: ${err}`);
    }
  };

  // -------------------- Run è½®è¯¢ --------------------

  const pollRun = useCallback(async (runId: string, onSuccess: () => void) => {
    if (pollTimerRef.current) {
      clearInterval(pollTimerRef.current);
    }

    const check = async () => {
      try {
        const run: TenderRun = await api.get(`/api/apps/tender/runs/${runId}`);
        
        if (run.status === 'success') {
          if (pollTimerRef.current) {
            clearInterval(pollTimerRef.current);
            pollTimerRef.current = null;
          }
          onSuccess();
        } else if (run.status === 'failed') {
          if (pollTimerRef.current) {
            clearInterval(pollTimerRef.current);
            pollTimerRef.current = null;
          }
          alert(`ä»»åŠ¡å¤±è´¥: ${run.message || 'unknown error'}`);
        }
        
        // æ›´æ–°å¯¹åº”çš„ run çŠ¶æ€
        if (run.kind === 'extract_project_info') setInfoRun(run);
        else if (run.kind === 'extract_risks') setRiskRun(run);
        else if (run.kind === 'generate_directory') setDirRun(run);
        else if (run.kind === 'extract_rule_set') setRuleSetRun(run);
        else if (run.kind === 'review') setReviewRun(run);
      } catch (err) {
        console.error('Poll run failed:', err);
      }
    };

    await check();
    pollTimerRef.current = setInterval(check, 2000);
  }, []);

  useEffect(() => {
    return () => {
      if (pollTimerRef.current) {
        clearInterval(pollTimerRef.current);
      }
    };
  }, []);

  // -------------------- Stepæ“ä½œï¼ˆçœç•¥ï¼Œä¸ä¹‹å‰ç›¸åŒï¼‰--------------------
  
  const extractProjectInfo = async () => {
    if (!currentProject) return;
    try {
      const res = await api.post(`/api/apps/tender/projects/${currentProject.id}/extract/project-info`,
        method: 'POST',
        body: JSON.stringify({ model_id: null }),
      });
      pollRun(res.run_id, loadProjectInfo);
    } catch (err) {
      alert(`æŠ½å–å¤±è´¥: ${err}`);
    }
  };

  const extractRisks = async () => {
    if (!currentProject) return;
    try {
      const res = await api.post(`/api/apps/tender/projects/${currentProject.id}/extract/risks`,
        method: 'POST',
        body: JSON.stringify({ model_id: null }),
      });
      pollRun(res.run_id, loadRisks);
    } catch (err) {
      alert(`è¯†åˆ«å¤±è´¥: ${err}`);
    }
  };

  const generateDirectory = async () => {
    if (!currentProject) return;
    try {
      const res = await api.post(`/api/apps/tender/projects/${currentProject.id}/directory/generate`,
        method: 'POST',
        body: JSON.stringify({ model_id: null }),
      });
      pollRun(res.run_id, loadDirectory);
    } catch (err) {
      alert(`ç”Ÿæˆå¤±è´¥: ${err}`);
    }
  };

  const extractRuleSet = async () => {
    if (!currentProject || !newRuleSetName.trim() || selectedRuleAssets.length === 0) {
      alert('è¯·å¡«å†™è§„åˆ™é›†åç§°å¹¶é€‰æ‹©è§„åˆ™æ–‡ä»¶');
      return;
    }
    try {
      const res = await api.post(`/api/apps/tender/projects/${currentProject.id}/rule-sets/extract`,
        method: 'POST',
        body: JSON.stringify({
          name: newRuleSetName,
          description: newRuleSetDesc,
          source_asset_ids: selectedRuleAssets,
          model_id: null,
        }),
      });
      pollRun(res.run_id, () => {
        loadRuleSets();
        setNewRuleSetName('');
        setNewRuleSetDesc('');
        setSelectedRuleAssets([]);
      });
    } catch (err) {
      alert(`æŠ½å–å¤±è´¥: ${err}`);
    }
  };

  const generateDocx = async () => {
    if (!currentProject) return;
    try {
      const token = localStorage.getItem('token') || '';
      const url = selectedTemplateId
        ? `${API_BASE}/api/apps/tender/projects/${currentProject.id}/docx?template_asset_id=${selectedTemplateId}`
        : `${API_BASE}/api/apps/tender/projects/${currentProject.id}/docx`;
      
      const res = await fetch(url,
        method: 'POST',
        headers: {
          'Authorization': token ? `Bearer ${token}` : '',
        },
      });
      
      if (!res.ok) {
        throw new Error(`Generate failed: ${res.status}`);
      }
      
      const blob = await res.blob();
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${currentProject.name}_æŠ•æ ‡æ–‡æ¡£.docx`;
      link.click();
    } catch (err) {
      alert(`ç”Ÿæˆå¤±è´¥: ${err}`);
    }
  };

  const runReview = async () => {
    if (!currentProject) return;
    if (!selectedBidder && assetsByKind.bid.length > 0) {
      alert('è¯·é€‰æ‹©æŠ•æ ‡äºº');
      return;
    }
    
    try {
      const res = await api.post(`/api/apps/tender/projects/${currentProject.id}/review/run`,
        method: 'POST',
        body: JSON.stringify({
          model_id: null,
          custom_rule_set_ids: selectedRuleSetIds,
          bidder_name: selectedBidder || undefined,
          bid_asset_ids: [],
        }),
      });
      pollRun(res.run_id, loadReview);
    } catch (err) {
      alert(`å®¡æ ¸å¤±è´¥: ${err}`);
    }
  };

  const showEvidence = async (chunkIds: string[]) => {
    if (chunkIds.length === 0) return;
    try {
      const data = await api.post('/api/apps/tender/chunks/lookup',
        method: 'POST',
        body: JSON.stringify({ chunk_ids: chunkIds }),
      });
      setEvidenceChunks(data);
      setEvidencePanelOpen(true);
    } catch (err) {
      alert(`åŠ è½½è¯æ®å¤±è´¥: ${err}`);
    }
  };

  // -------------------- æ•°æ®è¡ç”Ÿ --------------------

  const assetsByKind = useMemo(() => {
    const result: Record<TenderAssetKind, TenderAsset[]> = {
      tender: [],
      bid: [],
      template: [],
      custom_rule: [],
    };
    assets.forEach(a => {
      if (a.kind in result) {
        result[a.kind].push(a);
      }
    });
    return result;
  }, [assets]);

  const bidderOptions = useMemo(() => {
    return Array.from(new Set(
      assetsByKind.bid.map(a => a.bidder_name).filter(Boolean)
    )) as string[];
  }, [assetsByKind.bid]);

  // -------------------- å‰¯ä½œç”¨ --------------------

  useEffect(() => {
    loadProjects();
  }, [loadProjects]);

  useEffect(() => {
    if (currentProject) {
      loadAssets();
      loadProjectInfo();
      loadRisks();
      loadDirectory();
      loadRuleSets();
      loadReview();
    }
  }, [currentProject, loadAssets, loadProjectInfo, loadRisks, loadDirectory, loadRuleSets, loadReview]);

  // ==================== å†…è”æ ·å¼ï¼ˆä»…å¸ƒå±€ï¼‰ ====================
  // æ‰€æœ‰é¢œè‰²/èƒŒæ™¯/è¾¹æ¡†æ ·å¼å·²ç§»é™¤ï¼Œç»Ÿä¸€ä½¿ç”¨ç³»ç»Ÿ className

  // ==================== æ¸²æŸ“ ====================

  return (
    <div className="app-root">
      {/* å·¦ä¾§è¾¹æ ï¼šé¡¹ç›®åˆ—è¡¨ */}
      <div className="sidebar">
        <div className="sidebar-title">æ‹›æŠ•æ ‡å·¥ä½œå°</div>
        <div className="sidebar-subtitle">é¡¹ç›®ç®¡ç† + é£é™©è¯†åˆ« + æ–‡æ¡£ç”Ÿæˆ</div>
        
        <div style={{ flex: 1, overflow: 'auto' }}>
          {/* æ–°å»ºé¡¹ç›® */}
          <div className="kb-create-form" style={{ marginBottom: '16px' }}>
            <input
              type="text"
              placeholder="é¡¹ç›®åç§°"
              value={newProjectName}
              onChange={e => setNewProjectName(e.target.value)}
            />
            <textarea
              placeholder="é¡¹ç›®æè¿°ï¼ˆå¯é€‰ï¼‰"
              value={newProjectDesc}
              onChange={e => setNewProjectDesc(e.target.value)}
              style={{ minHeight: '50px' }}
            />
            <button onClick={createProject}>
              åˆ›å»ºé¡¹ç›®
            </button>
            <div className="sidebar-hint" style={{ marginTop: '8px' }}>
              ğŸ’¡ åˆ›å»ºé¡¹ç›®æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºçŸ¥è¯†åº“
            </div>
          </div>

          {/* é¡¹ç›®åˆ—è¡¨ */}
          <div className="kb-list-panel">
            {projects.map(proj => (
              <button
                key={proj.id}
                className={`kb-row ${currentProject?.id === proj.id ? 'active' : ''}`}
                onClick={() => selectProject(proj)}
              >
                <div className="kb-name">{proj.name}</div>
                {proj.description && (
                  <div className="kb-meta">{proj.description}</div>
                )}
              </button>
            ))}
            {projects.length === 0 && (
              <div className="kb-empty">è¿˜æ²¡æœ‰é¡¹ç›®ï¼Œå…ˆåœ¨ä¸Šæ–¹åˆ›å»ºä¸€ä¸ªå§ã€‚</div>
            )}
          </div>
        </div>
      </div>

      {/* ä¸­é—´å·¥ä½œåŒº */}
      <div className="main-panel">
        {currentProject ? (
          <>
            {/* å·¥ä½œåŒºå¤´éƒ¨ */}
            <div className="header-bar">
              <div>
                <div className="header-title">{currentProject.name}</div>
                {currentProject.description && (
                  <div className="sidebar-hint" style={{ marginTop: '4px' }}>
                    {currentProject.description}
                  </div>
                )}
              </div>
            </div>

            {/* å·¥ä½œåŒºå†…å®¹ */}
            <div className="kb-detail">
              {/* é¡¹ç›®å†…ä¸Šä¼ åŒº */}
              <section className="kb-upload-section">
                <h4>ğŸ“¤ é¡¹ç›®å†…ä¸Šä¼ </h4>
                <div style={{ display: 'flex', gap: '12px', marginBottom: '12px', flexWrap: 'wrap' }}>
                  <select
                    value={uploadKind}
                    onChange={e => setUploadKind(e.target.value as TenderAssetKind)}
                    className="sidebar-select"
                    style={{ width: 'auto', marginBottom: 0 }}
                  >
                    <option value="tender">æ‹›æ ‡æ–‡ä»¶</option>
                    <option value="bid">æŠ•æ ‡æ–‡ä»¶</option>
                    <option value="template">æ¨¡æ¿æ–‡ä»¶</option>
                    <option value="custom_rule">è‡ªå®šä¹‰è§„åˆ™</option>
                  </select>

                  {uploadKind === 'bid' && (
                    <input
                      type="text"
                      placeholder="æŠ•æ ‡äººåç§°ï¼ˆå¿…å¡«ï¼‰"
                      value={bidderName}
                      onChange={e => setBidderName(e.target.value)}
                      className="sidebar-select"
                      style={{ width: '200px', marginBottom: 0 }}
                    />
                  )}

                  <input
                    type="file"
                    multiple
                    onChange={handleFilesChange}
                    style={{ flex: 1, minWidth: '200px' }}
                  />

                  <button onClick={handleUpload} className="kb-create-form" style={{ width: 'auto', marginBottom: 0 }}>
                    ä¸Šä¼ å¹¶ç»‘å®š
                  </button>
                </div>
                
                {files.length > 0 && (
                  <div className="sidebar-hint">
                    å·²é€‰æ‹© {files.length} ä¸ªæ–‡ä»¶: {files.map(f => f.name).join(', ')}
                  </div>
                )}
              </section>

              {/* æ–‡ä»¶åˆ—è¡¨ */}
              <section className="kb-doc-section">
                <h4>ğŸ“ é¡¹ç›®æ–‡ä»¶</h4>
                <div style={{ display: 'flex', gap: '24px', flexWrap: 'wrap' }}>
                  {(['tender', 'bid', 'template', 'custom_rule'] as TenderAssetKind[]).map(kind => (
                    <div key={kind} style={{ flex: '1 1 200px' }}>
                      <div className="kb-doc-title">
                        {kind === 'tender' && 'ğŸ“„ æ‹›æ ‡æ–‡ä»¶'}
                        {kind === 'bid' && 'ğŸ“ æŠ•æ ‡æ–‡ä»¶'}
                        {kind === 'template' && 'ğŸ“‹ æ¨¡æ¿æ–‡ä»¶'}
                        {kind === 'custom_rule' && 'ğŸ“Œ è‡ªå®šä¹‰è§„åˆ™'}
                        <span className="sidebar-hint" style={{ marginLeft: '8px' }}>
                          ({assetsByKind[kind].length})
                        </span>
                      </div>
                      {assetsByKind[kind].map(asset => (
                        <div key={asset.id} className="kb-doc-meta" style={{ padding: '4px 0' }}>
                          â€¢ {asset.filename}
                          {asset.bidder_name && ` (${asset.bidder_name})`}
                        </div>
                      ))}
                      {assetsByKind[kind].length === 0 && (
                        <div className="kb-empty">æš‚æ— æ–‡ä»¶</div>
                      )}
                    </div>
                  ))}
                </div>
              </section>

              {/* äº”æ­¥å·¥ä½œæµ Tabs */}
              <div style={{ display: 'flex', gap: '8px', marginTop: '24px', marginBottom: '16px', flexWrap: 'wrap' }}>
                {[
                  { id: 1, label: 'Step 1: é¡¹ç›®ä¿¡æ¯' },
                  { id: 2, label: 'Step 2: é£é™©è¯†åˆ«' },
                  { id: 3, label: 'Step 3: ç›®å½• & è§„åˆ™' },
                  { id: 4, label: 'Step 4: æ–‡æ¡£ç”Ÿæˆ' },
                  { id: 5, label: 'Step 5: å®¡æ ¸' },
                ].map(tab => (
                  <button
                    key={tab.id}
                    onClick={() => setActiveTab(tab.id)}
                    className={activeTab === tab.id ? 'pill-button' : 'link-button'}
                    style={{ 
                      padding: activeTab === tab.id ? '8px 16px' : '8px 12px',
                      flex: 1,
                      minWidth: '140px'
                    }}
                  >
                    {tab.label}
                  </button>
                ))}
              </div>

              {/* Step 1: é¡¹ç›®ä¿¡æ¯ */}
              {activeTab === 1 && (
                <section className="kb-upload-section">
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                    <h4>é¡¹ç›®ä¿¡æ¯æŠ½å–</h4>
                    <button 
                      onClick={extractProjectInfo} 
                      className="kb-create-form" 
                      style={{ width: 'auto', marginBottom: 0 }}
                      disabled={infoRun?.status === 'running'}
                    >
                      {infoRun?.status === 'running' ? 'æŠ½å–ä¸­...' : 'å¼€å§‹æŠ½å–'}
                    </button>
                  </div>
                  
                  {infoRun && (
                    <div className="kb-import-results">
                      <div className="kb-import-item">
                        çŠ¶æ€: {infoRun.status} {infoRun.progress && `- ${infoRun.progress}%`}
                      </div>
                      {infoRun.message && (
                        <div className="kb-import-item">{infoRun.message}</div>
                      )}
                    </div>
                  )}
                  
                  {projectInfo && (
                    <div className="kb-doc-card" style={{ marginTop: '16px' }}>
                      <div className="kb-doc-title">é¡¹ç›®ä¿¡æ¯</div>
                      <div className="kb-doc-meta">
                        <pre style={{ whiteSpace: 'pre-wrap', fontSize: '12px' }}>
                          {JSON.stringify(projectInfo.data_json, null, 2)}
                        </pre>
                      </div>
                      {projectInfo.evidence_chunk_ids.length > 0 && (
                        <button
                          onClick={() => showEvidence(projectInfo.evidence_chunk_ids)}
                          className="link-button"
                          style={{ marginTop: '8px' }}
                        >
                          æŸ¥çœ‹è¯æ® ({projectInfo.evidence_chunk_ids.length} æ¡)
                        </button>
                      )}
                    </div>
                  )}
                </section>
              )}

              {/* Step 2: é£é™©è¯†åˆ« */}
              {activeTab === 2 && (
                <section className="kb-upload-section">
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                    <h4>é£é™©è¯†åˆ«</h4>
                    <button 
                      onClick={extractRisks} 
                      className="kb-create-form"
                      style={{ width: 'auto', marginBottom: 0 }}
                      disabled={riskRun?.status === 'running'}
                    >
                      {riskRun?.status === 'running' ? 'è¯†åˆ«ä¸­...' : 'å¼€å§‹è¯†åˆ«'}
                    </button>
                  </div>
                  
                  {riskRun && (
                    <div className="kb-import-results">
                      <div className="kb-import-item">
                        çŠ¶æ€: {riskRun.status} {riskRun.progress && `- ${riskRun.progress}%`}
                      </div>
                      {riskRun.message && (
                        <div className="kb-import-item">{riskRun.message}</div>
                      )}
                    </div>
                  )}
                  
                  <div className="kb-doc-grid">
                    {risks.map(risk => (
                      <div key={risk.id} className="kb-doc-card">
                        <div className="kb-doc-title">
                          {risk.title}
                          {risk.risk_type === 'mustReject' && (
                            <span className="header-tag" style={{ 
                              marginLeft: '8px',
                              fontSize: '11px'
                            }}>
                              âš ï¸ ä¸€ç¥¨å¦å†³
                            </span>
                          )}
                        </div>
                        {risk.description && (
                          <div className="kb-doc-meta" style={{ marginTop: '8px' }}>
                            {risk.description}
                          </div>
                        )}
                        {risk.suggestion && (
                          <div className="kb-doc-meta" style={{ marginTop: '8px' }}>
                            ğŸ’¡ {risk.suggestion}
                          </div>
                        )}
                        {risk.evidence_chunk_ids.length > 0 && (
                          <button
                            onClick={() => showEvidence(risk.evidence_chunk_ids)}
                            className="link-button"
                            style={{ marginTop: '8px' }}
                          >
                            æŸ¥çœ‹è¯æ® ({risk.evidence_chunk_ids.length} æ¡)
                          </button>
                        )}
                      </div>
                    ))}
                    {risks.length === 0 && (
                      <div className="kb-empty">æš‚æ— é£é™©è®°å½•ï¼Œç‚¹å‡»"å¼€å§‹è¯†åˆ«"</div>
                    )}
                  </div>
                </section>
              )}

              {/* Step 3: ç›®å½• & è§„åˆ™ */}
              {activeTab === 3 && (
                <>
                  <section className="kb-upload-section">
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                      <h4>ç”ŸæˆæŠ•æ ‡ç›®å½•</h4>
                      <button 
                        onClick={generateDirectory} 
                        className="kb-create-form"
                        style={{ width: 'auto', marginBottom: 0 }}
                        disabled={dirRun?.status === 'running'}
                      >
                        {dirRun?.status === 'running' ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆç›®å½•'}
                      </button>
                    </div>
                    
                    {dirRun && (
                      <div className="kb-import-results">
                        <div className="kb-import-item">
                          çŠ¶æ€: {dirRun.status} {dirRun.progress && `- ${dirRun.progress}%`}
                        </div>
                      </div>
                    )}
                    
                    {directory.map(node => (
                      <div key={node.numbering} className="kb-doc-card" style={{ marginBottom: '8px' }}>
                        <div className="kb-doc-title">
                          {node.numbering} {node.title}
                          {node.required && (
                            <span style={{ marginLeft: '8px', fontSize: '11px' }}>*å¿…å¡«</span>
                          )}
                        </div>
                        {node.notes && (
                          <div className="kb-doc-meta">{node.notes}</div>
                        )}
                        {node.evidence_chunk_ids.length > 0 && (
                          <button
                            onClick={() => showEvidence(node.evidence_chunk_ids)}
                            className="link-button"
                          >
                            æŸ¥çœ‹è¯æ® ({node.evidence_chunk_ids.length} æ¡)
                          </button>
                        )}
                      </div>
                    ))}
                    {directory.length === 0 && (
                      <div className="kb-empty">æš‚æ— ç›®å½•ï¼Œç‚¹å‡»"ç”Ÿæˆç›®å½•"</div>
                    )}
                  </section>

                  <section className="kb-doc-section">
                    <h4>è‡ªå®šä¹‰è§„åˆ™é›†</h4>
                    <div className="kb-create-form">
                      <input
                        type="text"
                        placeholder="è§„åˆ™é›†åç§°"
                        value={newRuleSetName}
                        onChange={e => setNewRuleSetName(e.target.value)}
                      />
                      <textarea
                        placeholder="è§„åˆ™é›†æè¿°ï¼ˆå¯é€‰ï¼‰"
                        value={newRuleSetDesc}
                        onChange={e => setNewRuleSetDesc(e.target.value)}
                        style={{ minHeight: '50px' }}
                      />
                      <div>
                        <label className="sidebar-label">é€‰æ‹©è§„åˆ™æ–‡ä»¶:</label>
                        {assetsByKind.custom_rule.map(asset => (
                          <label key={asset.id} className="kb-item">
                            <input
                              type="checkbox"
                              checked={selectedRuleAssets.includes(asset.id)}
                              onChange={() => {
                                setSelectedRuleAssets(prev =>
                                  prev.includes(asset.id)
                                    ? prev.filter(id => id !== asset.id)
                                    : [...prev, asset.id]
                                );
                              }}
                            />
                            <span>{asset.filename}</span>
                          </label>
                        ))}
                      </div>
                      <button 
                        onClick={extractRuleSet}
                        disabled={ruleSetRun?.status === 'running'}
                      >
                        {ruleSetRun?.status === 'running' ? 'æŠ½å–ä¸­...' : 'æŠ½å–è§„åˆ™'}
                      </button>
                    </div>
                    
                    {ruleSetRun && (
                      <div className="kb-import-results">
                        <div className="kb-import-item">
                          çŠ¶æ€: {ruleSetRun.status} {ruleSetRun.message && `- ${ruleSetRun.message}`}
                        </div>
                      </div>
                    )}
                    
                    <div className="kb-doc-grid" style={{ marginTop: '16px' }}>
                      {ruleSets.map(rs => (
                        <div key={rs.id} className="kb-doc-card">
                          <div className="kb-doc-title">{rs.name}</div>
                          {rs.description && (
                            <div className="kb-doc-meta">{rs.description}</div>
                          )}
                          <div className="kb-doc-meta">
                            è§„åˆ™æ•°: {rs.rules_json?.length || 0}
                          </div>
                        </div>
                      ))}
                      {ruleSets.length === 0 && (
                        <div className="kb-empty">æš‚æ— è§„åˆ™é›†</div>
                      )}
                    </div>
                  </section>
                </>
              )}

              {/* Step 4: æ–‡æ¡£ç”Ÿæˆ */}
              {activeTab === 4 && (
                <section className="kb-upload-section">
                  <h4>ç”ŸæˆæŠ•æ ‡æ–‡æ¡£ (DOCX)</h4>
                  <div className="kb-create-form">
                    <label className="sidebar-label">é€‰æ‹©æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰:</label>
                    <select
                      value={selectedTemplateId}
                      onChange={e => setSelectedTemplateId(e.target.value)}
                      className="sidebar-select"
                    >
                      <option value="">æ— æ¨¡æ¿ï¼ˆé»˜è®¤ï¼‰</option>
                      {assetsByKind.template.map(asset => (
                        <option key={asset.id} value={asset.id}>
                          {asset.filename}
                        </option>
                      ))}
                    </select>
                    <button onClick={generateDocx}>
                      ç”Ÿæˆå¹¶ä¸‹è½½ DOCX
                    </button>
                  </div>
                </section>
              )}

              {/* Step 5: å®¡æ ¸ */}
              {activeTab === 5 && (
                <section className="kb-upload-section">
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                    <h4>æŠ•æ ‡æ–‡ä»¶å®¡æ ¸</h4>
                    <button 
                      onClick={runReview} 
                      className="kb-create-form"
                      style={{ width: 'auto', marginBottom: 0 }}
                      disabled={reviewRun?.status === 'running'}
                    >
                      {reviewRun?.status === 'running' ? 'å®¡æ ¸ä¸­...' : 'å¼€å§‹å®¡æ ¸'}
                    </button>
                  </div>
                  
                  <div className="kb-create-form">
                    {bidderOptions.length > 0 && (
                      <>
                        <label className="sidebar-label">é€‰æ‹©æŠ•æ ‡äºº:</label>
                        <select
                          value={selectedBidder}
                          onChange={e => setSelectedBidder(e.target.value)}
                          className="sidebar-select"
                        >
                          <option value="">-- è¯·é€‰æ‹© --</option>
                          {bidderOptions.map(name => (
                            <option key={name} value={name}>{name}</option>
                          ))}
                        </select>
                      </>
                    )}
                    
                    <label className="sidebar-label">é€‰æ‹©è§„åˆ™é›†ï¼ˆå¯å¤šé€‰ï¼‰:</label>
                    {ruleSets.map(rs => (
                      <label key={rs.id} className="kb-item">
                        <input
                          type="checkbox"
                          checked={selectedRuleSetIds.includes(rs.id)}
                          onChange={() => {
                            setSelectedRuleSetIds(prev =>
                              prev.includes(rs.id)
                                ? prev.filter(id => id !== rs.id)
                                : [...prev, rs.id]
                            );
                          }}
                        />
                        <span>{rs.name}</span>
                      </label>
                    ))}
                  </div>
                  
                  {reviewRun && (
                    <div className="kb-import-results">
                      <div className="kb-import-item">
                        çŠ¶æ€: {reviewRun.status} {reviewRun.progress && `- ${reviewRun.progress}%`}
                      </div>
                    </div>
                  )}
                  
                  <div className="kb-doc-grid" style={{ marginTop: '16px' }}>
                    {reviewItems.map(item => (
                      <div key={item.id} className="kb-doc-card">
                        <div className="kb-doc-title">
                          {item.dimension}
                          <span style={{ marginLeft: '8px', fontSize: '12px' }}>
                            {item.result === 'pass' && 'âœ… é€šè¿‡'}
                            {item.result === 'risk' && 'âš ï¸ é£é™©'}
                            {item.result === 'fail' && 'âŒ ä¸åˆæ ¼'}
                          </span>
                          {item.rigid && (
                            <span style={{ marginLeft: '8px', fontSize: '11px' }}>
                              (ç¡¬æ€§)
                            </span>
                          )}
                        </div>
                        {item.requirement_text && (
                          <div className="kb-doc-meta" style={{ marginTop: '8px' }}>
                            è¦æ±‚: {item.requirement_text}
                          </div>
                        )}
                        {item.response_text && (
                          <div className="kb-doc-meta">
                            å“åº”: {item.response_text}
                          </div>
                        )}
                        {item.remark && (
                          <div className="kb-doc-meta">
                            å¤‡æ³¨: {item.remark}
                          </div>
                        )}
                        {(item.tender_evidence_chunk_ids.length > 0 || item.bid_evidence_chunk_ids.length > 0) && (
                          <div style={{ marginTop: '8px', display: 'flex', gap: '8px' }}>
                            {item.tender_evidence_chunk_ids.length > 0 && (
                              <button
                                onClick={() => showEvidence(item.tender_evidence_chunk_ids)}
                                className="link-button"
                              >
                                æ‹›æ ‡è¯æ® ({item.tender_evidence_chunk_ids.length})
                              </button>
                            )}
                            {item.bid_evidence_chunk_ids.length > 0 && (
                              <button
                                onClick={() => showEvidence(item.bid_evidence_chunk_ids)}
                                className="link-button"
                              >
                                æŠ•æ ‡è¯æ® ({item.bid_evidence_chunk_ids.length})
                              </button>
                            )}
                          </div>
                        )}
                      </div>
                    ))}
                    {reviewItems.length === 0 && (
                      <div className="kb-empty">æš‚æ— å®¡æ ¸è®°å½•ï¼Œç‚¹å‡»"å¼€å§‹å®¡æ ¸"</div>
                    )}
                  </div>
                </section>
              )}
            </div>
          </>
        ) : (
          <div className="kb-detail" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
            <div className="kb-empty-state">
              <div style={{ fontSize: '48px', marginBottom: '16px', textAlign: 'center' }}>ğŸ“‹</div>
              <div>è¯·é€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªé¡¹ç›®</div>
            </div>
          </div>
        )}
      </div>

      {/* å³ä¾§è¯æ®é¢æ¿ - å¤ç”¨ SourcePanel æ ·å¼ç»“æ„ */}
      <div className={`source-panel-container ${evidencePanelOpen ? '' : 'collapsed'}`}>
        {!evidencePanelOpen ? (
          <div className="source-panel-collapsed">
            <button
              className="source-toggle collapsed"
              onClick={() => setEvidencePanelOpen(true)}
              title="å±•å¼€è¯æ®é¢æ¿"
            >
              â—€
            </button>
            <span className="source-collapsed-label">è¯æ®é¢æ¿</span>
          </div>
        ) : (
          <div className="source-panel-body">
            <div className="source-title-row">
              <div className="source-title">è¯æ®é¢æ¿</div>
              <button className="source-toggle" onClick={() => setEvidencePanelOpen(false)}>
                æ”¶èµ·
              </button>
            </div>
            
            {evidenceChunks.length === 0 && (
              <div className="source-empty">
                ç‚¹å‡»"æŸ¥çœ‹è¯æ®"æŒ‰é’®åŠ è½½è¯æ®
              </div>
            )}
            
            {evidenceChunks.map(chunk => (
              <div key={chunk.chunk_id} className="source-card">
                <div className="source-card-title">
                  {chunk.title} #{chunk.position}
                </div>
                <div className="source-card-snippet" style={{ whiteSpace: 'pre-wrap' }}>
                  {chunk.content}
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}
