# é¡¹ç›®ä¿¡æ¯æŠ½å–æ€§èƒ½åˆ†æžä¸Žä¼˜åŒ–æ–¹æ¡ˆ

**é—®é¢˜**: é¡¹ç›®åŸºæœ¬ä¿¡æ¯æŠ½å–éœ€è¦10å¤šåˆ†é’Ÿ  
**åˆ†æžæ—¶é—´**: 2025-12-25

---

## ðŸ› æ€§èƒ½ç“¶é¢ˆåˆ†æž

### 1. å½“å‰æž¶æž„ï¼ˆå››é˜¶æ®µæŠ½å–ï¼‰

```
Stage 1 (base)            â†’ LLMè°ƒç”¨1 (2-3åˆ†é’Ÿ)
Stage 2 (technical)       â†’ LLMè°ƒç”¨2 (3-5åˆ†é’Ÿ) âš ï¸ æœ€æ…¢
Stage 3 (business)        â†’ LLMè°ƒç”¨3 (2-3åˆ†é’Ÿ)
Stage 4 (scoring)         â†’ LLMè°ƒç”¨4 (2-3åˆ†é’Ÿ)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡: 4æ¬¡LLMè°ƒç”¨          æ€»è€—æ—¶: 10-15åˆ†é’Ÿ âŒ
```

### 2. ä¸»è¦ç“¶é¢ˆ

| ç“¶é¢ˆé¡¹ | å½“å‰å€¼ | å½±å“ | è€—æ—¶ä¼°ç®— |
|--------|--------|------|----------|
| **æ£€ç´¢é‡** | 4ä¸ªquery Ã— 20 = 80 chunks | é«˜ | ~5-10ç§’ |
| **Contexté•¿åº¦** | 80 chunks Ã— 1200å­— = 96,000å­— | é«˜ | å½±å“LLMé€Ÿåº¦ |
| **Prompté•¿åº¦** | ~9,121å­—ç¬¦ (2,280 tokens) | ä¸­ | å½±å“LLMé€Ÿåº¦ |
| **LLMè¶…æ—¶** | 120ç§’ | é«˜ | ç»å¸¸è¶…æ—¶ |
| **LLMé€Ÿåº¦** | æ…¢ï¼ˆç‰¹åˆ«æ˜¯Stage 2ï¼‰ | é«˜ | å•æ¬¡2-5åˆ†é’Ÿ |
| **é¡ºåºæ‰§è¡Œ** | 4ä¸ªStageä¸²è¡Œ | é«˜ | æ—¶é—´å åŠ  |

### 3. è¯¦ç»†è€—æ—¶åˆ†è§£

#### Stage 1 (base - é¡¹ç›®åŸºæœ¬ä¿¡æ¯)
```
æ£€ç´¢: 4 queries Ã— 20 chunks/query = 80 chunks (5ç§’)
Contextæž„å»º: 80 chunks Ã— 1200å­— = 96KB (1ç§’)
Prompt: 2,280 tokens (åŸºæœ¬ä¿¡æ¯éƒ¨åˆ†~500 tokens)
LLMè°ƒç”¨: 96KB context + 500 tokens prompt â†’ 2-3åˆ†é’Ÿ
å¢žé‡ä¿å­˜: 1ç§’
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å°è®¡: ~2.5-3.5åˆ†é’Ÿ
```

#### Stage 2 (technical - æŠ€æœ¯å‚æ•°) âš ï¸ **æœ€æ…¢**
```
æ£€ç´¢: 4 queries Ã— 20 chunks/query = 80 chunks (5ç§’)
Contextæž„å»º: 80 chunks Ã— 1200å­— = 96KB (1ç§’)
Prompt: 2,280 tokens (æŠ€æœ¯å‚æ•°éƒ¨åˆ†~700 tokensï¼Œå·²ä¼˜åŒ–åŽ)
LLMè°ƒç”¨: 96KB context + 700 tokens prompt â†’ 3-5åˆ†é’Ÿ âš ï¸
å¢žé‡ä¿å­˜: 1ç§’
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å°è®¡: ~3.5-5.5åˆ†é’Ÿ âš ï¸ **ç“¶é¢ˆ**
```

**ä¸ºä»€ä¹ˆStage 2æœ€æ…¢ï¼Ÿ**
1. æŠ€æœ¯å‚æ•°æŸ¥è¯¢è¯æœ€å¤šæœ€å¤æ‚ï¼ˆåŒ…å«å¤§é‡å…·ä½“å‚æ•°åï¼‰
2. è¿”å›žçš„chunksé€šå¸¸åŒ…å«è¡¨æ ¼å’Œåˆ—è¡¨ï¼Œéš¾ä»¥è§£æž
3. LLMéœ€è¦ç†è§£è¯­ä¹‰å¹¶åˆ†ç±»ï¼Œè®¡ç®—é‡å¤§
4. JSONè¾“å‡ºç»“æž„æœ€å¤æ‚ï¼ˆæ•°ç»„åµŒå¥—ï¼‰

#### Stage 3 (business - å•†åŠ¡æ¡æ¬¾)
```
å°è®¡: ~2.5-3.5åˆ†é’Ÿ
```

#### Stage 4 (scoring - è¯„åˆ†è§„åˆ™)
```
å°è®¡: ~2-3åˆ†é’Ÿ
```

### 4. LLMè¶…æ—¶é—®é¢˜

**å½“å‰é…ç½®**:
```python
# backend/app/services/llm_client.py
async with httpx.AsyncClient(timeout=120.0) as client:  # 120ç§’ = 2åˆ†é’Ÿ
```

**é—®é¢˜**:
- Stage 2 ç»å¸¸éœ€è¦3-5åˆ†é’Ÿ
- 120ç§’è¶…æ—¶ â†’ `httpx.TimeoutException`
- å¯¼è‡´è¯¥Stageå¤±è´¥ï¼Œéœ€è¦é‡è¯•

---

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: å¿«é€Ÿä¼˜åŒ–ï¼ˆç«‹å³è§æ•ˆï¼‰

#### 1.1 å‡å°‘æ£€ç´¢é‡ï¼ˆå·²éƒ¨åˆ†ä¼˜åŒ–ï¼‰

**å½“å‰**: 
```python
top_k_per_query = 20  # æ¯ä¸ªqueryæ£€ç´¢20ä¸ªchunks
top_k_total = 80       # æ€»å…±80ä¸ªchunks
queries = 4            # 4ä¸ªæŸ¥è¯¢ç»´åº¦
```

**ä¼˜åŒ–**:
```python
top_k_per_query = 10   # âœ… å‡å°‘åˆ°10 (å‡å°‘50%)
top_k_total = 40        # âœ… å‡å°‘åˆ°40 (å‡å°‘50%)
queries = 4            # ä¿æŒ4ä¸ªç»´åº¦
```

**æ•ˆæžœ**:
- Contextå‡å°‘50%: 96KB â†’ 48KB
- æ£€ç´¢æ—¶é—´å‡å°‘50%: 5ç§’ â†’ 2.5ç§’
- LLMæŽ¨ç†æ—¶é—´å‡å°‘30-40%: 3-5åˆ†é’Ÿ â†’ 2-3åˆ†é’Ÿ
- **æ€»è€—æ—¶å‡å°‘**: 10-15åˆ†é’Ÿ â†’ 6-9åˆ†é’Ÿ

#### 1.2 å¢žåŠ LLMè¶…æ—¶

**å½“å‰**: 120ç§’  
**ä¼˜åŒ–**: 300ç§’ (5åˆ†é’Ÿ)

```python
# backend/app/services/llm_client.py
async with httpx.AsyncClient(timeout=300.0) as client:  # âœ… ä»Ž120ç§’å¢žåŠ åˆ°300ç§’
```

**æ•ˆæžœ**:
- Stage 2 ä¸å†è¶…æ—¶
- å‡å°‘é‡è¯•æ¬¡æ•°
- æé«˜æˆåŠŸçŽ‡

#### 1.3 åˆå¹¶ç›¸ä¼¼Stageï¼ˆé™ä½ŽLLMè°ƒç”¨æ¬¡æ•°ï¼‰

**å½“å‰**: 4ä¸ªStageï¼Œ4æ¬¡LLMè°ƒç”¨  
**ä¼˜åŒ–**: åˆå¹¶ä¸º2ä¸ªStage

```
Stage 1: base + scoring (åŸºæœ¬ä¿¡æ¯ + è¯„åˆ†è§„åˆ™)
  â†’ è¿™ä¸¤ä¸ªéƒ½æ¯”è¾ƒçŸ­ï¼Œå¯ä»¥ä¸€æ¬¡å®Œæˆ
  
Stage 2: technical + business (æŠ€æœ¯å‚æ•° + å•†åŠ¡æ¡æ¬¾)
  â†’ è¿™ä¸¤ä¸ªéƒ½æ˜¯åˆ—è¡¨åž‹æ•°æ®ï¼Œå¯ä»¥ä¸€æ¬¡å®Œæˆ
```

**æ•ˆæžœ**:
- LLMè°ƒç”¨æ¬¡æ•°: 4æ¬¡ â†’ 2æ¬¡
- æ€»è€—æ—¶: 10-15åˆ†é’Ÿ â†’ 5-7åˆ†é’Ÿ âœ…

---

### æ–¹æ¡ˆ2: ä¸­æœŸä¼˜åŒ–ï¼ˆæ›´æ¿€è¿›ï¼‰

#### 2.1 ä½¿ç”¨æ›´å¿«çš„LLMæ¨¡åž‹

**å½“å‰**: å¯èƒ½ä½¿ç”¨çš„æ˜¯å¤§æ¨¡åž‹ï¼ˆå¦‚GPT-4ã€Claude-3.5ï¼‰  
**ä¼˜åŒ–**: å°è¯•æ›´å¿«çš„æ¨¡åž‹

| æ¨¡åž‹ | é€Ÿåº¦ | è´¨é‡ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| GPT-4o | â­â­â­â­â­ å¿« | â­â­â­â­â­ ä¼˜ | âœ… æŽ¨è |
| Claude-3.5-Haiku | â­â­â­â­â­ å¿« | â­â­â­â­ å¥½ | âœ… æŽ¨è |
| GPT-4-Turbo | â­â­â­â­ è¾ƒå¿« | â­â­â­â­â­ ä¼˜ | å¯é€‰ |
| Claude-3.5-Sonnet | â­â­â­ ä¸­ç­‰ | â­â­â­â­â­ ä¼˜ | å½“å‰ä½¿ç”¨ï¼Ÿ |

**æ•ˆæžœ**:
- LLMæŽ¨ç†æ—¶é—´å‡å°‘50-70%
- æ€»è€—æ—¶: 10-15åˆ†é’Ÿ â†’ 3-5åˆ†é’Ÿ âœ…

#### 2.2 æ™ºèƒ½æŸ¥è¯¢ä¼˜åŒ–

**å½“å‰**: æ‰€æœ‰Stageä½¿ç”¨ç›¸åŒçš„4ä¸ªæŸ¥è¯¢  
**ä¼˜åŒ–**: æ¯ä¸ªStageä½¿ç”¨ä¸“é—¨çš„æŸ¥è¯¢

```python
# Stage 1: base - åªéœ€è¦1-2ä¸ªæŸ¥è¯¢
queries_base = {
    "base": "æ‹›æ ‡å…¬å‘Š é¡¹ç›®åç§° é‡‡è´­äºº æ‹›æ ‡äºº æŠ•æ ‡æˆªæ­¢æ—¶é—´ å¼€æ ‡æ—¶é—´"
}

# Stage 2: technical - éœ€è¦2-3ä¸ªæŸ¥è¯¢
queries_technical = {
    "technical_spec": "æŠ€æœ¯è¦æ±‚ æŠ€æœ¯è§„èŒƒ æŠ€æœ¯æ ‡å‡† æŠ€æœ¯å‚æ•°",
    "technical_detail": "è§„æ ¼ åž‹å· å‚æ•°è¡¨ CPU å†…å­˜ ç¡¬ç›˜ åŠŸçŽ‡"
}

# Stage 3: business - 1-2ä¸ªæŸ¥è¯¢
queries_business = {
    "business": "å•†åŠ¡æ¡æ¬¾ åˆåŒæ¡æ¬¾ ä»˜æ¬¾æ–¹å¼ äº¤ä»˜æœŸ è´¨ä¿ éªŒæ”¶"
}

# Stage 4: scoring - 1ä¸ªæŸ¥è¯¢
queries_scoring = {
    "scoring": "è¯„åˆ†æ ‡å‡† è¯„æ ‡åŠžæ³• è¯„å®¡åŠžæ³• è¯„åˆ†ç»†åˆ™ åˆ†å€¼"
}
```

**æ•ˆæžœ**:
- æ¯ä¸ªStageçš„æ£€ç´¢é‡å‡å°‘
- Stage 1: 80 chunks â†’ 20 chunks (å‡å°‘75%)
- Stage 2: 80 chunks â†’ 40 chunks (å‡å°‘50%)
- Stage 3: 80 chunks â†’ 20 chunks (å‡å°‘75%)
- Stage 4: 80 chunks â†’ 10 chunks (å‡å°‘87.5%)
- **æ€»è€—æ—¶**: 10-15åˆ†é’Ÿ â†’ 4-6åˆ†é’Ÿ âœ…

---

### æ–¹æ¡ˆ3: é•¿æœŸä¼˜åŒ–ï¼ˆæž¶æž„æ”¹è¿›ï¼‰

#### 3.1 å¹¶è¡Œæ‰§è¡Œç‹¬ç«‹Stage

**å½“å‰**: é¡ºåºæ‰§è¡Œ  
**ä¼˜åŒ–**: å¹¶è¡Œæ‰§è¡Œ

```python
# Stage 1, 3, 4 å¯ä»¥å¹¶è¡Œï¼ˆç›¸äº’ç‹¬ç«‹ï¼‰
# Stage 2 éœ€è¦ç­‰å¾…Stage 1 å®Œæˆï¼ˆéœ€è¦contextï¼‰

å¹¶è¡Œç»„1: [Stage 1, Stage 3, Stage 4]  â†’ åŒæ—¶æ‰§è¡Œ
å¹¶è¡Œç»„2: [Stage 2]                     â†’ ç­‰å¾…Stage 1å®ŒæˆåŽæ‰§è¡Œ
```

**æ•ˆæžœ**:
- Stage 1, 3, 4 å¹¶è¡Œ: max(2.5, 2.5, 2) = 2.5åˆ†é’Ÿ
- Stage 2 ç­‰å¾…: 3.5åˆ†é’Ÿ
- **æ€»è€—æ—¶**: 10-15åˆ†é’Ÿ â†’ 6åˆ†é’Ÿ âœ…

#### 3.2 ç¼“å­˜æœºåˆ¶

**ä¼˜åŒ–**: ç¼“å­˜æ£€ç´¢ç»“æžœ

```python
# ç¬¬ä¸€æ¬¡æŠ½å–æ—¶ï¼Œç¼“å­˜æ£€ç´¢åˆ°çš„chunks
cache_key = f"project:{project_id}:chunks"
redis.set(cache_key, chunks, ex=3600)  # 1å°æ—¶æœ‰æ•ˆ

# åŽç»­Stageç›´æŽ¥ä½¿ç”¨ç¼“å­˜
cached_chunks = redis.get(cache_key)
```

**æ•ˆæžœ**:
- æ£€ç´¢æ—¶é—´: 5ç§’ Ã— 4 = 20ç§’ â†’ 5ç§’ (ç¬¬ä¸€æ¬¡)
- **æ€»è€—æ—¶å‡å°‘**: 15ç§’

#### 3.3 æµå¼è¾“å‡º

**ä¼˜åŒ–**: LLMæµå¼è¿”å›žç»“æžœï¼Œè¾¹ç”Ÿæˆè¾¹è§£æž

```python
async for chunk in llm.stream(...):
    # å®žæ—¶è§£æžJSON
    # å®žæ—¶æ›´æ–°æ•°æ®åº“
    # å®žæ—¶æŽ¨é€åˆ°å‰ç«¯
```

**æ•ˆæžœ**:
- ç”¨æˆ·ä½“éªŒæ›´å¥½ï¼ˆå®žæ—¶çœ‹åˆ°ç»“æžœï¼‰
- æ€»è€—æ—¶ä¸å˜ï¼Œä½†æ„ŸçŸ¥æ—¶é—´ç¼©çŸ­

---

## ðŸŽ¯ æŽ¨èå®žæ–½é¡ºåº

### ç¬¬ä¸€æ­¥: å¿«é€Ÿä¼˜åŒ–ï¼ˆç«‹å³æ‰§è¡Œï¼‰

**è€—æ—¶**: 10åˆ†é’Ÿ  
**æ”¶ç›Š**: å‡å°‘40-50%æ—¶é—´

```bash
# 1. ä¿®æ”¹æ£€ç´¢é…ç½®
cd /aidata/x-llmapp1
export V2_RETRIEVAL_TOPK_PER_QUERY=10  # ä»Ž20é™åˆ°10
export V2_RETRIEVAL_TOPK_TOTAL=40      # ä»Ž80é™åˆ°40

# 2. å¢žåŠ LLMè¶…æ—¶
# ä¿®æ”¹ backend/app/services/llm_client.py
# timeout=120.0 â†’ timeout=300.0

# 3. é‡å¯åŽç«¯
docker compose restart backend
```

**é¢„æœŸæ•ˆæžœ**: 10-15åˆ†é’Ÿ â†’ 6-9åˆ†é’Ÿ

### ç¬¬äºŒæ­¥: åˆå¹¶Stageï¼ˆ1å°æ—¶å¼€å‘ï¼‰

**è€—æ—¶**: 1å°æ—¶å¼€å‘ + æµ‹è¯•  
**æ”¶ç›Š**: å‡å°‘50%LLMè°ƒç”¨

```python
# ä¿®æ”¹ backend/app/works/tender/extract_v2_service.py
stages = [
    {"stage": 1, "name": "åŸºæœ¬ä¿¡æ¯+è¯„åˆ†è§„åˆ™", "keys": ["base", "scoring_criteria"]},
    {"stage": 2, "name": "æŠ€æœ¯å‚æ•°+å•†åŠ¡æ¡æ¬¾", "keys": ["technical_parameters", "business_terms"]},
]
```

**é¢„æœŸæ•ˆæžœ**: 6-9åˆ†é’Ÿ â†’ 4-6åˆ†é’Ÿ

### ç¬¬ä¸‰æ­¥: æ™ºèƒ½æŸ¥è¯¢ï¼ˆ2å°æ—¶å¼€å‘ï¼‰

**è€—æ—¶**: 2å°æ—¶å¼€å‘ + æµ‹è¯•  
**æ”¶ç›Š**: å‡å°‘60-70%æ£€ç´¢é‡

```python
# ä¿®æ”¹ backend/app/works/tender/extract_v2_service.py
# æ¯ä¸ªStageä½¿ç”¨ä¸“é—¨çš„æŸ¥è¯¢é…ç½®
```

**é¢„æœŸæ•ˆæžœ**: 4-6åˆ†é’Ÿ â†’ 3-4åˆ†é’Ÿ

---

## ðŸ“Š ä¼˜åŒ–æ•ˆæžœå¯¹æ¯”

| æ–¹æ¡ˆ | å¼€å‘æˆæœ¬ | æ•ˆæžœ | æœ€ç»ˆè€—æ—¶ | æŽ¨è |
|------|----------|------|----------|------|
| **å½“å‰** | - | - | 10-15åˆ†é’Ÿ | âŒ å¤ªæ…¢ |
| **å¿«é€Ÿä¼˜åŒ–** | 10åˆ†é’Ÿ | â­â­â­ | 6-9åˆ†é’Ÿ | âœ… ç«‹å³æ‰§è¡Œ |
| **+åˆå¹¶Stage** | +1å°æ—¶ | â­â­â­â­ | 4-6åˆ†é’Ÿ | âœ… æŽ¨è |
| **+æ™ºèƒ½æŸ¥è¯¢** | +2å°æ—¶ | â­â­â­â­â­ | 3-4åˆ†é’Ÿ | âœ… æŽ¨è |
| **+å¹¶è¡Œæ‰§è¡Œ** | +4å°æ—¶ | â­â­â­â­â­ | 2-3åˆ†é’Ÿ | å¯é€‰ |

---

## ðŸš€ ç«‹å³å¯æ‰§è¡Œçš„å‘½ä»¤

```bash
cd /aidata/x-llmapp1

# 1. ä¿®æ”¹çŽ¯å¢ƒå˜é‡ï¼ˆå‡å°‘æ£€ç´¢é‡ï¼‰
cat >> .env << 'END'
V2_RETRIEVAL_TOPK_PER_QUERY=10
V2_RETRIEVAL_TOPK_TOTAL=40
END

# 2. ä¿®æ”¹LLMè¶…æ—¶ï¼ˆä»Ž120ç§’å¢žåŠ åˆ°300ç§’ï¼‰
sed -i 's/timeout=120\.0/timeout=300.0/g' backend/app/services/llm_client.py

# 3. é‡å¯åŽç«¯
docker compose restart backend

# 4. æŸ¥çœ‹æ—¥å¿—éªŒè¯
docker compose logs -f backend | grep "ExtractV2"
```

---

## âœ¨ æ€»ç»“

**å½“å‰é—®é¢˜**: 10-15åˆ†é’Ÿå¤ªæ…¢  
**ä¸»è¦ç“¶é¢ˆ**: 
1. âŒ æ£€ç´¢é‡è¿‡å¤§ï¼ˆ80 chunksï¼‰
2. âŒ LLMè¶…æ—¶å¤ªçŸ­ï¼ˆ120ç§’ï¼‰
3. âŒ Stage 2 æŠ€æœ¯å‚æ•°æœ€æ…¢ï¼ˆ3-5åˆ†é’Ÿï¼‰
4. âŒ é¡ºåºæ‰§è¡Œ4ä¸ªStage

**ç«‹å³ä¼˜åŒ–**: 
1. âœ… å‡å°‘æ£€ç´¢é‡: 80 â†’ 40 chunks
2. âœ… å¢žåŠ è¶…æ—¶: 120ç§’ â†’ 300ç§’

**é¢„æœŸæ•ˆæžœ**: 
- ç¬¬ä¸€æ­¥ä¼˜åŒ–åŽ: 6-9åˆ†é’Ÿ âœ…
- ç¬¬äºŒæ­¥ä¼˜åŒ–åŽ: 4-6åˆ†é’Ÿ âœ…âœ…
- ç¬¬ä¸‰æ­¥ä¼˜åŒ–åŽ: 3-4åˆ†é’Ÿ âœ…âœ…âœ…

**æŠ•å…¥äº§å‡ºæ¯”**: 
- 10åˆ†é’Ÿé…ç½® â†’ å‡å°‘40-50%æ—¶é—´
- 3å°æ—¶å¼€å‘ â†’ å‡å°‘70-75%æ—¶é—´

---

**åˆ†æžå®Œæˆæ—¶é—´**: 2025-12-25
