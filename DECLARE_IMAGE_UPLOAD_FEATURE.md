# ç”³æŠ¥ä¹¦æ¨¡å—å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½å®æ–½æ€»ç»“

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

ä¸ºç”³æŠ¥ä¹¦æ¨¡å—å®ç°äº†å®Œæ•´çš„å›¾ç‰‡ä¸Šä¼ ã€è¯´æ˜åŒ¹é…ã€AIç”Ÿæˆé›†æˆå’ŒDOCXå¯¼å‡ºåŠŸèƒ½ã€‚

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. å‰ç«¯UIæ”¹é€ 

**æ–‡ä»¶**: `frontend/src/components/DeclareWorkspaceV2.tsx`

**æ”¹åŠ¨**:
- å°†åŸæœ‰çš„"ä¼ä¸šä¿¡æ¯"ã€"æŠ€æœ¯èµ„æ–™"ä¸¤ä¸ªä¸Šä¼ åŒºåŸŸåˆå¹¶ä¸º"ç”¨æˆ·èµ„æ–™ï¼ˆæ–‡æ¡£ï¼‰"å’Œ"ç”¨æˆ·èµ„æ–™ï¼ˆå›¾ç‰‡ï¼‰"
- æ·»åŠ å›¾ç‰‡æ–‡ä»¶ä¸Šä¼ æ”¯æŒï¼ˆ.jpg/.jpeg/.png/.gif/.bmp/.webpï¼‰
- æ·»åŠ æ–‡ä»¶ç±»å‹accepté™åˆ¶ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- æ›´æ–°çŠ¶æ€ç®¡ç†ï¼š`companyFiles`, `techFiles` â†’ `userDocFiles`, `imageFiles`

**å‰ç«¯APIç±»å‹æ›´æ–°**:
- `frontend/src/api/declareApi.ts`: æ›´æ–°`uploadAssets`å‚æ•°ç±»å‹ï¼Œæ·»åŠ `'user_doc' | 'image'`
- `frontend/src/mock/declareMockApi.ts`: åŒæ­¥æ›´æ–°mock APIç±»å‹

### 2. åç«¯æ•°æ®åº“æ”¹é€ 

**è¿ç§»æ–‡ä»¶**: `backend/migrations/026_alter_declare_assets_add_asset_type.sql`

**æ”¹åŠ¨**:
- ä¸º`declare_assets`è¡¨æ·»åŠ `asset_type`å­—æ®µï¼ˆdocument | image | image_descriptionï¼‰
- æ›´æ–°`kind`å­—æ®µæ³¨é‡Šï¼Œæ·»åŠ `user_doc`å’Œ`image`æ”¯æŒ
- æ·»åŠ `asset_type`ç´¢å¼•ï¼Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

**æ‰§è¡Œå‘½ä»¤**:
```bash
docker-compose exec -T postgres psql -U localgpt -d localgpt -f - < backend/migrations/026_alter_declare_assets_add_asset_type.sql
```

### 3. åç«¯DAOå±‚æ”¹é€ 

**æ–‡ä»¶**: `backend/app/services/dao/declare_dao.py`

**æ”¹åŠ¨**:
- `create_asset`: æ·»åŠ `asset_type`å‚æ•°ï¼Œæ”¯æŒåˆ›å»ºä¸åŒç±»å‹çš„èµ„äº§
- `update_asset_meta`: æ–°å¢æ–¹æ³•ï¼Œç”¨äºæ›´æ–°èµ„äº§çš„`meta_json`ï¼ˆå¦‚å›¾ç‰‡è¯´æ˜çš„doc_version_idï¼‰

### 4. åç«¯Serviceå±‚æ”¹é€ 

**æ–‡ä»¶**: `backend/app/services/declare_service.py`

**æ”¹åŠ¨**:
- `import_assets`: å¤§å¹…æ”¹é€ ï¼Œæ”¯æŒå¤šæ–‡ä»¶ç±»å‹å¤„ç†
  - æ”¯æŒæ–°çš„kindç±»å‹ï¼š`user_doc`, `image`
  - æ·»åŠ Excelå›¾ç‰‡è¯´æ˜è§£æé€»è¾‘ï¼ˆè‡ªåŠ¨æ£€æµ‹.xlsx/.xlsæ–‡ä»¶ï¼‰
  - å›¾ç‰‡æ–‡ä»¶å•ç‹¬å¤„ç†ï¼š
    - å­˜å‚¨å›¾ç‰‡æ–‡ä»¶
    - å…³è”Excelä¸­çš„è¯´æ˜æ–‡å­—
    - å°†å›¾ç‰‡è¯´æ˜å…¥åº“å‘é‡ï¼ˆç”¨äºæ£€ç´¢ï¼‰
    - æ— è¯´æ˜çš„å›¾ç‰‡ä¹Ÿå…è®¸ä¸Šä¼ 
  - å›¾ç‰‡è¯´æ˜Excelä¸å…¥åº“å‘é‡ï¼Œä»…å­˜å‚¨

**æ–°å¢è¾…åŠ©æ–¹æ³•**:
- `_parse_image_description_excel`: è§£æExcelæ–‡ä»¶ï¼Œæå–"å›¾ç‰‡æ–‡ä»¶å"å’Œ"å›¾ç‰‡è¯´æ˜"ä¸¤åˆ—
- `_determine_asset_type`: æ ¹æ®æ–‡ä»¶æ‰©å±•ååˆ¤æ–­èµ„äº§ç±»å‹

**Excelæ ¼å¼**:
```
| å›¾ç‰‡æ–‡ä»¶å | å›¾ç‰‡è¯´æ˜ |
| ---------- | -------- |
| å›¾ç‰‡1.jpg  | ä¼ä¸šå‚æˆ¿å¤–è§‚... |
| å›¾ç‰‡2.png  | ç”Ÿäº§çº¿è®¾å¤‡... |
```

### 5. AIç”Ÿæˆå¢å¼º

**æ–‡ä»¶**: `backend/app/works/declare/extraction_specs/section_autofill_v2.py`

**æ”¹åŠ¨**:
- åœ¨`doc_types`ä¸­æ·»åŠ `"declare_user_doc"`, `"declare_image"`ï¼Œä½¿å›¾ç‰‡è¯´æ˜å¯è¢«æ£€ç´¢

**æ–‡ä»¶**: `backend/app/works/declare/prompts/section_autofill_v2.md`

**æ”¹åŠ¨**:
- æ·»åŠ å›¾ç‰‡å¼•ç”¨è§„åˆ™è¯´æ˜ï¼ˆç¬¬9ã€10æ¡ï¼‰
- æŒ‡å¯¼LLMåœ¨åˆé€‚ä½ç½®æ’å…¥å›¾ç‰‡å ä½ç¬¦ï¼š`{image:å›¾ç‰‡æ–‡ä»¶å}`
- æ˜ç¡®å›¾ç‰‡ä½¿ç”¨çš„çµæ´»æ€§ï¼šå¯ç”¨å¯ä¸ç”¨ï¼Œç”±LLMåˆ¤æ–­ç›¸å…³æ€§

**Promptç¤ºä¾‹**:
```markdown
9. **å›¾ç‰‡å¼•ç”¨è§„åˆ™**ï¼šå¦‚æœåŸæ–‡ç‰‡æ®µä¸­åŒ…å«å›¾ç‰‡è¯´æ˜ï¼ˆæ ¼å¼ä¸º"å›¾ç‰‡ï¼šxxx.jpg è¯´æ˜ï¼š..."ï¼‰ï¼Œ
   ä¸”è¯¥å›¾ç‰‡ä¸ç« èŠ‚å†…å®¹ç›¸å…³ï¼Œè¯·åœ¨ `content_md` ä¸­åˆé€‚çš„ä½ç½®æ’å…¥å›¾ç‰‡å ä½ç¬¦ï¼š`{image:å›¾ç‰‡æ–‡ä»¶å}`ã€‚
   ä¾‹å¦‚ï¼š`{image:ä¼ä¸šå‚æˆ¿å¤–è§‚.jpg}`ã€‚å›¾ç‰‡å ä½ç¬¦åº”ç‹¬å ä¸€è¡Œã€‚
10. å›¾ç‰‡å¯ç”¨å¯ä¸ç”¨ï¼Œç”±ä½ æ ¹æ®å†…å®¹ç›¸å…³æ€§åˆ¤æ–­ã€‚
```

### 6. DOCXå¯¼å‡ºå›¾ç‰‡æ’å…¥

**æ–‡ä»¶**: `backend/app/services/export/declare_docx_exporter.py`

**æ”¹åŠ¨**:
- `export`: ä¿®æ”¹å·²æœ‰å†…å®¹æ¸²æŸ“é€»è¾‘ï¼Œè°ƒç”¨`_render_markdown_with_images`

**æ–°å¢æ–¹æ³•**:
- `_render_markdown_with_images`: 
  - é€è¡Œè§£æMarkdownå†…å®¹
  - æ£€æµ‹å›¾ç‰‡å ä½ç¬¦`{image:filename}`
  - è°ƒç”¨`_insert_image`æ’å…¥å®é™…å›¾ç‰‡
  
- `_insert_image`:
  - ä»æ•°æ®åº“æŸ¥æ‰¾å›¾ç‰‡èµ„äº§
  - éªŒè¯æ–‡ä»¶å­˜åœ¨æ€§
  - ä½¿ç”¨`doc.add_picture()`æ’å…¥å›¾ç‰‡ï¼ˆå®½åº¦5è‹±å¯¸ï¼‰
  - æ·»åŠ å›¾ç‰‡è¯´æ˜ï¼ˆå±…ä¸­ï¼ŒCaptionæ ·å¼ï¼‰

**å›¾ç‰‡å ä½ç¬¦æ ¼å¼**:
```markdown
è¿™æ˜¯ä¸€äº›æ–‡å­—å†…å®¹ã€‚

{image:ä¼ä¸šå‚æˆ¿å¤–è§‚.jpg}

è¿™æ˜¯å›¾ç‰‡åçš„å†…å®¹ã€‚
```

## ğŸ“‚ æ–‡ä»¶æ¸…å•

### å‰ç«¯
- `frontend/src/components/DeclareWorkspaceV2.tsx` âœ… ä¿®æ”¹
- `frontend/src/api/declareApi.ts` âœ… ä¿®æ”¹
- `frontend/src/mock/declareMockApi.ts` âœ… ä¿®æ”¹

### åç«¯
- `backend/migrations/026_alter_declare_assets_add_asset_type.sql` âœ… æ–°å¢
- `backend/app/services/dao/declare_dao.py` âœ… ä¿®æ”¹
- `backend/app/services/declare_service.py` âœ… ä¿®æ”¹
- `backend/app/works/declare/extraction_specs/section_autofill_v2.py` âœ… ä¿®æ”¹
- `backend/app/works/declare/prompts/section_autofill_v2.md` âœ… ä¿®æ”¹
- `backend/app/services/export/declare_docx_exporter.py` âœ… ä¿®æ”¹

## ğŸ”„ æ•°æ®æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶         â”‚
â”‚ - ç”³æŠ¥é€šçŸ¥          â”‚
â”‚ - ç”¨æˆ·æ–‡æ¡£          â”‚
â”‚ - å›¾ç‰‡ + Excelè¯´æ˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ import_assets       â”‚
â”‚ - è§£æExcel         â”‚
â”‚ - åŒ¹é…å›¾ç‰‡&è¯´æ˜     â”‚
â”‚ - å›¾ç‰‡è¯´æ˜â†’å‘é‡åº“   â”‚
â”‚ - æ–‡æ¡£â†’å‘é‡åº“       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AIç”Ÿæˆç« èŠ‚å†…å®¹      â”‚
â”‚ - æ£€ç´¢æ–‡æœ¬+å›¾ç‰‡è¯´æ˜ â”‚
â”‚ - LLMç”Ÿæˆå†…å®¹       â”‚
â”‚ - æ’å…¥å›¾ç‰‡å ä½ç¬¦    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DOCXå¯¼å‡º            â”‚
â”‚ - è§£æ{image:xxx}   â”‚
â”‚ - æ’å…¥å®é™…å›¾ç‰‡      â”‚
â”‚ - æ·»åŠ å›¾ç‰‡è¯´æ˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¨ æ ¸å¿ƒè®¾è®¡ç‰¹ç‚¹

### 1. **æ— è¯´æ˜å›¾ç‰‡æ”¯æŒ**
- å›¾ç‰‡å¯ä»¥æ²¡æœ‰Excelè¯´æ˜æ–‡ä»¶
- æ— è¯´æ˜å›¾ç‰‡ä¹Ÿèƒ½ä¸Šä¼ å­˜å‚¨
- LLMåœ¨æ²¡æœ‰è¯´æ˜çš„æƒ…å†µä¸‹ï¼Œæ ¹æ®æ–‡ä»¶åå’Œä¸Šä¸‹æ–‡åˆ¤æ–­æ˜¯å¦ä½¿ç”¨

### 2. **çµæ´»çš„å›¾ç‰‡ä½¿ç”¨**
- LLMè‡ªä¸»å†³å®šæ˜¯å¦åœ¨å†…å®¹ä¸­å¼•ç”¨å›¾ç‰‡
- ä¸å¼ºåˆ¶ä½¿ç”¨æ‰€æœ‰ä¸Šä¼ çš„å›¾ç‰‡
- åŸºäºå†…å®¹ç›¸å…³æ€§æ™ºèƒ½é€‰æ‹©

### 3. **ç®€åŒ–çš„ç”¨æˆ·ä½“éªŒ**
- ç”¨æˆ·åªéœ€ï¼š
  1. ä¸Šä¼ å›¾ç‰‡
  2. ï¼ˆå¯é€‰ï¼‰ä¸Šä¼ Excelè¯´æ˜
  3. AIè‡ªåŠ¨å®Œæˆå…¶ä½™å·¥ä½œ
- æ— éœ€æ‰‹åŠ¨è°ƒæ•´åˆ†ç±»
- æ— éœ€å›¾ç‰‡è£å‰ª/å‹ç¼©

### 4. **å‘é‡åŒ–ç­–ç•¥**
- **å›¾ç‰‡è¯´æ˜å…¥åº“å‘é‡**ï¼šç”¨äºæ£€ç´¢ï¼Œå¸®åŠ©LLMæ‰¾åˆ°ç›¸å…³å›¾ç‰‡
- **å›¾ç‰‡æ–‡ä»¶ä¸å…¥åº“å‘é‡**ï¼šä»…å­˜å‚¨ï¼Œé€šè¿‡è¯´æ˜é—´æ¥å…³è”
- **Excelæ–‡ä»¶ä¸å…¥åº“å‘é‡**ï¼šä»…ä½œä¸ºå…ƒæ•°æ®æº

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç”¨æˆ·æ“ä½œæµç¨‹
1. **Step1: ä¸Šä¼ æ–‡æ¡£**
   - ä¸Šä¼ ç”³æŠ¥é€šçŸ¥ï¼ˆå¿…éœ€ï¼‰
   - ä¸Šä¼ ç”¨æˆ·æ–‡æ¡£ï¼ˆå¯é€‰ï¼‰
   - ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰
   - ä¸Šä¼ å›¾ç‰‡è¯´æ˜Excelï¼ˆå¯é€‰ï¼‰

2. **Step2: æå–ä¿¡æ¯**
   - ç³»ç»Ÿè‡ªåŠ¨æå–ç”³æŠ¥è¦æ±‚
   - ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆç”³æŠ¥ç›®å½•

3. **Step3: AIç”Ÿæˆ**
   - ç‚¹å‡»"AIç”Ÿæˆç”³æŠ¥ä¹¦"
   - ç³»ç»Ÿè‡ªåŠ¨ï¼š
     - æ£€ç´¢ç›¸å…³æ–‡æœ¬å’Œå›¾ç‰‡è¯´æ˜
     - ç”Ÿæˆç« èŠ‚å†…å®¹
     - åœ¨åˆé€‚ä½ç½®æ’å…¥å›¾ç‰‡å¼•ç”¨
   - å¯¼å‡ºDOCXï¼šå›¾ç‰‡è‡ªåŠ¨æ’å…¥æ–‡æ¡£

### Excelè¯´æ˜æ–‡ä»¶ç¤ºä¾‹
```excel
å›¾ç‰‡æ–‡ä»¶å           | å›¾ç‰‡è¯´æ˜
---------------------|-----------------------------
ä¼ä¸šå‚æˆ¿å¤–è§‚.jpg     | å…¬å¸ä½äºXXå·¥ä¸šå›­ï¼Œå åœ°5000å¹³æ–¹ç±³
ç”Ÿäº§çº¿è®¾å¤‡.png       | å…¨è‡ªåŠ¨åŒ–ç”Ÿäº§çº¿ï¼Œå¹´äº§èƒ½100ä¸‡ä»¶
ç ”å‘å›¢é˜Ÿåˆå½±.jpg     | æ ¸å¿ƒç ”å‘å›¢é˜Ÿ15äººï¼Œå¹³å‡10å¹´è¡Œä¸šç»éªŒ
äº§å“å±•ç¤ºå›¾.jpg       | å…¬å¸ä¸»æ‰“äº§å“ç³»åˆ—
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Excelæ ¼å¼ä¸¥æ ¼è¦æ±‚**ï¼šå¿…é¡»åªæœ‰ä¸¤åˆ—ï¼Œåˆ†åˆ«æ˜¯"å›¾ç‰‡æ–‡ä»¶å"å’Œ"å›¾ç‰‡è¯´æ˜"
2. **æ–‡ä»¶ååŒ¹é…**ï¼šExcelä¸­çš„æ–‡ä»¶åå¿…é¡»ä¸ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶åå®Œå…¨ä¸€è‡´
3. **å›¾ç‰‡å°ºå¯¸**ï¼šå¯¼å‡ºDOCXæ—¶å›¾ç‰‡å®½åº¦å›ºå®šä¸º5è‹±å¯¸ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´
4. **å›¾ç‰‡æ ¼å¼**ï¼šæ”¯æŒ.jpg/.jpeg/.png/.gif/.bmp/.webp/.tiff/.svg
5. **å‘é‡åº“æ˜ å°„**ï¼šéœ€è¦åœ¨`doc_type_mapper.py`ä¸­æ·»åŠ `declare_user_doc`å’Œ`declare_image`çš„æ˜ å°„

## ğŸ”§ ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰é…ç½®ï¼‰

æ— æ–°å¢ç¯å¢ƒå˜é‡ï¼Œä½¿ç”¨ç°æœ‰çš„ï¼š
- `DECLARE_STORAGE_DIR`: æ–‡ä»¶å­˜å‚¨ç›®å½•ï¼ˆé»˜è®¤`./data/declare/files`ï¼‰
- `DECLARE_SECTION_TOPK_TOTAL`: æ£€ç´¢top-kï¼ˆé»˜è®¤80ï¼Œå·²åŒ…å«å›¾ç‰‡è¯´æ˜ï¼‰

## ğŸš€ éƒ¨ç½²è¯´æ˜

1. **æ•°æ®åº“è¿ç§»**ï¼š
   ```bash
   docker-compose exec -T postgres psql -U localgpt -d localgpt -f - < backend/migrations/026_alter_declare_assets_add_asset_type.sql
   ```

2. **é‡å¯æœåŠ¡**ï¼š
   ```bash
   docker-compose restart backend frontend
   ```

3. **éªŒè¯åŠŸèƒ½**ï¼š
   - åˆ›å»ºç”³æŠ¥é¡¹ç›®
   - ä¸Šä¼ æµ‹è¯•æ–‡æ¡£å’Œå›¾ç‰‡
   - æå–ä¿¡æ¯
   - AIç”Ÿæˆ
   - å¯¼å‡ºDOCXéªŒè¯å›¾ç‰‡æ’å…¥

## âœ¨ åŠŸèƒ½äº®ç‚¹

1. âœ… **é›¶ç”¨æˆ·å¹²é¢„**ï¼šå›¾ç‰‡è‡ªåŠ¨è¯†åˆ«ã€è‡ªåŠ¨åŒ¹é…ã€è‡ªåŠ¨æ’å…¥
2. âœ… **æ™ºèƒ½é€‰æ‹©**ï¼šLLMæ ¹æ®ç›¸å…³æ€§å†³å®šä½¿ç”¨å“ªäº›å›¾ç‰‡
3. âœ… **å®¹é”™æ€§å¼º**ï¼šæ— è¯´æ˜å›¾ç‰‡ä¹Ÿèƒ½å¤„ç†
4. âœ… **å‘é‡å¢å¼º**ï¼šå›¾ç‰‡è¯´æ˜å‚ä¸æ£€ç´¢ï¼Œæå‡ç›¸å…³æ€§
5. âœ… **ä¸“ä¸šæ’ç‰ˆ**ï¼šå›¾ç‰‡è‡ªåŠ¨å±…ä¸­ï¼Œè¯´æ˜è‡ªåŠ¨æ·»åŠ 

## ğŸ‰ å®ŒæˆçŠ¶æ€

- âœ… å‰ç«¯ï¼šå¤šæ–‡ä»¶ä¸Šä¼ UIæ”¹é€ 
- âœ… åç«¯ï¼šæ‰¹é‡ä¸Šä¼ æ¥å£å’Œå›¾ç‰‡å­˜å‚¨
- âœ… åç«¯ï¼šExcelå›¾ç‰‡è¯´æ˜è§£æå’ŒåŒ¹é…
- âœ… åç«¯ï¼šAIç”Ÿæˆå¢å¼ºï¼ˆå›¾ç‰‡æ£€ç´¢+Promptï¼‰
- âœ… åç«¯ï¼šDOCXå¯¼å‡ºå›¾ç‰‡æ’å…¥
- ğŸ”„ å®Œæ•´æµç¨‹æµ‹è¯•ï¼ˆç­‰å¾…ç”¨æˆ·éªŒè¯ï¼‰

---

**å®æ–½æ—¥æœŸ**: 2026-01-02  
**å®æ–½ç‰ˆæœ¬**: v1.0  
**ä¸‹ä¸€æ­¥**: ç”¨æˆ·å®é™…æµ‹è¯•å¹¶æ”¶é›†åé¦ˆ

