# 恢复v0.3.0提取策略（保持契约字段名）

## 问题反馈

用户报告提取结果不符合预期：

### 技术参数提取不足
**现状**（只有3条，且很笼统）：
1. 主要设备：PLC设备、超融合一体机
2. 系统组成：智能监控平台、广播系统、门禁系统...（列举系统名称）
3. 质量要求：达到国家现行有关规范要求的合格标准...

**问题**：
- ❌ 数量太少（应该 > 20条）
- ❌ 内容太笼统（缺少具体的技术参数、配置要求、标准规范等）
- ❌ 缺少详细的设备参数、性能指标、工艺要求等

### 商务条款提取错误
**现状**（显示的是基本信息，不是商务条款）：
1. 投标保证金：50万元...
2. 投标截止时间：2024年12月12日10时30分
3. 投标有效期：120日历天...
4. 联系人：李女士...

**问题**：
- ❌ 这些应该是base字段的基本信息
- ❌ 不应该出现在business_terms中
- ❌ 缺少真正的商务条款（付款方式、交货期、质保期、验收标准等）

---

## 根本原因分析

### 对比v0.3.0和修改后的prompt

#### v0.3.0 prompt特点（307行）
✅ **简洁明确**：JSON schema清晰，字段说明简单
✅ **强调宽泛**："宁可多提取，不要遗漏"，多次强调
✅ **灵活处理**："parameters可以为空"，"category可以自定义"
✅ **示例多样**：5个技术参数示例，5个商务条款示例，涵盖各种情况

#### 修改后的prompt问题（472行）
❌ **过于详细**：加了太多"必填字段"、"重要字段"的说明
❌ **约束太多**：强调"必须填写parameters"，"必须提取具体数值"
❌ **语气保守**：过多强调"契约要求"、"必填"，让LLM变得谨慎
❌ **失去灵活性**：太多规则，让LLM不敢"宽泛提取"

### 为什么提取变少了？

**心理学原理**：
- 当prompt中出现大量"必填"、"重要"、"必须"时，LLM会变得保守
- LLM会倾向于"只提取明确符合要求的内容"，而不是"宽泛提取"
- 过多的约束让LLM"不敢"提取不确定的内容

**具体表现**：
1. **技术参数**：LLM只提取了明显的"设备列表"和"质量要求"，而不敢提取具体的配置、标准、工艺等
2. **商务条款**：LLM误将基本信息（截止时间、联系人）当成商务条款，说明对"条款"的理解出现偏差

---

## 解决方案

### 核心策略：恢复v0.3.0的"宽泛提取"理念 + 保持契约字段名

#### 1. JSON Schema部分
**改动**：
- 字段名：`item` → `name`，`requirement` → `value`（technical_parameters）
- 字段名：`term` → `clause_type`，`requirement` → `content`（business_terms）
- 保持v0.3.0的简洁注释风格

**示例**：
```json
// v0.3.0（旧字段名）
{
  "item": "条目标题或功能点",
  "requirement": "要求描述",
  "parameters": [...]
}

// 修改后（契约字段名）
{
  "name": "参数/功能名称（条目标题或功能点）",
  "value": "参数值/要求描述（可包含型号、数量、范围等）",
  "parameters": [...]
}
```

#### 2. 提取原则部分
**完全恢复v0.3.0的表述**：
- "核心原则：宁可多提取，不要遗漏"
- "应该提取的内容（宽泛定义）"
- "灵活处理，优先保证内容完整性"
- "不要因为结构化困难而跳过提取"

**删除的约束**：
- ❌ "必填字段：name和value必填（契约要求）"
- ❌ "什么情况必须填写parameters（重要！）"
- ❌ "核心思想：parameters必须填写具体数值"

#### 3. 示例部分
**完全恢复v0.3.0的5个示例**：
- 示例1：传统设备参数（有parameters数组）
- 示例2：标准规范（有parameters数组）
- 示例3：工艺要求（parameters为空）
- 示例4：配置清单（parameters为空）
- 示例5：测试要求（parameters为空）

**关键差异**：v0.3.0的示例展示了"parameters可以为空"的多种情况，鼓励LLM宽泛提取

#### 4. 最后提醒
**完全恢复v0.3.0的简洁表述**：
1. "宁可多提取，不要遗漏"
2. "保持灵活性：parameters可以为空，category/clause_type可以自定义"
3. "优先完整性：先保证内容提取完整，再考虑结构化"
4. "使用证据：所有提取内容必须有对应的evidence_chunk_ids"

---

## 字段名对照表

### technical_parameters
| v0.3.0（旧） | 修改后（契约） | 说明 |
|--------------|----------------|------|
| item | name | 参数/功能名称 |
| requirement | value | 参数值/要求描述 |
| category | category | 分类（不变） |
| - | unit | 单位（新增，契约optional） |
| - | remark | 备注（新增） |
| parameters | parameters | 子参数数组（不变） |
| evidence_chunk_ids | evidence_chunk_ids | 证据（不变） |

### business_terms
| v0.3.0（旧） | 修改后（契约） | 说明 |
|--------------|----------------|------|
| term | clause_type | 条款类型 |
| requirement | content | 条款内容 |
| - | clause_title | 条款标题（新增，契约optional） |
| evidence_chunk_ids | evidence_chunk_ids | 证据（不变） |

---

## 前端兼容性

### ✅ 完全向后兼容
前端代码已修改为优先使用契约字段，fallback到旧字段：

```typescript
// 技术参数
item: String(x?.name || x?.item || ""),
requirement: String(x?.value || x?.requirement || ""),
unit: String(x?.unit || ""),
remark: String(x?.remark || ""),

// 商务条款
term: String(x?.clause_type || x?.term || ""),
requirement: String(x?.content || x?.requirement || ""),
```

**效果**：
- ✅ 新数据（name/value/clause_type/content）正常显示
- ✅ 旧数据（item/requirement/term）也能正常显示

---

## 预期效果

### 技术参数（应该 > 20条）
**提取范围（宽泛）**：
1. ✅ 设备列表（PLC、超融合等）
2. ✅ 系统组成（智能监控、广播、门禁等）
3. ✅ 配置要求（CPU、内存、操作系统等）
4. ✅ 性能指标（功率、电压、温度、防护等级等）
5. ✅ 标准规范（GB、ISO、BS等标准）
6. ✅ 工艺要求（焊接、涂装、安装等）
7. ✅ 测试要求（出厂检验、调试等）
8. ✅ 配置清单（备品备件、工具等）
9. ✅ 维护培训（手册、培训等）
10. ✅ 质量要求（合格标准、认证等）

### 商务条款（应该 > 10条）
**提取范围（宽泛）**：
1. ✅ 付款方式（预付、进度、尾款等）
2. ✅ 交货期（供货期、安装调试时限等）
3. ✅ 质保期（质保范围、维修响应等）
4. ✅ 验收标准（验收流程、验收人员等）
5. ✅ 违约责任（违约情形、赔偿标准等）
6. ✅ 发票税费（发票类型、税率等）
7. ✅ 投标资格（资质要求、业绩要求等）
8. ✅ 投标限制（代理商限制、联合体限制等）
9. ✅ 合同管理（合同返回、盖章要求等）
10. ✅ 价格构成（报价包含内容、费用组成等）

**注意**：投标保证金、截止时间、联系人等**不应该**出现在商务条款中，它们属于base字段的基本信息。

---

## 关键改动点

### 删除的内容（让LLM变保守的部分）
1. ❌ "字段使用说明"章节（太详细的必填/可选说明）
2. ❌ "什么算具体参数值"章节（过于限制性）
3. ❌ "什么情况必须填写parameters"章节（过度强调必填）
4. ❌ "核心思想：parameters必须填写具体数值"（让LLM变保守）
5. ❌ 大量的"必填"、"重要"、"必须"等强制性表述

### 保留的内容（v0.3.0的精华）
1. ✅ "核心原则：宁可多提取，不要遗漏"
2. ✅ "应该提取的内容（宽泛定义）"
3. ✅ 11种技术参数类型的详细列表
4. ✅ 13种商务条款类型的详细列表
5. ✅ "灵活处理，优先保证内容完整性"
6. ✅ "不要因为结构化困难而跳过提取"
7. ✅ 5个多样化的技术参数示例（含parameters为空的情况）
8. ✅ 5个多样化的商务条款示例

### 新增的内容（契约字段 + 向后兼容）
1. ✅ 字段名改为契约标准（name, value, clause_type, content）
2. ✅ 新增unit和remark字段（契约optional）
3. ✅ 新增clause_title字段（契约optional）
4. ✅ 前端兼容新旧字段名

---

## 测试建议

请重新测试"测试"项目的提取：

### 1. 技术参数
**验证点**：
- ✅ 数量应该 > 20条（而不是3条）
- ✅ 应该包含具体的配置、标准、工艺、测试等详细内容
- ✅ 不应该只是笼统的"系统组成列表"

**示例期望**：
```
1. 智能监控平台配置（具体配置要求）
2. 广播系统技术参数（功率、覆盖范围等）
3. 门禁系统标准（符合XX标准）
4. PLC设备配置（CPU型号、内存等）
5. 超融合一体机规格（计算能力、存储等）
6. 焊接工艺要求（焊接标准、工艺流程）
7. 出厂检验标准（检验项目、合格标准）
8. 随机备品备件清单（备件类型、数量）
9. 安装调试要求（安装方法、调试步骤）
10. 操作手册要求（手册内容、语言等）
... 等等
```

### 2. 商务条款
**验证点**：
- ✅ 数量应该 > 10条
- ✅ 应该是真正的"条款"（付款、交货、质保等）
- ✅ **不应该**包含投标保证金、截止时间、联系人等基本信息

**示例期望**：
```
1. 付款方式（预付30%、进度60%、尾款10%等）
2. 供货期（合同签订后XX天内）
3. 质保期（质保XX年，响应时间XX小时）
4. 验收标准（验收流程、验收人员等）
5. 违约责任（逾期违约金XX%/天）
6. 发票税费（增值税专用发票、税率XX%）
7. 投标资格要求（资质、业绩、人员等）
8. 代理商限制（一个制造商只能委托一个代理商）
9. 合同返回时限（收到合同后XX天内返回）
10. 报价包含内容（设备、运输、安装、培训等）
... 等等
```

---

## 总结

### 核心变化
1. **字段名**：改为契约标准（name/value/clause_type/content）✅
2. **提取策略**：恢复v0.3.0的"宽泛提取"理念 ✅
3. **前端兼容**：优先新字段，fallback旧字段 ✅

### 为什么这样修改
- **契约合规**：字段名符合`tender_contract_v1.yaml`标准
- **提取能力**：恢复v0.3.0的宽泛提取，不限制LLM
- **向后兼容**：前端同时支持新旧字段，平滑过渡

### 关键理念
**"宁可多提取，不要遗漏"** > **"严格约束，确保精确"**

在信息提取任务中，**完整性（Recall）比精确性（Precision）更重要**。用户可以忽略不相关的内容，但无法找回遗漏的信息。

---

**修改日期**：2025-12-25  
**修改状态**：✅ 已完成并部署  
**Prompt行数**：472行 → 307行（与v0.3.0一致）  
**测试状态**：⏳ 等待用户验证

