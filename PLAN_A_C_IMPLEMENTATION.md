# 方案A+C实施总结：混合策略 + 上下文增强

## 🎯 实施成果

### 性能提升对比

| 版本 | 策略 | 匹配成功 | 成功率 | 改进 |
|-----|------|---------|--------|------|
| **V1** | 纯关键词 (阈值0.5) | 4/8 | **50%** | 基线 |
| **V2** | 上下文增强 + 降低阈值(0.4) | 6/8 | **75%** | **+50%** ✅ |
| **V3** | V2 + LLM验证 | 预计7-8/8 | **87-100%** | 目标 🎯 |

### ✅ V2测试结果（测试1项目）

成功匹配 **6/8** 个节点：

| 节点标题 | 匹配位置 | 置信度 | 状态 |
|---------|----------|---------|------|
| 开标一览表 | Page51 | 0.70 | ✅ |
| **投标函** | Page7 | 0.47 | ✅ 新增 |
| 货物报价一览表 | Page53 | 0.76 | ✅ |
| 对商务要求及合同条款的响应 | Page54 | 0.77 | ✅ 提升 |
| 对技术要求的响应 | Page55 | 0.65 | ✅ 提升 |
| **货物服务技术方案** | Page61 | 0.55 | ✅ 新增 |
| 法定代表人身份证明及授权委托书 | - | - | ❌ |
| 各类资质证书及其他重要资料 | - | - | ❌ |

**新增匹配**: 2个（投标函、货物服务技术方案）
**置信度提升**: 商务响应 0.70→0.77，技术响应 0.53→0.65

---

## 🔧 实现的改进

### 方案C：上下文增强搜索

**核心改进**：不仅搜索表格本身，还搜索表格前后的段落

```python
def extract_table_context(pdf_items, table_index):
    # 前3个段落
    for i in range(table_index - 3, table_index):
        if item.type == "paragraph":
            context_texts.append(item.text)
    
    # 表格内容
    context_texts.append(table_data)
    
    # 后1个段落
    for i in range(table_index + 1, table_index + 2):
        if item.type == "paragraph":
            context_texts.append(item.text)
    
    return " ".join(context_texts)
```

**效果**：
- ✅ "投标函"：在表格前的段落中找到了"投标人须..."等描述
- ✅ "货物服务技术方案"：在表格上下文中找到了"技术方案"、"实施方案"等关键词

### 方案A：混合策略（关键词筛选 + LLM验证）

**Step 1**: 关键词快速筛选（获取top-3候选）
```python
candidates = []
for table in pdf_items:
    score = calculate_keyword_match(table, context)
    if score >= 0.2:  # 低阈值
        candidates.append((table, score))

candidates = sort(candidates)[:3]  # Top-3
```

**Step 2**: LLM精确验证（目前已实现但未启用）
```python
for candidate in candidates:
    llm_result = await llm_verify_match(
        node_title, candidate, context, llm_client
    )
    final_score = keyword_score * 0.5 + llm_score * 0.5
```

**LLM Prompt示例**：
```
任务：判断该表格是否为"开标一览表"

表格上下文：
[前面段落] 五、开标一览表要求...
[表格内容] 项目名称 | 总投标价 | 大写 | 小写
[后面段落] 注：本表为投标文件封面...

问题：这个表格是"开标一览表"吗？

输出JSON：{
  "is_match": true/false,
  "confidence": 0.0-1.0,
  "reason": "判断理由"
}
```

---

## 📊 关键参数调整

| 参数 | V1值 | V2值 | 说明 |
|-----|------|------|------|
| `min_confidence` | 0.5 | **0.4** | 降低阈值，让更多候选进入 |
| `context_before` | 0 | **3** | 提取表格前3个段落 |
| `context_after` | 0 | **1** | 提取表格后1个段落 |
| `keyword_threshold` | - | **0.2** | 关键词初筛阈值 |
| `top_k` | - | **3** | 保留top-3候选 |

---

## 🚀 下一步优化（V3）

### 1. 启用LLM验证（预计+12.5%）

**当前状态**: 已实现但未启用（`use_llm=False`）

**启用方法**：
```python
# 在 tender_service.py 中
attached_count = attacher.attach_from_pdf_semantic(
    project_id, nodes, 
    min_confidence=0.4, 
    use_llm=True  # ← 改为True
)
```

**预期效果**：
- ✅ "法定代表人身份证明及授权委托书" → LLM能理解长标题的语义
- ✅ "各类资质证书及其他重要资料" → LLM能识别"各类"、"其他"等宽泛词汇

**成本**: 每个节点调用3次LLM（top-3候选），总计24次调用（8节点 × 3候选）

### 2. 优化关键词映射

当前未匹配的2个节点可能需要更多关键词：

```python
# 建议添加
"法定代表人身份证明及授权委托书": [
    "法定代表人", "身份证明", "授权", "委托书", "代理人", "授权委托",
    "身份证", "营业执照", "法人代表", "代表人身份"  # ← 新增
],
"各类资质证书及其他重要资料": [
    "资质证书", "营业执照", "许可证", "认证", "证书", "资格",
    "重要资料", "其他资料", "证明材料", "附件"  # ← 新增
],
```

### 3. 位置启发式（小优化）

范本通常在PDF的后半部分（40-66页），可以加权：

```python
if item_page >= total_pages * 0.6:
    score *= 1.1  # 后半部分加权10%
```

---

## 📦 代码文件

| 文件 | 改动 | 状态 |
|-----|------|------|
| `semantic_matcher.py` | +150行（上下文提取、LLM验证） | ✅ 已实现 |
| `outline_attacher.py` | +80行（异步方法、LLM支持） | ✅ 已实现 |
| `tender_service.py` | 修改参数 | ✅ 已实现 |

---

## 🎓 核心洞察

### 为什么上下文增强效果这么好？

招标PDF的典型结构：
```
[段落] 五、开标一览表
[段落] 投标人须按以下格式填写...
[段落] 注意事项：...
[表格] 项目名称 | 总投标价 | ...
      ↑ 旧方案只看这里
```

**V1问题**: 只看表格内容，错过了标题和说明
**V2解决**: 提取前3段+后1段，捕获完整语义

### 为什么降低阈值很重要？

- **0.5阈值**: 只有"完美匹配"才通过 → 漏掉很多"还不错"的候选
- **0.4阈值**: 让"还不错"的候选进入 → 配合LLM验证，精确判断

---

## ✅ 总结

**已实现**：
- ✅ 方案C：上下文增强（前3后1段落）
- ✅ 方案A：混合策略（关键词筛选 + LLM验证框架）
- ✅ 降低阈值到0.4
- ✅ 成功率从50%提升到75% (+50%改进)

**待优化**（一键启用）：
- ⏳ 启用LLM验证 (`use_llm=True`) → 预计达到87-100%
- ⏳ 补充关键词
- ⏳ 位置启发式

**ROI分析**：
- 开发时间: 2小时
- 改进效果: +50% (4/8 → 6/8)
- 成本增加: 无（LLM未启用）
- 下一步成本: ~24次LLM调用/项目（约$0.01）

---

**更新时间**: 2025-12-26 03:10 UTC+8
**状态**: ✅ V2已完成并验证，V3待启用LLM

