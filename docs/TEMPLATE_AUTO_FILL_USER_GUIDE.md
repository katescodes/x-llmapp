# 格式范本自动填充功能 - 使用说明

## ✅ 功能状态
已完成并集成到目录生成流程（阶段5）

---

## 📖 功能说明

### **什么是格式范本自动填充？**
自动识别招标文件中的格式范本（如投标函格式、授权书格式、报价表格式等），并将其填充到投标文件目录的对应节点正文中，减少手动复制粘贴工作。

### **工作原理**
采用**混合策略**（规则 + LLM）：

#### **阶段1：文档分片时识别**（已集成）
- 在文档上传、分片时自动运行
- 使用轻量级规则识别潜在范本
- 标记到 `doc_segments.meta_json`

**识别规则：**
- 包含关键词："格式"、"范本"、"模板"、"样表"
- 内容特征：大量下划线（___）、空白框（□）、填写说明
- 排除：合同条款、评分标准原文

#### **阶段2：LLM精确匹配**（目录生成时）
- 目录生成后自动运行
- 只对标记为潜在范本的chunks调用LLM
- 判断范本与目录节点的匹配关系
- 置信度 ≥ 0.7 才匹配

#### **阶段3：自动填充正文**（目录生成时）
- 将匹配的范本文本填充到节点 `body_content`
- 记录 `source_chunk_ids` 以便追溯
- 用户可在前端查看/编辑

---

## 🚀 如何使用

### **方式1：新文档上传（推荐）**

```
1. 创建项目
2. 上传招标文件（PDF）
   ↓ 自动分片 + 识别范本（阶段1）
3. 提取项目信息
4. 生成目录
   ↓ 自动匹配范本（阶段2）
   ↓ 自动填充正文（阶段3）
5. 查看目录，节点正文已自动填充格式范本 ✅
```

### **方式2：现有项目补打标记**

如果项目是在功能上线前创建的，chunks未标记范本：

```bash
# 为单个项目补打标记
cd /aidata/x-llmapp1
python scripts/mark_existing_templates.py --project-id <项目ID>

# 为所有项目补打标记
python scripts/mark_existing_templates.py --all
```

然后重新生成目录即可。

---

## 🎯 前端操作

### **1. 生成目录**
```
项目 → ③ 目录 → 点击"生成目录"按钮
```

### **2. 查看填充统计**
目录生成完成后，工具栏底部显示：
```
📄 格式范本填充：自动填充了 3 个节点的格式范本 
(投标函、授权书、项目管理机构)
```

### **3. 查看填充的正文**
```
目录树 → 点击节点 → 右侧显示正文内容
```

如果节点正文是自动填充的范本，会显示完整的格式范本文本（如投标函模板）。

### **4. 编辑正文（可选）**
```
点击节点 → 右侧正文编辑器 → 修改内容 → 保存
```

---

## 📊 预期效果

### **目录显示示例**
```
商务标
  ├─ 投标函及投标函附录
  │   └─ 正文：✅ [已自动填充] 
  │       致：××× 
  │       我单位愿意参加贵单位组织的...
  │       投标人：_____________
  │       法定代表人：_________
  │       ...
  │
  ├─ 授权委托书
  │   └─ 正文：✅ [已自动填充]
  │       兹授权 _______ 为我单位合法代理人...
  │
  ├─ 项目管理机构
      └─ 正文：✅ [已自动填充]
          项目管理机构配备表
          ┌────┬────┬────┬────┐
          │姓名│职务│...  │    │
          └────┴────┴────┴────┘
```

### **前端统计示例**
```
⚡ 快速生成模式：基于已提取的项目信息构建骨架 (15个节点)
✨ 规则细化：从招标要求中提取了 12 个细分节点
🔍 LLM括号解析：从括号说明中提取了 5 个L4子节点
📄 格式范本填充：自动填充了 3 个节点的格式范本 ✨
```

---

## ⚙️ 配置选项

### **禁用范本填充**
如果不想使用此功能，可以在API调用时禁用：

```python
# 后端代码
await extract_v2_service.generate_directory_v2(
    project_id=project_id,
    enable_template_matching=False,  # 禁用范本填充
)
```

### **调整识别阈值**
编辑 `/backend/app/works/tender/template_matcher.py`：

```python
# 第44行：调整评分阈值
if template_score >= 50:  # 默认50，提高=更严格，降低=更宽松
    return {...}

# 第170行：调整匹配置信度
if confidence < 0.7:  # 默认0.7，提高=更严格
    continue
```

---

## 🔍 故障排查

### **问题1：未识别到范本**
**症状：** 前端显示"未发现可匹配的格式范本"

**排查步骤：**
1. 检查招标文件是否包含"格式"、"范本"等关键词
2. 查看数据库中是否有标记为范本的chunks：
   ```sql
   SELECT 
       id,
       LEFT(content_text, 100) as preview,
       meta_json->>'is_potential_template' as is_template,
       meta_json->>'template_score' as score
   FROM doc_segments
   WHERE doc_version_id = '<文档版本ID>'
     AND meta_json->>'is_potential_template' = 'true'
   LIMIT 10;
   ```
3. 如果为0，运行补打标记脚本：
   ```bash
   python scripts/mark_existing_templates.py --project-id <项目ID>
   ```

### **问题2：匹配不准确**
**症状：** 范本填充到了错误的节点

**原因：** LLM匹配置信度阈值过低

**解决：** 提高匹配阈值（见配置选项）

### **问题3：填充失败**
**症状：** 匹配成功但节点正文未填充

**排查步骤：**
1. 查看后端日志：
   ```bash
   docker-compose logs backend | grep -i "template"
   ```
2. 检查 `tender_directory_nodes` 表的 `body_content` 字段
3. 验证目录 `version_id` 是否正确

---

## 📈 成功指标

### **识别准确率**
- **目标：** ≥ 80% 的格式范本被正确识别
- **验证：** 人工抽查标记为范本的chunks

### **匹配准确率**
- **目标：** ≥ 90% 的匹配关系正确
- **验证：** 检查填充的节点正文是否与节点标题相关

### **用户体验**
- **目标：** 减少 50% 的手动填写工作量
- **验证：** 统计自动填充的节点数量

---

## 🔧 技术细节

### **数据库字段**

#### `doc_segments.meta_json`（阶段1标记）
```json
{
  "chunk_position": 15,
  "is_potential_template": true,
  "template_score": 75,
  "template_hints": [
    "包含范本关键词",
    "含12处填写下划线",
    "含范本起始标识"
  ]
}
```

#### `tender_directory_nodes.body_content`（阶段3填充）
```sql
-- 填充后的正文内容
body_content: "致：××× 我单位愿意参加..."

-- 来源追溯
source_chunk_ids: ["seg_xxx", "seg_yyy"]
```

### **API返回示例**

```json
{
  "data": {"nodes": [...]},
  "generation_mode": "hybrid",
  "template_matching_stats": {
    "enabled": true,
    "matched_count": 3,
    "filled_count": 3,
    "matched_nodes": [
      "投标函及投标函附录",
      "授权委托书",
      "项目管理机构"
    ]
  }
}
```

---

## 📞 常见问题

**Q1: 为什么有些范本没有被识别？**
A: 可能是文档格式问题或关键词不明显。可以手动调整识别规则或降低阈值。

**Q2: 可以手动添加范本吗？**
A: 可以。在前端目录编辑器中，直接编辑节点正文即可。

**Q3: 范本填充会覆盖已有内容吗？**
A: 不会。只有 `body_content` 为空的节点才会被填充。

**Q4: 如何撤销自动填充？**
A: 在前端编辑器中清空节点正文，或者重新生成目录时禁用范本填充功能。

---

## ✅ 总结

格式范本自动填充功能已完整集成，采用**混合策略**（规则 + LLM）：
- ✅ **阶段1**：文档分片时自动识别（已集成到 `v2_service.py`）
- ✅ **阶段2**：LLM精确匹配（目录生成时）
- ✅ **阶段3**：自动填充正文（目录生成时）
- ✅ 前端UI显示统计
- ✅ 补打标记脚本

**使用方法：**
1. 上传新文档 → 自动识别
2. 或运行补打标记脚本 → 重新生成目录
3. 查看目录，节点正文已自动填充 ✅

**功能完整可用！** 🚀

