# æƒé™ç®¡ç†ç³»ç»Ÿä½¿ç”¨æŒ‡å—

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•ä½¿ç”¨æ–°å®ç°çš„åŸºäºRBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰çš„æƒé™ç®¡ç†ç³»ç»Ÿã€‚

## ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒæ¦‚å¿µ

1. **æƒé™é¡¹ï¼ˆPermissionï¼‰**ï¼šç³»ç»Ÿä¸­çš„åŠŸèƒ½ç‚¹ï¼Œå¦‚"åˆ›å»ºå¯¹è¯"ã€"åˆ é™¤çŸ¥è¯†åº“"ç­‰
2. **è§’è‰²ï¼ˆRoleï¼‰**ï¼šæƒé™çš„é›†åˆï¼Œå¦‚"ç®¡ç†å‘˜"ã€"å‘˜å·¥"ã€"å®¢æˆ·"
3. **ç”¨æˆ·-è§’è‰²å…³è”**ï¼šç”¨æˆ·é€šè¿‡åˆ†é…è§’è‰²è·å¾—æƒé™
4. **æ•°æ®æƒé™**ï¼šæ§åˆ¶ç”¨æˆ·å¯ä»¥è®¿é—®çš„æ•°æ®èŒƒå›´ï¼ˆå…¨éƒ¨/éƒ¨é—¨/ä»…è‡ªå·±ï¼‰

### æ•°æ®åº“è¡¨ç»“æ„

```
permissions (æƒé™é¡¹è¡¨)
â”œâ”€â”€ id: æƒé™ID
â”œâ”€â”€ code: æƒé™ä»£ç ï¼ˆå”¯ä¸€ï¼‰
â”œâ”€â”€ name: æƒé™åç§°
â”œâ”€â”€ module: æ‰€å±æ¨¡å—
â””â”€â”€ parent_code: çˆ¶æƒé™ä»£ç 

roles (è§’è‰²è¡¨)
â”œâ”€â”€ id: è§’è‰²ID
â”œâ”€â”€ code: è§’è‰²ä»£ç ï¼ˆå”¯ä¸€ï¼‰
â”œâ”€â”€ name: è§’è‰²åç§°
â””â”€â”€ is_system: æ˜¯å¦ç³»ç»Ÿè§’è‰²

role_permissions (è§’è‰²-æƒé™å…³è”è¡¨)
â”œâ”€â”€ role_id: è§’è‰²ID
â””â”€â”€ permission_id: æƒé™ID

user_roles (ç”¨æˆ·-è§’è‰²å…³è”è¡¨)
â”œâ”€â”€ user_id: ç”¨æˆ·ID
â”œâ”€â”€ role_id: è§’è‰²ID
â””â”€â”€ granted_by: æˆäºˆäºº

data_permissions (æ•°æ®æƒé™è¡¨)
â”œâ”€â”€ user_id: ç”¨æˆ·ID
â”œâ”€â”€ resource_type: èµ„æºç±»å‹
â””â”€â”€ data_scope: æ•°æ®èŒƒå›´ï¼ˆall/dept/self/customï¼‰
```

## å®‰è£…éƒ¨ç½²

### 1. è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
cd backend/migrations

# æ–¹å¼1: ä½¿ç”¨psqlç›´æ¥æ‰§è¡Œ
psql -h localhost -U postgres -d x_llmapp -f 030_create_rbac_tables.sql

# æ–¹å¼2: ä½¿ç”¨æä¾›çš„è„šæœ¬
./run_rbac_migration.sh
```

### 2. éªŒè¯è¿ç§»ç»“æœ

è¿ç§»æˆåŠŸåï¼Œæ•°æ®åº“ä¼šè‡ªåŠ¨åˆ›å»ºï¼š
- 4ä¸ªç³»ç»Ÿå†…ç½®è§’è‰²ï¼ˆadmin, manager, employee, customerï¼‰
- 50+ ä¸ªæƒé™é¡¹
- é»˜è®¤çš„è§’è‰²-æƒé™åˆ†é…
- ä¸ºç°æœ‰ç”¨æˆ·åˆ†é…å¯¹åº”è§’è‰²

## ä½¿ç”¨æŒ‡å—

### å‰ç«¯ä½¿ç”¨

#### 1. è®¿é—®æƒé™ç®¡ç†ç•Œé¢

åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®æƒé™ç®¡ç†ç•Œé¢ï¼š

1. ä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•
2. ç‚¹å‡»é¡¶éƒ¨å¯¼èˆªæ çš„ "ğŸ” æƒé™ç®¡ç†" æŒ‰é’®
3. è¿›å…¥æƒé™ç®¡ç†é¡µé¢ï¼ŒåŒ…å«ä¸‰ä¸ªå­æ¨¡å—ï¼š
   - ç”¨æˆ·ç®¡ç†ï¼šç®¡ç†ç³»ç»Ÿç”¨æˆ·ã€åˆ†é…è§’è‰²
   - è§’è‰²ç®¡ç†ï¼šç®¡ç†è§’è‰²ã€åˆ†é…æƒé™
   - æƒé™é¡¹ç®¡ç†ï¼šæŸ¥çœ‹ç³»ç»Ÿæ‰€æœ‰æƒé™é¡¹

#### 2. ç”¨æˆ·ç®¡ç†

**æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨**
- æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯
- æ˜¾ç¤ºç”¨æˆ·å½“å‰è§’è‰²å’ŒçŠ¶æ€

**åˆ†é…è§’è‰²**
1. ç‚¹å‡»ç”¨æˆ·è¡Œçš„"åˆ†é…è§’è‰²"æŒ‰é’®
2. åœ¨å¼¹å‡ºå¯¹è¯æ¡†ä¸­æŸ¥çœ‹å½“å‰è§’è‰²
3. ç‚¹å‡»"æ·»åŠ è§’è‰²"ä¸­çš„è§’è‰²åç§°è¿›è¡Œåˆ†é…
4. ç‚¹å‡»å·²åˆ†é…è§’è‰²çš„"Ã—"æŒ‰é’®ç§»é™¤è§’è‰²

**å¯ç”¨/ç¦ç”¨ç”¨æˆ·**
- ç‚¹å‡»"å¯ç”¨/ç¦ç”¨"æŒ‰é’®åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
- ç¦ç”¨çš„ç”¨æˆ·æ— æ³•ç™»å½•ç³»ç»Ÿ

#### 3. è§’è‰²ç®¡ç†

**åˆ›å»ºè§’è‰²**
1. ç‚¹å‡»"+ åˆ›å»ºè§’è‰²"æŒ‰é’®
2. å¡«å†™è§’è‰²ä»£ç ã€åç§°å’Œæè¿°
3. ç‚¹å‡»"åˆ›å»º"æŒ‰é’®

**åˆ†é…æƒé™**
1. ç‚¹å‡»è§’è‰²è¡Œçš„"åˆ†é…æƒé™"æŒ‰é’®
2. åœ¨å¼¹å‡ºå¯¹è¯æ¡†ä¸­æŒ‰æ¨¡å—æŸ¥çœ‹æ‰€æœ‰æƒé™
3. ç‚¹å‡»æƒé™çš„"+"æŒ‰é’®åˆ†é…æƒé™
4. ç‚¹å‡»å·²åˆ†é…æƒé™çš„"Ã—"æŒ‰é’®ç§»é™¤æƒé™

**åˆ é™¤è§’è‰²**
- åªèƒ½åˆ é™¤éç³»ç»Ÿè§’è‰²
- ç‚¹å‡»"åˆ é™¤"æŒ‰é’®å¹¶ç¡®è®¤

#### 4. æƒé™é¡¹ç®¡ç†

- æŸ¥çœ‹æ‰€æœ‰æƒé™é¡¹
- æŒ‰æ¨¡å—ç­›é€‰æƒé™
- æŸ¥çœ‹æƒé™çš„è¯¦ç»†ä¿¡æ¯ï¼ˆä»£ç ã€åç§°ã€æè¿°ã€èµ„æºç±»å‹ï¼‰

### åç«¯APIä½¿ç”¨

#### 1. æƒé™éªŒè¯è£…é¥°å™¨

```python
from fastapi import Depends
from app.utils.permission import require_permission

@router.get("/api/some-endpoint")
async def some_endpoint(
    current_user: TokenData = Depends(require_permission("module.action"))
):
    # åªæœ‰æ‹¥æœ‰ "module.action" æƒé™çš„ç”¨æˆ·æ‰èƒ½è®¿é—®
    pass
```

#### 2. æ•°æ®æƒé™è¿‡æ»¤

```python
from app.utils.permission import DataFilter, require_resource_access

# è‡ªåŠ¨è¿‡æ»¤æŸ¥è¯¢ç»“æœ
def list_resources(current_user: TokenData = Depends(get_current_user)):
    filter_cond = DataFilter.get_owner_filter(current_user, "resource_type")
    
    if filter_cond.get("all"):
        # æŸ¥è¯¢æ‰€æœ‰æ•°æ®
        pass
    else:
        # åªæŸ¥è¯¢ç”¨æˆ·è‡ªå·±çš„æ•°æ®
        owner_id = filter_cond.get("owner_id")
        pass

# æ£€æŸ¥å•ä¸ªèµ„æºè®¿é—®æƒé™
def get_resource(resource_id: str, current_user: TokenData = Depends(get_current_user)):
    resource = get_resource_by_id(resource_id)
    require_resource_access(current_user, resource.owner_id, "resource_type")
    return resource
```

#### 3. æƒé™æ£€æŸ¥è¾…åŠ©å‡½æ•°

```python
from app.services import permission_service

# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æƒé™
has_perm = permission_service.has_permission(user_id, "permission.code")

# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰ä»»ä¸€æƒé™
perms = permission_service.check_user_permissions(user_id, ["perm1", "perm2"])

# è·å–ç”¨æˆ·æ‰€æœ‰æƒé™
user_perms = permission_service.get_user_permissions(user_id)
```

## æƒé™åˆ—è¡¨

### å¯¹è¯æ¨¡å—ï¼ˆchatï¼‰
- `chat.create` - åˆ›å»ºå¯¹è¯
- `chat.view` - æŸ¥çœ‹å¯¹è¯
- `chat.delete` - åˆ é™¤å¯¹è¯
- `chat.export` - å¯¼å‡ºå¯¹è¯

### çŸ¥è¯†åº“æ¨¡å—ï¼ˆkbï¼‰
- `kb.create` - åˆ›å»ºçŸ¥è¯†åº“
- `kb.view` - æŸ¥çœ‹çŸ¥è¯†åº“
- `kb.edit` - ç¼–è¾‘çŸ¥è¯†åº“
- `kb.delete` - åˆ é™¤çŸ¥è¯†åº“
- `kb.upload` - ä¸Šä¼ æ–‡æ¡£
- `kb.share` - å…±äº«çŸ¥è¯†åº“

### æ‹›æŠ•æ ‡æ¨¡å—ï¼ˆtenderï¼‰
- `tender.create` - åˆ›å»ºé¡¹ç›®
- `tender.view` - æŸ¥çœ‹é¡¹ç›®
- `tender.edit` - ç¼–è¾‘é¡¹ç›®
- `tender.delete` - åˆ é™¤é¡¹ç›®
- `tender.export` - å¯¼å‡ºæ–‡æ¡£
- `tender.template` - æ¨¡æ¿ç®¡ç†

### ç”³æŠ¥ä¹¦æ¨¡å—ï¼ˆdeclareï¼‰
- `declare.create` - åˆ›å»ºç”³æŠ¥ä¹¦
- `declare.view` - æŸ¥çœ‹ç”³æŠ¥ä¹¦
- `declare.edit` - ç¼–è¾‘ç”³æŠ¥ä¹¦
- `declare.delete` - åˆ é™¤ç”³æŠ¥ä¹¦
- `declare.export` - å¯¼å‡ºç”³æŠ¥ä¹¦

### å½•éŸ³æ¨¡å—ï¼ˆrecordingï¼‰
- `recording.create` - åˆ›å»ºå½•éŸ³
- `recording.view` - æŸ¥çœ‹å½•éŸ³
- `recording.delete` - åˆ é™¤å½•éŸ³
- `recording.import` - å¯¼å…¥çŸ¥è¯†åº“

### æƒé™ç®¡ç†æ¨¡å—ï¼ˆpermissionï¼‰
- `permission.user.view` - æŸ¥çœ‹ç”¨æˆ·
- `permission.user.create` - åˆ›å»ºç”¨æˆ·
- `permission.user.edit` - ç¼–è¾‘ç”¨æˆ·
- `permission.user.delete` - åˆ é™¤ç”¨æˆ·
- `permission.user.assign_role` - åˆ†é…è§’è‰²
- `permission.role.view` - æŸ¥çœ‹è§’è‰²
- `permission.role.create` - åˆ›å»ºè§’è‰²
- `permission.role.edit` - ç¼–è¾‘è§’è‰²
- `permission.role.delete` - åˆ é™¤è§’è‰²
- `permission.role.assign_perm` - åˆ†é…æƒé™
- `permission.item.view` - æŸ¥çœ‹æƒé™é¡¹
- `permission.item.edit` - ç¼–è¾‘æƒé™é¡¹

## é»˜è®¤è§’è‰²åŠæƒé™

### ç®¡ç†å‘˜ï¼ˆadminï¼‰
- æ‹¥æœ‰æ‰€æœ‰æƒé™
- å¯ä»¥ç®¡ç†ç”¨æˆ·ã€è§’è‰²å’Œæƒé™
- å¯ä»¥è®¿é—®æ‰€æœ‰æ•°æ®

### éƒ¨é—¨ç»ç†ï¼ˆmanagerï¼‰
- æ‹¥æœ‰é™¤æƒé™ç®¡ç†å¤–çš„æ‰€æœ‰åŠŸèƒ½æƒé™
- å¯ä»¥ç®¡ç†æœ¬éƒ¨é—¨æ•°æ®

### æ™®é€šå‘˜å·¥ï¼ˆemployeeï¼‰
- å¯ä»¥ä½¿ç”¨å¯¹è¯ã€çŸ¥è¯†åº“ã€æ‹›æŠ•æ ‡ã€ç”³æŠ¥ä¹¦ã€å½•éŸ³ç­‰åŸºæœ¬åŠŸèƒ½
- åªèƒ½è®¿é—®è‡ªå·±åˆ›å»ºçš„æ•°æ®

### å®¢æˆ·ï¼ˆcustomerï¼‰
- åªèƒ½ä½¿ç”¨å¯¹è¯ã€æŸ¥çœ‹çŸ¥è¯†åº“ã€å½•éŸ³ç­‰åŸºç¡€åŠŸèƒ½
- åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®

## æ•°æ®æƒé™è¯´æ˜

### æ•°æ®èŒƒå›´ç±»å‹

1. **allï¼ˆå…¨éƒ¨æ•°æ®ï¼‰**
   - å¯ä»¥è®¿é—®ç³»ç»Ÿä¸­çš„æ‰€æœ‰æ•°æ®
   - é€šå¸¸åˆ†é…ç»™ç®¡ç†å‘˜

2. **deptï¼ˆæœ¬éƒ¨é—¨æ•°æ®ï¼‰**
   - å¯ä»¥è®¿é—®æœ¬éƒ¨é—¨æˆå‘˜åˆ›å»ºçš„æ•°æ®
   - é€šå¸¸åˆ†é…ç»™éƒ¨é—¨ç»ç†
   - éœ€è¦é…ç½®éƒ¨é—¨ä¿¡æ¯

3. **selfï¼ˆä»…è‡ªå·±çš„æ•°æ®ï¼‰**
   - åªèƒ½è®¿é—®è‡ªå·±åˆ›å»ºçš„æ•°æ®
   - é»˜è®¤è®¾ç½®ï¼Œé€‚ç”¨äºå¤§å¤šæ•°ç”¨æˆ·

4. **customï¼ˆè‡ªå®šä¹‰èŒƒå›´ï¼‰**
   - å¯ä»¥æŒ‡å®šç‰¹å®šç”¨æˆ·IDåˆ—è¡¨
   - çµæ´»çš„æƒé™æ§åˆ¶

### æ•°æ®æƒé™åº”ç”¨

ç³»ç»Ÿä¼šè‡ªåŠ¨æ ¹æ®ç”¨æˆ·çš„æ•°æ®æƒé™è¿‡æ»¤ä»¥ä¸‹èµ„æºï¼š
- å¯¹è¯ä¼šè¯ï¼ˆchat_sessionï¼‰
- çŸ¥è¯†åº“ï¼ˆknowledge_baseï¼‰
- æ‹›æŠ•æ ‡é¡¹ç›®ï¼ˆtender_projectï¼‰
- ç”³æŠ¥ä¹¦é¡¹ç›®ï¼ˆdeclare_projectï¼‰
- å½•éŸ³è®°å½•ï¼ˆrecordingï¼‰

## æ•…éšœæ’æŸ¥

### 1. ç”¨æˆ·æ— æ³•è®¿é—®æŸåŠŸèƒ½

**æ£€æŸ¥æ­¥éª¤ï¼š**
1. ç¡®è®¤ç”¨æˆ·å·²åˆ†é…ç›¸åº”è§’è‰²
2. ç¡®è®¤è§’è‰²æ‹¥æœ‰è¯¥åŠŸèƒ½æƒé™
3. æ£€æŸ¥ç”¨æˆ·è´¦å·æ˜¯å¦å¯ç”¨
4. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰æƒé™é”™è¯¯

### 2. ç”¨æˆ·çœ‹ä¸åˆ°æ•°æ®

**æ£€æŸ¥æ­¥éª¤ï¼š**
1. ç¡®è®¤æ•°æ®çš„owner_idæ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥ç”¨æˆ·çš„æ•°æ®æƒé™èŒƒå›´ï¼ˆdata_scopeï¼‰
3. å¯¹äºå…±äº«æ•°æ®ï¼Œæ£€æŸ¥å…±äº«è®¾ç½®
4. ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ•°æ®

### 3. è§’è‰²åˆ†é…å¤±è´¥

**å¯èƒ½åŸå› ï¼š**
- è§’è‰²ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨
- ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨
- æ²¡æœ‰åˆ†é…è§’è‰²çš„æƒé™

## APIç«¯ç‚¹å‚è€ƒ

### æƒé™é¡¹ç®¡ç†
- `GET /api/permissions/items` - è·å–æƒé™åˆ—è¡¨
- `GET /api/permissions/items/tree` - è·å–æƒé™æ ‘
- `GET /api/permissions/items/{id}` - è·å–æƒé™è¯¦æƒ…
- `POST /api/permissions/items` - åˆ›å»ºæƒé™
- `PUT /api/permissions/items/{id}` - æ›´æ–°æƒé™

### è§’è‰²ç®¡ç†
- `GET /api/permissions/roles` - è·å–è§’è‰²åˆ—è¡¨
- `GET /api/permissions/roles/{id}` - è·å–è§’è‰²è¯¦æƒ…
- `POST /api/permissions/roles` - åˆ›å»ºè§’è‰²
- `PUT /api/permissions/roles/{id}` - æ›´æ–°è§’è‰²
- `DELETE /api/permissions/roles/{id}` - åˆ é™¤è§’è‰²
- `POST /api/permissions/roles/assign-permissions` - åˆ†é…æƒé™
- `POST /api/permissions/roles/remove-permissions` - ç§»é™¤æƒé™

### ç”¨æˆ·è§’è‰²ç®¡ç†
- `GET /api/permissions/users/{id}/roles` - è·å–ç”¨æˆ·è§’è‰²
- `POST /api/permissions/users/assign-roles` - åˆ†é…è§’è‰²
- `POST /api/permissions/users/remove-roles` - ç§»é™¤è§’è‰²
- `GET /api/permissions/users/{id}/all-permissions` - è·å–ç”¨æˆ·æ‰€æœ‰æƒé™
- `GET /api/permissions/me/permissions` - è·å–å½“å‰ç”¨æˆ·æƒé™

### æ•°æ®æƒé™ç®¡ç†
- `GET /api/permissions/users/{id}/data-permissions/{type}` - è·å–æ•°æ®æƒé™
- `POST /api/permissions/users/{id}/data-permissions` - è®¾ç½®æ•°æ®æƒé™

### ç»Ÿè®¡ä¿¡æ¯
- `GET /api/permissions/stats` - è·å–æƒé™ç»Ÿè®¡

## æœ€ä½³å®è·µ

1. **æœ€å°æƒé™åŸåˆ™**ï¼šåªåˆ†é…å¿…è¦çš„æƒé™
2. **ä½¿ç”¨è§’è‰²ç®¡ç†æƒé™**ï¼šé€šè¿‡è§’è‰²è€Œéç›´æ¥ç»™ç”¨æˆ·åˆ†é…æƒé™
3. **å®šæœŸå®¡æŸ¥æƒé™**ï¼šå®šæœŸæ£€æŸ¥å’Œæ¸…ç†ä¸éœ€è¦çš„æƒé™
4. **ä¿æŠ¤æ•æ„Ÿæ“ä½œ**ï¼šå¯¹åˆ é™¤ã€å¯¼å‡ºç­‰æ“ä½œè¿›è¡Œé¢å¤–ç¡®è®¤
5. **è®°å½•æƒé™å˜æ›´**ï¼šç³»ç»Ÿè‡ªåŠ¨è®°å½•æƒé™åˆ†é…å†å²

## æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜æˆ–æŸ¥çœ‹ç›¸å…³æ–‡æ¡£ï¼š
- åç«¯APIæ–‡æ¡£ï¼š`/docs`ï¼ˆFastAPIè‡ªåŠ¨ç”Ÿæˆï¼‰
- æ•°æ®åº“è¡¨ç»“æ„ï¼š`backend/migrations/030_create_rbac_tables.sql`
- å‰ç«¯ç»„ä»¶ï¼š`frontend/src/components/permission/`

