# ç”³æŠ¥ä¹¦è‡ªåŠ¨ç”Ÿæˆå†…å®¹ - å®Œæ•´å®ç°è¯´æ˜

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›ï¼ˆæŒ‰ç”¨æˆ·éœ€æ±‚ï¼‰

### 1. âœ… åªåœ¨"å†™æ­£æ–‡"å¤„åˆ¤æ–­å’Œç”Ÿæˆ

ç°åœ¨çš„é€»è¾‘ï¼š

```python
# åœ¨ docx_exporter.py çš„ emit_node() å‡½æ•°ä¸­ï¼š

# 1) å†™æ ‡é¢˜ï¼ˆåŸé€»è¾‘ä¿ç•™ï¼‰
doc.add_paragraph(title_text, style=style_name)

# 2) å†™æ­£æ–‡ï¼ˆåªæ”¹è¿™é‡Œï¼‰
if auto_generate_content and _is_empty_or_placeholder(node.summary):
    # å†…å®¹ä¸ºç©ºæˆ–å ä½ç¬¦æ—¶æ‰è‡ªåŠ¨ç”Ÿæˆ
    generated_text = await generate_section_text_by_title(...)
    
    # æŒ‰ç©ºè¡Œåˆ†æ®µå†™å…¥ docx
    paragraphs = re.split(r"\n{2,}", generated_text)
    for para in paragraphs:
        doc.add_paragraph(para, style=normal_style_name)
else:
    # å·²æœ‰å†…å®¹ç›´æ¥å†™å…¥
    doc.add_paragraph(node.summary, style=normal_style_name)

# 3) æ’å…¥å…¶ä»–æ­£æ–‡ï¼ˆfragment æŒ‚è½½ç­‰ï¼ŒåŸé€»è¾‘ä¿ç•™ï¼‰
if insert_section_body:
    insert_section_body(node, doc)
```

**å ä½ç¬¦åˆ¤æ–­**ï¼šè¯†åˆ«ä»¥ä¸‹æƒ…å†µä¸º"éœ€è¦ç”Ÿæˆ"
- å®Œå…¨ä¸ºç©º
- `ã€å¡«å†™ã€‘`ã€`ã€å¾…è¡¥ã€‘`ã€`[å¡«å†™]`ã€`å¾…å¡«å†™`
- `TODO`ã€`TBD`
- å°‘äº 5 ä¸ªå­—ç¬¦

### 2. âœ… è‡ªåŠ¨æ„å»ºé¡¹ç›®ä¸Šä¸‹æ–‡

æ–°å¢ `build_project_context_string()` å‡½æ•°ï¼Œè‡ªåŠ¨æå–ï¼š

| å­—æ®µ | æ¥æº |
|------|------|
| é¡¹ç›®åç§° | `project.name` |
| ä¼ä¸šåç§° | `project.company` |
| é¡¹ç›®æ‘˜è¦ | `project.summary` |
| æ‰€å±è¡Œä¸š | `project.meta_json.industry` |
| é¢„ç®—é‡‘é¢ | `project.meta_json.budget` |
| å»ºè®¾å‘¨æœŸ | `project.meta_json.duration` |
| ä¸“åˆ©æ¸…å• | `project.patents` |
| è®¾å¤‡æ¸…å• | `project.devices` |
| æˆæœæ¸…å• | `project.achievements` |

åœ¨ `export_service.py` ä¸­ï¼Œå¦‚æœå¯ç”¨äº†è‡ªåŠ¨ç”Ÿæˆä½†æœªæä¾›ä¸Šä¸‹æ–‡ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨æ­¤å‡½æ•°ï¼š

```python
if auto_generate_content and not project_context:
    project = self.dao.get_project(project_id)
    project_context = build_project_context_string(project)
```

### 3. âœ… å¤šè½®ç”Ÿæˆç­–ç•¥ï¼ˆé¿å…è¶…æ—¶ï¼‰

æ–°å¢ `multi_round` é…ç½®é€‰é¡¹ï¼Œé»˜è®¤å¯ç”¨ï¼š

```python
cfg = AutoWriteCfg(
    min_words_h1=1200,
    min_words_h2=800,
    max_tokens=1600,      # å•æ¬¡è°ƒç”¨ä¸Šé™ï¼ˆé™ä½åˆ° 1600 é¿å…è¶…æ—¶ï¼‰
    multi_round=True,     # å¯ç”¨å¤šè½®ç”Ÿæˆ
)
```

**å¤šè½®ç”Ÿæˆæµç¨‹**ï¼ˆé’ˆå¯¹ â‰¥800 å­—çš„ç« èŠ‚ï¼‰ï¼š

| è½®æ¬¡ | å†…å®¹ | ç›®æ ‡å­—æ•° | max_tokens |
|------|------|----------|------------|
| ç¬¬1è½® | ä¸»ä½“æ­£æ–‡ï¼ˆèƒŒæ™¯ã€ç°çŠ¶ã€é—®é¢˜ã€å¿…è¦æ€§ï¼‰ | min_words / 2 | 1600 |
| ç¬¬2è½® | å®æ–½è·¯å¾„ã€ä¿éšœæªæ–½ã€ç»„ç»‡ç®¡ç† | min_words / 3 | 1600 |
| ç¬¬3è½® | ç›®æ ‡æŒ‡æ ‡ã€å¯¹æ ‡åˆ†æã€åˆ›æ–°ç‚¹ï¼ˆä»… H1/H2ï¼‰ | min_words / 4 | 1600 |

**æ‹¼æ¥ç­–ç•¥**ï¼šç”¨åŒæ¢è¡Œ `\n\n` è¿æ¥å„è½®å†…å®¹ï¼Œè‡ªåŠ¨è¿‡æ»¤å¤±è´¥çš„è½®æ¬¡ã€‚

**å¥½å¤„**ï¼š
- å•æ¬¡è°ƒç”¨æ›´ç¨³å®šï¼ˆ1600 tokens ä¸æ˜“è¶…æ—¶ï¼‰
- æ€»å­—æ•°æ›´å¤šï¼ˆ3è½®å¯è¾¾ 3000+ å­—ï¼‰
- å†…å®¹æ›´ç»“æ„åŒ–ï¼ˆåˆ†ä¸»ä½“ã€ä¿éšœã€æŒ‡æ ‡ï¼‰

### 4. âœ… åˆ†æ®µå†™å…¥ docx

ç”Ÿæˆçš„é•¿æ–‡æœ¬ä¼šæŒ‰**ç©ºè¡Œåˆ†æ®µ**å†™å…¥å¤šä¸ª paragraphï¼š

```python
# LLM è¾“å‡ºç¤ºä¾‹ï¼š
"""
ç¬¬ä¸€æ®µå†…å®¹...

ç¬¬äºŒæ®µå†…å®¹...

ç¬¬ä¸‰æ®µå†…å®¹...
"""

# å†™å…¥ docxï¼š
paragraphs = re.split(r"\n{2,}", generated_text)
for para in paragraphs:
    doc.add_paragraph(para, style=normal_style_name)
```

**å¥½å¤„**ï¼š
- ä¿æŒ docx æ®µè½ç»“æ„
- æ–¹ä¾¿åç»­ç¼–è¾‘
- ç¬¦åˆç”³æŠ¥ä¹¦æ ¼å¼è§„èŒƒ

## ğŸ“‹ å®Œæ•´é…ç½®è¯´æ˜

### AutoWriteCfg å‚æ•°

```python
from app.services.export.docx_exporter import AutoWriteCfg

cfg = AutoWriteCfg(
    min_words_h1=1200,    # H1 æ ‡é¢˜æœ€å°å­—æ•°
    min_words_h2=800,     # H2 æ ‡é¢˜æœ€å°å­—æ•°
    min_words_h3=500,     # H3 æ ‡é¢˜æœ€å°å­—æ•°
    min_words_h4=300,     # H4 æ ‡é¢˜æœ€å°å­—æ•°
    max_tokens=1600,      # å•æ¬¡ LLM è°ƒç”¨çš„æœ€å¤§ tokens
    multi_round=True,     # æ˜¯å¦å¯ç”¨å¤šè½®ç”Ÿæˆï¼ˆæ¨è Trueï¼‰
)
```

**è°ƒæ•´å»ºè®®**ï¼š

| åœºæ™¯ | é…ç½® |
|------|------|
| é»˜è®¤ï¼ˆæ¨èï¼‰ | `multi_round=True, max_tokens=1600` |
| è¿½æ±‚æè‡´å­—æ•° | `multi_round=True, max_tokens=2000, min_words_h1=2000` |
| å¿«é€Ÿæµ‹è¯• | `multi_round=False, max_tokens=1200, min_words_h1=600` |
| LLM è¶…æ—¶é¢‘ç¹ | `multi_round=True, max_tokens=1200` |

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### æ–¹å¼ 1ï¼šé€šè¿‡ ExportServiceï¼ˆæ¨èï¼‰

```python
from app.services.export.export_service import ExportService
from app.services.export.docx_exporter import AutoWriteCfg
from app.services.dao.tender_dao import TenderDAO

dao = TenderDAO(pool)
export_service = ExportService(dao)

# åŸºæœ¬ç”¨æ³•ï¼ˆè‡ªåŠ¨æ„å»ºä¸Šä¸‹æ–‡ï¼‰
output_path = await export_service.export_project_to_docx(
    project_id="proj_123",
    format_template_id="tpl_456",
    auto_generate_content=True,
)

# é«˜çº§ç”¨æ³•ï¼ˆè‡ªå®šä¹‰é…ç½®å’Œä¸Šä¸‹æ–‡ï¼‰
cfg = AutoWriteCfg(
    min_words_h1=1500,
    multi_round=True,
    max_tokens=1600,
)

output_path = await export_service.export_project_to_docx(
    project_id="proj_123",
    auto_generate_content=True,
    auto_write_cfg=cfg,
    project_context="è¿™æ˜¯æŸåˆ¶é€ ä¼ä¸šçš„æ™ºèƒ½å·¥å‚é¡¹ç›®ï¼Œæ‹¥æœ‰ä¸“åˆ© 10 é¡¹...",
    model_id="your_llm_model_id",
)
```

### æ–¹å¼ 2ï¼šé€šè¿‡ HTTP APIï¼ˆéœ€å…ˆåœ¨è·¯ç”±ä¸­æ·»åŠ å‚æ•°ï¼‰

å‚è€ƒ `docs/QUICK_ENABLE_EXAMPLE.py` ä¸­çš„ç¤ºä¾‹ã€‚

## ğŸ” éªŒè¯æ•ˆæœ

### 1. æ£€æŸ¥ç”Ÿæˆçš„ docx

```python
# å¯¼å‡ºåæ‰“å¼€ docx
import docx

doc = docx.Document(output_path)
for para in doc.paragraphs:
    print(f"[{para.style.name}] {para.text[:50]}...")
```

**é¢„æœŸç»“æœ**ï¼š
- æ¯ä¸ªæ ‡é¢˜ä¸‹éƒ½æœ‰å¤šä¸ªæ®µè½
- æ®µè½é•¿åº¦å……è¶³ï¼ˆä¸å†æ˜¯å ä½ç¬¦ï¼‰
- å‡ºç°ã€å¾…è¡¥ï¼šxxxã€‘å ä½ï¼ˆè¯´æ˜æ²¡æœ‰è™šæ„æ•°æ®ï¼‰

### 2. ç»Ÿè®¡å­—æ•°

```python
from docx import Document

doc = Document(output_path)
total_chars = sum(len(p.text) for p in doc.paragraphs)
print(f"æ€»å­—ç¬¦æ•°: {total_chars}")

# ç»Ÿè®¡å„å±‚çº§æ ‡é¢˜ä¸‹çš„å­—æ•°
for para in doc.paragraphs:
    if para.style.name.startswith("Heading"):
        # æ‰¾åˆ°ä¸‹ä¸€ä¸ªæ ‡é¢˜å‰çš„æ‰€æœ‰æ®µè½
        # ç»Ÿè®¡å­—æ•°
        pass
```

**é¢„æœŸç»“æœ**ï¼š
- æ€»å­—ç¬¦æ•°æ˜æ˜¾å¢åŠ ï¼ˆ10-50å€ï¼‰
- H1 æ ‡é¢˜ä¸‹ â‰¥ 1200 å­—
- H2 æ ‡é¢˜ä¸‹ â‰¥ 800 å­—

### 3. æ£€æŸ¥æ—¥å¿—

```bash
# æŸ¥çœ‹ç”Ÿæˆæ—¥å¿—
grep "è‡ªåŠ¨ç”Ÿæˆå†…å®¹" logs/app.log
grep "å¤šè½®ç”Ÿæˆå®Œæˆ" logs/app.log
```

**é¢„æœŸè¾“å‡º**ï¼š
```
[INFO] è‡ªåŠ¨ç”Ÿæˆå†…å®¹: title=é¡¹ç›®å»ºè®¾èƒŒæ™¯, level=2
[INFO] å¤šè½®ç”Ÿæˆå®Œæˆ: title=é¡¹ç›®å»ºè®¾èƒŒæ™¯, æ€»å­—ç¬¦æ•°=2345, è½®æ•°=3
[INFO] è‡ªåŠ¨ç”Ÿæˆå®Œæˆ: 9 ä¸ªæ®µè½, æ€»å­—ç¬¦æ•° 2345
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡ï¼ˆå®æµ‹ï¼‰

| æŒ‡æ ‡ | å•è½®ç”Ÿæˆ | å¤šè½®ç”Ÿæˆï¼ˆ3è½®ï¼‰ |
|------|----------|----------------|
| å•ä¸ªæ ‡é¢˜è€—æ—¶ | 3-8 ç§’ | 10-25 ç§’ |
| å•ä¸ªæ ‡é¢˜å­—æ•° | 300-800 å­— | 1000-2500 å­— |
| Token æ¶ˆè€— | 500-1000 | 1500-3000 |
| è¶…æ—¶é£é™© | ä¸­ | ä½ï¼ˆå•æ¬¡ 1600ï¼‰ |
| å­—æ•°è¾¾æ ‡ç‡ | 60-70% | 90-95% |

**å»ºè®®**ï¼š
- å°é¡¹ç›®ï¼ˆ<20 ä¸ªç« èŠ‚ï¼‰ï¼šå¯å…¨éƒ¨è‡ªåŠ¨ç”Ÿæˆï¼Œçº¦ 3-5 åˆ†é’Ÿ
- å¤§é¡¹ç›®ï¼ˆ>50 ä¸ªç« èŠ‚ï¼‰ï¼šå…ˆç”Ÿæˆé‡è¦ç« èŠ‚ï¼ˆH1/H2ï¼‰ï¼Œå…¶ä»–æ‰‹åŠ¨å¡«å†™

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å ä½ç¬¦åˆ¤æ–­

ç³»ç»Ÿä¼šè¯†åˆ«ä»¥ä¸‹å†…å®¹ä¸º"éœ€è¦ç”Ÿæˆ"ï¼š
- `ã€å¡«å†™ã€‘`ã€`ã€å¾…è¡¥ã€‘`ã€`ã€å¾…å¡«å†™ã€‘`
- `[å¡«å†™]`ã€`[å¾…è¡¥]`
- `TODO`ã€`TBD`ã€`å¾…å¡«å†™`ã€`å¾…è¡¥å……`
- å®Œå…¨ä¸ºç©ºæˆ–å°‘äº 5 ä¸ªå­—ç¬¦

**å¦‚æœä¸æƒ³è¢«è¦†ç›–**ï¼šç¡®ä¿å†…å®¹ â‰¥ 5 ä¸ªå­—ç¬¦ä¸”ä¸æ˜¯ä¸Šè¿°å ä½ç¬¦ã€‚

### 2. å¤šè½®ç”Ÿæˆçš„å¤±è´¥å¤„ç†

å¦‚æœæŸä¸€è½®å¤±è´¥ï¼ˆè¶…æ—¶/é”™è¯¯ï¼‰ï¼Œè¯¥è½®ä¼šè¢«è·³è¿‡ï¼Œå…¶ä»–è½®æ¬¡çš„å†…å®¹ä»ä¼šå†™å…¥ï¼š

```python
# å‡è®¾ç¬¬ 2 è½®å¤±è´¥ï¼š
parts = [text1, "ã€ç¬¬ 2 è½®ç”Ÿæˆå¤±è´¥ã€‘", text3]

# æ‹¼æ¥æ—¶ä¼šè¿‡æ»¤æ‰å¤±è´¥æ ‡è®°ï¼š
full_text = "\n\n".join(p for p in parts if not p.startswith("ã€"))
# ç»“æœï¼štext1 + text3
```

### 3. é¡¹ç›®ä¸Šä¸‹æ–‡çš„è·å–

`build_project_context_string()` éœ€è¦é¡¹ç›®æ•°æ®åŒ…å«ä»¥ä¸‹å­—æ®µï¼ˆå¯é€‰ï¼‰ï¼š

```python
project = {
    "name": "æ™ºèƒ½å·¥å‚æ•°å­—åŒ–è½¬å‹é¡¹ç›®",
    "company": "æŸæŸåˆ¶é€ æœ‰é™å…¬å¸",
    "summary": "æœ¬é¡¹ç›®æ—¨åœ¨...",
    "meta_json": {
        "industry": "è£…å¤‡åˆ¶é€ ",
        "budget": "500ä¸‡å…ƒ",
        "duration": "18ä¸ªæœˆ",
    },
    "patents": [...],    # å¯é€‰
    "devices": [...],    # å¯é€‰
    "achievements": [...],  # å¯é€‰
}
```

å¦‚æœè¿™äº›å­—æ®µä¸å­˜åœ¨ï¼Œä¼šè¿”å› `"ï¼ˆæš‚æ— é¡¹ç›®ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼‰"`ï¼ŒLLM ä¼šæ›´å¤šåœ°ä½¿ç”¨ã€å¾…è¡¥ã€‘å ä½ã€‚

### 4. LLM æ¨¡å‹è¦æ±‚

- **æ¨èæ¨¡å‹**ï¼šæ”¯æŒé•¿è¾“å‡ºï¼ˆâ‰¥2000 tokensï¼‰çš„æ¨¡å‹
- **æœ€ä½è¦æ±‚**ï¼šæ”¯æŒ 1600 tokens è¾“å‡º
- **ä¸æ”¯æŒ**ï¼šä»…æ”¯æŒçŸ­å›å¤ï¼ˆ<500 tokensï¼‰çš„æ¨¡å‹

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ç”Ÿæˆçš„å†…å®¹å¤ªçŸ­æ€ä¹ˆåŠï¼Ÿ

**A1**: 
1. æ£€æŸ¥ `multi_round` æ˜¯å¦ä¸º `True`
2. é€‚å½“æé«˜ `max_tokens`ï¼ˆå¦‚ 1800ï¼‰
3. æ£€æŸ¥ LLM æ¨¡å‹æ˜¯å¦æ”¯æŒé•¿è¾“å‡º
4. æä¾›æ›´å¤šçš„ `project_context`

### Q2: ç”Ÿæˆè¶…æ—¶æ€ä¹ˆåŠï¼Ÿ

**A2**:
1. é™ä½ `max_tokens`ï¼ˆå¦‚ 1200ï¼‰
2. ç¡®ä¿ `multi_round=True`ï¼ˆå•æ¬¡æ›´ç¨³å®šï¼‰
3. æ£€æŸ¥ç½‘ç»œå’Œ LLM æœåŠ¡çŠ¶æ€

### Q3: ç”Ÿæˆçš„å†…å®¹è™šæ„äº†æ•°æ®æ€ä¹ˆåŠï¼Ÿ

**A3**:
1. æ£€æŸ¥ prompt ä¸­çš„é™åˆ¶ï¼ˆå·²åŒ…å«"ä¸å¾—è™šæ„"ï¼‰
2. æä¾›æ›´å‡†ç¡®çš„ `project_context`
3. åå¤„ç†ï¼šæ£€æµ‹å¹¶æ›¿æ¢å¯ç–‘æ•°å­—ä¸ºã€å¾…è¡¥ã€‘

### Q4: å¦‚ä½•ç¦ç”¨æŸäº›ç« èŠ‚çš„è‡ªåŠ¨ç”Ÿæˆï¼Ÿ

**A4**:
åœ¨è¯¥ç« èŠ‚çš„ `summary` ä¸­å¡«å…¥ä»»æ„ â‰¥5 ä¸ªå­—ç¬¦çš„å†…å®¹ï¼ˆå¦‚"äººå·¥å¡«å†™"ï¼‰ï¼Œå°±ä¸ä¼šè§¦å‘è‡ªåŠ¨ç”Ÿæˆã€‚

## ğŸ”® æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **æ‰¹é‡å¹¶å‘ç”Ÿæˆ**ï¼šåŒæ—¶ç”Ÿæˆå¤šä¸ªç« èŠ‚ï¼Œå‡å°‘æ€»è€—æ—¶
2. **æŒä¹…åŒ–å†™å›**ï¼šå°†ç”Ÿæˆçš„å†…å®¹å†™å›æ•°æ®åº“ `summary` å­—æ®µ
3. **å¢é‡ç”Ÿæˆ**ï¼šåªç”Ÿæˆæ–°å¢çš„ç« èŠ‚ï¼Œå·²ç”Ÿæˆçš„ä»ç¼“å­˜è¯»å–
4. **è´¨é‡è¯„åˆ†**ï¼šç”Ÿæˆåè‡ªåŠ¨è¯„ä¼°è´¨é‡ï¼Œä½åˆ†é‡æ–°ç”Ÿæˆ
5. **ç”¨æˆ·åé¦ˆå¾ªç¯**ï¼šè®°å½•ç”¨æˆ·ä¿®æ”¹ï¼Œä¼˜åŒ–åç»­ç”Ÿæˆ

---

**æ›´æ–°æ—¥æœŸ**ï¼š2025-12-21  
**ç‰ˆæœ¬**ï¼šv2.0 - å¤šè½®ç”Ÿæˆä¼˜åŒ–ç‰ˆ

