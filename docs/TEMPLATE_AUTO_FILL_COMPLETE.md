# æ ¼å¼èŒƒæœ¬è‡ªåŠ¨å¡«å…… - å®Œæ•´å®ç°è¯´æ˜

## âœ… å·²å®Œæˆæ‰€æœ‰é˜¶æ®µ

### é˜¶æ®µ1ï¼šæ–‡æ¡£åˆ†ç‰‡æ—¶è¯†åˆ«ï¼ˆå·²é›†æˆï¼‰âœ…
**æ–‡ä»¶ï¼š** `/backend/app/platform/ingest/v2_service.py`

**ä¿®æ”¹å†…å®¹ï¼š**
- åœ¨ `_write_segments()` æ–¹æ³•ä¸­é›†æˆ `identify_potential_template()`
- æ¯ä¸ªchunkåœ¨å†™å…¥æ•°æ®åº“å‰è‡ªåŠ¨è¯†åˆ«æ˜¯å¦ä¸ºæ ¼å¼èŒƒæœ¬
- è¯†åˆ«ç»“æœä¿å­˜åˆ° `doc_segments.meta_json` å­—æ®µ

**è¯†åˆ«é€»è¾‘ï¼š**
```python
# å…³é”®è¯åŒ¹é…
template_keywords = ["æ ¼å¼", "èŒƒæœ¬", "æ¨¡æ¿", "æ ·è¡¨", ...]

# å†…å®¹ç‰¹å¾
- ä¸‹åˆ’çº¿æ•°é‡ > 5
- ç©ºç™½æ¡†æ•°é‡ > 3
- åŒ…å«èŒƒæœ¬èµ·å§‹è¯ï¼ˆ"è‡´ï¼š"ã€"å…¹æˆæƒ"ç­‰ï¼‰
- åŒ…å«è¡¨æ ¼ç»“æ„

# è¯„åˆ†æœºåˆ¶
template_score >= 50 â†’ æ ‡è®°ä¸º is_potential_template: true
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```json
{
  "chunk_position": 15,
  "is_potential_template": true,
  "template_score": 75,
  "template_hints": ["åŒ…å«èŒƒæœ¬å…³é”®è¯", "å«12å¤„å¡«å†™ä¸‹åˆ’çº¿", "å«èŒƒæœ¬èµ·å§‹æ ‡è¯†"]
}
```

---

### é˜¶æ®µ2ï¼šLLMç²¾ç¡®åŒ¹é…ï¼ˆå·²å®Œæˆï¼‰âœ…
**æ–‡ä»¶ï¼š** `/backend/app/works/tender/template_matcher.py`

**åŠŸèƒ½ï¼š**
- æŸ¥è¯¢æ ‡è®°ä¸º `is_potential_template=true` çš„chunks
- æ‰¹é‡è°ƒç”¨LLMåˆ¤æ–­èŠ‚ç‚¹ä¸èŒƒæœ¬çš„åŒ¹é…å…³ç³»
- è¿”å›ç½®ä¿¡åº¦ â‰¥ 0.7 çš„åŒ¹é…ç»“æœ

**LLM Promptæ ¸å¿ƒï¼š**
```
ä¸ºç›®å½•èŠ‚ç‚¹åŒ¹é…æ ¼å¼èŒƒæœ¬
âœ… åº”è¯¥åŒ¹é…ï¼šèŠ‚ç‚¹"æŠ•æ ‡å‡½" â†” èŒƒæœ¬"è‡´ï¼šÃ—Ã—Ã— æˆ‘å•ä½..."
âŒ ä¸åº”åŒ¹é…ï¼šèŠ‚ç‚¹"æŠ€æœ¯æ–¹æ¡ˆ" âœ— èŒƒæœ¬"æŠ•æ ‡å‡½æ ¼å¼"
ç½®ä¿¡åº¦é˜ˆå€¼ï¼š0.7-0.9ï¼ˆåŸºæœ¬ç¬¦åˆï¼‰ï¼Œ0.9-1.0ï¼ˆå®Œå…¨åŒ¹é…ï¼‰
```

---

### é˜¶æ®µ3ï¼šè‡ªåŠ¨å¡«å……èŠ‚ç‚¹æ­£æ–‡ï¼ˆå·²å®Œæˆï¼‰âœ…
**æ–‡ä»¶ï¼š** `/backend/app/works/tender/template_matcher.py`

**åŠŸèƒ½ï¼š**
- å°†åŒ¹é…çš„èŒƒæœ¬æ–‡æœ¬å¡«å……åˆ° `tender_directory_nodes.body_content`
- è®°å½• `source_chunk_ids` ä»¥ä¾¿è¿½æº¯
- æ‰¹é‡æ›´æ–°ï¼Œäº‹åŠ¡ä¿è¯

---

### é›†æˆåˆ°ç›®å½•ç”Ÿæˆæµç¨‹ï¼ˆå·²å®Œæˆï¼‰âœ…
**æ–‡ä»¶ï¼š** `/backend/app/works/tender/extract_v2_service.py`

**æ–°å¢é˜¶æ®µ5ï¼š**
```python
async def generate_directory_v2(
    enable_template_matching: bool = True,  # æ–°å¢å‚æ•°
):
    # ... é˜¶æ®µ1-4 ...
    
    # é˜¶æ®µ5ï¼šæ ¼å¼èŒƒæœ¬åŒ¹é…ä¸å¡«å……
    match_result = await match_templates_to_nodes(...)
    fill_result = await auto_fill_template_bodies(...)
```

---

### å‰ç«¯UIæ˜¾ç¤ºï¼ˆå·²å®Œæˆï¼‰âœ…
**æ–‡ä»¶ï¼š**
- `/frontend/src/components/TenderWorkspace.tsx`
- `/frontend/src/components/tender/DirectoryToolbar.tsx`

**æ˜¾ç¤ºæ•ˆæœï¼š**
```
ğŸ“„ æ ¼å¼èŒƒæœ¬å¡«å……ï¼šè‡ªåŠ¨å¡«å……äº† 3 ä¸ªèŠ‚ç‚¹çš„æ ¼å¼èŒƒæœ¬ 
(æŠ•æ ‡å‡½ã€æˆæƒä¹¦ã€é¡¹ç›®ç®¡ç†æœºæ„)
```

---

## ğŸ”§ è¡¥æ‰“æ ‡è®°è„šæœ¬ï¼ˆå·²å®Œæˆï¼‰âœ…

**æ–‡ä»¶ï¼š** `/scripts/mark_existing_templates.py`

**ç”¨é€”ï¼š** ä¸ºå·²å…¥åº“ä½†æœªæ ‡è®°çš„chunksè¡¥æ‰“èŒƒæœ¬æ ‡è®°

**ä½¿ç”¨æ–¹æ³•ï¼š**

### 1. ä¸ºå•ä¸ªé¡¹ç›®æ ‡è®°
```bash
cd /aidata/x-llmapp1
python scripts/mark_existing_templates.py --project-id <é¡¹ç›®ID>
```

### 2. ä¸ºæ‰€æœ‰é¡¹ç›®æ ‡è®°
```bash
python scripts/mark_existing_templates.py --all
```

### 3. æµ‹è¯•æ¨¡å¼ï¼ˆä¸å®é™…æ›´æ–°ï¼‰
```bash
python scripts/mark_existing_templates.py --project-id <é¡¹ç›®ID> --dry-run
```

**ç¤ºä¾‹è¾“å‡ºï¼š**
```
2025-12-31 10:00:00 - INFO - Processing project: proj_xxx
2025-12-31 10:00:01 - INFO - Found tender document version: dv_yyy
2025-12-31 10:00:02 - INFO - Found 150 chunks to process
2025-12-31 10:00:05 - INFO - Project proj_xxx: Marked 8/150 chunks as templates
2025-12-31 10:00:05 - INFO - Marked chunk IDs: seg_aaa..., seg_bbb..., seg_ccc...
âœ… Done! Processed 150 chunks, marked 8 as templates
```

---

## ğŸ“Š å®Œæ•´å·¥ä½œæµç¨‹

### æ–°æ–‡æ¡£ä¸Šä¼ ï¼ˆè‡ªåŠ¨æ ‡è®°ï¼‰
```
ç”¨æˆ·ä¸Šä¼ æ‹›æ ‡ä¹¦
  â†“
æ–‡æ¡£è§£æ & åˆ†ç‰‡
  â†“
ã€é˜¶æ®µ1ã€‘æ¯ä¸ªchunkè‡ªåŠ¨è¯†åˆ«æ˜¯å¦ä¸ºèŒƒæœ¬ âœ…
  â†“
å†™å…¥ doc_segments (meta_json åŒ…å« is_potential_template)
  â†“
ç›®å½•ç”Ÿæˆ
  â†“
ã€é˜¶æ®µ2ã€‘LLMåŒ¹é…èŒƒæœ¬åˆ°èŠ‚ç‚¹ âœ…
  â†“
ã€é˜¶æ®µ3ã€‘è‡ªåŠ¨å¡«å……èŠ‚ç‚¹æ­£æ–‡ âœ…
  â†“
å‰ç«¯æ˜¾ç¤ºç»Ÿè®¡ âœ…
```

### ç°æœ‰é¡¹ç›®ï¼ˆè¡¥æ‰“æ ‡è®°ï¼‰
```
è¿è¡Œè¡¥æ‰“æ ‡è®°è„šæœ¬
  â†“
æ‰«æ doc_segments è¡¨
  â†“
å¯¹æœªæ ‡è®°çš„chunksè°ƒç”¨ identify_potential_template()
  â†“
æ›´æ–° meta_json å­—æ®µ
  â†“
é‡æ–°ç”Ÿæˆç›®å½•
  â†“
è‡ªåŠ¨åŒ¹é…ä¸å¡«å…… âœ…
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯•1ï¼šæ–°æ–‡æ¡£ä¸Šä¼ ï¼ˆæ¨èï¼‰
1. å‡†å¤‡ä¸€ä¸ªåŒ…å«æ ¼å¼èŒƒæœ¬çš„æ‹›æ ‡ä¹¦PDF
2. åˆ›å»ºæ–°é¡¹ç›®å¹¶ä¸Šä¼ æ–‡æ¡£
3. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼š
   ```
   IngestV2: Identified 5/150 potential template chunks
   ```
4. ç”Ÿæˆç›®å½•
5. æŸ¥çœ‹å‰ç«¯ç»Ÿè®¡ï¼š
   ```
   ğŸ“„ æ ¼å¼èŒƒæœ¬å¡«å……ï¼šè‡ªåŠ¨å¡«å……äº† 3 ä¸ªèŠ‚ç‚¹çš„æ ¼å¼èŒƒæœ¬
   ```

### æµ‹è¯•2ï¼šç°æœ‰é¡¹ç›®è¡¥æ‰“æ ‡è®°
1. é€‰æ‹©ä¸€ä¸ªå·²æœ‰æ‹›æ ‡æ–‡æ¡£çš„é¡¹ç›®
2. è¿è¡Œè¡¥æ‰“æ ‡è®°è„šæœ¬ï¼š
   ```bash
   python scripts/mark_existing_templates.py --project-id <é¡¹ç›®ID>
   ```
3. æŸ¥çœ‹è¾“å‡ºç»Ÿè®¡
4. é‡æ–°ç”Ÿæˆç›®å½•
5. éªŒè¯èŒƒæœ¬å¡«å……æ•ˆæœ

### æµ‹è¯•3ï¼šéªŒè¯æ•°æ®åº“
```sql
-- æŸ¥è¯¢æ ‡è®°ä¸ºèŒƒæœ¬çš„chunks
SELECT 
    id,
    LEFT(content_text, 100) as preview,
    meta_json->>'is_potential_template' as is_template,
    meta_json->>'template_score' as score,
    meta_json->>'template_hints' as hints
FROM doc_segments
WHERE meta_json->>'is_potential_template' = 'true'
ORDER BY (meta_json->>'template_score')::int DESC
LIMIT 10;
```

---

## âš™ï¸ é…ç½®é€‰é¡¹

### ç¦ç”¨èŒƒæœ¬åŒ¹é…
```python
# åœ¨ extract_v2_service.py
enable_template_matching=False
```

### è°ƒæ•´è¯†åˆ«é˜ˆå€¼
```python
# åœ¨ template_matcher.py çš„ identify_potential_template()
if template_score >= 60:  # é»˜è®¤50ï¼Œæé«˜é˜ˆå€¼æ›´ä¸¥æ ¼
    return {...}
```

### è°ƒæ•´åŒ¹é…ç½®ä¿¡åº¦
```python
# åœ¨ template_matcher.py çš„ _match_batch()
if match.get("confidence", 0) < 0.8:  # é»˜è®¤0.7
    continue
```

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### ç›®å½•æ˜¾ç¤º
```
å•†åŠ¡æ ‡
  â”œâ”€ æŠ•æ ‡å‡½åŠæŠ•æ ‡å‡½é™„å½•
  â”‚   â””â”€ æ­£æ–‡ï¼šâœ… [è‡ªåŠ¨å¡«å……] è‡´ï¼šÃ—Ã—Ã— æˆ‘å•ä½æ„¿æ„å‚åŠ ...
  â”œâ”€ æˆæƒå§”æ‰˜ä¹¦
  â”‚   â””â”€ æ­£æ–‡ï¼šâœ… [è‡ªåŠ¨å¡«å……] å…¹æˆæƒxxxä¸ºæˆ‘å•ä½åˆæ³•ä»£ç†äºº...
  â”œâ”€ é¡¹ç›®ç®¡ç†æœºæ„
      â””â”€ æ­£æ–‡ï¼šâœ… [è‡ªåŠ¨å¡«å……] é¡¹ç›®ç®¡ç†æœºæ„é…å¤‡è¡¨...
```

### å‰ç«¯ç»Ÿè®¡
```
âš¡ å¿«é€Ÿç”Ÿæˆæ¨¡å¼ï¼šåŸºäºå·²æå–çš„é¡¹ç›®ä¿¡æ¯æ„å»ºéª¨æ¶ (15ä¸ªèŠ‚ç‚¹)
âœ¨ è§„åˆ™ç»†åŒ–ï¼šä»æ‹›æ ‡è¦æ±‚ä¸­æå–äº† 12 ä¸ªç»†åˆ†èŠ‚ç‚¹
ğŸ” LLMæ‹¬å·è§£æï¼šä»æ‹¬å·è¯´æ˜ä¸­æå–äº† 5 ä¸ªL4å­èŠ‚ç‚¹
ğŸ“„ æ ¼å¼èŒƒæœ¬å¡«å……ï¼šè‡ªåŠ¨å¡«å……äº† 3 ä¸ªèŠ‚ç‚¹çš„æ ¼å¼èŒƒæœ¬ (æŠ•æ ‡å‡½ã€æˆæƒä¹¦ã€é¡¹ç›®ç®¡ç†æœºæ„)
```

---

## ğŸ¯ æˆåŠŸæŒ‡æ ‡

### è¯†åˆ«å‡†ç¡®ç‡
- **ç›®æ ‡ï¼š** â‰¥ 80% çš„æ ¼å¼èŒƒæœ¬è¢«æ­£ç¡®è¯†åˆ«
- **éªŒè¯ï¼š** äººå·¥æŠ½æŸ¥æ ‡è®°ä¸ºèŒƒæœ¬çš„chunks

### åŒ¹é…å‡†ç¡®ç‡
- **ç›®æ ‡ï¼š** â‰¥ 90% çš„åŒ¹é…å…³ç³»æ­£ç¡®
- **éªŒè¯ï¼š** æ£€æŸ¥å¡«å……çš„èŠ‚ç‚¹æ­£æ–‡æ˜¯å¦ä¸èŠ‚ç‚¹æ ‡é¢˜ç›¸å…³

### ç”¨æˆ·ä½“éªŒ
- **ç›®æ ‡ï¼š** å‡å°‘ 50% çš„æ‰‹åŠ¨å¡«å†™å·¥ä½œé‡
- **éªŒè¯ï¼š** ç»Ÿè®¡è‡ªåŠ¨å¡«å……çš„èŠ‚ç‚¹æ•°é‡

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šæœªè¯†åˆ«åˆ°èŒƒæœ¬
**ç—‡çŠ¶ï¼š** æ—¥å¿—æ˜¾ç¤º `Identified 0/150 potential template chunks`

**æ’æŸ¥ï¼š**
1. æ£€æŸ¥æ–‡æ¡£å†…å®¹æ˜¯å¦åŒ…å«"æ ¼å¼"ã€"èŒƒæœ¬"ç­‰å…³é”®è¯
2. é™ä½è¯†åˆ«é˜ˆå€¼ï¼ˆtemplate_score >= 40ï¼‰
3. æŸ¥çœ‹æ—¥å¿—ä¸­çš„ template_score åˆ†å¸ƒ

### é—®é¢˜2ï¼šåŒ¹é…å¤±è´¥
**ç—‡çŠ¶ï¼š** å‰ç«¯æ˜¾ç¤º"æœªå‘ç°å¯åŒ¹é…çš„æ ¼å¼èŒƒæœ¬"

**æ’æŸ¥ï¼š**
1. æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰ `is_potential_template=true` çš„chunksï¼š
   ```sql
   SELECT COUNT(*) FROM doc_segments 
   WHERE meta_json->>'is_potential_template' = 'true';
   ```
2. å¦‚æœä¸º0ï¼Œè¿è¡Œè¡¥æ‰“æ ‡è®°è„šæœ¬
3. æ£€æŸ¥LLMæœåŠ¡æ˜¯å¦æ­£å¸¸

### é—®é¢˜3ï¼šå¡«å……å¤±è´¥
**ç—‡çŠ¶ï¼š** åŒ¹é…æˆåŠŸä½†èŠ‚ç‚¹æ­£æ–‡æœªå¡«å……

**æ’æŸ¥ï¼š**
1. æ£€æŸ¥ `tender_directory_nodes` è¡¨çš„ `body_content` å­—æ®µ
2. æŸ¥çœ‹åç«¯æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
3. éªŒè¯ç›®å½•version_idæ˜¯å¦æ­£ç¡®

---

## ğŸ“ æ”¯æŒä¸åé¦ˆ

**æ ¸å¿ƒæ–‡ä»¶ï¼š**
- `/backend/app/platform/ingest/v2_service.py` - åˆ†ç‰‡è¯†åˆ«é›†æˆ
- `/backend/app/works/tender/template_matcher.py` - æ ¸å¿ƒåŒ¹é…é€»è¾‘
- `/backend/app/works/tender/extract_v2_service.py` - ç›®å½•ç”Ÿæˆé›†æˆ
- `/scripts/mark_existing_templates.py` - è¡¥æ‰“æ ‡è®°è„šæœ¬

**æ—¥å¿—å…³é”®è¯ï¼š**
- `[IngestV2]` - æ–‡æ¡£å…¥åº“ä¸è¯†åˆ«
- `[TemplateMatcher]` - èŒƒæœ¬åŒ¹é…ä¸å¡«å……
- `[ExtractV2]` - ç›®å½•ç”Ÿæˆ

---

## âœ… å®ŒæˆçŠ¶æ€

âœ… é˜¶æ®µ1ï¼šæ–‡æ¡£åˆ†ç‰‡æ—¶è¯†åˆ«ï¼ˆå·²é›†æˆåˆ° v2_service.pyï¼‰  
âœ… é˜¶æ®µ2ï¼šLLMç²¾ç¡®åŒ¹é…ï¼ˆå·²å®Œæˆï¼‰  
âœ… é˜¶æ®µ3ï¼šè‡ªåŠ¨å¡«å……èŠ‚ç‚¹æ­£æ–‡ï¼ˆå·²å®Œæˆï¼‰  
âœ… é›†æˆåˆ°ç›®å½•ç”Ÿæˆæµç¨‹ï¼ˆå·²å®Œæˆï¼‰  
âœ… å‰ç«¯UIæ˜¾ç¤ºï¼ˆå·²å®Œæˆï¼‰  
âœ… è¡¥æ‰“æ ‡è®°è„šæœ¬ï¼ˆå·²å®Œæˆï¼‰  

**åŠŸèƒ½å®Œæ•´å¯ç”¨ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•ï¼** ğŸš€

