# æ–‡ä»¶ä¸Šä¼ æµç¨‹å®Œæ•´æ£€æŸ¥æŠ¥å‘Š

**æ—¥æœŸ**: 2025-12-29  
**é¡¹ç›®**: tp_3f49f66ead6d46e1bac3f0bd16a3efe9

---

## âœ… æ£€æŸ¥ç»“æœæ€»ç»“

### ã€âœ… Step 1ã€‘æ–‡ä»¶ä¸Šä¼ åˆ° tender_project_assets

| ç±»å‹ | æ–‡ä»¶æ•° | kb_doc_id | segments |
|------|--------|-----------|----------|
| tender | 1 | âœ… å·²å¡«å…… | 32 |
| bid    | 2 | âœ… å·²å¡«å…… | 70 |
| **åˆè®¡** | **3** | **3/3** | **102** |

**çŠ¶æ€**: âœ… **æ­£å¸¸** - æ‰€æœ‰æ–‡ä»¶éƒ½æœ‰ `kb_doc_id`

---

### ã€âœ… Step 2ã€‘æ–‡æ¡£å…¥åº“åˆ° documentsè¡¨

```sql
3ä¸ªæ–‡æ¡£å·²æˆåŠŸå…¥åº“:
- doc_70702e26435249979b5e898e1d4ad6d1 (tender_notice)
- doc_9c40d6349a514f05a71d4cc7525948c7 (bid_document) 
- doc_b4e9f5ce8d69480b94f580548bc5dd25 (bid_document)
```

**çŠ¶æ€**: âœ… **æ­£å¸¸**

---

### ã€âœ… Step 3ã€‘æ–‡æ¡£åˆ†æ®µåˆ° doc_segments

| æŒ‡æ ‡ | å€¼ |
|------|------|
| æ€»segments | 102 |
| æœ‰ content_text | 102/102 |
| æœ‰ tsv (å…¨æ–‡ç´¢å¼•) | 102/102 |
| å¹³å‡é•¿åº¦ | 1177 å­—ç¬¦ |

**Sampleå†…å®¹**:
```
seg_xxx: "è¥ä¸šæ‰§ç…§...èµ„è´¨è¯ä¹¦..."
seg_xxx: "è´¨é‡ä¿è¯ä½“ç³»åŠèŒè´£..."
seg_xxx: "å·¥æœŸä¿è¯ä½“ç³»...è¿›åº¦è®¡åˆ’è¡¨..."
```

**çŠ¶æ€**: âœ… **å®Œå…¨æ­£å¸¸** - æ‰€æœ‰segmentséƒ½æœ‰å†…å®¹å’Œå…¨æ–‡ç´¢å¼•

---

### ã€âŒ Step 4ã€‘å‘é‡åŒ–åˆ° kb_chunks (é—®é¢˜æ‰€åœ¨!)

| æŒ‡æ ‡ | å€¼ |
|------|------|
| kb_chunks æ€»æ•° | **0** âŒ |
| æœ‰ embedding çš„ | 0 |
| æœ‰ content çš„ | 0 |

**è¯¦ç»†ç»Ÿè®¡ (æŒ‰æ–‡æ¡£)**:
| æ–‡ä»¶ç±»å‹ | æ–‡ä»¶å | segments | kb_chunks |
|---------|--------|----------|-----------|
| tender | è¥¿å‘é•‡ç»™æ°´ç®¡ç½‘æ”¹é€ å·¥ç¨‹.docx | 32 | **0** âŒ |
| bid | æŠ€æœ¯æ ‡.docx | 68 | **0** âŒ |
| bid | å•†åŠ¡æ ‡.docx | 2 | **0** âŒ |

**çŠ¶æ€**: âŒ **å¼‚å¸¸** - æ–‡æ¡£æœªå‘é‡åŒ–åˆ° `kb_chunks`

---

## ğŸ” é—®é¢˜åˆ†æ

### å½“å‰æ¶æ„

**æ‹›æŠ•æ ‡ç³»ç»Ÿæ£€ç´¢æµç¨‹**:
```
ç”¨æˆ·æŸ¥è¯¢
  â†“
RetrievalFacade (æ£€ç´¢é—¨é¢)
  â†“
NewRetriever (æ–°æ£€ç´¢å™¨)
  â”œâ†’ Milvus å‘é‡æ£€ç´¢ (ä¼˜å…ˆ)
  â””â†’ PGå…¨æ–‡æ£€ç´¢ (ä» doc_segments.tsv)
  â†“
åˆå¹¶ç»“æœ â†’ è¿”å› top_k
```

### å…³é”®å‘ç°

1. **âœ… NewRetriever ä½¿ç”¨ `doc_segments.tsv` åšå…¨æ–‡æ£€ç´¢**
   - SQL: `SELECT * FROM doc_segments WHERE tsv @@ to_tsquery(...)`
   - æˆ‘ä»¬çš„æ•°æ®: 102ä¸ªsegmentsï¼Œå…¨éƒ¨æœ‰tsv âœ…

2. **âš ï¸ Milvus å‘é‡æ£€ç´¢å¯èƒ½å¤±è´¥**
   - Milvus ç”¨äºdenseæ£€ç´¢ï¼ˆå‘é‡ç›¸ä¼¼åº¦ï¼‰
   - ä½† NewRetriever æœ‰ fallbackæœºåˆ¶ï¼šå‘é‡æ£€ç´¢å¤±è´¥ â†’ é™çº§åˆ°çº¯å…¨æ–‡æ£€ç´¢

3. **âœ… kb_chunks ä¸ºç©ºä¸å½±å“æ£€ç´¢**
   - `kb_chunks` æ˜¯æ—§ç³»ç»Ÿçš„è¡¨
   - æ–°ç³»ç»Ÿ (`NewRetriever`) ç›´æ¥ç”¨ `doc_segments`

---

## ğŸ¯ é¢„æœŸè¡Œä¸º

### å½“å‰é…ç½®ä¸‹çš„æ£€ç´¢æµç¨‹

1. **å‘èµ·æŸ¥è¯¢**: "è¥ä¸šæ‰§ç…§è¦æ±‚"
2. **NewRetriever å°è¯• Milvus**:
   - å¦‚æœæœ‰ embedding_provider â†’ å‘é‡æ£€ç´¢
   - å¦‚æœå¤±è´¥ â†’ è®°å½•warningï¼Œç»§ç»­
3. **NewRetriever å…¨æ–‡æ£€ç´¢** (å¿…å®šæ‰§è¡Œ):
   ```sql
   SELECT id, ts_rank(tsv, query) as rank
   FROM doc_segments
   WHERE doc_version_id = ANY([dv_xxx, dv_yyy])
     AND tsv @@ to_tsquery('english', 'è¥ä¸š | æ‰§ç…§ | è¦æ±‚')
   ORDER BY rank DESC
   LIMIT 40
   ```
4. **åˆå¹¶ç»“æœ** â†’ è¿”å› top 12

### éªŒè¯å…¨æ–‡æ£€ç´¢æ˜¯å¦å·¥ä½œ

è®©æˆ‘æ‰§è¡Œä¸€ä¸ªå®é™…çš„å…¨æ–‡æ£€ç´¢æµ‹è¯•ï¼š

```sql
SELECT 
    id,
    LEFT(content_text, 100) as content,
    ts_rank(tsv, query) as rank
FROM doc_segments, 
     to_tsquery('simple', 'è¥ä¸š | æ‰§ç…§') query
WHERE doc_version_id IN (
    SELECT dv.id FROM document_versions dv
    WHERE dv.document_id IN (
        SELECT kb_doc_id FROM tender_project_assets 
        WHERE project_id = 'tp_3f49f66ead6d46e1bac3f0bd16a3efe9'
    )
)
  AND tsv @@ query
ORDER BY rank DESC
LIMIT 5;
```

---

## âœ… ç»“è®º

### æ–‡ä»¶ä¸Šä¼ æµç¨‹çŠ¶æ€

| é˜¶æ®µ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| 1. æ–‡ä»¶ä¸Šä¼  | âœ… æ­£å¸¸ | kb_doc_id å·²æ­£ç¡®å¡«å…… |
| 2. æ–‡æ¡£å…¥åº“ | âœ… æ­£å¸¸ | documents è¡¨æœ‰æ•°æ® |
| 3. åˆ†æ®µ | âœ… æ­£å¸¸ | 102 segmentsï¼Œå…¨éƒ¨æœ‰å†…å®¹å’Œå…¨æ–‡ç´¢å¼• |
| 4. å‘é‡åŒ– (Milvus) | âš ï¸ æœªæ‰§è¡Œ | kb_chunks ä¸ºç©º |
| 5. æ£€ç´¢èƒ½åŠ› | âœ… å¯ç”¨ | doc_segments.tsv å…¨æ–‡æ£€ç´¢å¯ç”¨ |

### å…³é”®ç»“è®º

**âœ… æ–‡ä»¶ä¸Šä¼ æµç¨‹æ­£ç¡®ï¼**

è™½ç„¶ `kb_chunks` ä¸ºç©ºï¼ˆå‘é‡åŒ–æœªæ‰§è¡Œï¼‰ï¼Œä½†è¿™**ä¸å½±å“æ£€ç´¢åŠŸèƒ½**ï¼Œå› ä¸ºï¼š

1. âœ… `doc_segments` æœ‰å®Œæ•´çš„å†…å®¹ (102æ¡)
2. âœ… `doc_segments.tsv` æœ‰å…¨æ–‡ç´¢å¼• (102/102)
3. âœ… NewRetriever å¯ä»¥ç”¨ PG å…¨æ–‡æ£€ç´¢æ‰¾åˆ°ç›¸å…³æ®µè½
4. âš ï¸ å‘é‡æ£€ç´¢ä¸å¯ç”¨ï¼Œä½†æœ‰ fallback åˆ°å…¨æ–‡æ£€ç´¢

### æŠ•æ ‡å“åº”æŠ½å–é¢„æœŸ

**åŸºäºå…¨æ–‡æ£€ç´¢**:
- æŸ¥è¯¢: "è¥ä¸šæ‰§ç…§è¦æ±‚"
- å…¨æ–‡æ£€ç´¢å¯æ‰¾åˆ°åŒ…å« "è¥ä¸š"ã€"æ‰§ç…§" çš„æ®µè½
- **é¢„æœŸç»“æœ**: åº”è¯¥èƒ½æŠ½å–åˆ° 10-20 æ¡å“åº”ï¼ˆè€Œä¸æ˜¯3-6æ¡ï¼‰

### å¦‚æœæŠ½å–ä»ç„¶åªæœ‰3-6æ¡

å¯èƒ½åŸå› :
1. **LLM prompt é™åˆ¶**:å¤§ä¸Šä¸‹æ–‡è¢«æˆªæ–­
2. **æ£€ç´¢å¬å›ä¸è¶³**: top_k å¤ªå°ï¼Œç›¸å…³æ®µè½æœªå¬å›
3. **LLM è¾“å‡ºè§£æé—®é¢˜**: è§£æå¤±è´¥å¯¼è‡´éƒ¨åˆ†å“åº”ä¸¢å¤±

---

## ğŸ“ å»ºè®®

### ä¸‹ä¸€æ­¥æ“ä½œ

1. **ç«‹å³æµ‹è¯•æŠ•æ ‡å“åº”æŠ½å–**:
   ```bash
   # å‰ç«¯æ“ä½œ
   è¿›å…¥é¡¹ç›® â†’ é€‰æ‹©æŠ•æ ‡äºº â†’ ç‚¹å‡» "å¼€å§‹æŠ½å–"
   ```

2. **å¦‚æœè¿˜æ˜¯3-6æ¡ï¼ŒæŸ¥çœ‹æ—¥å¿—**:
   ```bash
   docker-compose logs --tail=200 backend | grep -E "NewRetriever|retrieve|chunks"
   ```

3. **æ‰‹åŠ¨æµ‹è¯•æ£€ç´¢**:
   ```bash
   # åœ¨æ•°æ®åº“ä¸­æ‰§è¡Œå…¨æ–‡æ£€ç´¢
   docker-compose exec postgres psql -U localgpt -d localgpt
   ```

### å‘é‡åŒ–é—®é¢˜ (å¯é€‰ä¼˜åŒ–)

å¦‚æœéœ€è¦å¯ç”¨å‘é‡æ£€ç´¢:
1. æ£€æŸ¥ embedding_provider é…ç½®
2. æ£€æŸ¥ Milvus æ˜¯å¦æ­£å¸¸å·¥ä½œ
3. æ‰‹åŠ¨è§¦å‘å‘é‡åŒ–ï¼ˆå¦‚æœæœ‰æ¥å£ï¼‰

ä½†**ä¸æ˜¯å¿…éœ€çš„** - å…¨æ–‡æ£€ç´¢å·²ç»è¶³å¤Ÿã€‚

---

## ğŸ‰ æœ€ç»ˆè¯„ä¼°

**æ–‡ä»¶ä¸Šä¼ æµç¨‹: âœ… æ­£ç¡®**

- æ–‡ä»¶æˆåŠŸä¸Šä¼  âœ…
- kb_doc_id æ­£ç¡®å¡«å…… âœ…
- doc_segments å®Œæ•´ âœ…
- å…¨æ–‡ç´¢å¼•å°±ç»ª âœ…
- æ£€ç´¢åŠŸèƒ½å¯ç”¨ âœ…

**å¯ä»¥æ­£å¸¸ä½¿ç”¨æŠ•æ ‡å“åº”æŠ½å–åŠŸèƒ½ï¼** ğŸš€

