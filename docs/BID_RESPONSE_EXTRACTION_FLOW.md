# æŠ•æ ‡å“åº”æŠ½å–å®Œæ•´æµç¨‹

## æ¦‚è¿°
å½“ç”¨æˆ·ç‚¹å‡»"æŠ½å–æŠ•æ ‡å“åº”"æŒ‰é’®åï¼Œç³»ç»Ÿä¼šä»æŠ•æ ‡æ–‡ä»¶ä¸­æå–ç»“æ„åŒ–çš„å“åº”æ•°æ®ï¼Œä¸ºV3å®¡æ ¸æä¾›æ•°æ®æ”¯æŒã€‚

## ğŸ”„ å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ç‚¹å‡»"æŠ½å–æŠ•æ ‡å“åº”"æŒ‰é’®                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: å‰ç«¯ (TenderWorkspace.tsx)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†é¡¹ç›®å’ŒæŠ•æ ‡äºº                                   â”‚
â”‚  2. æ˜¾ç¤ºæç¤ºï¼šå¼€å§‹æŠ½å–æŠ•æ ‡å“åº”æ•°æ®ï¼Œè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´...      â”‚
â”‚  3. å‘é€ POST è¯·æ±‚åˆ°åç«¯ API:                                   â”‚
â”‚     /api/apps/tender/projects/{project_id}/                     â”‚
â”‚     extract-bid-responses?bidder_name=123                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: API è·¯ç”± (tender.py)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  @router.post("/projects/{project_id}/extract-bid-responses")  â”‚
â”‚                                                                 â”‚
â”‚  1. è·å–ä¾èµ–:                                                   â”‚
â”‚     - pool = _get_pool(request)      # æ•°æ®åº“è¿æ¥æ±              â”‚
â”‚     - llm = _get_llm(request)        # LLMç¼–æ’å™¨               â”‚
â”‚     - engine = ExtractionEngine()    # æŠ½å–å¼•æ“                â”‚
â”‚     - retriever = RetrievalFacade(pool)  # æ£€ç´¢å™¨              â”‚
â”‚                                                                 â”‚
â”‚  2. åˆ›å»º BidResponseService å®ä¾‹                               â”‚
â”‚                                                                 â”‚
â”‚  3. è°ƒç”¨ service.extract_bid_response_v1()                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: BidResponseService.extract_bid_response_v1()          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¾“å…¥: project_id, bidder_name, model_id                       â”‚
â”‚                                                                 â”‚
â”‚  3.1 è·å– Embedding Provider                                   â”‚
â”‚      - get_embedding_store().get_default()                     â”‚
â”‚                                                                 â”‚
â”‚  3.2 æ„å»ºæŠ½å–è§„æ ¼ (ExtractionSpec)                             â”‚
â”‚      - è°ƒç”¨ build_bid_response_spec_async(pool)                â”‚
â”‚      - ä»æ•°æ®åº“åŠ è½½ "bid_response" prompt                      â”‚
â”‚      - å®šä¹‰7ä¸ªæ£€ç´¢ç»´åº¦çš„æŸ¥è¯¢å…³é”®è¯                              â”‚
â”‚                                                                 â”‚
â”‚  3.3 è°ƒç”¨ ExtractionEngine.run()                              â”‚
â”‚      - ä¼ å…¥ spec, retriever, llm, project_id ç­‰å‚æ•°            â”‚
â”‚                                                                 â”‚
â”‚  3.4 è§£æå¼•æ“è¿”å›çš„ç»“æœ (JSONæ ¼å¼)                              â”‚
â”‚                                                                 â”‚
â”‚  3.5 è½åº“åˆ° tender_bid_response_items è¡¨                       â”‚
â”‚      - ä¸ºæ¯æ¡å“åº”æ•°æ®ç”Ÿæˆå”¯ä¸€ID                                 â”‚
â”‚      - æ’å…¥æ•°æ®åº“                                               â”‚
â”‚                                                                 â”‚
â”‚  3.6 è¿”å›ç»“æœç»Ÿè®¡                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: ExtractionEngine.run() - æ ¸å¿ƒæŠ½å–é€»è¾‘                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  4.1 æ‰§è¡Œæ£€ç´¢ (_retrieve_chunks)                               â”‚
â”‚      â”œâ”€ 7ä¸ªç»´åº¦å¹¶è¡Œæ£€ç´¢:                                        â”‚
â”‚      â”‚  â”œâ”€ qualification (èµ„æ ¼å®¡æŸ¥)  â†’ 20æ¡                    â”‚
â”‚      â”‚  â”œâ”€ technical (æŠ€æœ¯å‚æ•°)      â†’ 20æ¡                    â”‚
â”‚      â”‚  â”œâ”€ business (å•†åŠ¡æ¡æ¬¾)       â†’ 20æ¡                    â”‚
â”‚      â”‚  â”œâ”€ price (æŠ¥ä»·)              â†’ 20æ¡                    â”‚
â”‚      â”‚  â”œâ”€ doc_structure (æ–‡ä»¶ç»“æ„)  â†’ 20æ¡                    â”‚
â”‚      â”‚  â”œâ”€ schedule_quality (å·¥æœŸ)   â†’ 20æ¡                    â”‚
â”‚      â”‚  â””â”€ other (å…¶ä»–)              â†’ 20æ¡                    â”‚
â”‚      â”‚                                                          â”‚
â”‚      â”œâ”€ ä½¿ç”¨ RetrievalFacade.retrieve_multi()                  â”‚
â”‚      â”œâ”€ åªæ£€ç´¢ doc_types=['bid'] (æŠ•æ ‡æ–‡ä»¶)                     â”‚
â”‚      â”œâ”€ ä½¿ç”¨å‘é‡ç›¸ä¼¼åº¦æœç´¢                                      â”‚
â”‚      â””â”€ æ€»è®¡æœ€å¤š140æ¡ chunks (å»é‡åå¯èƒ½æ›´å°‘)                   â”‚
â”‚                                                                 â”‚
â”‚  4.2 æ„å»ºä¸Šä¸‹æ–‡ (build_marked_context)                         â”‚
â”‚      - å°†æ£€ç´¢åˆ°çš„ chunks ç»„ç»‡æˆå¸¦æ ‡è®°çš„æ–‡æœ¬                     â”‚
â”‚      - æ ¼å¼: [CHUNK_1] ...å†…å®¹... [/CHUNK_1]                   â”‚
â”‚                                                                 â”‚
â”‚  4.3 æ„å»ºå®Œæ•´Prompt                                             â”‚
â”‚      System Message: bid_response promptæ¨¡æ¿                   â”‚
â”‚      User Message: åŒ…å«æ ‡è®°åçš„ä¸Šä¸‹æ–‡                           â”‚
â”‚                                                                 â”‚
â”‚  4.4 è°ƒç”¨LLM (call_llm)                                        â”‚
â”‚      - ä½¿ç”¨ llm_orchestrator.chat() æ–¹æ³•                       â”‚
â”‚      - temperature=0.0 (ç¡®å®šæ€§è¾“å‡º)                            â”‚
â”‚      - max_tokens=4096                                         â”‚
â”‚      - åœ¨çº¿ç¨‹æ± ä¸­å¼‚æ­¥æ‰§è¡Œ                                       â”‚
â”‚                                                                 â”‚
â”‚  4.5 è§£æLLMè¾“å‡º                                                â”‚
â”‚      - å°è¯•æå–JSON (extract_json)                             â”‚
â”‚      - å¦‚æœå¤±è´¥ï¼Œå°è¯•ä¿®å¤JSON (repair_json)                     â”‚
â”‚      - å¦‚æœä»å¤±è´¥ï¼Œè¿”å›ç©ºç»“æœ                                   â”‚
â”‚                                                                 â”‚
â”‚  4.6 è¿”å› ExtractionResult                                     â”‚
â”‚      - data: è§£æåçš„JSONæ•°æ®                                  â”‚
â”‚      - evidence_chunk_ids: è¯æ®chunk IDs                       â”‚
â”‚      - raw_model_output: LLMåŸå§‹è¾“å‡º                           â”‚
â”‚      - retrieval_trace: æ£€ç´¢è¿½è¸ªä¿¡æ¯                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 5: æ•°æ®å­˜å‚¨ (tender_bid_response_itemsè¡¨)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¯¹æ¯æ¡å“åº”æ•°æ®æ‰§è¡Œ INSERT:                                     â”‚
â”‚                                                                 â”‚
â”‚  â”œâ”€ id: UUID (å”¯ä¸€æ ‡è¯†)                                        â”‚
â”‚  â”œâ”€ project_id: é¡¹ç›®ID                                         â”‚
â”‚  â”œâ”€ bidder_name: æŠ•æ ‡äººåç§°                                    â”‚
â”‚  â”œâ”€ dimension: ç»´åº¦ (qualification/technical/...)              â”‚
â”‚  â”œâ”€ response_type: å“åº”ç±»å‹ (document_ref/direct_answer/...)   â”‚
â”‚  â”œâ”€ response_text: å“åº”å†…å®¹æ–‡æœ¬                                â”‚
â”‚  â”œâ”€ extracted_value_json: æå–çš„ç»“æ„åŒ–æ•°æ® (JSON)              â”‚
â”‚  â””â”€ evidence_chunk_ids: è¯æ®chunk IDsæ•°ç»„                      â”‚
â”‚                                                                 â”‚
â”‚  ç¤ºä¾‹æ•°æ®:                                                      â”‚
â”‚  {                                                              â”‚
â”‚    "dimension": "qualification",                               â”‚
â”‚    "response_text": "å·²æä¾›è¥ä¸šæ‰§ç…§ï¼Œæ³¨å†Œèµ„æœ¬5000ä¸‡å…ƒ",         â”‚
â”‚    "extracted_value_json": {                                   â”‚
â”‚      "registered_capital": "5000ä¸‡å…ƒ",                         â”‚
â”‚      "credit_code": "91xxxxxx"                                 â”‚
â”‚    },                                                           â”‚
â”‚    "evidence_chunk_ids": ["chunk_123", "chunk_456"]            â”‚
â”‚  }                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 6: è¿”å›å‰ç«¯å¹¶æ˜¾ç¤ºç»“æœ                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¿”å›JSON:                                                      â”‚
â”‚  {                                                              â”‚
â”‚    "success": true,                                            â”‚
â”‚    "message": "æˆåŠŸæŠ½å–XXæ¡å“åº”æ•°æ®",                           â”‚
â”‚    "data": {                                                   â”‚
â”‚      "bidder_name": "æŠ•æ ‡äººA",                                 â”‚
â”‚      "responses": [...],                                       â”‚
â”‚      "total_responses": 25,                                    â”‚
â”‚      "added_count": 25                                         â”‚
â”‚    }                                                            â”‚
â”‚  }                                                              â”‚
â”‚                                                                 â”‚
â”‚  å‰ç«¯æ˜¾ç¤º: alert("æŠ½å–å®Œæˆï¼å…±æŠ½å– 25 æ¡æŠ•æ ‡å“åº”æ•°æ®")          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š 7ä¸ªæŠ½å–ç»´åº¦è¯¦è§£

### 1. **qualification** (èµ„æ ¼å®¡æŸ¥)
**æ£€ç´¢å…³é”®è¯**: æŠ•æ ‡äººèµ„æ ¼ è¥ä¸šæ‰§ç…§ èµ„è´¨è¯ä¹¦ ä¸šç»©è¯æ˜ è´¢åŠ¡æŠ¥è¡¨ æ³¨å†Œèµ„æœ¬ ä¿¡ç”¨è®°å½• ç¤¾ä¼šä¿¡ç”¨ä»£ç  æ³•å®šä»£è¡¨äºº

**æŠ½å–å†…å®¹**:
- è¥ä¸šæ‰§ç…§ä¿¡æ¯
- èµ„è´¨è¯ä¹¦
- æ³¨å†Œèµ„æœ¬
- ä¸šç»©è¯æ˜
- ä¿¡ç”¨è®°å½•

### 2. **technical** (æŠ€æœ¯å‚æ•°)
**æ£€ç´¢å…³é”®è¯**: æŠ€æœ¯å‚æ•° æŠ€æœ¯è§„èŒƒ æŠ€æœ¯æ–¹æ¡ˆ æ€§èƒ½æŒ‡æ ‡ åŠŸèƒ½å‚æ•° è®¾å¤‡é…ç½® CPU å†…å­˜ ç¡¬ç›˜ å¤„ç†å™¨ æ ‡å‡† å‹å· è§„æ ¼

**æŠ½å–å†…å®¹**:
- æŠ€æœ¯è§„æ ¼
- è®¾å¤‡å‚æ•°
- æ€§èƒ½æŒ‡æ ‡
- æŠ€æœ¯æ–¹æ¡ˆ

### 3. **business** (å•†åŠ¡æ¡æ¬¾)
**æ£€ç´¢å…³é”®è¯**: å•†åŠ¡æ¡æ¬¾ è´¨ä¿æœŸ ä»˜æ¬¾æ–¹å¼ äº¤ä»˜æ—¶é—´ éªŒæ”¶æ ‡å‡† å”®åæœåŠ¡ è¿çº¦è´£ä»» ä¿ä¿®æœŸ

**æŠ½å–å†…å®¹**:
- è´¨ä¿æœŸæ‰¿è¯º
- ä»˜æ¬¾æ¡ä»¶
- äº¤ä»˜æ—¶é—´
- éªŒæ”¶æ ‡å‡†
- å”®åæœåŠ¡

### 4. **price** (æŠ¥ä»·)
**æ£€ç´¢å…³é”®è¯**: æŠ•æ ‡æ€»ä»· æŠ¥ä»· å•ä»· åˆ†é¡¹æŠ¥ä»· ä»·æ ¼ åˆä»· é‡‘é¢ æŠ¥ä»·è¡¨ æ€»è®¡

**æŠ½å–å†…å®¹**:
- æŠ•æ ‡æ€»ä»·
- åˆ†é¡¹æŠ¥ä»·
- å•ä»·æ˜ç»†

### 5. **doc_structure** (æ–‡ä»¶ç»“æ„)
**æ£€ç´¢å…³é”®è¯**: æŠ•æ ‡æ–‡ä»¶ç›®å½• æ–‡ä»¶ç»„æˆ æ ¼å¼ å¯†å° ç­¾å­— ç›–ç«  æˆæƒ

**æŠ½å–å†…å®¹**:
- æ–‡ä»¶å®Œæ•´æ€§
- ç­¾å­—ç›–ç« æƒ…å†µ
- æˆæƒæ–‡ä»¶

### 6. **schedule_quality** (å·¥æœŸä¸è´¨é‡)
**æ£€ç´¢å…³é”®è¯**: å·¥æœŸ è¿›åº¦è®¡åˆ’ è´¨é‡ä¿è¯ è´¨é‡æ ‡å‡† æ–½å·¥æ–¹æ¡ˆ é¡¹ç›®è®¡åˆ’

**æŠ½å–å†…å®¹**:
- å·¥æœŸæ‰¿è¯º
- è¿›åº¦è®¡åˆ’
- è´¨é‡ä¿è¯æªæ–½

### 7. **other** (å…¶ä»–)
**æ£€ç´¢å…³é”®è¯**: å…¶ä»–æ‰¿è¯º è¡¥å……è¯´æ˜ åç¦»è¡¨ å¤‡æ³¨

**æŠ½å–å†…å®¹**:
- å…¶ä»–æ‰¿è¯º
- åç¦»è¯´æ˜
- è¡¥å……ææ–™

## âš™ï¸ å…³é”®é…ç½®å‚æ•°

### æ£€ç´¢å‚æ•°
```python
topk_per_query = 20     # æ¯ä¸ªç»´åº¦æ£€ç´¢20æ¡
topk_total = 140        # æ€»è®¡æœ€å¤š140æ¡ (7ç»´åº¦ Ã— 20)
doc_types = ["bid"]     # åªæ£€ç´¢æŠ•æ ‡æ–‡ä»¶
```

### LLMå‚æ•°
```python
temperature = 0.0       # ç¡®å®šæ€§è¾“å‡º
max_tokens = 4096       # æœ€å¤§è¾“å‡ºtokenæ•°
```

### Prompt
- **æ¥æº**: æ•°æ®åº“è¡¨ `prompt_templates`
- **æ¨¡å—**: `bid_response`
- **ç‰ˆæœ¬**: 1
- **é•¿åº¦**: 4,191å­—ç¬¦
- **æ ¼å¼**: Markdownæ ¼å¼çš„æŠ½å–æŒ‡ä»¤

## ğŸ” æ£€ç´¢å·¥ä½œåŸç†

### RetrievalFacade.retrieve_multi()
```python
# ä¸ºæ¯ä¸ªç»´åº¦æ‰§è¡Œå‘é‡æ£€ç´¢
for dimension, query in queries.items():
    # 1. å°†æŸ¥è¯¢æ–‡æœ¬è½¬ä¸ºå‘é‡ (embedding)
    query_vector = embedding_provider.embed(query)
    
    # 2. åœ¨å‘é‡æ•°æ®åº“ä¸­æœç´¢ç›¸ä¼¼chunk
    #    - åªæœç´¢ doc_type='bid' çš„chunks
    #    - ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦
    #    - è¿”å›top 20
    chunks = vector_db.search(
        query_vector,
        filters={"doc_type": "bid", "project_id": project_id},
        top_k=20
    )
    
    # 3. æ”¶é›†ç»“æœ
    all_chunks.extend(chunks)

# 4. å»é‡ï¼ˆåŒä¸€chunkå¯èƒ½è¢«å¤šä¸ªç»´åº¦æ£€ç´¢åˆ°ï¼‰
unique_chunks = deduplicate(all_chunks)
```

## ğŸ’¾ æ•°æ®åº“å­˜å‚¨

### tender_bid_response_items è¡¨ç»“æ„
```sql
CREATE TABLE tender_bid_response_items (
  id TEXT PRIMARY KEY,                              -- UUID
  project_id TEXT NOT NULL,                         -- é¡¹ç›®ID
  bidder_name TEXT NOT NULL,                        -- æŠ•æ ‡äººåç§°
  dimension TEXT NOT NULL,                          -- ç»´åº¦
  response_type TEXT NOT NULL,                      -- å“åº”ç±»å‹
  response_text TEXT NOT NULL,                      -- å“åº”å†…å®¹
  extracted_value_json JSONB,                       -- æå–çš„ç»“æ„åŒ–å€¼
  evidence_chunk_ids TEXT[] NOT NULL DEFAULT '{}',  -- è¯æ®chunk IDs
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

### ç´¢å¼•
```sql
CREATE INDEX idx_tender_bid_response_project 
  ON tender_bid_response_items(project_id);
  
CREATE INDEX idx_tender_bid_response_bidder 
  ON tender_bid_response_items(bidder_name);
  
CREATE INDEX idx_tender_bid_response_dimension 
  ON tender_bid_response_items(dimension);

CREATE INDEX idx_tender_bid_response_project_bidder 
  ON tender_bid_response_items(project_id, bidder_name);
```

## ğŸ¯ LLMè¾“å‡ºæ ¼å¼

### æœŸæœ›çš„JSONç»“æ„
```json
{
  "schema_version": "bid_response_v1",
  "bidder_name": "æŠ•æ ‡äººA",
  "responses": [
    {
      "response_id": "qual_resp_001",
      "dimension": "qualification",
      "response_type": "document_ref",
      "response_text": "å·²æä¾›è¥ä¸šæ‰§ç…§ï¼ˆç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ï¼š91xxxxxxï¼‰ï¼Œæ³¨å†Œèµ„æœ¬5000ä¸‡å…ƒ",
      "extracted_value_json": {
        "document_name": "è¥ä¸šæ‰§ç…§",
        "credit_code": "91xxxxxx",
        "registered_capital": "5000ä¸‡å…ƒ",
        "registration_date": "2018-01-15"
      },
      "evidence_chunk_ids": ["chunk_bid_001", "chunk_bid_002"]
    },
    {
      "response_id": "tech_resp_001",
      "dimension": "technical",
      "response_type": "direct_answer",
      "response_text": "æœåŠ¡å™¨é…ç½®ï¼šCPU Intel Xeon Gold 6248R (3.0GHz)ï¼Œå†…å­˜128GB DDR4ï¼Œç¡¬ç›˜4TB SSD",
      "extracted_value_json": {
        "cpu": "Intel Xeon Gold 6248R (3.0GHz)",
        "memory": "128GB DDR4",
        "storage": "4TB SSD"
      },
      "evidence_chunk_ids": ["chunk_bid_015", "chunk_bid_016"]
    }
  ]
}
```

### response_type ç±»å‹
- `document_ref`: å¼•ç”¨æ–‡æ¡£ï¼ˆå¦‚è¥ä¸šæ‰§ç…§ï¼‰
- `direct_answer`: ç›´æ¥å›ç­”ï¼ˆå¦‚æŠ€æœ¯å‚æ•°ï¼‰
- `table_extract`: è¡¨æ ¼æå–ï¼ˆå¦‚æŠ¥ä»·è¡¨ï¼‰
- `promise`: æ‰¿è¯ºæ€§è¯´æ˜ï¼ˆå¦‚å·¥æœŸæ‰¿è¯ºï¼‰
- `reference`: å¼•ç”¨è¯´æ˜
- `missing`: ç¼ºå¤±/æœªå“åº”

## â±ï¸ æ€§èƒ½è€ƒè™‘

### è€—æ—¶ä¼°ç®—
1. **æ£€ç´¢é˜¶æ®µ**: 2-5ç§’
   - 7ä¸ªç»´åº¦å¹¶è¡Œæ£€ç´¢
   - å‘é‡ç›¸ä¼¼åº¦è®¡ç®—
   - çº¦140æ¡chunks

2. **LLMè°ƒç”¨**: 30-120ç§’
   - å–å†³äºæ–‡æ¡£é•¿åº¦å’ŒLLMé€Ÿåº¦
   - è¾“å…¥: ~4000 tokens (ä¸Šä¸‹æ–‡)
   - è¾“å‡º: ~2000 tokens (ç»“æ„åŒ–æ•°æ®)

3. **æ•°æ®åº“å†™å…¥**: < 1ç§’
   - æ‰¹é‡æ’å…¥25-50æ¡è®°å½•

**æ€»è®¡**: çº¦1-2åˆ†é’Ÿ

### ä¼˜åŒ–å»ºè®®
1. ä½¿ç”¨æ›´å¿«çš„LLMæ¨¡å‹
2. å‡å°‘topkæ•°é‡ï¼ˆå¦‚10æ¡/ç»´åº¦ï¼‰
3. å¹¶è¡Œå¤„ç†å¤šä¸ªæŠ•æ ‡äºº
4. ç¼“å­˜å·²æŠ½å–çš„ç»“æœ

## ğŸš¨ é”™è¯¯å¤„ç†

### å¯èƒ½çš„é”™è¯¯
1. **No embedding provider**: æœªé…ç½®å‘é‡åµŒå…¥æä¾›è€…
2. **Prompt not found**: æ•°æ®åº“ä¸­æ²¡æœ‰ `bid_response` prompt
3. **No chunks found**: é¡¹ç›®ä¸­æ²¡æœ‰æŠ•æ ‡æ–‡ä»¶æˆ–æ£€ç´¢å¤±è´¥
4. **JSON parse error**: LLMè¾“å‡ºæ ¼å¼ä¸æ­£ç¡®
5. **Database error**: æ•°æ®åº“å†™å…¥å¤±è´¥

### é”™è¯¯æ¢å¤
- JSONè§£æå¤±è´¥ â†’ å°è¯•ä¿®å¤JSON
- ä¿®å¤å¤±è´¥ â†’ è¿”å›ç©ºç»“æœä½†ä¸æŠ¥é”™
- æ•°æ®åº“é”™è¯¯ â†’ å›æ»šäº‹åŠ¡ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯

## ğŸ“ æ—¥å¿—è¿½è¸ª

### å…³é”®æ—¥å¿—ç‚¹
```
[BidResponseService] extract_bid_response_v1 start project_id=xxx, bidder=xxx
[ExtractionEngine] START project_id=xxx run_id=xxx mode=xxx
[ExtractionEngine] AFTER_RETRIEVAL count=120 ms=2500
[call_llm] START orchestrator_type=xxx model_id=xxx
[call_llm] Method chat returned: type=str latency_ms=45000
[ExtractionEngine] AFTER_LLM_CALL project_id=xxx latency_ms=45000
[BidResponseService] extract_bid_response_v1 done responses=25, added=25
```

## ğŸ”— ç›¸å…³V3å®¡æ ¸

æŠ½å–å®Œæˆåï¼Œæ•°æ®å¯ç”¨äºï¼š
1. **ReviewV3Service.run_review_v3()**
2. ä» `tender_requirements` è¯»å–æ‹›æ ‡è¦æ±‚
3. ä» `tender_bid_response_items` è¯»å–æŠ•æ ‡å“åº” â† æœ¬æµç¨‹äº§ç”Ÿçš„æ•°æ®
4. åº”ç”¨è§„åˆ™å¼•æ“è¿›è¡Œå¯¹æ¯”å®¡æ ¸
5. ç”Ÿæˆå®¡æ ¸ç»“æœ

## ğŸ“š ç›¸å…³æ–‡æ¡£
- `docs/REVIEW_V3_ENABLE_AND_CUSTOM_RULES.md` - V3å®¡æ ¸å’Œè‡ªå®šä¹‰è§„åˆ™åŒ…
- `backend/app/works/tender/extraction_specs/bid_response_v1.py` - æŠ½å–è§„æ ¼å®šä¹‰
- `backend/app/platform/extraction/engine.py` - æŠ½å–å¼•æ“æ ¸å¿ƒä»£ç 

---

**æœ€åæ›´æ–°**: 2025-12-28

