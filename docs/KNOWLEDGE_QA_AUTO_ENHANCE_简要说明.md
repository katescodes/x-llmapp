# 知识问答自动增强功能 - 快速说明

## 📌 功能说明

当用户选择了知识库进行问答时，系统会自动在用户问题后追加"**请尽可能详尽、全面回答。**"，引导 LLM 提供更详细的回答。

## ✨ 特点

1. **自动判断**: 仅在选择知识库时生效
2. **智能检测**: 如果用户已经要求"详细"、"全面"等，不会重复追加
3. **保留原始**: 历史记录中保存原始用户输入
4. **全流程支持**: 适用于编排器、历史案例、标准问答等所有模式

## 🔧 实现细节

**修改文件**: `backend/app/routers/chat.py`

**核心代码** (约 333-343 行):
```python
# 知识问答增强：当选择了知识库时，自动在用户问题后追加提示语
enhanced_message = req.message
if effective_kb_ids:
    # 检查用户问题是否已经包含详尽度相关的关键词
    detail_keywords = ["详尽", "详细", "全面", "完整", "深入", "展开"]
    has_detail_request = any(keyword in req.message for keyword in detail_keywords)
    
    # 如果用户没有明确要求详尽回答，则自动追加提示语
    if not has_detail_request:
        enhanced_message = f"{req.message}\n\n请尽可能详尽、全面回答。"
        req_logger.info(f"[知识问答增强] 已为用户问题追加详尽度提示语")
```

## 📝 使用示例

### 示例 1: 自动追加
- 用户输入: `什么是机器学习？`
- 选择知识库: ✅
- 实际发送给 LLM: `什么是机器学习？\n\n请尽可能详尽、全面回答。`

### 示例 2: 智能跳过
- 用户输入: `请详细解释什么是机器学习？`
- 选择知识库: ✅
- 实际发送给 LLM: `请详细解释什么是机器学习？` (原样保留)

### 示例 3: 无知识库不追加
- 用户输入: `什么是机器学习？`
- 选择知识库: ❌
- 实际发送给 LLM: `什么是机器学习？` (原样保留)

## 🎯 触发条件

| 条件 | 说明 |
|------|------|
| ✅ 选择知识库 | `effective_kb_ids` 不为空 |
| ✅ 无详尽度关键词 | 用户问题中不含: 详尽、详细、全面、完整、深入、展开 |

## 🔍 关键词列表

可以根据需要修改检测关键词:
```python
detail_keywords = ["详尽", "详细", "全面", "完整", "深入", "展开"]
```

## 📊 日志输出

当触发自动追加时，会在日志中输出:
```
[知识问答增强] 已为用户问题追加详尽度提示语
```

## ⚙️ 代码修改位置

在以下关键位置将 `req.message` 替换为 `enhanced_message`:

1. **编排器需求抽取** (~922 行)
2. **编排器答案生成** (~966 行)
3. **历史案例模式** (~1005 行)
4. **标准答案生成** (~1055, 1082 行)

## 📚 详细文档

更多技术细节请参考: `docs/KNOWLEDGE_QA_AUTO_ENHANCE.md`

---

**最后更新**: 2025-12-22

