# 知识问答自动增强功能

## 功能概述

当用户在知识问答场景中提出问题时，系统会自动检测用户是否选择了知识库。如果选择了知识库，系统会自动在用户问题后追加提示语："请尽可能详尽、全面回答。"，以引导 LLM 提供更加详细、完整的回答。

## 实现位置

**文件**: `backend/app/routers/chat.py`

**函数**: `_chat_endpoint_impl`

**代码位置**: 约第 333-343 行

## 实现逻辑

```python
# 知识问答增强：当选择了知识库时，自动在用户问题后追加提示语
enhanced_message = req.message
if effective_kb_ids:
    # 检查用户问题是否已经包含详尽度相关的关键词
    detail_keywords = ["详尽", "详细", "全面", "完整", "深入", "展开"]
    has_detail_request = any(keyword in req.message for keyword in detail_keywords)
    
    # 如果用户没有明确要求详尽回答，则自动追加提示语
    if not has_detail_request:
        enhanced_message = f"{req.message}\n\n请尽可能详尽、全面回答。"
        req_logger.info(f"[知识问答增强] 已为用户问题追加详尽度提示语")
```

## 触发条件

1. **必须选择知识库**: `effective_kb_ids` 不为空
2. **用户未明确要求详细回答**: 用户问题中不包含以下关键词：
   - 详尽
   - 详细
   - 全面
   - 完整
   - 深入
   - 展开

## 关键特性

### 1. 智能判断
系统会检查用户问题中是否已经包含详尽度相关的关键词。如果用户已经明确要求详细回答，就不会重复添加提示语。

### 2. 保留原始消息
虽然在处理过程中使用增强后的消息 (`enhanced_message`)，但保存到历史记录中的仍然是用户的原始问题 (`req.message`)，保证历史对话的真实性。

### 3. 全流程支持
增强后的消息 (`enhanced_message`) 会被应用到以下场景：
- **编排器模式**: 需求抽取和模块化答案生成
- **历史案例模式**: 历史决策问答
- **标准问答模式**: 常规答案生成

## 应用场景示例

### 场景 1: 自动追加提示语

**用户输入**:
```
什么是机器学习？
```

**选择知识库**: ✅ (已选择)

**系统增强后**:
```
什么是机器学习？

请尽可能详尽、全面回答。
```

**日志输出**:
```
[知识问答增强] 已为用户问题追加详尽度提示语
```

### 场景 2: 用户已明确要求，不追加

**用户输入**:
```
请详细解释一下什么是机器学习？
```

**选择知识库**: ✅ (已选择)

**系统处理**:
保持原样，不追加提示语（因为已包含"详细"关键词）

### 场景 3: 未选择知识库，不追加

**用户输入**:
```
什么是机器学习？
```

**选择知识库**: ❌ (未选择)

**系统处理**:
保持原样，不追加提示语（因为未选择知识库）

## 代码修改点

### 1. 创建增强消息变量
```python
enhanced_message = req.message
```

### 2. 判断并追加提示语
在确定 `effective_kb_ids` 后，根据条件创建 `enhanced_message`

### 3. 更新使用点
将以下关键位置的 `req.message` 替换为 `enhanced_message`:

- **编排器需求抽取** (约第 922 行):
  ```python
  requirements = await orchestrator.extract_requirements(
      user_message=enhanced_message,  # 原为 req.message
      ...
  )
  ```

- **编排器答案生成** (约第 966 行):
  ```python
  raw_answer = await orchestrator.generate_modular_answer(
      user_message=enhanced_message,  # 原为 req.message
      ...
  )
  ```

- **历史案例模式** (约第 1005 行):
  ```python
  decision_result = await generate_history_decision_answer(
      raw_question=enhanced_message,  # 原为 req.message
      ...
  )
  ```

- **标准答案生成** (约第 1055, 1082 行):
  ```python
  answer = await summarize_with_llm_stream(
      stream_call,
      enhanced_message,  # 原为 req.message
      ...
  )
  ```

## 优势

1. **用户体验优化**: 用户无需记住添加"请详细回答"等提示语
2. **知识库利用最大化**: 在使用知识库时自动引导 LLM 提供更详尽的答案
3. **智能避免重复**: 检测用户意图，避免重复添加提示语
4. **透明日志**: 通过日志记录，便于调试和监控
5. **历史记录真实**: 保存原始用户输入，不污染历史对话

## 配置建议

如果需要自定义详尽度关键词列表，可以修改 `detail_keywords` 数组：

```python
detail_keywords = ["详尽", "详细", "全面", "完整", "深入", "展开"]
```

可以根据实际使用情况增加或减少关键词，例如：
- 添加: "具体", "深度", "解释", "说明"
- 或者使用正则表达式进行更灵活的匹配

## 注意事项

1. **只在选择知识库时生效**: 这是设计选择，因为知识库场景通常期望详细回答
2. **不影响历史记录**: 历史记录中保存的是原始用户输入
3. **与 UI 详尽度设置配合**: 此功能是补充性的，与前端的 `detail_level` 设置并行工作
4. **编排器优先**: 如果启用了编排器，编排器会根据增强后的消息进行需求分析

## 测试建议

### 测试用例 1: 基本功能
- 选择知识库
- 输入: "什么是 Python?"
- 验证: 日志显示已追加提示语
- 验证: 返回的答案更详尽

### 测试用例 2: 关键词检测
- 选择知识库
- 输入: "请详细介绍 Python"
- 验证: 日志不显示追加提示语
- 验证: 保持原始输入

### 测试用例 3: 无知识库
- 不选择知识库
- 输入: "什么是 Python?"
- 验证: 日志不显示追加提示语
- 验证: 使用原始输入

### 测试用例 4: 历史记录完整性
- 选择知识库
- 输入: "什么是 Python?"
- 验证: 历史记录中的消息是原始输入，不含追加的提示语

## 版本历史

- **v1.0** (2025-12-22): 初始实现
  - 支持知识库场景自动追加提示语
  - 智能检测用户意图，避免重复
  - 保留原始消息到历史记录

