# æ ¼å¼èŒƒæœ¬è‡ªåŠ¨å¡«å……åŠŸèƒ½ - æ•…éšœæ’æŸ¥ä¸æµ‹è¯•

## âœ… å·²ä¿®å¤çš„é”™è¯¯

### é”™è¯¯1ï¼šæ•°æ®åº“è¡¨åé”™è¯¯
**é”™è¯¯ä¿¡æ¯ï¼š**
```
[TemplateMatcher] Failed to load templates: relation "doc_versions" does not exist
```

**é—®é¢˜åŸå› ï¼š**
- `template_matcher.py` ä¸­ä½¿ç”¨äº†é”™è¯¯çš„è¡¨å `doc_versions`
- æ­£ç¡®çš„è¡¨ååº”è¯¥æ˜¯ `document_versions`

**ä¿®å¤ä½ç½®ï¼š**
- æ–‡ä»¶ï¼š`/backend/app/works/tender/template_matcher.py`
- è¡Œæ•°ï¼šç¬¬222è¡Œ
- ä¿®æ”¹ï¼š`doc_versions` â†’ `document_versions`

**çŠ¶æ€ï¼š** âœ… å·²ä¿®å¤å¹¶é‡å¯åç«¯æœåŠ¡

---

## ğŸ§ª å®Œæ•´æµ‹è¯•æ­¥éª¤

### **æ–¹å¼1ï¼šæµ‹è¯•ç°æœ‰é¡¹ç›®**

#### å‰ææ¡ä»¶
ç°æœ‰é¡¹ç›®çš„æ–‡æ¡£æ˜¯åœ¨åŠŸèƒ½ä¸Šçº¿å‰ä¸Šä¼ çš„ï¼Œchunksæœªæ ‡è®°èŒƒæœ¬ï¼Œéœ€è¦å…ˆè¡¥æ‰“æ ‡è®°ã€‚

#### æ­¥éª¤

**1. è¡¥æ‰“èŒƒæœ¬æ ‡è®°**
```bash
cd /aidata/x-llmapp1

# ä¸ºå•ä¸ªé¡¹ç›®è¡¥æ‰“æ ‡è®°
python scripts/mark_existing_templates.py --project-id <é¡¹ç›®ID>

# ç¤ºä¾‹è¾“å‡ºï¼š
# Processing project: proj_xxx
# Found 150 chunks to process
# Marked 8/150 chunks as templates
# âœ… Done!
```

**2. é‡æ–°ç”Ÿæˆç›®å½•**
```
å‰ç«¯ â†’ é€‰æ‹©é¡¹ç›® â†’ â‘¢ ç›®å½• â†’ ç‚¹å‡»"ç”Ÿæˆç›®å½•"æŒ‰é’®
```

**3. æŸ¥çœ‹å¡«å……ç»Ÿè®¡**
ç›®å½•ç”Ÿæˆå®Œæˆåï¼Œå·¥å…·æ åº•éƒ¨åº”è¯¥æ˜¾ç¤ºï¼š
```
ğŸ“„ æ ¼å¼èŒƒæœ¬å¡«å……ï¼šè‡ªåŠ¨å¡«å……äº† X ä¸ªèŠ‚ç‚¹çš„æ ¼å¼èŒƒæœ¬
```

**4. æŸ¥çœ‹èŠ‚ç‚¹æ­£æ–‡**
```
ç›®å½•æ ‘ â†’ ç‚¹å‡»èŠ‚ç‚¹ï¼ˆå¦‚"æŠ•æ ‡å‡½"ï¼‰â†’ å³ä¾§æŸ¥çœ‹æ­£æ–‡
```

å¦‚æœå¡«å……æˆåŠŸï¼Œåº”è¯¥çœ‹åˆ°å®Œæ•´çš„æ ¼å¼èŒƒæœ¬æ–‡æœ¬ã€‚

---

### **æ–¹å¼2ï¼šæµ‹è¯•æ–°é¡¹ç›®**ï¼ˆæ¨èï¼‰

#### æ­¥éª¤

**1. åˆ›å»ºæ–°é¡¹ç›®**
```
å‰ç«¯ â†’ å·¦ä¸Šè§’"æ–°å»ºé¡¹ç›®" â†’ è¾“å…¥é¡¹ç›®åç§°
```

**2. ä¸Šä¼ æ‹›æ ‡ä¹¦PDF**
```
é¡¹ç›® â†’ â‘  æ–‡æ¡£ â†’ ä¸Šä¼ æ–‡ä»¶ â†’ é€‰æ‹©æ‹›æ ‡ä¹¦PDF
â†“ ç³»ç»Ÿè‡ªåŠ¨åˆ†ç‰‡å¹¶è¯†åˆ«èŒƒæœ¬ï¼ˆé˜¶æ®µ1ï¼‰
```

**3. æå–é¡¹ç›®ä¿¡æ¯**
```
é¡¹ç›® â†’ â‘  ä¿¡æ¯ â†’ ç‚¹å‡»"æå–ä¿¡æ¯"æŒ‰é’®
ç­‰å¾…æå–å®Œæˆ...
```

**4. ç”Ÿæˆç›®å½•**
```
é¡¹ç›® â†’ â‘¢ ç›®å½• â†’ ç‚¹å‡»"ç”Ÿæˆç›®å½•"æŒ‰é’®
ç­‰å¾…ç”Ÿæˆå®Œæˆ...
â†“ ç³»ç»Ÿè‡ªåŠ¨åŒ¹é…èŒƒæœ¬ï¼ˆé˜¶æ®µ2ï¼‰
â†“ ç³»ç»Ÿè‡ªåŠ¨å¡«å……æ­£æ–‡ï¼ˆé˜¶æ®µ3ï¼‰
```

**5. æŸ¥çœ‹ç»“æœ**

å·¥å…·æ åº•éƒ¨ç»Ÿè®¡ï¼š
```
âš¡ å¿«é€Ÿç”Ÿæˆæ¨¡å¼ï¼šåŸºäºå·²æå–çš„é¡¹ç›®ä¿¡æ¯æ„å»ºéª¨æ¶ (15ä¸ªèŠ‚ç‚¹)
âœ¨ è§„åˆ™ç»†åŒ–ï¼šä»æ‹›æ ‡è¦æ±‚ä¸­æå–äº† 12 ä¸ªç»†åˆ†èŠ‚ç‚¹
ğŸ” LLMæ‹¬å·è§£æï¼šä»æ‹¬å·è¯´æ˜ä¸­æå–äº† 5 ä¸ªL4å­èŠ‚ç‚¹
ğŸ“„ æ ¼å¼èŒƒæœ¬å¡«å……ï¼šè‡ªåŠ¨å¡«å……äº† 3 ä¸ªèŠ‚ç‚¹çš„æ ¼å¼èŒƒæœ¬ âœ¨
```

ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹æ­£æ–‡ï¼š
```
å•†åŠ¡æ ‡
  â”œâ”€ æŠ•æ ‡å‡½åŠæŠ•æ ‡å‡½é™„å½•
  â”‚   â””â”€ æ­£æ–‡ï¼šâœ… [å·²å¡«å……]
  â”‚       è‡´ï¼šÃ—Ã—Ã— æ‹›æ ‡å•ä½
  â”‚       æˆ‘å•ä½æ„¿æ„å‚åŠ è´µå•ä½ç»„ç»‡çš„...
  â”‚       æŠ•æ ‡äººï¼š_____________
  â”‚       ...
```

---

## ğŸ” å¦‚ä½•éªŒè¯èŒƒæœ¬æ˜¯å¦è¢«è¯†åˆ«

### æ–¹æ³•1ï¼šæŸ¥çœ‹æ•°æ®åº“
```sql
-- æŸ¥è¯¢æ ‡è®°ä¸ºèŒƒæœ¬çš„chunks
SELECT 
    id,
    LEFT(content_text, 100) as preview,
    meta_json->>'is_potential_template' as is_template,
    meta_json->>'template_score' as score,
    meta_json->>'template_hints' as hints
FROM doc_segments
WHERE doc_version_id = '<æ–‡æ¡£ç‰ˆæœ¬ID>'
  AND meta_json->>'is_potential_template' = 'true'
ORDER BY (meta_json->>'template_score')::int DESC
LIMIT 10;
```

**é¢„æœŸç»“æœï¼š**
å¦‚æœè¯†åˆ«æˆåŠŸï¼Œåº”è¯¥è¿”å›å¤šæ¡è®°å½•ï¼Œ`template_score` åº”è¯¥ â‰¥ 50ã€‚

### æ–¹æ³•2ï¼šæŸ¥çœ‹åç«¯æ—¥å¿—
```bash
# æŸ¥çœ‹ç›®å½•ç”Ÿæˆæ—¶çš„èŒƒæœ¬åŒ¹é…æ—¥å¿—
docker-compose logs backend | grep -i "template" | tail -50
```

**é¢„æœŸæ—¥å¿—ï¼š**
```
ExtractV2: Starting template matching and auto-fill for project=xxx
ExtractV2: Template matching found 3 matches
ExtractV2: Template auto-fill complete - 3/3 nodes filled
```

---

## ğŸš¨ å¸¸è§é—®é¢˜

### Q1: å·¥å…·æ ç»Ÿè®¡æ˜¾ç¤º"æœªå‘ç°å¯åŒ¹é…çš„æ ¼å¼èŒƒæœ¬"

**åŸå› ï¼š**
1. æ‹›æ ‡æ–‡ä»¶ä¸­æ²¡æœ‰åŒ…å«"æ ¼å¼"ã€"èŒƒæœ¬"ç­‰å…³é”®è¯
2. chunksæœªè¢«æ ‡è®°ï¼ˆç°æœ‰é¡¹ç›®ï¼‰

**è§£å†³ï¼š**
- å¯¹äºç°æœ‰é¡¹ç›®ï¼šè¿è¡Œè¡¥æ‰“æ ‡è®°è„šæœ¬
- å¯¹äºæ–°é¡¹ç›®ï¼šæ£€æŸ¥æ‹›æ ‡æ–‡ä»¶å†…å®¹

### Q2: è¡¥æ‰“æ ‡è®°è„šæœ¬è¿è¡Œåä»ç„¶æ˜¾ç¤º0æ¡

**åŸå› ï¼š**
æ‹›æ ‡æ–‡ä»¶ä¸­ç¡®å®æ²¡æœ‰æ˜æ˜¾çš„æ ¼å¼èŒƒæœ¬ã€‚

**éªŒè¯ï¼š**
æ‰‹åŠ¨æ‰“å¼€æ‹›æ ‡ä¹¦PDFï¼Œæœç´¢"æ ¼å¼"ã€"èŒƒæœ¬"ç­‰å…³é”®è¯ï¼Œçœ‹æ˜¯å¦æœ‰ç›¸å…³å†…å®¹ã€‚

### Q3: è¯†åˆ«åˆ°èŒƒæœ¬ä½†æœªå¡«å……

**åŸå› ï¼š**
LLMåŒ¹é…ç½®ä¿¡åº¦ä¸å¤Ÿï¼ˆ< 0.7ï¼‰ã€‚

**è§£å†³ï¼š**
é™ä½åŒ¹é…é˜ˆå€¼ï¼ˆéœ€ä¿®æ”¹ä»£ç ï¼‰æˆ–æ‰‹åŠ¨ç¼–è¾‘èŠ‚ç‚¹æ­£æ–‡ã€‚

### Q4: èŠ‚ç‚¹æ­£æ–‡æ˜¾ç¤ºä¸ºç©º

**åŸå› ï¼š**
- å¯èƒ½æ˜¯æ•°æ®åº“æŸ¥è¯¢é—®é¢˜
- å¯èƒ½æ˜¯å‰ç«¯æœªæ­£ç¡®åŠ è½½æ­£æ–‡

**æ’æŸ¥ï¼š**
```sql
-- æŸ¥è¯¢èŠ‚ç‚¹æ­£æ–‡
SELECT 
    numbering,
    title,
    LEFT(body_content, 100) as preview,
    source_chunk_ids
FROM tender_directory_nodes
WHERE project_id = '<é¡¹ç›®ID>'
  AND body_content IS NOT NULL
  AND body_content != ''
ORDER BY numbering;
```

---

## ğŸ“Š æˆåŠŸæ ‡å‡†

### è¯†åˆ«é˜¶æ®µï¼ˆé˜¶æ®µ1ï¼‰
- âœ… æ•°æ®åº“ä¸­æœ‰ `is_potential_template=true` çš„chunks
- âœ… `template_score` â‰¥ 50
- âœ… `template_hints` åŒ…å«è¯†åˆ«åŸå› 

### åŒ¹é…é˜¶æ®µï¼ˆé˜¶æ®µ2ï¼‰
- âœ… åç«¯æ—¥å¿—æ˜¾ç¤º"Template matching found X matches"
- âœ… åŒ¹é…çš„ç½®ä¿¡åº¦ â‰¥ 0.7

### å¡«å……é˜¶æ®µï¼ˆé˜¶æ®µ3ï¼‰
- âœ… åç«¯æ—¥å¿—æ˜¾ç¤º"Template auto-fill complete - X/X nodes filled"
- âœ… å‰ç«¯å·¥å…·æ æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
- âœ… èŠ‚ç‚¹æ­£æ–‡åŒ…å«èŒƒæœ¬æ–‡æœ¬

---

## ğŸ› ï¸ è°ƒè¯•å‘½ä»¤

### æŸ¥çœ‹æœ€è¿‘çš„ç›®å½•ç”Ÿæˆæ—¥å¿—
```bash
docker-compose logs backend | grep -E "(ExtractV2|template)" | tail -100
```

### æŸ¥çœ‹ç‰¹å®šé¡¹ç›®çš„èŒƒæœ¬è¯†åˆ«æƒ…å†µ
```bash
# 1. è·å–é¡¹ç›®çš„æ–‡æ¡£ç‰ˆæœ¬ID
psql -U localgpt -d localgpt -c "
SELECT dv.id, dv.filename 
FROM tender_project_documents tpd
JOIN document_versions dv ON dv.asset_id = tpd.asset_id
WHERE tpd.project_id = '<é¡¹ç›®ID>' AND tpd.doc_role = 'tender';
"

# 2. æŸ¥è¯¢èŒƒæœ¬chunks
psql -U localgpt -d localgpt -c "
SELECT COUNT(*), 
       AVG((meta_json->>'template_score')::int) as avg_score
FROM doc_segments
WHERE doc_version_id = '<æ–‡æ¡£ç‰ˆæœ¬ID>'
  AND meta_json->>'is_potential_template' = 'true';
"
```

### æ‰‹åŠ¨æµ‹è¯•è¡¥æ‰“æ ‡è®°
```bash
cd /aidata/x-llmapp1

# æµ‹è¯•å•ä¸ªé¡¹ç›®ï¼ˆä¼šæ˜¾ç¤ºè¯¦ç»†æ—¥å¿—ï¼‰
python scripts/mark_existing_templates.py --project-id <é¡¹ç›®ID>

# æµ‹è¯•æ‰€æœ‰é¡¹ç›®
python scripts/mark_existing_templates.py --all
```

---

## âœ… æ€»ç»“

**å·²ä¿®å¤çš„é”™è¯¯ï¼š**
1. âœ… æ•°æ®åº“è¡¨åé”™è¯¯ï¼ˆ`doc_versions` â†’ `document_versions`ï¼‰
2. âœ… è‡ªå®šä¹‰è§„åˆ™å®¡æ ¸é”™è¯¯ï¼ˆ`condition_json` ç±»å‹æ£€æŸ¥ï¼‰

**åŠŸèƒ½çŠ¶æ€ï¼š**
- âœ… é˜¶æ®µ1ï¼šæ–‡æ¡£åˆ†ç‰‡æ—¶è¯†åˆ«ï¼ˆå·²é›†æˆï¼‰
- âœ… é˜¶æ®µ2ï¼šLLMç²¾ç¡®åŒ¹é…ï¼ˆå·²å®ç°ï¼‰
- âœ… é˜¶æ®µ3ï¼šè‡ªåŠ¨å¡«å……æ­£æ–‡ï¼ˆå·²å®ç°ï¼‰
- âœ… å‰ç«¯UIæ˜¾ç¤ºï¼ˆå·²å®Œæˆï¼‰
- âœ… è¡¥æ‰“æ ‡è®°è„šæœ¬ï¼ˆå·²å®Œæˆï¼‰

**æµ‹è¯•æ–¹æ³•ï¼š**
- **æ¨è**ï¼šåˆ›å»ºæ–°é¡¹ç›®æµ‹è¯•ï¼ˆå…¨è‡ªåŠ¨ï¼‰
- **å¤‡é€‰**ï¼šç°æœ‰é¡¹ç›® + è¡¥æ‰“æ ‡è®°è„šæœ¬

**åŠŸèƒ½å®Œæ•´å¯ç”¨ï¼** ğŸš€

