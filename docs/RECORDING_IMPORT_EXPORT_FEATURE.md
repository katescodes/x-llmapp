# 录音导入导出功能说明

## 功能概述

为录音功能添加了以下两个新特性：
1. **导出录音文件**：可以下载系统中保存的录音音频文件
2. **导入外部音频**：可以上传外部音频文件到系统，并进行转写和播放

## 功能实现

### 1. 后端API

#### 1.1 导出录音文件
- **接口**: `GET /api/recordings/{recording_id}/download`
- **认证**: 需要Bearer Token
- **功能**: 下载指定录音的音频文件，文件名会使用录音标题
- **示例**:
  ```bash
  curl -X GET "http://localhost:8000/api/recordings/{recording_id}/download" \
    -H "Authorization: Bearer <token>" \
    -o recording.webm
  ```

#### 1.2 上传音频文件
- **接口**: `POST /api/recordings/upload`
- **认证**: 需要Bearer Token
- **参数**: 
  - `file`: 音频文件（multipart/form-data）
  - `title`: 可选，录音标题
- **支持格式**: mp3, wav, m4a, ogg, webm, flac, aac
- **文件大小限制**: 100MB
- **功能**: 上传音频文件并创建录音记录，状态为pending，需要手动转写
- **示例**:
  ```bash
  curl -X POST "http://localhost:8000/api/recordings/upload" \
    -H "Authorization: Bearer <token>" \
    -F "file=@/path/to/audio.mp3" \
    -F "title=我的录音"
  ```

#### 1.3 现有的音频播放接口（已存在）
- **接口**: `GET /api/recordings/{recording_id}/audio?token={token}`
- **功能**: 在浏览器中播放音频文件

### 2. 前端UI改进

#### 2.1 录音列表页面
新增了两个主要按钮：
- **📁 导入音频**: 打开上传对话框
- **🎤 新录音**: 开始新的录音（原有功能）

#### 2.2 录音卡片操作
在每条录音的操作按钮中新增：
- **💾 导出**: 下载音频文件到本地
- **▶️ 播放**: 在线播放音频（原有功能）
- **📝 转写**: 对音频进行语音识别（原有功能）

#### 2.3 导入音频对话框
- 支持点击选择文件
- 支持拖拽文件上传
- 显示支持的文件格式和大小限制
- 上传进度提示
- 使用说明

## 使用流程

### 导出录音流程
1. 在"我的录音"列表中找到要导出的录音
2. 点击该录音卡片上的 **💾 导出** 按钮
3. 浏览器会自动下载音频文件，文件名为录音标题

### 导入外部音频流程
1. 点击页面右上角的 **📁 导入音频** 按钮
2. 在弹出的对话框中：
   - 点击上传区域选择文件，或
   - 直接拖拽音频文件到上传区域
3. 等待上传完成（会显示上传成功提示）
4. 上传的音频会出现在录音列表中
5. 点击 **📝 转写** 按钮进行语音识别
6. 转写完成后可以：
   - 播放音频
   - 查看转写文本
   - 生成摘要
   - 导入到知识库
   - 再次导出

## 技术细节

### 文件处理
- 音频文件存储在 `{APP_DATA_DIR}/recordings/` 目录
- 文件命名格式: `rec_{12位随机ID}.{扩展名}`
- 数据库中保存文件路径和元数据

### 安全性
- 所有API都需要认证（Bearer Token）
- 仅能访问自己上传的录音
- 文件类型白名单验证
- 文件大小限制（100MB）

### 错误处理
- 不支持的文件格式会提示错误
- 文件过大会提示错误
- 网络错误会给出友好提示
- 上传失败会清空文件选择

## 数据库结构

录音记录包含以下字段：
```sql
voice_recordings:
  - id: 录音ID
  - user_id: 用户ID
  - title: 标题
  - filename: 文件名
  - duration: 时长（秒）
  - file_size: 文件大小（字节）
  - audio_format: 音频格式（mp3/wav/webm等）
  - transcript: 转写文本
  - word_count: 字数
  - audio_path: 音频文件路径
  - keep_audio: 是否保留音频（true）
  - import_status: 导入状态（pending/imported等）
  - created_at: 创建时间
  - updated_at: 更新时间
```

## 测试建议

### 1. 导出功能测试
- [ ] 测试导出WebM格式录音
- [ ] 测试导出其他格式录音
- [ ] 验证下载的文件可以正常播放
- [ ] 验证文件名正确（使用录音标题）

### 2. 导入功能测试
- [ ] 测试上传MP3文件
- [ ] 测试上传WAV文件
- [ ] 测试上传M4A文件
- [ ] 测试上传超大文件（应失败）
- [ ] 测试上传不支持格式（应失败）
- [ ] 测试拖拽上传
- [ ] 验证上传后可以正常播放
- [ ] 验证上传后可以正常转写

### 3. 完整流程测试
- [ ] 导入外部音频 → 转写 → 播放 → 导出
- [ ] 系统录音 → 导出 → 作为外部音频导入 → 验证一致性
- [ ] 批量导入多个文件
- [ ] 导入后导入知识库

## 注意事项

1. **音频格式兼容性**: 
   - WebM格式在某些播放器中可能不支持
   - 建议使用MP3或M4A格式以获得最佳兼容性

2. **转写要求**: 
   - 需要配置ASR服务（语音识别服务）
   - 上传的音频文件需要手动点击"转写"按钮

3. **存储空间**: 
   - 音频文件会占用服务器存储空间
   - 建议定期清理不需要的录音

4. **性能考虑**: 
   - 大文件上传可能需要较长时间
   - 转写大文件可能需要几分钟

## 后续优化建议

1. **批量操作**: 支持批量导出和删除
2. **格式转换**: 在导出时提供格式转换选项
3. **云存储**: 支持上传到OSS等云存储服务
4. **自动转写**: 上传后自动启动转写任务
5. **进度显示**: 显示上传和转写的实时进度
6. **文件预览**: 上传前预览音频信息（时长、比特率等）

