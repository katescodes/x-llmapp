# 招标文件上传和解析功能说明

## 问题汇总与解决方案

### ✅ 问题1：上传 Excel 文件失败

**问题描述**：
- 用户上传 `.xlsx` 或 `.xls` 格式的招标文件失败
- 系统无法正确解析 Excel 内容

**根本原因**：
- 文档解析器 (`backend/app/platform/ingest/parser.py`) 不支持 Excel 格式
- 只支持：TXT, MD, HTML, PDF, DOCX, AUDIO

**解决方案**：✅ 已修复
1. 添加 `EXCEL_EXTS = {".xlsx", ".xls"}` 常量定义
2. 实现 `_parse_excel()` 函数，使用 `openpyxl` 库解析 Excel
3. 在 `parse_document()` 中添加 Excel 处理分支
4. 添加 `openpyxl==3.1.2` 到 requirements.txt

**Excel 解析特性**：
- 提取所有工作表（Sheet）内容
- 按行列组织文本，使用 `|` 分隔单元格
- 自动过滤空行
- 返回元数据：sheets, rows, cells, chars

**示例输出**：
```
=== Sheet1 ===
项目名称 | 预算金额 | 工期
某某工程 | 1000万 | 180天

=== Sheet2 ===
技术参数 | 要求
...
```

---

### ✅ 问题2：解析招标文件需要从上传的多个文件全部解析

**问题描述**：
- 用户上传了多个招标文件（如：招标公告.pdf、技术规范.docx、商务条款.xlsx）
- 需要确认系统是否从所有文件中提取信息

**结论**：✅ **系统已支持多文件提取**

**工作机制**：

```
【Step 1: 文件上传和入库】
用户上传多个文件 (kind="tender")
  ↓
文件1 (招标公告.pdf)
  → IngestV2Service.ingest_asset_v2()
  → parse_document() → 解析为文本
  → chunk_document() → 分片 (1200字符/片)
  → DocStore + Milvus 向量库

文件2 (技术规范.docx)  
  → IngestV2Service.ingest_asset_v2()
  → parse_document() → 解析为文本
  → chunk_document() → 分片
  → DocStore + Milvus 向量库

文件3 (商务条款.xlsx) ← ✅ 新增支持
  → IngestV2Service.ingest_asset_v2()
  → parse_document() → 解析为文本
  → chunk_document() → 分片
  → DocStore + Milvus 向量库

【Step 2: 提取项目信息】
ExtractV2Service.extract_project_info_v2()
  ↓
构建多维度查询：
  - base: "招标公告 项目名称 预算金额..."
  - technical: "技术要求 技术规范 参数表..."
  - business: "商务条款 付款方式 工期..."
  - scoring: "评分标准 评标办法..."
  ↓
RetrievalFacade.retrieve(
  query="...",
  doc_types=["tender"],  ← 从所有招标文件中检索
  top_k=30
)
  ↓
返回：所有招标文件中相关的文本片段
  - 来自文件1的10个片段
  - 来自文件2的15个片段  
  - 来自文件3的5个片段
  ↓
LLM 处理：从所有片段中提取结构化信息
  ↓
返回：完整的项目信息
```

**关键配置**：

1. **ExtractionSpec** (`backend/app/works/tender/extraction_specs/project_info_v2.py`):
```python
ExtractionSpec(
    doc_types=["tender"],  # 检索所有 tender 类型文件
    topk_per_query=30,     # 每个查询返回30个片段
    topk_total=120         # 总共最多120个片段
)
```

2. **检索器** (`backend/app/platform/retrieval/facade.py`):
```python
async def retrieve(
    query: str,
    project_id: str,
    doc_types: List[str],  # 指定文档类型过滤
    ...
):
    # 从 Milvus 向量库检索
    # doc_types=["tender"] 表示只检索招标文件
    # 会从所有匹配的文件中检索
```

**验证方法**：
1. 上传多个招标文件（PDF + DOCX + XLSX）
2. 运行"提取项目信息"
3. 查看日志中的检索结果：
   ```
   retrieval_trace: {
     "chunks": [
       {"doc_version_id": "xxx1", "filename": "招标公告.pdf", ...},
       {"doc_version_id": "xxx2", "filename": "技术规范.docx", ...},
       {"doc_version_id": "xxx3", "filename": "商务条款.xlsx", ...}
     ]
   }
   ```

---

## 支持的文件格式

### 当前支持的格式（✅ 已测试）

| 格式类别 | 文件扩展名 | 解析库 | 说明 |
|---------|-----------|--------|------|
| 文本文件 | .txt, .md, .markdown, .csv, .json | Python标准库 | 纯文本解析 |
| HTML | .html, .htm | BeautifulSoup | 提取文本，去除脚本和样式 |
| PDF | .pdf | pypdf | 逐页提取文本 |
| Word | .docx | python-docx | 提取段落文本 |
| **Excel** | **.xlsx, .xls** | **openpyxl** | **✅ 新增支持** |
| PowerPoint | .pptx | python-pptx | 提取幻灯片文本 |
| 音频 | .mp3, .wav, etc | 转文字API | 需要配置转写服务 |

---

## 使用建议

### 1. 招标文件上传最佳实践

**推荐做法**：
- ✅ 将招标文件拆分为多个文件上传（如：公告、规范、条款分别上传）
- ✅ 使用清晰的文件名（如：`招标公告.pdf`、`技术规范.docx`、`评分表.xlsx`）
- ✅ 确保所有文件的 `kind` 参数都设置为 `"tender"`

**为什么多文件更好**：
1. **提高检索精度**：不同类型的内容分散在不同文件，检索更准确
2. **减少噪音**：避免单个大文件包含过多无关内容
3. **便于管理**：文件职责清晰，易于更新和替换

**示例**：
```javascript
// 前端上传代码
const files = [
  { file: 招标公告.pdf, kind: "tender" },
  { file: 技术规范.docx, kind: "tender" },
  { file: 商务条款.xlsx, kind: "tender" },  // ✅ 现在支持
  { file: 评分表.xlsx, kind: "tender" }     // ✅ 现在支持
];

// 批量上传
await uploadAssets(projectId, files);
```

### 2. Excel 文件使用建议

**推荐的 Excel 结构**：
```
Sheet1: 技术参数
┌──────────────┬──────────┬──────┬────────┐
│ 参数名称     │ 参数要求 │ 单位 │ 备注   │
├──────────────┼──────────┼──────┼────────┤
│ 处理能力     │ ≥100吨/天│ 吨   │ 最低要求│
│ 功耗         │ ≤50kW    │ kW   │        │
└──────────────┴──────────┴──────┴────────┘

Sheet2: 商务条款
┌──────────────┬────────────────────────┐
│ 条款类型     │ 要求                    │
├──────────────┼────────────────────────┤
│ 付款方式     │ 分3期支付：30%+40%+30% │
│ 质保期       │ 1年                     │
└──────────────┴────────────────────────┘
```

**解析效果**：
```
=== 技术参数 ===
参数名称 | 参数要求 | 单位 | 备注
处理能力 | ≥100吨/天 | 吨 | 最低要求
功耗 | ≤50kW | kW |

=== 商务条款 ===
条款类型 | 要求
付款方式 | 分3期支付：30%+40%+30%
质保期 | 1年
```

### 3. 提取效果优化

**提高提取准确率**：
1. ✅ 使用结构化的 Excel 表格（有标题行）
2. ✅ 避免合并单元格（会导致解析错位）
3. ✅ 重要信息用清晰的标题标注
4. ✅ 数值和单位分开放在不同列

**检查提取结果**：
```javascript
// 提取完成后，查看 evidence_chunk_ids
{
  "data": {
    "base": {
      "projectName": "某某项目",
      // ...
    }
  },
  "evidence_chunk_ids": [
    "CHUNK_xxx",  // 来自 招标公告.pdf
    "CHUNK_yyy",  // 来自 技术规范.docx  
    "CHUNK_zzz"   // 来自 评分表.xlsx ← 新增
  ]
}
```

---

## 常见问题

### Q1: 为什么我的 Excel 文件上传后内容提取不准确？

**可能原因**：
1. Excel 有大量空行/空列 → 解析器会自动过滤
2. 使用了复杂的公式 → 解析器只读取计算后的值 (`data_only=True`)
3. 有合并单元格 → 建议拆分为多行

**解决方法**：
- 简化 Excel 结构，使用简单的表格
- 将复杂的 Excel 转换为 PDF 后上传

### Q2: 上传多个文件后，系统会重复提取信息吗？

**答**：不会。系统使用向量检索 + LLM 去重机制：
1. 检索阶段：从所有文件中检索相关片段
2. 排序阶段：按相关度排序，优先返回最相关的
3. LLM 阶段：LLM 会综合所有证据，自动去重和归纳

### Q3: 我可以上传多少个招标文件？

**答**：理论上无限制，但建议：
- 每个项目上传 **3-10** 个招标文件为宜
- 总文件大小建议不超过 **50MB**
- 每个文件建议不超过 **10MB**

---

## 技术细节

### 修改的文件

1. **`backend/app/platform/ingest/parser.py`**
   - 添加 `EXCEL_EXTS` 常量
   - 实现 `_parse_excel()` 函数
   - 在 `parse_document()` 中添加 Excel 分支

2. **`backend/requirements.txt`**
   - 添加 `openpyxl==3.1.2` 依赖

### 测试方法

```python
# 测试 Excel 解析
from app.platform.ingest.parser import parse_document

# 读取 Excel 文件
with open("test.xlsx", "rb") as f:
    data = f.read()

# 解析
doc = await parse_document("test.xlsx", data)

print(f"Title: {doc.title}")
print(f"Text: {doc.text[:500]}")  # 前500字符
print(f"Metadata: {doc.metadata}")
```

---

## 部署说明

### Docker 部署（推荐）

```bash
# 1. 更新代码
cd /aidata/x-llmapp1

# 2. 重新构建镜像
docker-compose build --no-cache backend

# 3. 重启服务
docker-compose restart backend

# 4. 验证
docker exec localgpt-backend python -c "import openpyxl; print('openpyxl installed')"
```

### 本地开发

```bash
# 1. 安装依赖
pip install openpyxl==3.1.2

# 2. 运行测试
python -m pytest tests/test_parser.py -v
```

---

## 更新日志

### v1.1.0 (2025-12-23)

**新增功能**：
- ✅ 支持 Excel 文件上传和解析 (.xlsx, .xls)
- ✅ 自动提取所有工作表内容
- ✅ 按行列组织文本，保留表格结构

**改进**：
- ✅ 确认并文档化多文件提取机制
- ✅ 添加最佳实践建议

**已知限制**：
- Excel 合并单元格可能导致解析错位
- 不支持 Excel 图表和图片提取
- 复杂公式只返回计算后的值

---

## 支持

如有问题，请联系技术支持或查看：
- 代码文档：`backend/app/platform/ingest/parser.py`
- 测试用例：`tests/platform/test_parser.py`
- API 文档：`/api/docs`

